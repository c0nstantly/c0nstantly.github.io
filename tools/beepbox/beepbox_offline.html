<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>BeepBox</title>
	<meta name="mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="theme-color" content="#444" />
	<meta name="format-detection" content="telephone=no" />
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" rel="stylesheet" media="none" onload="if (this.media != 'all') this.media='all';" /> <!-- this is a trick to load CSS asynchronously. -->
	<meta name="robots" content="noindex, nofollow" />
	<style type="text/css">
		html {
			background: var(--page-margin, black);
			overflow-x: hidden;
			font-size: large;
			font-family: 'Roboto', sans-serif;
			line-height: 1.3;
			color: var(--primary-text, white);
		}
		body {
			margin: auto;
			overflow-x: hidden;
			display: flex;
			flex-direction: column;
			align-items: center;
			align-content: center;
		}
		#beepboxEditorContainer {
			min-height: 645px;
			overflow: auto;
			background: var(--editor-background, black);
			width: 100%;
			max-width: 710px;
			padding-left: 30px;
			padding-right: 30px;
		}
		#text-content {
			overflow: auto;
			background: var(--editor-background, black);
			width: 100%;
			max-width: 710px;
			padding-left: 30px;
			padding-right: 30px;
		}
		h1 {
			font-size: 1.7rem;
			text-align: center;
			margin-top: 0.5em;
			margin-bottom: 0.5em;
			-webkit-text-stroke-width: 0;
		}
		h2 {
			font-size: 1.5rem;
			text-align: center;
			margin-top: 0.5em;
			margin-bottom: 0.5em;
			-webkit-text-stroke-width: 0;
		}
		a {
			color: var(--link-accent, #98f);
		}
		.donation form {
			display: inline;
		}
		.donation input[type="submit"] {
			-webkit-appearance: none;
			appearance: none;
			background: none;
			border: none;
			font-family: inherit;
			font-size: inherit;
			color: var(--link-accent, #98f);
			text-decoration: underline;
			cursor: pointer;
			padding: 0;
			margin: 0;
		}
		
		/* wide screen */
		@media (min-width: 711px) {
			html {
				width: 100%;
			}
			body {
				width: 100%;
			}
			.column-container {
				width: 710px;
				display: flex;
				gap: 25px;
			}
			/*.instructions-column {
				min-width: 0;
			}
			.twitter-column {
				width: 300px;
				flex-shrink: 0;
			}*/
		}
		
		/* narrow screen */
		@media (max-width: 710px) {
			body {
				width: 100%;
			}
			p, .donation {
				margin: 1em 0.5em;
			}
			.column-container {
				display: flex;
				flex-direction: column;
				align-items: center;
			}
		}
	</style>
</head>

<body>
	<div id="beepboxEditorContainer">
		<noscript>
			Sorry, BeepBox requires a JavaScript-enabled browser.
		</noscript>
	</div>
	<div id="text-content">
		<section>
			<h1>
				BeepBox Offline
			</h1>
			<p id="introduction">
				BeepBox is an online (and offline!) tool for sketching and sharing instrumental music. 
			</p>
			<p>
				All song data is contained in the URL at the top of your browser. 
				When you make changes to the song, the URL is updated to reflect your changes. 
				When you are satisfied with your song, just copy and paste the URL to save and share your song! 
			</p>
			<div class="donation">
				BeepBox is a passion project, and will always be free to use. If you find it valuable and have the means, any gratuity via
				<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
					<input type="hidden" name="cmd" value="_donations" />
					<input type="hidden" name="business" value="QZJTX9GRYEV9N" />
					<input type="hidden" name="currency_code" value="USD" />
					<input type="submit" name="submit" value="Paypal"/>
				</form>
				would be appreciated!
			</div>
		</section>
	
		<div class="column-container">
			<main class="instructions-column">
				<section>
					<h2>
						Instructions
					</h2>
					<p>
						You can add or remove notes by clicking on the gray rows at the top. 
						BeepBox automatically plays the notes out loud for you. Try it!
					</p>
					<p>
						Notes go into patterns, and you can edit one pattern at a time.
						Those numbered boxes at the bottom of the editor are the different patterns you can edit.
						<span id="bar-editing">
							Click the boxes to move to a different part of the song, or click the arrows on the currently selected box to swap which pattern is played during that part of the song.
						</span>
					</p>
					<p>
						BeepBox can play several rows of patterns simultaneously, and each row has its own set of patterns. 
						Most rows can play melodies or harmonies, but the bottom row is for drums.
					</p>
					<p>
						The purple loop underneath the numbered boxes controls which part of the song is currently repeating. 
						Move the loop to listen to a different part of the song, or drag the ends to expand the loop to include the whole song. 
					</p>
					<div id="keyboard-instructions">
						<p>
							When BeepBox has focus (click on its interface above), you can use these keyboard shortcuts: <br/>
						</p>
						<ul>
							<li><b>Spacebar</b>: play or pause the song</li>
							<li><b>Shift Spacebar</b>: play from mouse location</li>
							<li><b>Z</b>: undo, <b>Y or Shift Z</b>: redo</li>
							<li><b>C/V</b>: copy/paste selected pattern(s)</li>
							<li><b>0-9</b>: assign pattern number to selection</li>
							<li><b>Arrows</b>: move selection</li>
							<li><b>Ctrl + Arrows</b>: rearrange channels</li>
							<li><b>[ ]</b>: move playhead backward or forward</li>
							<li><b>F/H</b>: move to First or Highlighted pattern </li>
							<li><b>Shift & Drag</b>: select part of a pattern (long press on touch screen)</li>
							<li>Check BeepBox's edit menu for more!</li>
						</ul>
					</div>
					<p>
						In the note pattern editor, you can click and drag horizontally on a note to adjust its duration.
						You can also click above or below an existing note to add more notes to be played simultaneously, which is called a chord. 
					</p>
					<p>
						ADVANCED: Drag vertically from an existing note to bend its pitch, or drag vertically from above or below the note to adjust its volume. Drag on the numbered pattern boxes to select multiple patterns to copy and paste parts of your song.
					</p>
					<p>
						BeepBox has many more features. 
						Try playing with the buttons and menus on the right side to find out what it can do!
						You can also click on the label next to each option for a description of what it does.
					</p>
				</section>
				<section>
					<h2>
						About
					</h2>
					<p>
						BeepBox is developed by <a href="http://www.johnnesky.com" target="_blank">John Nesky</a>, also known as <a href="https://twitter.com/shaktool" target="_blank">@shaktool</a>. 
					</p>
					<p>
						BeepBox does not claim ownership over songs created with it, so original songs belong to their authors. 
					</p>
					<p>
						Neither John Nesky nor BeepBox assume responsibility for any copyrighted material played on BeepBox. No songs are ever received, recorded, or distributed by BeepBox's servers. All song data is contained in the URL after the hash (#) mark, and your song data will not leave your device unless you copy and share the URL. BeepBox does not collect, track, or share any user data. 
					</p>
					<p>
						You can find the <a href="https://github.com/johnnesky/beepbox/releases/" target="_blank">release notes for the latest versions of BeepBox here</a>.
					</p>
					<p>
						You can download and use <a href="https://github.com/johnnesky/beepbox" target="_blank">the source code</a> under the MIT license
					</p>
				<section>
			</main>
		</div>
	</div>
	
	<script type="text/javascript">

if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|android|ipad|playbook|silk/i.test(navigator.userAgent) ) {
	document.getElementById("introduction").innerHTML = "BeepBox is an online tool for sketching and sharing instrumental music. Make sure that your volume is turned up, then press the play button!";
	document.getElementById("keyboard-instructions").style.display = "none";
	document.getElementById("bar-editing").innerHTML = "Tap the boxes to move to a different part of the song, or tap on the currently selected box to swap which pattern is played during that part of the song.";
}

var beepbox=function(t){"use strict";
/*!
    Copyright (C) 2021 John Nesky

    Permission is hereby granted, free of charge, to any person obtaining a copy of
    this software and associated documentation files (the "Software"), to deal in
    the Software without restriction, including without limitation the rights to
    use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
    of the Software, and to permit persons to whom the Software is furnished to do
    so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.
    */class e{}function i(t){let e=0;for(let i=0;i<t.length;i++)e+=t[i];const i=e/t.length;for(let e=0;e<t.length;e++)t[e]-=i;return s(t),t.push(0),new Float64Array(t)}function s(t){let e=0;for(let i=0;i<t.length;i++){const s=t[i];t[i]=e,e+=s}}function n(t){return.5*Math.pow(.5,(e.pulseWidthRange-1-t)*e.pulseWidthStepPower)}function o(t,i,s){let n=e.chipNoises[t].samples;if(null==n){if(n=new Float32Array(e.chipNoiseLength+1),e.chipNoises[t].samples=n,0==t){let t=1;for(let i=0;i<e.chipNoiseLength;i++){n[i]=2*(1&t)-1;let e=t>>1;1==(t+e&1)&&(e+=16384),t=e}}else if(1==t)for(let t=0;t<e.chipNoiseLength;t++)n[t]=2*Math.random()-1;else if(2==t){let t=1;for(let i=0;i<e.chipNoiseLength;i++){n[i]=2*(1&t)-1;let e=t>>1;1==(t+e&1)&&(e+=32768),t=e}}else if(3==t){let t=1;for(let i=0;i<e.chipNoiseLength;i++){n[i]=2*(1&t)-1;let e=t>>1;1==(t+e&1)&&(e+=40),t=e}}else{if(4!=t)throw new Error("Unrecognized drum index: "+t);r(n,e.chipNoiseLength,10,11,1,1,0),r(n,e.chipNoiseLength,11,14,.6578,.6578,0),i(n,e.chipNoiseLength),s(n,1/Math.sqrt(e.chipNoiseLength))}n[e.chipNoiseLength]=n[0]}return n}function r(t,e,i,s,n,r,h){const a=0|Math.pow(2,i),l=Math.min(e>>1,0|Math.pow(2,s)),c=o(0,null,null);let u=0;for(let o=a;o<l;o++){let a=n+(r-n)*(Math.log2(o)-i)/(s-i),l=Math.pow(2,7*(a-1)+1)*a;l*=Math.pow(o/2048,h),u+=l,l*=c[o];const f=.61803398875*o*o*Math.PI*2;t[o]=Math.cos(f)*l,t[e-o]=Math.sin(f)*l}return u}function h(t,i,s){const n=e.rhythms[i].arpeggioPatterns[t-1];return null!=n?n[s%n.length]:s%t}function a(t){const e={};for(let i=0;i<t.length;i++){const s=t[i];s.index=i,e[s.name]=s}const i=t;return i.dictionary=e,i}function l(t){return 0!=(1024&t)}function c(t){return 0!=(2048&t)}function u(t){return 0!=(128&t)}function f(t){return 0!=(256&t)}function p(t){return 0!=(512&t)}function d(t){return 0!=(32&t)}function m(t){return 0!=(8&t)}function y(t){return 0!=(16&t)}function g(t){return 0!=(4&t)}function b(t){return 0!=(2&t)}function v(t){return 0!=(64&t)}function w(t){return 0!=(1&t)}e.scales=a([{name:"easy :)",realName:"pentatonic major",flags:[!0,!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!1]},{name:"easy :(",realName:"pentatonic minor",flags:[!0,!1,!1,!0,!1,!0,!1,!0,!1,!1,!0,!1]},{name:"island :)",realName:"ryukyu",flags:[!0,!1,!1,!1,!0,!0,!1,!0,!1,!1,!1,!0]},{name:"island :(",realName:"pelog selisir",flags:[!0,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!1]},{name:"blues :)",realName:"blues major",flags:[!0,!1,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1]},{name:"blues :(",realName:"blues",flags:[!0,!1,!1,!0,!1,!0,!0,!0,!1,!1,!0,!1]},{name:"normal :)",realName:"ionian",flags:[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0]},{name:"normal :(",realName:"aeolian",flags:[!0,!1,!0,!0,!1,!0,!1,!0,!0,!1,!0,!1]},{name:"dbl harmonic :)",realName:"double harmonic major",flags:[!0,!0,!1,!1,!0,!0,!1,!0,!0,!1,!1,!0]},{name:"dbl harmonic :(",realName:"double harmonic minor",flags:[!0,!1,!0,!0,!1,!1,!0,!0,!0,!1,!1,!0]},{name:"strange",realName:"whole tone",flags:[!0,!1,!0,!1,!0,!1,!0,!1,!0,!1,!0,!1]},{name:"expert",realName:"chromatic",flags:[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]}]),e.keys=a([{name:"C",isWhiteKey:!0,basePitch:12},{name:"C♯",isWhiteKey:!1,basePitch:13},{name:"D",isWhiteKey:!0,basePitch:14},{name:"D♯",isWhiteKey:!1,basePitch:15},{name:"E",isWhiteKey:!0,basePitch:16},{name:"F",isWhiteKey:!0,basePitch:17},{name:"F♯",isWhiteKey:!1,basePitch:18},{name:"G",isWhiteKey:!0,basePitch:19},{name:"G♯",isWhiteKey:!1,basePitch:20},{name:"A",isWhiteKey:!0,basePitch:21},{name:"A♯",isWhiteKey:!1,basePitch:22},{name:"B",isWhiteKey:!0,basePitch:23}]),e.blackKeyNameParents=[-1,1,-1,1,-1,1,-1,-1,1,-1,1,-1],e.tempoMin=30,e.tempoMax=300,e.echoDelayRange=24,e.echoDelayStepTicks=4,e.echoSustainRange=8,e.echoShelfHz=4e3,e.echoShelfGain=Math.pow(2,-.5),e.reverbShelfHz=8e3,e.reverbShelfGain=Math.pow(2,-1.5),e.reverbRange=4,e.reverbDelayBufferSize=16384,e.reverbDelayBufferMask=e.reverbDelayBufferSize-1,e.beatsPerBarMin=3,e.beatsPerBarMax=16,e.barCountMin=1,e.barCountMax=128,e.instrumentCountMin=1,e.layeredInstrumentCountMax=4,e.patternInstrumentCountMax=10,e.partsPerBeat=24,e.ticksPerPart=2,e.rhythms=a([{name:"÷3 (triplets)",stepsPerBeat:3,ticksPerArpeggio:4,arpeggioPatterns:[[0],[0,0,1,1],[0,1,2,1]],roundUpThresholds:[5,12,18]},{name:"÷4 (standard)",stepsPerBeat:4,ticksPerArpeggio:3,arpeggioPatterns:[[0],[0,0,1,1],[0,1,2,1]],roundUpThresholds:[3,9,17,21]},{name:"÷6",stepsPerBeat:6,ticksPerArpeggio:4,arpeggioPatterns:[[0],[0,1],[0,1,2,1]],roundUpThresholds:null},{name:"÷8",stepsPerBeat:8,ticksPerArpeggio:3,arpeggioPatterns:[[0],[0,1],[0,1,2,1]],roundUpThresholds:null},{name:"freehand",stepsPerBeat:24,ticksPerArpeggio:3,arpeggioPatterns:[[0],[0,1],[0,1,2,1]],roundUpThresholds:null}]),e.instrumentTypeNames=["chip","FM","noise","spectrum","drumset","harmonics","PWM","Picked String"],e.instrumentTypeHasSpecialInterval=[!0,!0,!1,!1,!1,!0,!1,!1],e.chipBaseExpression=.03375,e.fmBaseExpression=.03,e.noiseBaseExpression=.19,e.spectrumBaseExpression=.3,e.drumsetBaseExpression=.45,e.harmonicsBaseExpression=.025,e.pwmBaseExpression=.04725,e.pickedStringBaseExpression=.025,e.distortionBaseVolume=.011,e.bitcrusherBaseVolume=.01,e.chipWaves=a([{name:"rounded",expression:.94,samples:i([0,.2,.4,.5,.6,.7,.8,.85,.9,.95,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,.95,.9,.85,.8,.7,.6,.5,.4,.2,0,-.2,-.4,-.5,-.6,-.7,-.8,-.85,-.9,-.95,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-.95,-.9,-.85,-.8,-.7,-.6,-.5,-.4,-.2])},{name:"triangle",expression:1,samples:i([1/15,.2,5/15,7/15,.6,11/15,13/15,1,1,13/15,11/15,.6,7/15,5/15,.2,1/15,-1/15,-.2,-5/15,-7/15,-.6,-11/15,-13/15,-1,-1,-13/15,-11/15,-.6,-7/15,-5/15,-.2,-1/15])},{name:"square",expression:.5,samples:i([1,-1])},{name:"1/4 pulse",expression:.5,samples:i([1,-1,-1,-1])},{name:"1/8 pulse",expression:.5,samples:i([1,-1,-1,-1,-1,-1,-1,-1])},{name:"sawtooth",expression:.65,samples:i([1/31,3/31,5/31,7/31,9/31,11/31,13/31,15/31,17/31,19/31,21/31,23/31,25/31,27/31,29/31,1,-1,-29/31,-27/31,-25/31,-23/31,-21/31,-19/31,-17/31,-15/31,-13/31,-11/31,-9/31,-7/31,-5/31,-3/31,-1/31])},{name:"double saw",expression:.5,samples:i([0,-.2,-.4,-.6,-.8,-1,1,-.8,-.6,-.4,-.2,1,.8,.6,.4,.2])},{name:"double pulse",expression:.4,samples:i([1,1,1,1,1,-1,-1,-1,1,1,1,1,-1,-1,-1,-1])},{name:"spiky",expression:.4,samples:i([1,-1,1,-1,1,0])}]),e.chipNoises=a([{name:"retro",expression:.25,basePitch:69,pitchFilterMult:1024,isSoft:!1,samples:null},{name:"white",expression:1,basePitch:69,pitchFilterMult:8,isSoft:!0,samples:null},{name:"clang",expression:.4,basePitch:69,pitchFilterMult:1024,isSoft:!1,samples:null},{name:"buzz",expression:.3,basePitch:69,pitchFilterMult:1024,isSoft:!1,samples:null},{name:"hollow",expression:1.5,basePitch:96,pitchFilterMult:1,isSoft:!0,samples:null}]),e.filterFreqStep=1/4,e.filterFreqRange=34,e.filterFreqReferenceSetting=28,e.filterFreqReferenceHz=8e3,e.filterFreqMaxHz=e.filterFreqReferenceHz*Math.pow(2,e.filterFreqStep*(e.filterFreqRange-1-e.filterFreqReferenceSetting)),e.filterFreqMinHz=8,e.filterGainRange=15,e.filterGainCenter=7,e.filterGainStep=.5,e.filterMaxPoints=8,e.filterTypeNames=["low-pass","high-pass","peak"],e.fadeInRange=10,e.fadeOutTicks=[-24,-12,-6,-3,-1,6,12,24,48,72,96],e.fadeOutNeutral=4,e.drumsetFadeOutTicks=48,e.transitions=a([{name:"normal",isSeamless:!1,continues:!1,slides:!1,slideTicks:3,includeAdjacentPatterns:!1},{name:"interrupt",isSeamless:!0,continues:!1,slides:!1,slideTicks:3,includeAdjacentPatterns:!0},{name:"continue",isSeamless:!0,continues:!0,slides:!1,slideTicks:3,includeAdjacentPatterns:!0},{name:"slide",isSeamless:!0,continues:!1,slides:!0,slideTicks:3,includeAdjacentPatterns:!0},{name:"slide in pattern",isSeamless:!0,continues:!1,slides:!0,slideTicks:3,includeAdjacentPatterns:!1}]),e.vibratos=a([{name:"none",amplitude:0,periodsSeconds:[.14],delayTicks:0},{name:"light",amplitude:.15,periodsSeconds:[.14],delayTicks:0},{name:"delayed",amplitude:.3,periodsSeconds:[.14],delayTicks:37},{name:"heavy",amplitude:.45,periodsSeconds:[.14],delayTicks:0},{name:"shaky",amplitude:.1,periodsSeconds:[.11,.17798,.33],delayTicks:0}]),e.unisons=a([{name:"none",voices:1,spread:0,offset:0,expression:1.4,sign:1},{name:"shimmer",voices:2,spread:.018,offset:0,expression:.8,sign:1},{name:"hum",voices:2,spread:.045,offset:0,expression:1,sign:1},{name:"honky tonk",voices:2,spread:.09,offset:0,expression:1,sign:1},{name:"dissonant",voices:2,spread:.25,offset:0,expression:.9,sign:1},{name:"fifth",voices:2,spread:3.5,offset:3.5,expression:.9,sign:1},{name:"octave",voices:2,spread:6,offset:6,expression:.8,sign:1},{name:"bowed",voices:2,spread:.02,offset:0,expression:1,sign:-1},{name:"piano",voices:2,spread:.01,offset:0,expression:1,sign:.7}]),e.effectNames=["reverb","chorus","panning","distortion","bitcrusher","note filter","echo","pitch shift","detune","vibrato","transition type","chord type"],e.effectOrder=[10,11,7,8,9,5,3,4,2,1,6,0],e.noteSizeMax=3,e.volumeRange=8,e.volumeLogScale=-.5,e.panCenter=4,e.panMax=2*e.panCenter,e.panDelaySecondsMax=5e-4,e.chorusRange=4,e.chorusPeriodSeconds=2,e.chorusDelayRange=.0034,e.chorusDelayOffsets=[[1.51,2.1,3.35],[1.47,2.15,3.25]],e.chorusPhaseOffsets=[[0,2.1,4.2],[3.2,5.3,1]],e.chorusMaxDelay=e.chorusDelayRange*(1+e.chorusDelayOffsets[0].concat(e.chorusDelayOffsets[1]).reduce(((t,e)=>Math.max(t,e)))),e.chords=a([{name:"simultaneous",customInterval:!1,arpeggiates:!1,strumParts:0,singleTone:!1},{name:"strum",customInterval:!1,arpeggiates:!1,strumParts:1,singleTone:!1},{name:"arpeggio",customInterval:!1,arpeggiates:!0,strumParts:0,singleTone:!0},{name:"custom interval",customInterval:!0,arpeggiates:!1,strumParts:0,singleTone:!0}]),e.maxChordSize=4,e.operatorCount=4,e.algorithms=a([{name:"1←(2 3 4)",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2,3,4],[],[],[]]},{name:"1←(2 3←4)",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2,3],[],[4],[]]},{name:"1←2←(3 4)",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2],[3,4],[],[]]},{name:"1←(2 3)←4",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2,3],[4],[4],[]]},{name:"1←2←3←4",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2],[3],[4],[]]},{name:"1←3 2←4",carrierCount:2,associatedCarrier:[1,2,1,2],modulatedBy:[[3],[4],[],[]]},{name:"1 2←(3 4)",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[],[3,4],[],[]]},{name:"1 2←3←4",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[],[3],[4],[]]},{name:"(1 2)←3←4",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[3],[3],[4],[]]},{name:"(1 2)←(3 4)",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[3,4],[3,4],[],[]]},{name:"1 2 3←4",carrierCount:3,associatedCarrier:[1,2,3,3],modulatedBy:[[],[],[4],[]]},{name:"(1 2 3)←4",carrierCount:3,associatedCarrier:[1,2,3,3],modulatedBy:[[4],[4],[4],[]]},{name:"1 2 3 4",carrierCount:4,associatedCarrier:[1,2,3,4],modulatedBy:[[],[],[],[]]}]),e.operatorCarrierInterval=[0,.04,-.073,.091],e.operatorAmplitudeMax=15,e.operatorFrequencies=a([{name:"1×",mult:1,hzOffset:0,amplitudeSign:1},{name:"~1×",mult:1,hzOffset:1.5,amplitudeSign:-1},{name:"2×",mult:2,hzOffset:0,amplitudeSign:1},{name:"~2×",mult:2,hzOffset:-1.3,amplitudeSign:-1},{name:"3×",mult:3,hzOffset:0,amplitudeSign:1},{name:"4×",mult:4,hzOffset:0,amplitudeSign:1},{name:"5×",mult:5,hzOffset:0,amplitudeSign:1},{name:"6×",mult:6,hzOffset:0,amplitudeSign:1},{name:"7×",mult:7,hzOffset:0,amplitudeSign:1},{name:"8×",mult:8,hzOffset:0,amplitudeSign:1},{name:"9×",mult:9,hzOffset:0,amplitudeSign:1},{name:"11×",mult:11,hzOffset:0,amplitudeSign:1},{name:"13×",mult:13,hzOffset:0,amplitudeSign:1},{name:"16×",mult:16,hzOffset:0,amplitudeSign:1},{name:"20×",mult:20,hzOffset:0,amplitudeSign:1}]),e.envelopes=a([{name:"none",type:1,speed:0},{name:"note size",type:0,speed:0},{name:"punch",type:2,speed:0},{name:"flare 1",type:3,speed:32},{name:"flare 2",type:3,speed:8},{name:"flare 3",type:3,speed:2},{name:"twang 1",type:4,speed:32},{name:"twang 2",type:4,speed:8},{name:"twang 3",type:4,speed:2},{name:"swell 1",type:5,speed:32},{name:"swell 2",type:5,speed:8},{name:"swell 3",type:5,speed:2},{name:"tremolo1",type:6,speed:4},{name:"tremolo2",type:6,speed:2},{name:"tremolo3",type:6,speed:1},{name:"tremolo4",type:7,speed:4},{name:"tremolo5",type:7,speed:2},{name:"tremolo6",type:7,speed:1},{name:"decay 1",type:8,speed:10},{name:"decay 2",type:8,speed:7},{name:"decay 3",type:8,speed:4}]),e.feedbacks=a([{name:"1⟲",indices:[[1],[],[],[]]},{name:"2⟲",indices:[[],[2],[],[]]},{name:"3⟲",indices:[[],[],[3],[]]},{name:"4⟲",indices:[[],[],[],[4]]},{name:"1⟲ 2⟲",indices:[[1],[2],[],[]]},{name:"3⟲ 4⟲",indices:[[],[],[3],[4]]},{name:"1⟲ 2⟲ 3⟲",indices:[[1],[2],[3],[]]},{name:"2⟲ 3⟲ 4⟲",indices:[[],[2],[3],[4]]},{name:"1⟲ 2⟲ 3⟲ 4⟲",indices:[[1],[2],[3],[4]]},{name:"1→2",indices:[[],[1],[],[]]},{name:"1→3",indices:[[],[],[1],[]]},{name:"1→4",indices:[[],[],[],[1]]},{name:"2→3",indices:[[],[],[2],[]]},{name:"2→4",indices:[[],[],[],[2]]},{name:"3→4",indices:[[],[],[],[3]]},{name:"1→3 2→4",indices:[[],[],[1],[2]]},{name:"1→4 2→3",indices:[[],[],[2],[1]]},{name:"1→2→3→4",indices:[[],[1],[2],[3]]}]),e.chipNoiseLength=32768,e.spectrumNoiseLength=32768,e.spectrumBasePitch=24,e.spectrumControlPoints=30,e.spectrumControlPointsPerOctave=7,e.spectrumControlPointBits=3,e.spectrumMax=(1<<e.spectrumControlPointBits)-1,e.harmonicsControlPoints=28,e.harmonicsRendered=64,e.harmonicsRenderedForPickedString=256,e.harmonicsControlPointBits=3,e.harmonicsMax=(1<<e.harmonicsControlPointBits)-1,e.harmonicsWavelength=2048,e.pulseWidthRange=8,e.pulseWidthStepPower=.5,e.pitchChannelCountMin=1,e.pitchChannelCountMax=10,e.noiseChannelCountMin=0,e.noiseChannelCountMax=5,e.noiseInterval=6,e.pitchesPerOctave=12,e.drumCount=12,e.pitchOctaves=7,e.maxPitch=e.pitchOctaves*e.pitchesPerOctave,e.maximumTonesPerChannel=2*e.maxChordSize,e.justIntonationSemitones=[.5,8/15,9/16,.6,5/8,2/3,32/45,3/4,.8,5/6,8/9,15/16,1,16/15,9/8,1.2,5/4,4/3,45/32,1.5,1.6,5/3,16/9,15/8,2].map((t=>Math.log2(t)*e.pitchesPerOctave)),e.pitchShiftRange=e.justIntonationSemitones.length,e.pitchShiftCenter=e.pitchShiftRange>>1,e.detuneCenter=9,e.detuneMax=2*e.detuneCenter,e.sineWaveLength=256,e.sineWaveMask=e.sineWaveLength-1,e.sineWave=function(){const t=new Float64Array(e.sineWaveLength+1);for(let i=0;i<e.sineWaveLength+1;i++)t[i]=Math.sin(i*Math.PI*2/e.sineWaveLength);return t}(),e.pickedStringDispersionCenterFreq=6e3,e.pickedStringDispersionFreqScale=.3,e.pickedStringDispersionFreqMult=4,e.pickedStringShelfHz=4e3,e.distortionRange=8,e.stringSustainRange=15,e.stringDecayRate=.12,e.bitcrusherFreqRange=14,e.bitcrusherOctaveStep=.5,e.bitcrusherQuantizationRange=8,e.maxEnvelopeCount=12,e.defaultAutomationRange=13,e.instrumentAutomationTargets=a([{name:"none",computeIndex:null,displayName:"none",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:null},{name:"noteVolume",computeIndex:0,displayName:"note volume",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:null},{name:"pulseWidth",computeIndex:2,displayName:"pulse width",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:[6]},{name:"stringSustain",computeIndex:3,displayName:"sustain",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:[7]},{name:"unison",computeIndex:4,displayName:"unison",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:[0,5,7]},{name:"operatorFrequency",computeIndex:5,displayName:"fm# freq",interleave:!0,isFilter:!1,maxCount:e.operatorCount,effect:null,compatibleInstruments:[1]},{name:"operatorAmplitude",computeIndex:9,displayName:"fm# volume",interleave:!1,isFilter:!1,maxCount:e.operatorCount,effect:null,compatibleInstruments:[1]},{name:"feedbackAmplitude",computeIndex:13,displayName:"fm feedback",interleave:!1,isFilter:!1,maxCount:1,effect:null,compatibleInstruments:[1]},{name:"pitchShift",computeIndex:14,displayName:"pitch shift",interleave:!1,isFilter:!1,maxCount:1,effect:7,compatibleInstruments:null},{name:"detune",computeIndex:15,displayName:"detune",interleave:!1,isFilter:!1,maxCount:1,effect:8,compatibleInstruments:null},{name:"vibratoDepth",computeIndex:16,displayName:"vibrato range",interleave:!1,isFilter:!1,maxCount:1,effect:9,compatibleInstruments:null},{name:"noteFilterAllFreqs",computeIndex:1,displayName:"n. filter freqs",interleave:!1,isFilter:!0,maxCount:1,effect:5,compatibleInstruments:null},{name:"noteFilterFreq",computeIndex:17,displayName:"n. filter # freq",interleave:!1,isFilter:!0,maxCount:e.filterMaxPoints,effect:5,compatibleInstruments:null}]);const k=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|android|ipad|playbook|silk/i.test(navigator.userAgent);function M(t){return t.toFixed(2).replace(/\.?0*$/,"")}class x{static valueToPreset(t){const e=t>>6,i=63&t;return x.presetCategories[e].presets[i]}static midiProgramToPresetValue(t){for(let e=0;e<x.presetCategories.length;e++){const i=x.presetCategories[e];for(let s=0;s<i.presets.length;s++){const n=i.presets[s];if(n.generalMidi&&n.midiProgram==t)return(e<<6)+s}}return null}static nameToPresetValue(t){for(let e=0;e<x.presetCategories.length;e++){const i=x.presetCategories[e];for(let s=0;s<i.presets.length;s++){if(i.presets[s].name==t)return(e<<6)+s}}return null}}x.version="4.0.1",x.versionDisplayName="BeepBox",x.releaseNotesURL="https://github.com/johnnesky/beepbox/releases/tag/v"+x.version,x.isOnMac=/^Mac/i.test(navigator.platform)||/Mac OS X/i.test(navigator.userAgent)||/^(iPhone|iPad|iPod)/i.test(navigator.platform)||/(iPhone|iPad|iPod)/i.test(navigator.userAgent),x.ctrlSymbol=x.isOnMac?"⌘":"Ctrl+",x.presetCategories=a([{name:"Custom Instruments",presets:a([{name:"chip wave",customType:0},{name:"FM (expert)",customType:1},{name:"basic noise",customType:2},{name:"spectrum",customType:3},{name:"drumset",customType:4},{name:"harmonics",customType:5},{name:"pulse width",customType:6},{name:"picked string",customType:7}])},{name:"Retro Presets",presets:a([{name:"square wave",midiProgram:80,settings:{type:"chip",eqFilter:[],effects:[],transition:"interrupt",fadeInSeconds:0,fadeOutTicks:-1,chord:"arpeggio",wave:"square",unison:"none",envelopes:[]}},{name:"triangle wave",midiProgram:71,settings:{type:"chip",eqFilter:[],effects:[],transition:"interrupt",fadeInSeconds:0,fadeOutTicks:-1,chord:"arpeggio",wave:"triangle",unison:"none",envelopes:[]}},{name:"square lead",midiProgram:80,generalMidi:!0,settings:{type:"chip",eqFilter:[{type:"low-pass",cutoffHz:8e3,linearGain:.3536}],effects:[],transition:"normal",fadeInSeconds:0,fadeOutTicks:-3,chord:"simultaneous",wave:"square",unison:"hum",envelopes:[]}},{name:"sawtooth lead 1",midiProgram:81,generalMidi:!0,settings:{type:"chip",eqFilter:[{type:"low-pass",cutoffHz:4e3,linearGain:.5}],effects:[],transition:"normal",fadeInSeconds:0,fadeOutTicks:-3,chord:"simultaneous",wave:"sawtooth",unison:"shimmer",envelopes:[]}},{name:"sawtooth lead 2",midiProgram:81,settings:{type:"chip",eqFilter:[{type:"low-pass",cutoffHz:6727.17,linearGain:1}],effects:["vibrato"],vibrato:"light",transition:"normal",fadeInSeconds:.0125,fadeOutTicks:72,chord:"simultaneous",wave:"sawtooth",unison:"hum",envelopes:[]}},{name:"chip noise",midiProgram:116,isNoise:!0,settings:{type:"noise",transition:"hard",effects:"none",chord:"arpeggio",filterCutoffHz:4e3,filterResonance:0,filterEnvelope:"steady",wave:"retro"}},{name:"FM twang",midiProgram:32,settings:{type:"FM",eqFilter:[],effects:[],transition:"normal",fadeInSeconds:0,fadeOutTicks:-3,chord:"simultaneous",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,operators:[{frequency:"1×",amplitude:15},{frequency:"1×",amplitude:15},{frequency:"1×",amplitude:0},{frequency:"1×",amplitude:0}],envelopes:[{target:"operatorAmplitude",envelope:"twang 2",index:1}]}},{name:"FM bass",midiProgram:36,settings:{type:"FM",eqFilter:[],effects:[],transition:"normal",fadeInSeconds:0,fadeOutTicks:-3,chord:"custom interval",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:0,operators:[{frequency:"2×",amplitude:11},{frequency:"1×",amplitude:7},{frequency:"1×",amplitude:9},{frequency:"20×",amplitude:3}],envelopes:[{target:"operatorAmplitude",envelope:"twang 2",index:1},{target:"operatorAmplitude",envelope:"twang 3",index:2},{target:"operatorAmplitude",envelope:"twang 2",index:3}]}},{name:"FM flute",midiProgram:73,settings:{type:"FM",eqFilter:[],effects:[],transition:"normal",fadeInSeconds:.0263,fadeOutTicks:-3,chord:"simultaneous",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,operators:[{frequency:"1×",amplitude:15},{frequency:"1×",amplitude:6},{frequency:"1×",amplitude:0},{frequency:"1×",amplitude:0}],envelopes:[{target:"operatorAmplitude",envelope:"twang 2",index:1}]}},{name:"FM organ",midiProgram:16,settings:{type:"FM",eqFilter:[],effects:["vibrato"],vibrato:"delayed",transition:"normal",fadeInSeconds:.0263,fadeOutTicks:-3,chord:"custom interval",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,operators:[{frequency:"1×",amplitude:14},{frequency:"2×",amplitude:14},{frequency:"1×",amplitude:11},{frequency:"2×",amplitude:11}],envelopes:[]}}])},{name:"Keyboard Presets",presets:a([{name:"grand piano",midiProgram:0,generalMidi:!0,settings:{type:"Picked String",eqFilter:[{type:"high-pass",cutoffHz:148.65,linearGain:.7071},{type:"peak",cutoffHz:2e3,linearGain:2.8284}],effects:["note filter","reverb"],noteFilter:[{type:"low-pass",cutoffHz:8e3,linearGain:.125}],reverb:67,transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"simultaneous",harmonics:[100,100,86,86,86,71,71,71,0,86,71,71,71,57,57,71,57,14,57,57,57,57,57,57,57,57,29,57],unison:"piano",stringSustain:79,envelopes:[{target:"noteFilterAllFreqs",envelope:"note size"}]}},{name:"bright piano",midiProgram:1,generalMidi:!0,settings:{type:"Picked String",eqFilter:[{type:"low-pass",cutoffHz:1681.79,linearGain:.7071},{type:"high-pass",cutoffHz:148.65,linearGain:.5},{type:"peak",cutoffHz:3363.59,linearGain:1.4142}],effects:["reverb"],reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:24,chord:"simultaneous",harmonics:[100,100,86,86,71,71,0,71,71,71,71,71,71,14,57,57,57,57,57,57,29,57,57,57,57,57,57,57],unison:"piano",stringSustain:86,envelopes:[]}},{name:"electric grand",midiProgram:2,generalMidi:!0,settings:{type:"chip",eqFilter:[],effects:["note filter"],noteFilter:[{type:"low-pass",cutoffHz:2378.41,linearGain:.5}],transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"simultaneous",wave:"1/8 pulse",unison:"shimmer",envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 3"}]}},{name:"honky-tonk piano",midiProgram:3,generalMidi:!0,settings:{type:"Picked String",eqFilter:[{type:"low-pass",cutoffHz:5656.85,linearGain:.3536}],effects:["reverb"],reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"simultaneous",harmonics:[100,100,86,71,86,71,43,71,43,43,57,57,57,29,57,57,57,57,57,57,43,57,57,57,43,43,43,43],unison:"honky tonk",stringSustain:71,envelopes:[]}},{name:"electric piano 1",midiProgram:4,generalMidi:!0,settings:{type:"harmonics",eqFilter:[],effects:["note filter"],noteFilter:[{type:"low-pass",cutoffHz:3363.59,linearGain:.5}],transition:"normal",fadeInSeconds:0,fadeOutTicks:-3,chord:"simultaneous",harmonics:[86,100,100,71,71,57,57,43,43,43,29,29,29,14,14,14,0,0,0,0,0,57,0,0,0,0,0,0],unison:"none",envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 2"}]}},{name:"electric piano 2",midiProgram:5,generalMidi:!0,settings:{type:"FM",eqFilter:[],effects:["note filter"],noteFilter:[{type:"low-pass",cutoffHz:13454.34,linearGain:.25}],transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"simultaneous",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,operators:[{frequency:"1×",amplitude:12},{frequency:"1×",amplitude:6},{frequency:"1×",amplitude:9},{frequency:"16×",amplitude:6}],envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 3"},{target:"operatorAmplitude",envelope:"twang 3",index:3}]}},{name:"harpsichord",midiProgram:6,generalMidi:!0,settings:{type:"Picked String",eqFilter:[{type:"high-pass",cutoffHz:250,linearGain:.3536},{type:"peak",cutoffHz:11313.71,linearGain:2.8284}],effects:["reverb"],reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:24,chord:"simultaneous",harmonics:[100,100,100,86,57,86,86,86,86,57,57,71,71,86,86,71,71,86,86,71,71,71,71,71,71,71,71,71],unison:"none",stringSustain:79,envelopes:[]}},{name:"clavinet",midiProgram:7,generalMidi:!0,settings:{type:"FM",eqFilter:[],effects:["note filter"],noteFilter:[{type:"low-pass",cutoffHz:19027.31,linearGain:.3536}],transition:"normal",fadeInSeconds:0,fadeOutTicks:-3,chord:"simultaneous",algorithm:"1←(2 3 4)",feedbackType:"3⟲",feedbackAmplitude:6,operators:[{frequency:"3×",amplitude:15},{frequency:"~1×",amplitude:6},{frequency:"8×",amplitude:4},{frequency:"1×",amplitude:0}],envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 2"},{target:"feedbackAmplitude",envelope:"twang 2"}]}},{name:"dulcimer",midiProgram:15,generalMidi:!0,settings:{type:"Picked String",eqFilter:[{type:"low-pass",cutoffHz:8e3,linearGain:.3536}],effects:["reverb"],reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"strum",harmonics:[100,100,100,86,100,86,57,100,100,86,100,86,100,86,100,71,57,71,71,100,86,71,86,86,100,86,86,86],unison:"piano",stringSustain:79,envelopes:[]}}])},{name:"Idiophone Presets",presets:a([{name:"celesta",midiProgram:8,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"(1 2)←(3 4)",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"~1×",amplitude:11,envelope:"custom"},{frequency:"8×",amplitude:6,envelope:"custom"},{frequency:"20×",amplitude:3,envelope:"twang 1"},{frequency:"3×",amplitude:1,envelope:"twang 2"}]}},{name:"glockenspiel",midiProgram:9,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:2,feedbackEnvelope:"decay 1",operators:[{frequency:"1×",amplitude:7,envelope:"custom"},{frequency:"5×",amplitude:11,envelope:"custom"},{frequency:"8×",amplitude:7,envelope:"custom"},{frequency:"20×",amplitude:2,envelope:"twang 1"}]}},{name:"music box 1",midiProgram:10,generalMidi:!0,settings:{type:"Picked String",eqFilter:[{type:"low-pass",cutoffHz:4756.83,linearGain:.5}],effects:["reverb"],reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"strum",harmonics:[100,0,0,100,0,0,0,0,0,0,100,0,0,0,0,0,0,0,0,86,0,0,0,0,0,0,71,0],unison:"none",stringSustain:64,envelopes:[]}},{name:"music box 2",midiProgram:10,settings:{type:"Picked String",eqFilter:[{type:"low-pass",cutoffHz:2828.43,linearGain:.7071}],effects:["reverb"],reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"strum",harmonics:[100,57,57,0,0,0,0,0,0,57,0,0,0,0,0,0,0,0,0,43,0,0,0,0,0,0,0,0],unison:"none",stringSustain:29,envelopes:[]}},{name:"vibraphone",midiProgram:11,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1→2→3→4",feedbackAmplitude:3,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:9,envelope:"custom"},{frequency:"~1×",amplitude:9,envelope:"custom"},{frequency:"9×",amplitude:3,envelope:"custom"},{frequency:"4×",amplitude:9,envelope:"custom"}]}},{name:"marimba",midiProgram:12,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"decay 1",vibrato:"none",algorithm:"1 2←(3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"4×",amplitude:6,envelope:"custom"},{frequency:"13×",amplitude:6,envelope:"twang 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"kalimba",midiProgram:108,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"decay 1",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:11,envelope:"custom"},{frequency:"5×",amplitude:3,envelope:"twang 2"},{frequency:"20×",amplitude:3,envelope:"twang 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"xylophone",midiProgram:13,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:9,envelope:"custom"},{frequency:"6×",amplitude:9,envelope:"custom"},{frequency:"11×",amplitude:9,envelope:"custom"},{frequency:"20×",amplitude:6,envelope:"twang 1"}]}},{name:"tubular bell",midiProgram:14,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"Picked String",eqFilter:[{type:"low-pass",cutoffHz:4e3,linearGain:.5},{type:"high-pass",cutoffHz:105.11,linearGain:.3536}],effects:["reverb"],reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:96,chord:"strum",harmonics:[43,71,0,100,0,100,0,86,0,0,86,0,14,71,14,14,57,14,14,43,14,14,43,14,14,43,14,14],unison:"shimmer",stringSustain:86,envelopes:[]}},{name:"bell synth",midiProgram:14,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"~2×",amplitude:10,envelope:"custom"},{frequency:"7×",amplitude:6,envelope:"twang 3"},{frequency:"20×",amplitude:1,envelope:"twang 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"rain drop",midiProgram:96,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"(1 2)←(3 4)",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"6×",amplitude:4,envelope:"custom"},{frequency:"20×",amplitude:3,envelope:"twang 1"},{frequency:"1×",amplitude:6,envelope:"tremolo1"}]}},{name:"crystal",midiProgram:98,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",vibrato:"delayed",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:4,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"3×",amplitude:7,envelope:"custom"},{frequency:"6×",amplitude:4,envelope:"custom"},{frequency:"13×",amplitude:4,envelope:"custom"}]}},{name:"tinkle bell",midiProgram:112,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1→2→3→4",feedbackAmplitude:5,feedbackEnvelope:"twang 3",operators:[{frequency:"~2×",amplitude:7,envelope:"custom"},{frequency:"5×",amplitude:7,envelope:"custom"},{frequency:"7×",amplitude:7,envelope:"custom"},{frequency:"16×",amplitude:7,envelope:"custom"}]}},{name:"agogo",midiProgram:113,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"decay 1",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1→4",feedbackAmplitude:15,feedbackEnvelope:"decay 1",operators:[{frequency:"2×",amplitude:9,envelope:"custom"},{frequency:"5×",amplitude:6,envelope:"custom"},{frequency:"8×",amplitude:9,envelope:"custom"},{frequency:"13×",amplitude:11,envelope:"custom"}]}}])},{name:"Guitar Presets",presets:a([{name:"nylon guitar",midiProgram:24,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"3⟲",feedbackAmplitude:6,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"5×",amplitude:2,envelope:"steady"},{frequency:"7×",amplitude:4,envelope:"steady"}]}},{name:"steel guitar",midiProgram:25,generalMidi:!0,settings:{type:"Picked String",eqFilter:[],effects:["reverb"],reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"strum",harmonics:[100,100,86,71,71,71,86,86,71,57,43,43,43,57,57,57,57,57,43,43,43,43,43,43,43,43,43,43],unison:"none",stringSustain:71,envelopes:[]}},{name:"jazz guitar",midiProgram:26,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 2",interval:"union",vibrato:"none",harmonics:[100,100,86,71,57,71,71,43,57,71,57,43,29,29,29,29,29,29,29,29,14,14,14,14,14,14,14,0]}},{name:"clean guitar",midiProgram:27,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",interval:"union",vibrato:"none",harmonics:[86,100,100,100,86,57,86,100,100,100,71,57,43,71,86,71,57,57,71,71,71,71,57,57,57,57,57,43]}},{name:"muted guitar",midiProgram:28,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:7,feedbackEnvelope:"twang 2",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:4,envelope:"twang 3"},{frequency:"4×",amplitude:4,envelope:"twang 2"},{frequency:"16×",amplitude:4,envelope:"twang 1"}]}}])},{name:"Picked Bass Presets",presets:a([{name:"acoustic bass",midiProgram:32,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 1",interval:"union",vibrato:"none",harmonics:[100,86,71,71,71,71,57,57,57,57,43,43,43,43,43,29,29,29,29,29,29,14,14,14,14,14,14,14]}},{name:"fingered bass",midiProgram:33,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 1",interval:"union",vibrato:"none",harmonics:[100,86,71,57,71,43,57,29,29,29,29,29,29,14,14,14,14,14,14,14,14,14,14,14,14,14,14,0]}},{name:"picked bass",midiProgram:34,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"3⟲",feedbackAmplitude:4,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:5,envelope:"steady"},{frequency:"11×",amplitude:1,envelope:"twang 3"},{frequency:"1×",amplitude:9,envelope:"steady"}]}},{name:"fretless bass",midiProgram:35,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:1e3,filterResonance:14,filterEnvelope:"flare 2",interval:"union",vibrato:"none",harmonics:[100,100,86,71,71,57,57,71,71,71,57,57,57,57,57,57,57,43,43,43,43,43,43,43,43,29,29,14]}},{name:"slap bass 1",midiProgram:36,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:4e3,filterResonance:0,filterEnvelope:"twang 1",interval:"union",vibrato:"none",harmonics:[100,100,100,100,86,71,57,29,29,43,43,57,71,57,29,29,43,57,57,57,43,43,43,57,71,71,71,71]}},{name:"slap bass 2",midiProgram:37,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:5657,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"3⟲",feedbackAmplitude:4,feedbackEnvelope:"steady",operators:[{frequency:"3×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:7,envelope:"steady"},{frequency:"13×",amplitude:3,envelope:"steady"},{frequency:"1×",amplitude:11,envelope:"steady"}]}},{name:"bass synth 1",midiProgram:38,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:4e3,filterResonance:43,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"3⟲ 4⟲",feedbackAmplitude:9,feedbackEnvelope:"twang 2",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"1×",amplitude:14,envelope:"twang 1"},{frequency:"~1×",amplitude:13,envelope:"twang 2"}]}},{name:"bass synth 2",midiProgram:39,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:1e3,filterResonance:57,filterEnvelope:"punch",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1→2",feedbackAmplitude:4,feedbackEnvelope:"twang 3",operators:[{frequency:"1×",amplitude:9,envelope:"custom"},{frequency:"1×",amplitude:9,envelope:"steady"},{frequency:"3×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"bass & lead",midiProgram:87,generalMidi:!0,settings:{type:"chip",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:4e3,filterResonance:86,filterEnvelope:"twang 2",wave:"sawtooth",interval:"shimmer",vibrato:"none"}},{name:"dubstep yoi yoi",midiProgram:87,settings:{type:"chip",eqFilter:[{type:"low-pass",cutoffHz:6727.17,linearGain:.7071}],effects:["note filter","bitcrusher"],noteFilter:[{type:"low-pass",cutoffHz:594.6,linearGain:11.3137}],bitcrusherOctave:1.5,bitcrusherQuantization:0,transition:"slide",fadeInSeconds:.0263,fadeOutTicks:-3,chord:"arpeggio",wave:"sawtooth",unison:"none",envelopes:[{target:"noteFilterFreq",envelope:"flare 2",index:0}]}}])},{name:"Picked String Presets",presets:a([{name:"pizzicato strings",midiProgram:45,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:1e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:7,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"3×",amplitude:11,envelope:"custom"},{frequency:"6×",amplitude:9,envelope:"custom"},{frequency:"~1×",amplitude:10,envelope:"steady"}]}},{name:"harp",midiProgram:46,generalMidi:!0,settings:{type:"FM",transition:"hard fade",effects:"reverb",chord:"strum",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"3⟲",feedbackAmplitude:6,feedbackEnvelope:"twang 2",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"4×",amplitude:6,envelope:"custom"},{frequency:"~2×",amplitude:3,envelope:"steady"},{frequency:"1×",amplitude:6,envelope:"steady"}]}},{name:"sitar",midiProgram:104,generalMidi:!0,settings:{type:"FM",transition:"hard fade",effects:"reverb",chord:"strum",filterCutoffHz:8e3,filterResonance:57,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:14,envelope:"twang 3"},{frequency:"9×",amplitude:3,envelope:"twang 3"},{frequency:"16×",amplitude:9,envelope:"swell 3"}]}},{name:"banjo",midiProgram:105,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"2⟲",feedbackAmplitude:4,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"steady"},{frequency:"11×",amplitude:3,envelope:"twang 3"},{frequency:"1×",amplitude:11,envelope:"steady"}]}},{name:"ukulele",midiProgram:105,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2e3,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"3⟲",feedbackAmplitude:5,feedbackEnvelope:"twang 1",operators:[{frequency:"2×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"9×",amplitude:4,envelope:"twang 2"},{frequency:"1×",amplitude:11,envelope:"steady"}]}},{name:"shamisen",midiProgram:106,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:8e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"3⟲",feedbackAmplitude:9,feedbackEnvelope:"twang 3",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:12,envelope:"steady"},{frequency:"16×",amplitude:4,envelope:"twang 3"},{frequency:"1×",amplitude:7,envelope:"steady"}]}},{name:"koto",midiProgram:107,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:5,feedbackEnvelope:"twang 2",operators:[{frequency:"~1×",amplitude:12,envelope:"custom"},{frequency:"6×",amplitude:10,envelope:"custom"},{frequency:"4×",amplitude:8,envelope:"twang 3"},{frequency:"~2×",amplitude:8,envelope:"twang 3"}]}}])},{name:"Distortion Presets",presets:a([{name:"overdrive guitar",midiProgram:29,generalMidi:!0,settings:{type:"Picked String",eqFilter:[{type:"low-pass",cutoffHz:4756.83,linearGain:.7071},{type:"high-pass",cutoffHz:210.22,linearGain:1},{type:"low-pass",cutoffHz:5656.85,linearGain:1},{type:"peak",cutoffHz:840.9,linearGain:.5}],effects:["note filter","distortion"],noteFilter:[{type:"high-pass",cutoffHz:297.3,linearGain:2},{type:"low-pass",cutoffHz:2378.41,linearGain:.7071}],distortion:71,transition:"normal",fadeInSeconds:0,fadeOutTicks:12,chord:"strum",harmonics:[86,100,100,86,86,86,86,71,71,71,71,71,71,71,71,71,71,57,57,57,57,57,57,57,57,57,57,57],unison:"none",stringSustain:71,envelopes:[{target:"noteFilterFreq",envelope:"note size",index:1}]}},{name:"distortion guitar",midiProgram:30,generalMidi:!0,settings:{type:"Picked String",eqFilter:[{type:"low-pass",cutoffHz:4756.83,linearGain:.7071},{type:"high-pass",cutoffHz:210.22,linearGain:1},{type:"low-pass",cutoffHz:5656.85,linearGain:1},{type:"peak",cutoffHz:594.6,linearGain:.3536},{type:"peak",cutoffHz:1e3,linearGain:.25}],effects:["note filter","distortion","reverb"],noteFilter:[{type:"high-pass",cutoffHz:353.55,linearGain:2},{type:"low-pass",cutoffHz:2e3,linearGain:1}],distortion:86,reverb:67,transition:"normal",fadeInSeconds:0,fadeOutTicks:12,chord:"strum",harmonics:[86,100,100,86,86,86,86,71,71,71,71,71,71,71,71,71,71,57,57,57,57,57,57,57,57,57,57,57],unison:"none",stringSustain:71,envelopes:[{target:"noteFilterFreq",envelope:"note size",index:1}]}},{name:"charango synth",midiProgram:84,generalMidi:!0,settings:{type:"FM",eqFilter:[{type:"low-pass",cutoffHz:11313.71,linearGain:1}],effects:[],transition:"normal",fadeInSeconds:0,fadeOutTicks:-3,chord:"strum",algorithm:"1←(2 3←4)",feedbackType:"1→2→3→4",feedbackAmplitude:8,operators:[{frequency:"3×",amplitude:13},{frequency:"~1×",amplitude:5},{frequency:"4×",amplitude:6},{frequency:"3×",amplitude:7}],envelopes:[{target:"feedbackAmplitude",envelope:"twang 3"}]}},{name:"guitar harmonics",midiProgram:31,generalMidi:!0,settings:{type:"FM",eqFilter:[{type:"low-pass",cutoffHz:4e3,linearGain:2}],effects:["reverb"],reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:-3,chord:"strum",algorithm:"1←(2 3)←4",feedbackType:"1⟲",feedbackAmplitude:2,operators:[{frequency:"4×",amplitude:12},{frequency:"16×",amplitude:5},{frequency:"1×",amplitude:2},{frequency:"~1×",amplitude:12}],envelopes:[{target:"operatorAmplitude",envelope:"swell 1",index:1},{target:"operatorAmplitude",envelope:"punch",index:2},{target:"operatorAmplitude",envelope:"twang 1",index:3}]}},{name:"PWM overdrive",midiProgram:29,settings:{type:"PWM",eqFilter:[{type:"low-pass",cutoffHz:5656.85,linearGain:1.4142}],effects:[],transition:"normal",fadeInSeconds:0,fadeOutTicks:-3,chord:"strum",pulseWidth:17.67767,envelopes:[{target:"pulseWidth",envelope:"punch"}]}},{name:"PWM distortion",midiProgram:30,settings:{type:"PWM",eqFilter:[{type:"low-pass",cutoffHz:3363.59,linearGain:2}],effects:["vibrato"],vibrato:"delayed",transition:"normal",fadeInSeconds:0,fadeOutTicks:-3,chord:"strum",pulseWidth:50,envelopes:[{target:"pulseWidth",envelope:"swell 1"}]}},{name:"FM overdrive",midiProgram:29,settings:{type:"FM",eqFilter:[{type:"low-pass",cutoffHz:4756.83,linearGain:1}],effects:["reverb"],reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:-3,chord:"strum",algorithm:"1←(2 3←4)",feedbackType:"1→2",feedbackAmplitude:2,operators:[{frequency:"~1×",amplitude:15},{frequency:"1×",amplitude:12},{frequency:"~2×",amplitude:6},{frequency:"1×",amplitude:12}],envelopes:[{target:"operatorAmplitude",envelope:"twang 1",index:2},{target:"operatorAmplitude",envelope:"swell 3",index:3},{target:"feedbackAmplitude",envelope:"punch"}]}},{name:"FM distortion",midiProgram:30,settings:{type:"FM",eqFilter:[{type:"low-pass",cutoffHz:4e3,linearGain:2}],effects:["reverb"],reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:-3,chord:"strum",algorithm:"1←(2 3←4)",feedbackType:"1→2",feedbackAmplitude:4,operators:[{frequency:"~1×",amplitude:15},{frequency:"1×",amplitude:11},{frequency:"1×",amplitude:9},{frequency:"~2×",amplitude:4}],envelopes:[{target:"operatorAmplitude",envelope:"swell 1",index:2},{target:"operatorAmplitude",envelope:"swell 3",index:3}]}}])},{name:"Bellows Presets",presets:a([{name:"drawbar organ 1",midiProgram:16,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[86,86,0,86,0,0,0,86,0,0,0,0,0,0,0,86,0,0,0,0,0,0,0,0,0,0,0,0]}},{name:"drawbar organ 2",midiProgram:16,midiSubharmonicOctaves:1,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[86,29,71,86,71,14,0,100,0,0,0,86,0,0,0,71,0,0,0,57,0,0,0,29,0,0,0,0]}},{name:"percussive organ",midiProgram:17,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"FM",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"punch",vibrato:"light",algorithm:"1 2 3 4",feedbackType:"1→3 2→4",feedbackAmplitude:7,feedbackEnvelope:"decay 1",operators:[{frequency:"1×",amplitude:7,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"custom"},{frequency:"3×",amplitude:8,envelope:"custom"},{frequency:"4×",amplitude:8,envelope:"custom"}]}},{name:"rock organ",midiProgram:18,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"FM",effects:"chorus & reverb",transition:"hard",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"punch",vibrato:"delayed",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:2,feedbackEnvelope:"flare 1",operators:[{frequency:"1×",amplitude:9,envelope:"custom"},{frequency:"4×",amplitude:9,envelope:"custom"},{frequency:"6×",amplitude:9,envelope:"custom"},{frequency:"2×",amplitude:5,envelope:"steady"}]}},{name:"pipe organ",midiProgram:19,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"FM",transition:"cross fade",effects:"reverb",chord:"harmony",filterCutoffHz:5657,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:5,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:8,envelope:"custom"},{frequency:"2×",amplitude:9,envelope:"custom"},{frequency:"4×",amplitude:9,envelope:"custom"},{frequency:"8×",amplitude:8,envelope:"custom"}]}},{name:"reed organ",midiProgram:20,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[71,86,100,86,71,100,57,71,71,71,43,43,43,71,43,71,57,57,57,57,57,57,57,29,43,29,29,14]}},{name:"accordion",midiProgram:21,generalMidi:!0,settings:{type:"chip",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:5657,filterResonance:0,filterEnvelope:"swell 1",wave:"double saw",interval:"honky tonk",vibrato:"none"}},{name:"bandoneon",midiProgram:23,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"swell 1",interval:"hum",vibrato:"none",harmonics:[86,86,86,57,71,86,57,71,71,71,57,43,57,43,71,43,71,57,57,43,43,43,57,43,43,29,29,29]}},{name:"bagpipe",midiProgram:109,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:5657,filterResonance:43,filterEnvelope:"punch",interval:"hum",vibrato:"none",harmonics:[71,86,86,100,100,86,57,100,86,71,71,71,57,57,57,71,57,71,57,71,43,57,57,43,43,43,43,43]}}])},{name:"String Presets",presets:a([{name:"violin",midiProgram:40,generalMidi:!0,settings:{type:"FM",eqFilter:[{type:"low-pass",cutoffHz:4e3,linearGain:1.4142},{type:"high-pass",cutoffHz:105.11,linearGain:.3536}],effects:["vibrato","reverb"],vibrato:"delayed",reverb:67,transition:"normal",fadeInSeconds:.0413,fadeOutTicks:6,chord:"simultaneous",algorithm:"(1 2)←(3 4)",feedbackType:"1→2",feedbackAmplitude:5,operators:[{frequency:"4×",amplitude:9},{frequency:"3×",amplitude:9},{frequency:"2×",amplitude:7},{frequency:"7×",amplitude:5}],envelopes:[{target:"operatorAmplitude",envelope:"swell 1",index:3},{target:"feedbackAmplitude",envelope:"twang 3"}]}},{name:"viola",midiProgram:41,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",vibrato:"delayed",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:8,feedbackEnvelope:"swell 1",operators:[{frequency:"2×",amplitude:11,envelope:"custom"},{frequency:"7×",amplitude:7,envelope:"custom"},{frequency:"13×",amplitude:4,envelope:"custom"},{frequency:"1×",amplitude:5,envelope:"steady"}]}},{name:"cello",midiProgram:42,generalMidi:!0,settings:{type:"FM",eqFilter:[{type:"low-pass",cutoffHz:4e3,linearGain:.1768},{type:"high-pass",cutoffHz:297.3,linearGain:.7071},{type:"peak",cutoffHz:4756.83,linearGain:5.6569}],effects:["note filter","reverb"],noteFilter:[{type:"low-pass",cutoffHz:16e3,linearGain:.0884}],reverb:67,transition:"normal",fadeInSeconds:.0125,fadeOutTicks:12,chord:"simultaneous",algorithm:"(1 2)←3←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:3,operators:[{frequency:"16×",amplitude:5},{frequency:"~1×",amplitude:10},{frequency:"1×",amplitude:9},{frequency:"6×",amplitude:3}],envelopes:[{target:"noteFilterAllFreqs",envelope:"swell 1"},{target:"operatorAmplitude",envelope:"swell 1",index:3}]}},{name:"contrabass",midiProgram:43,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",vibrato:"delayed",algorithm:"(1 2)←3←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"16×",amplitude:5,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"steady"},{frequency:"6×",amplitude:3,envelope:"swell 1"}]}},{name:"fiddle",midiProgram:110,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"steady",vibrato:"delayed",algorithm:"(1 2)←(3 4)",feedbackType:"3⟲ 4⟲",feedbackAmplitude:5,feedbackEnvelope:"twang 1",operators:[{frequency:"2×",amplitude:10,envelope:"custom"},{frequency:"8×",amplitude:8,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"steady"},{frequency:"16×",amplitude:3,envelope:"steady"}]}},{name:"tremolo strings",midiProgram:44,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:0,filterEnvelope:"tremolo4",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1→2→3→4",feedbackAmplitude:12,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:8,envelope:"custom"},{frequency:"~2×",amplitude:8,envelope:"custom"},{frequency:"4×",amplitude:8,envelope:"custom"},{frequency:"7×",amplitude:8,envelope:"custom"}]}},{name:"strings",midiProgram:48,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"(1 2)←(3 4)",feedbackType:"4⟲",feedbackAmplitude:5,feedbackEnvelope:"twang 3",operators:[{frequency:"4×",amplitude:9,envelope:"custom"},{frequency:"3×",amplitude:9,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"steady"},{frequency:"7×",amplitude:3,envelope:"swell 1"}]}},{name:"slow strings",midiProgram:49,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:1414,filterResonance:0,filterEnvelope:"swell 2",vibrato:"none",algorithm:"(1 2)←(3 4)",feedbackType:"4⟲",feedbackAmplitude:6,feedbackEnvelope:"flare 3",operators:[{frequency:"4×",amplitude:10,envelope:"custom"},{frequency:"3×",amplitude:10,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"steady"},{frequency:"7×",amplitude:4,envelope:"swell 1"}]}},{name:"strings synth 1",midiProgram:50,generalMidi:!0,settings:{type:"chip",transition:"soft fade",effects:"chorus & reverb",chord:"harmony",filterCutoffHz:1414,filterResonance:43,filterEnvelope:"steady",wave:"sawtooth",interval:"hum",vibrato:"delayed"}},{name:"strings synth 2",midiProgram:51,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:12,feedbackEnvelope:"swell 1",operators:[{frequency:"3×",amplitude:6,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"custom"},{frequency:"1×",amplitude:9,envelope:"custom"}]}},{name:"orchestra hit 1",midiProgram:55,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"FM",effects:"chorus & reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:8e3,filterResonance:14,filterEnvelope:"custom",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:14,feedbackEnvelope:"twang 3",operators:[{frequency:"1×",amplitude:15,envelope:"twang 3"},{frequency:"2×",amplitude:15,envelope:"flare 3"},{frequency:"4×",amplitude:15,envelope:"flare 2"},{frequency:"8×",amplitude:15,envelope:"flare 1"}]}},{name:"orchestra hit 2",midiProgram:55,midiSubharmonicOctaves:1,settings:{type:"FM",effects:"chorus & reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"decay 1",vibrato:"delayed",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:14,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"2×",amplitude:14,envelope:"custom"},{frequency:"3×",amplitude:12,envelope:"custom"},{frequency:"4×",amplitude:14,envelope:"custom"}]}}])},{name:"Vocal Presets",presets:a([{name:"choir soprano",midiProgram:94,generalMidi:!0,settings:{type:"harmonics",eqFilter:[{type:"low-pass",cutoffHz:2828.43,linearGain:2},{type:"peak",cutoffHz:1189.21,linearGain:5.6569},{type:"high-pass",cutoffHz:707.11,linearGain:2.8284},{type:"peak",cutoffHz:2e3,linearGain:.0884},{type:"peak",cutoffHz:840.9,linearGain:.25},{type:"low-pass",cutoffHz:6727.17,linearGain:11.3137}],effects:["vibrato","chorus","reverb"],vibrato:"shaky",chorus:100,reverb:33,fadeInSeconds:.0413,fadeOutTicks:24,harmonics:[100,100,86,57,29,29,57,71,57,29,14,14,14,29,43,57,43,29,14,14,14,14,14,14,0,0,0,0],unison:"none",envelopes:[]}},{name:"choir tenor",midiProgram:52,generalMidi:!0,settings:{type:"harmonics",eqFilter:[{type:"peak",cutoffHz:1e3,linearGain:11.3137},{type:"peak",cutoffHz:707.11,linearGain:5.6569},{type:"peak",cutoffHz:840.9,linearGain:.0884},{type:"peak",cutoffHz:1681.79,linearGain:.0884},{type:"high-pass",cutoffHz:297.3,linearGain:.7071},{type:"low-pass",cutoffHz:2828.43,linearGain:11.3137}],effects:["vibrato","chorus","reverb"],vibrato:"shaky",chorus:100,reverb:67,transition:"normal",fadeInSeconds:.0413,fadeOutTicks:48,chord:"simultaneous",harmonics:[86,100,100,86,71,57,43,29,29,29,29,43,43,43,29,29,29,29,29,29,29,29,29,14,14,14,14,14],unison:"none",envelopes:[]}},{name:"choir bass",midiProgram:52,settings:{type:"harmonics",eqFilter:[{type:"low-pass",cutoffHz:2378.41,linearGain:11.3137},{type:"peak",cutoffHz:594.6,linearGain:5.6569},{type:"peak",cutoffHz:1681.79,linearGain:.0884},{type:"peak",cutoffHz:707.11,linearGain:.0884},{type:"peak",cutoffHz:840.9,linearGain:11.3137}],effects:["vibrato","chorus","reverb"],vibrato:"shaky",chorus:100,reverb:67,transition:"normal",fadeInSeconds:.0413,fadeOutTicks:48,chord:"simultaneous",harmonics:[71,86,100,100,86,86,57,43,29,29,29,29,29,29,43,43,43,43,43,29,29,29,29,14,14,14,14,14],unison:"none",envelopes:[]}},{name:"solo soprano",midiProgram:85,settings:{type:"harmonics",eqFilter:[{type:"low-pass",cutoffHz:2828.43,linearGain:2},{type:"peak",cutoffHz:1189.21,linearGain:5.6569},{type:"high-pass",cutoffHz:707.11,linearGain:2.8284},{type:"peak",cutoffHz:2e3,linearGain:.0884},{type:"peak",cutoffHz:840.9,linearGain:.25}],effects:["vibrato","reverb"],vibrato:"shaky",reverb:33,fadeInSeconds:.0413,fadeOutTicks:12,harmonics:[86,100,86,43,14,14,57,71,57,14,14,14,14,14,43,57,43,14,14,14,14,14,14,14,0,0,0,0],unison:"none",envelopes:[]}},{name:"solo tenor",midiProgram:85,settings:{type:"harmonics",eqFilter:[{type:"peak",cutoffHz:1e3,linearGain:11.3137},{type:"peak",cutoffHz:707.11,linearGain:5.6569},{type:"peak",cutoffHz:840.9,linearGain:.0884},{type:"peak",cutoffHz:1681.79,linearGain:.0884},{type:"high-pass",cutoffHz:297.3,linearGain:.7071},{type:"low-pass",cutoffHz:2828.43,linearGain:11.3137}],effects:["vibrato","reverb"],vibrato:"shaky",reverb:33,fadeInSeconds:.0413,fadeOutTicks:12,harmonics:[86,100,100,86,71,57,43,29,29,29,29,43,43,43,29,29,29,29,29,29,29,29,29,14,14,14,14,14],unison:"none",envelopes:[]}},{name:"solo bass",midiProgram:85,settings:{type:"harmonics",eqFilter:[{type:"low-pass",cutoffHz:2378.41,linearGain:5.6569},{type:"peak",cutoffHz:594.6,linearGain:8},{type:"peak",cutoffHz:1681.79,linearGain:.0884},{type:"peak",cutoffHz:707.11,linearGain:.0884},{type:"peak",cutoffHz:840.9,linearGain:8},{type:"high-pass",cutoffHz:210.22,linearGain:1.4142}],effects:["vibrato","reverb"],vibrato:"shaky",reverb:33,transition:"normal",fadeInSeconds:.0263,fadeOutTicks:12,chord:"simultaneous",harmonics:[71,86,100,100,86,86,57,43,29,29,29,29,29,29,43,43,43,43,43,29,29,29,29,14,14,14,14,14],unison:"none",envelopes:[]}},{name:"voice ooh",midiProgram:53,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:1414,filterResonance:57,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[100,57,43,43,14,14,0,0,0,14,29,29,14,0,14,29,29,14,0,0,0,0,0,0,0,0,0,0]}},{name:"voice synth",midiProgram:54,generalMidi:!0,settings:{type:"chip",transition:"medium fade",effects:"chorus & reverb",chord:"harmony",filterCutoffHz:4e3,filterResonance:57,filterEnvelope:"steady",wave:"rounded",interval:"union",vibrato:"light"}},{name:"vox synth lead",midiProgram:85,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",vibrato:"light",algorithm:"(1 2 3)←4",feedbackType:"1→2→3→4",feedbackAmplitude:2,feedbackEnvelope:"punch",operators:[{frequency:"2×",amplitude:10,envelope:"custom"},{frequency:"9×",amplitude:5,envelope:"custom"},{frequency:"20×",amplitude:1,envelope:"custom"},{frequency:"~1×",amplitude:4,envelope:"steady"}]}},{name:"tiny robot",midiProgram:85,settings:{type:"FM",eqFilter:[],effects:["vibrato","reverb"],vibrato:"delayed",reverb:33,transition:"slide",fadeInSeconds:.0263,fadeOutTicks:-3,chord:"simultaneous",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:2,operators:[{frequency:"2×",amplitude:15},{frequency:"1×",amplitude:7},{frequency:"~1×",amplitude:7},{frequency:"1×",amplitude:0}],envelopes:[{target:"operatorAmplitude",envelope:"punch",index:1},{target:"feedbackAmplitude",envelope:"twang 3"}]}},{name:"yowie",midiProgram:85,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:86,filterEnvelope:"tremolo5",vibrato:"none",algorithm:"1←2←(3 4)",feedbackType:"1⟲",feedbackAmplitude:12,feedbackEnvelope:"tremolo3",operators:[{frequency:"2×",amplitude:12,envelope:"custom"},{frequency:"16×",amplitude:5,envelope:"steady"},{frequency:"1×",amplitude:5,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"mouse",midiProgram:85,settings:{type:"FM",eqFilter:[],effects:["vibrato","reverb"],vibrato:"light",reverb:33,transition:"slide in pattern",fadeInSeconds:.0263,fadeOutTicks:-3,chord:"simultaneous",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:5,operators:[{frequency:"2×",amplitude:13},{frequency:"5×",amplitude:12},{frequency:"1×",amplitude:0},{frequency:"1×",amplitude:0}],envelopes:[{target:"noteVolume",envelope:"note size"},{target:"feedbackAmplitude",envelope:"flare 2"}]}},{name:"gumdrop",midiProgram:85,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"2×",amplitude:15,envelope:"punch"},{frequency:"4×",amplitude:15,envelope:"punch"},{frequency:"7×",amplitude:15,envelope:"punch"},{frequency:"1×",amplitude:10,envelope:"twang 1"}]}},{name:"echo drop",midiProgram:102,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"punch",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"~2×",amplitude:11,envelope:"custom"},{frequency:"~1×",amplitude:5,envelope:"steady"},{frequency:"11×",amplitude:2,envelope:"steady"},{frequency:"16×",amplitude:5,envelope:"swell 3"}]}},{name:"dark choir",midiProgram:85,settings:{type:"spectrum",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"swell 1",spectrum:[43,14,14,14,14,14,14,100,14,14,14,57,14,14,100,14,43,14,43,14,14,43,14,29,14,29,14,14,29,0]}}])},{name:"Brass Presets",presets:a([{name:"trumpet",midiProgram:56,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:9,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"steady"},{frequency:"1×",amplitude:5,envelope:"flare 2"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"trombone",midiProgram:57,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"2⟲",feedbackAmplitude:7,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"tuba",midiProgram:58,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"2⟲",feedbackAmplitude:8,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"muted trumpet",midiProgram:59,generalMidi:!0,settings:{type:"FM",eqFilter:[{type:"low-pass",cutoffHz:8e3,linearGain:2.8284},{type:"peak",cutoffHz:4e3,linearGain:2.8284}],effects:["note filter","reverb"],noteFilter:[{type:"low-pass",cutoffHz:3363.59,linearGain:1}],reverb:33,fadeInSeconds:.0263,fadeOutTicks:-3,algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:5,operators:[{frequency:"1×",amplitude:13},{frequency:"1×",amplitude:5},{frequency:"9×",amplitude:5},{frequency:"13×",amplitude:7}],envelopes:[{target:"noteFilterAllFreqs",envelope:"swell 1"},{target:"operatorAmplitude",envelope:"swell 1",index:3},{target:"feedbackAmplitude",envelope:"flare 2"}]}},{name:"french horn",midiProgram:60,generalMidi:!0,settings:{type:"FM",eqFilter:[{type:"low-pass",cutoffHz:4e3,linearGain:1},{type:"peak",cutoffHz:2378.41,linearGain:2.8284}],effects:["reverb"],reverb:33,fadeInSeconds:.0263,fadeOutTicks:-3,algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:3,operators:[{frequency:"1×",amplitude:15},{frequency:"1×",amplitude:12},{frequency:"1×",amplitude:10},{frequency:"~1×",amplitude:8}],envelopes:[{target:"operatorAmplitude",envelope:"swell 1",index:2},{target:"operatorAmplitude",envelope:"flare 2",index:3},{target:"feedbackAmplitude",envelope:"swell 1"}]}},{name:"brass section",midiProgram:61,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"punch",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:6,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"swell 1"},{frequency:"~1×",amplitude:10,envelope:"swell 1"}]}},{name:"brass synth 1",midiProgram:62,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:11,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:12,envelope:"flare 1"},{frequency:"~1×",amplitude:8,envelope:"flare 2"}]}},{name:"brass synth 2",midiProgram:63,generalMidi:!0,settings:{type:"FM",transition:"soft",effects:"reverb",chord:"harmony",filterCutoffHz:4e3,filterResonance:43,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:9,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"flare 1"},{frequency:"~1×",amplitude:7,envelope:"flare 1"}]}},{name:"pulse brass",midiProgram:62,settings:{type:"PWM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"swell 1",pulseWidth:50,pulseEnvelope:"flare 3",vibrato:"none"}}])},{name:"Reed Presets",presets:a([{name:"soprano sax",midiProgram:64,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"4⟲",feedbackAmplitude:5,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"4×",amplitude:4,envelope:"swell 1"},{frequency:"1×",amplitude:7,envelope:"steady"},{frequency:"5×",amplitude:4,envelope:"punch"}]}},{name:"alto sax",midiProgram:65,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:4,feedbackEnvelope:"punch",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"4×",amplitude:6,envelope:"swell 1"},{frequency:"1×",amplitude:12,envelope:"steady"}]}},{name:"tenor sax",midiProgram:66,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"1⟲",feedbackAmplitude:6,feedbackEnvelope:"swell 1",operators:[{frequency:"2×",amplitude:12,envelope:"custom"},{frequency:"3×",amplitude:7,envelope:"steady"},{frequency:"1×",amplitude:3,envelope:"steady"},{frequency:"8×",amplitude:3,envelope:"steady"}]}},{name:"baritone sax",midiProgram:67,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"swell 2",operators:[{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"8×",amplitude:4,envelope:"steady"},{frequency:"4×",amplitude:5,envelope:"steady"},{frequency:"1×",amplitude:4,envelope:"punch"}]}},{name:"sax synth",midiProgram:64,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"light",algorithm:"1←(2 3 4)",feedbackType:"1⟲ 2⟲",feedbackAmplitude:4,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"shehnai",midiProgram:111,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"light",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:3,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"oboe",midiProgram:68,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"swell 1",vibrato:"none",algorithm:"1 2←(3 4)",feedbackType:"2⟲",feedbackAmplitude:2,feedbackEnvelope:"tremolo5",operators:[{frequency:"1×",amplitude:7,envelope:"custom"},{frequency:"4×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"6×",amplitude:2,envelope:"steady"}]}},{name:"english horn",midiProgram:69,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2←(3 4)",feedbackType:"2⟲",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:12,envelope:"custom"},{frequency:"2×",amplitude:10,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"punch"},{frequency:"8×",amplitude:4,envelope:"steady"}]}},{name:"bassoon",midiProgram:70,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:707,filterResonance:57,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"2×",amplitude:11,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"6×",amplitude:6,envelope:"swell 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"clarinet",midiProgram:71,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:1414,filterResonance:14,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[100,43,86,57,86,71,86,71,71,71,71,71,71,43,71,71,57,57,57,57,57,57,43,43,43,29,14,0]}},{name:"harmonica",midiProgram:22,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:5657,filterResonance:29,filterEnvelope:"swell 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:9,feedbackEnvelope:"tremolo5",operators:[{frequency:"2×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"steady"},{frequency:"~2×",amplitude:2,envelope:"twang 3"},{frequency:"1×",amplitude:0,envelope:"steady"}]}}])},{name:"Flute Presets",presets:a([{name:"flute",midiProgram:73,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"4⟲",feedbackAmplitude:7,feedbackEnvelope:"decay 2",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"2×",amplitude:4,envelope:"steady"},{frequency:"1×",amplitude:3,envelope:"steady"},{frequency:"~1×",amplitude:1,envelope:"punch"}]}},{name:"recorder",midiProgram:74,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"swell 2",interval:"union",vibrato:"none",harmonics:[100,43,57,43,57,43,43,43,43,43,43,43,43,29,29,29,29,29,29,29,14,14,14,14,14,14,14,0]}},{name:"whistle",midiProgram:78,generalMidi:!0,settings:{type:"harmonics",effects:"chorus & reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",interval:"union",vibrato:"delayed",harmonics:[100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},{name:"ocarina",midiProgram:79,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[100,14,57,14,29,14,14,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},{name:"piccolo",midiProgram:72,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:5657,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"4⟲",feedbackAmplitude:15,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"~2×",amplitude:3,envelope:"punch"},{frequency:"~1×",amplitude:5,envelope:"punch"}]}},{name:"shakuhachi",midiProgram:77,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"steady",vibrato:"delayed",algorithm:"1←(2 3←4)",feedbackType:"3→4",feedbackAmplitude:15,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"2×",amplitude:3,envelope:"punch"},{frequency:"~1×",amplitude:4,envelope:"twang 1"},{frequency:"20×",amplitude:15,envelope:"steady"}]}},{name:"pan flute",midiProgram:75,generalMidi:!0,settings:{type:"spectrum",eqFilter:[{type:"low-pass",cutoffHz:9513.66,linearGain:5.6569}],effects:["note filter","reverb"],noteFilter:[{type:"high-pass",cutoffHz:4756.83,linearGain:.7071}],reverb:33,fadeInSeconds:.0125,fadeOutTicks:-3,spectrum:[100,0,0,0,0,0,0,14,0,0,0,71,0,0,14,0,57,0,29,14,29,14,14,29,14,29,14,14,29,14],envelopes:[{target:"noteFilterFreq",envelope:"twang 1",index:0},{target:"noteVolume",envelope:"punch"}]}},{name:"blown bottle",midiProgram:76,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:5657,filterResonance:57,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:7,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"3×",amplitude:4,envelope:"custom"},{frequency:"6×",amplitude:2,envelope:"custom"},{frequency:"11×",amplitude:2,envelope:"custom"}]}},{name:"calliope",midiProgram:82,generalMidi:!0,settings:{type:"spectrum",transition:"cross fade",effects:"reverb",chord:"harmony",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"steady",spectrum:[100,0,0,0,0,0,0,86,0,0,0,71,0,0,57,0,43,0,29,14,14,29,14,14,14,14,14,14,14,14]}},{name:"chiffer",midiProgram:83,generalMidi:!0,settings:{type:"spectrum",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"punch",spectrum:[86,0,0,0,0,0,0,71,0,0,0,71,0,0,57,0,57,0,43,14,14,43,14,29,14,29,29,29,29,14]}},{name:"breath noise",midiProgram:121,generalMidi:!0,settings:{type:"spectrum",eqFilter:[],effects:["chord type","note filter","reverb"],chord:"strum",noteFilter:[{type:"high-pass",cutoffHz:840.9,linearGain:.3536},{type:"low-pass",cutoffHz:16e3,linearGain:.3536}],reverb:33,fadeInSeconds:.0413,fadeOutTicks:12,spectrum:[71,0,0,0,0,0,0,29,0,0,0,71,0,0,29,0,100,29,14,29,100,29,100,14,14,71,0,29,0,0],envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 1"}]}}])},{name:"Pad Presets",presets:a([{name:"new age pad",midiProgram:88,generalMidi:!0,settings:{type:"FM",eqFilter:[],effects:["chorus"],chorus:100,transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"simultaneous",algorithm:"1←(2 3←4)",feedbackType:"1⟲ 2⟲",feedbackAmplitude:3,operators:[{frequency:"2×",amplitude:14},{frequency:"~1×",amplitude:4},{frequency:"6×",amplitude:3},{frequency:"13×",amplitude:3}],envelopes:[{target:"operatorAmplitude",envelope:"swell 2",index:1},{target:"operatorAmplitude",envelope:"twang 3",index:2},{target:"feedbackAmplitude",envelope:"swell 3"}]}},{name:"warm pad",midiProgram:89,generalMidi:!0,settings:{type:"FM",eqFilter:[],effects:["note filter","chorus"],noteFilter:[{type:"low-pass",cutoffHz:3363.59,linearGain:1}],chorus:100,transition:"normal",fadeInSeconds:.0575,fadeOutTicks:96,chord:"simultaneous",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:7,operators:[{frequency:"1×",amplitude:14},{frequency:"1×",amplitude:6},{frequency:"1×",amplitude:0},{frequency:"1×",amplitude:0}],envelopes:[{target:"noteFilterAllFreqs",envelope:"swell 3"},{target:"operatorAmplitude",envelope:"swell 1",index:1}]}},{name:"polysynth pad",midiProgram:90,generalMidi:!0,settings:{type:"chip",eqFilter:[],effects:["vibrato","note filter","chorus"],vibrato:"delayed",noteFilter:[{type:"low-pass",cutoffHz:2828.43,linearGain:1}],chorus:100,transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"simultaneous",wave:"sawtooth",unison:"honky tonk",envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 3"}]}},{name:"space voice pad",midiProgram:91,generalMidi:!0,settings:{type:"FM",eqFilter:[{type:"low-pass",cutoffHz:6727.17,linearGain:5.6569},{type:"peak",cutoffHz:2828.43,linearGain:5.6569},{type:"peak",cutoffHz:1414.21,linearGain:.1768}],effects:["chorus"],chorus:100,transition:"normal",fadeInSeconds:.0125,fadeOutTicks:72,chord:"simultaneous",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:5,operators:[{frequency:"1×",amplitude:10},{frequency:"2×",amplitude:8},{frequency:"3×",amplitude:7},{frequency:"11×",amplitude:2}],envelopes:[{target:"operatorAmplitude",envelope:"punch",index:3},{target:"feedbackAmplitude",envelope:"swell 2"}]}},{name:"bowed glass pad",midiProgram:92,generalMidi:!0,settings:{type:"FM",eqFilter:[],effects:["note filter"],noteFilter:[{type:"low-pass",cutoffHz:4756.83,linearGain:.5}],transition:"normal",fadeInSeconds:.0575,fadeOutTicks:96,chord:"simultaneous",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,operators:[{frequency:"1×",amplitude:10},{frequency:"2×",amplitude:12},{frequency:"3×",amplitude:7},{frequency:"7×",amplitude:4}],envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 3"},{target:"operatorAmplitude",envelope:"twang 3",index:2},{target:"operatorAmplitude",envelope:"flare 3",index:3}]}},{name:"metallic pad",midiProgram:93,generalMidi:!0,settings:{type:"FM",eqFilter:[],effects:["note filter"],noteFilter:[{type:"low-pass",cutoffHz:6727.17,linearGain:.5}],transition:"normal",fadeInSeconds:.0125,fadeOutTicks:72,chord:"simultaneous",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:13,operators:[{frequency:"1×",amplitude:15},{frequency:"~1×",amplitude:9},{frequency:"1×",amplitude:7},{frequency:"11×",amplitude:7}],envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 3"},{target:"operatorAmplitude",envelope:"swell 2",index:2},{target:"feedbackAmplitude",envelope:"twang 3"}]}},{name:"sweep pad",midiProgram:95,generalMidi:!0,settings:{type:"chip",eqFilter:[],effects:["note filter","chorus"],noteFilter:[{type:"low-pass",cutoffHz:4e3,linearGain:4}],chorus:100,transition:"normal",fadeInSeconds:.0575,fadeOutTicks:96,chord:"simultaneous",wave:"sawtooth",unison:"hum",envelopes:[{target:"noteFilterAllFreqs",envelope:"flare 3"}]}},{name:"atmosphere",midiProgram:99,generalMidi:!0,settings:{type:"FM",eqFilter:[{type:"low-pass",cutoffHz:4756.83,linearGain:1}],effects:["chorus","reverb"],chorus:100,reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"strum",algorithm:"1←(2 3 4)",feedbackType:"3⟲ 4⟲",feedbackAmplitude:3,operators:[{frequency:"1×",amplitude:14},{frequency:"~1×",amplitude:10},{frequency:"3×",amplitude:7},{frequency:"1×",amplitude:7}],envelopes:[{target:"operatorAmplitude",envelope:"swell 3",index:1},{target:"operatorAmplitude",envelope:"twang 2",index:2},{target:"operatorAmplitude",envelope:"twang 3",index:3}]}},{name:"brightness",midiProgram:100,generalMidi:!0,settings:{type:"Picked String",eqFilter:[{type:"low-pass",cutoffHz:4756.83,linearGain:2}],effects:["chorus"],chorus:100,transition:"normal",fadeInSeconds:.0125,fadeOutTicks:72,chord:"simultaneous",harmonics:[100,86,86,86,43,57,43,71,43,43,43,57,43,43,57,71,57,43,29,43,57,57,43,29,29,29,29,14],unison:"octave",stringSustain:86,envelopes:[]}},{name:"goblins",midiProgram:101,generalMidi:!0,settings:{type:"FM",eqFilter:[{type:"peak",cutoffHz:2828.43,linearGain:11.3137}],effects:["note filter","chorus"],noteFilter:[{type:"low-pass",cutoffHz:1681.79,linearGain:.5}],chorus:100,transition:"normal",fadeInSeconds:.0575,fadeOutTicks:96,chord:"simultaneous",algorithm:"1←2←3←4",feedbackType:"1⟲",feedbackAmplitude:10,operators:[{frequency:"1×",amplitude:15},{frequency:"4×",amplitude:5},{frequency:"1×",amplitude:10},{frequency:"1×",amplitude:0}],envelopes:[{target:"noteFilterAllFreqs",envelope:"swell 2"},{target:"operatorAmplitude",envelope:"swell 3",index:1},{target:"operatorAmplitude",envelope:"tremolo1",index:2},{target:"feedbackAmplitude",envelope:"flare 3"}]}},{name:"sci-fi",midiProgram:103,generalMidi:!0,settings:{type:"FM",eqFilter:[{type:"peak",cutoffHz:9513.66,linearGain:2.8284}],effects:["note filter","chorus"],noteFilter:[{type:"low-pass",cutoffHz:6727.17,linearGain:.5}],chorus:100,transition:"normal",fadeInSeconds:.0125,fadeOutTicks:48,chord:"simultaneous",algorithm:"(1 2)←3←4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:8,operators:[{frequency:"~1×",amplitude:13},{frequency:"2×",amplitude:10},{frequency:"5×",amplitude:5},{frequency:"11×",amplitude:8}],envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 3"},{target:"operatorAmplitude",envelope:"twang 3",index:2},{target:"operatorAmplitude",envelope:"tremolo5",index:3},{target:"feedbackAmplitude",envelope:"twang 3"}]}},{name:"flutter pad",midiProgram:90,settings:{type:"FM",eqFilter:[],effects:["vibrato","note filter","chorus"],vibrato:"delayed",noteFilter:[{type:"low-pass",cutoffHz:4e3,linearGain:4}],chorus:100,transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"simultaneous",algorithm:"(1 2)←(3 4)",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:9,operators:[{frequency:"1×",amplitude:13},{frequency:"5×",amplitude:7},{frequency:"7×",amplitude:5},{frequency:"~1×",amplitude:6}],envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 3"},{target:"operatorAmplitude",envelope:"tremolo1",index:2},{target:"operatorAmplitude",envelope:"punch",index:3}]}},{name:"feedback pad",midiProgram:89,settings:{type:"FM",eqFilter:[{type:"peak",cutoffHz:2378.41,linearGain:8}],effects:[],transition:"normal",fadeInSeconds:.0575,fadeOutTicks:96,chord:"custom interval",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:8,operators:[{frequency:"1×",amplitude:15},{frequency:"1×",amplitude:15},{frequency:"1×",amplitude:15},{frequency:"~1×",amplitude:15}],envelopes:[{target:"feedbackAmplitude",envelope:"swell 2"}]}}])},{name:"Drum Presets",presets:a([{name:"standard drumset",midiProgram:116,isNoise:!0,settings:{type:"drumset",effects:"reverb",drums:[{filterEnvelope:"twang 1",spectrum:[57,71,71,86,86,86,71,71,71,71,57,57,57,57,43,43,43,43,29,29,29,29,29,29,29,29,29,29,29,29]},{filterEnvelope:"twang 1",spectrum:[0,0,0,100,71,71,57,86,57,57,57,71,43,43,57,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43]},{filterEnvelope:"twang 1",spectrum:[0,0,0,0,100,57,43,43,29,57,43,29,71,43,43,43,43,57,43,43,43,43,43,43,43,43,29,43,43,43]},{filterEnvelope:"twang 1",spectrum:[0,0,0,0,0,71,57,43,43,43,57,57,43,29,57,43,43,43,29,43,57,43,43,43,43,43,43,29,43,43]},{filterEnvelope:"decay 2",spectrum:[0,14,29,43,86,71,29,43,43,43,43,29,71,29,71,29,43,43,43,43,57,43,43,57,43,43,43,57,57,57]},{filterEnvelope:"decay 1",spectrum:[0,0,14,14,14,14,29,29,29,43,43,43,57,57,57,71,71,71,71,71,71,71,71,57,57,57,57,43,43,43]},{filterEnvelope:"twang 3",spectrum:[43,43,43,71,29,29,43,43,43,29,43,43,43,29,29,43,43,29,29,29,57,14,57,43,43,57,43,43,57,57]},{filterEnvelope:"decay 3",spectrum:[29,43,43,43,43,29,29,43,29,29,43,29,14,29,43,29,43,29,57,29,43,57,43,71,43,71,57,57,71,71]},{filterEnvelope:"twang 3",spectrum:[43,29,29,43,29,29,29,57,29,29,29,57,43,43,29,29,57,43,43,43,71,43,43,71,57,71,71,71,71,71]},{filterEnvelope:"decay 3",spectrum:[57,57,57,43,57,57,43,43,57,43,43,43,71,57,43,57,86,71,57,86,71,57,86,100,71,86,86,86,86,86]},{filterEnvelope:"flare 1",spectrum:[0,0,14,14,14,14,29,29,29,43,43,43,57,57,71,71,86,86,100,100,100,100,100,100,100,100,86,57,29,0]},{filterEnvelope:"decay 2",spectrum:[14,14,14,14,29,14,14,29,14,43,14,43,57,86,57,57,100,57,43,43,57,100,57,43,29,14,0,0,0,0]}]}},{name:"steel pan",midiProgram:114,generalMidi:!0,settings:{type:"FM",eqFilter:[{type:"high-pass",cutoffHz:62.5,linearGain:.1768}],effects:["note filter","chorus","reverb"],noteFilter:[{type:"low-pass",cutoffHz:13454.34,linearGain:.25}],chorus:67,reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:24,chord:"simultaneous",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:0,operators:[{frequency:"~1×",amplitude:14},{frequency:"7×",amplitude:3},{frequency:"3×",amplitude:5},{frequency:"4×",amplitude:4}],envelopes:[{target:"noteFilterAllFreqs",envelope:"decay 2"},{target:"operatorAmplitude",envelope:"flare 1",index:1},{target:"operatorAmplitude",envelope:"flare 2",index:2},{target:"operatorAmplitude",envelope:"swell 2",index:3}]}},{name:"steel pan synth",midiProgram:114,settings:{type:"FM",eqFilter:[],effects:["note filter"],noteFilter:[{type:"low-pass",cutoffHz:13454.34,linearGain:.25}],transition:"normal",fadeInSeconds:0,fadeOutTicks:-3,chord:"simultaneous",algorithm:"1 2 3←4",feedbackType:"1⟲",feedbackAmplitude:5,operators:[{frequency:"~1×",amplitude:12},{frequency:"2×",amplitude:15},{frequency:"4×",amplitude:14},{frequency:"~1×",amplitude:3}],envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 1"},{target:"operatorAmplitude",envelope:"note size",index:0},{target:"operatorAmplitude",envelope:"note size",index:1},{target:"operatorAmplitude",envelope:"flare 1",index:2},{target:"operatorAmplitude",envelope:"flare 2",index:3},{target:"feedbackAmplitude",envelope:"flare 1"}]}},{name:"timpani",midiProgram:47,generalMidi:!0,settings:{type:"spectrum",eqFilter:[{type:"peak",cutoffHz:6727.17,linearGain:5.6569}],effects:["pitch shift","note filter","reverb"],pitchShiftSemitones:15,noteFilter:[{type:"low-pass",cutoffHz:19027.31,linearGain:.5}],reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"simultaneous",spectrum:[100,0,0,0,86,0,0,71,0,14,43,14,43,43,0,29,43,29,29,29,43,29,43,29,43,43,43,43,43,43],envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 1"},{target:"pitchShift",envelope:"twang 1"}]}},{name:"dark strike",midiProgram:47,settings:{type:"spectrum",eqFilter:[],effects:["note filter","reverb"],noteFilter:[{type:"low-pass",cutoffHz:4756.83,linearGain:.7071}],reverb:33,transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"simultaneous",spectrum:[0,0,14,14,14,29,29,43,43,86,43,43,43,29,86,29,29,29,86,29,14,14,14,14,0,0,0,0,0,0],envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 2"}]}},{name:"woodblock",midiProgram:115,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-2.5,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 1",spectrum:[0,14,29,43,43,57,86,86,71,57,57,43,43,57,86,86,43,43,71,57,57,57,57,57,86,86,71,71,71,71]}},{name:"taiko drum",midiProgram:116,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-.5,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"twang 1",spectrum:[71,100,100,43,43,71,71,43,43,43,43,43,43,57,29,57,43,57,43,43,57,43,43,43,43,43,43,43,43,43]}},{name:"melodic drum",midiProgram:117,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-1.5,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"twang 1",spectrum:[100,71,71,57,57,43,43,71,43,43,43,57,43,43,57,43,43,43,43,29,29,29,29,29,29,29,29,29,29,29]}},{name:"drum synth",midiProgram:118,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-2,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:43,filterEnvelope:"decay 1",spectrum:[100,86,71,57,43,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29]}},{name:"tom-tom",midiProgram:116,isNoise:!0,midiSubharmonicOctaves:-1,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 1",spectrum:[100,29,14,0,0,86,14,43,29,86,29,14,29,57,43,43,43,43,57,43,43,43,29,57,43,43,43,43,43,43]}},{name:"metal pipe",midiProgram:117,isNoise:!0,midiSubharmonicOctaves:-1.5,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:8e3,filterResonance:14,filterEnvelope:"twang 2",spectrum:[29,43,86,43,43,43,43,43,100,29,14,14,100,14,14,0,0,0,0,0,14,29,29,14,0,0,14,29,0,0]}},{name:"synth kick",midiProgram:47,settings:{type:"FM",eqFilter:[],effects:[],transition:"normal",fadeInSeconds:0,fadeOutTicks:-6,chord:"simultaneous",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,operators:[{frequency:"8×",amplitude:15},{frequency:"1×",amplitude:0},{frequency:"1×",amplitude:0},{frequency:"1×",amplitude:0}],envelopes:[{target:"operatorFrequency",envelope:"twang 1",index:0},{target:"noteVolume",envelope:"twang 2"}]}}])},{name:"Novelty Presets",presets:a([{name:"guitar fret noise",midiProgram:120,generalMidi:!0,settings:{type:"spectrum",eqFilter:[{type:"high-pass",cutoffHz:1e3,linearGain:.1768}],effects:["note filter"],noteFilter:[{type:"low-pass",cutoffHz:6727.17,linearGain:5.6569}],transition:"normal",fadeInSeconds:.0125,fadeOutTicks:-3,chord:"simultaneous",spectrum:[0,0,0,0,0,0,0,0,0,0,0,0,0,14,0,0,0,29,14,0,0,43,0,43,0,71,43,0,57,0],envelopes:[{target:"noteFilterAllFreqs",envelope:"flare 1"},{target:"noteVolume",envelope:"twang 2"}]}},{name:"fifth saw lead",midiProgram:86,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"chip",eqFilter:[],effects:["note filter","chorus"],noteFilter:[{type:"low-pass",cutoffHz:2828.43,linearGain:1.4142}],chorus:67,transition:"normal",fadeInSeconds:0,fadeOutTicks:48,chord:"simultaneous",wave:"sawtooth",unison:"fifth",envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 3"}]}},{name:"fifth swell",midiProgram:86,midiSubharmonicOctaves:1,settings:{type:"chip",eqFilter:[],effects:["note filter","chorus"],noteFilter:[{type:"low-pass",cutoffHz:2e3,linearGain:2}],chorus:100,transition:"normal",fadeInSeconds:.0125,fadeOutTicks:72,chord:"simultaneous",wave:"sawtooth",unison:"fifth",envelopes:[{target:"noteFilterAllFreqs",envelope:"swell 3"}]}},{name:"soundtrack",midiProgram:97,generalMidi:!0,settings:{type:"chip",eqFilter:[],effects:["note filter","chorus"],noteFilter:[{type:"low-pass",cutoffHz:2378.41,linearGain:.5}],chorus:67,transition:"normal",fadeInSeconds:.0413,fadeOutTicks:72,chord:"simultaneous",wave:"sawtooth",unison:"fifth",envelopes:[{target:"noteFilterAllFreqs",envelope:"flare 3"}]}},{name:"reverse cymbal",midiProgram:119,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-3,settings:{type:"spectrum",effects:"none",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"swell 3",spectrum:[29,57,57,29,57,57,29,29,43,29,29,43,29,29,57,57,14,57,14,57,71,71,57,86,57,100,86,86,86,86]}},{name:"seashore",midiProgram:122,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-3,settings:{type:"spectrum",transition:"soft fade",effects:"reverb",chord:"harmony",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"swell 3",spectrum:[14,14,29,29,43,43,43,57,57,57,57,57,57,71,71,71,71,71,71,71,71,71,71,71,71,71,71,71,71,57]}},{name:"bird tweet",midiProgram:123,generalMidi:!0,settings:{type:"harmonics",eqFilter:[],effects:["chord type","vibrato","reverb"],chord:"strum",vibrato:"heavy",reverb:67,fadeInSeconds:.0575,fadeOutTicks:-6,harmonics:[0,0,0,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],unison:"hum",envelopes:[{target:"noteVolume",envelope:"decay 1"}]}},{name:"telephone ring",midiProgram:124,generalMidi:!0,settings:{type:"FM",eqFilter:[],effects:["note filter"],noteFilter:[{type:"low-pass",cutoffHz:5656.85,linearGain:1}],transition:"normal",fadeInSeconds:.0125,fadeOutTicks:-3,chord:"arpeggio",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,operators:[{frequency:"2×",amplitude:12},{frequency:"1×",amplitude:4},{frequency:"20×",amplitude:1},{frequency:"1×",amplitude:0}],envelopes:[{target:"noteFilterAllFreqs",envelope:"tremolo4"},{target:"operatorAmplitude",envelope:"tremolo1",index:1}]}},{name:"helicopter",midiProgram:125,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-.5,settings:{type:"spectrum",effects:"reverb",transition:"seamless",chord:"arpeggio",filterCutoffHz:1414,filterResonance:14,filterEnvelope:"tremolo4",spectrum:[14,43,43,57,57,57,71,71,71,71,86,86,86,86,86,86,86,86,86,86,86,71,71,71,71,71,71,71,57,57]}},{name:"applause",midiProgram:126,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-3,settings:{type:"spectrum",effects:"reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"swell 3",spectrum:[14,14,29,29,29,43,43,57,71,71,86,86,86,71,71,57,57,57,71,86,86,86,86,86,71,71,57,57,57,57]}},{name:"gunshot",midiProgram:127,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-2,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:1414,filterResonance:29,filterEnvelope:"twang 1",spectrum:[14,29,43,43,57,57,57,71,71,71,86,86,86,86,86,86,86,86,86,86,86,71,71,71,71,57,57,57,57,43]}},{name:"scoot",midiProgram:92,settings:{type:"chip",eqFilter:[],effects:["note filter"],noteFilter:[{type:"low-pass",cutoffHz:707.11,linearGain:4}],transition:"normal",fadeInSeconds:.0125,fadeOutTicks:-3,chord:"simultaneous",wave:"double saw",unison:"shimmer",envelopes:[{target:"noteFilterAllFreqs",envelope:"flare 1"}]}},{name:"buzz saw",midiProgram:30,settings:{type:"FM",eqFilter:[{type:"low-pass",cutoffHz:9513.66,linearGain:.5}],effects:[],transition:"normal",fadeInSeconds:.0263,fadeOutTicks:-3,chord:"custom interval",algorithm:"1←2←3←4",feedbackType:"1⟲",feedbackAmplitude:4,operators:[{frequency:"5×",amplitude:13},{frequency:"1×",amplitude:10},{frequency:"~1×",amplitude:6},{frequency:"11×",amplitude:12}],envelopes:[]}},{name:"mosquito",midiProgram:93,settings:{type:"PWM",eqFilter:[{type:"low-pass",cutoffHz:2828.43,linearGain:2}],effects:["vibrato"],vibrato:"shaky",transition:"normal",fadeInSeconds:.0575,fadeOutTicks:-6,chord:"simultaneous",pulseWidth:4.41942,envelopes:[{target:"pulseWidth",envelope:"tremolo6"}]}},{name:"breathing",midiProgram:126,isNoise:!0,midiSubharmonicOctaves:-1,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"swell 2",spectrum:[14,14,14,29,29,29,29,29,43,29,29,43,43,43,29,29,71,43,86,86,57,100,86,86,86,86,71,86,71,57]}},{name:"klaxon synth",midiProgram:125,isNoise:!0,midiSubharmonicOctaves:-1,settings:{type:"noise",effects:"reverb",transition:"slide",chord:"harmony",filterCutoffHz:2e3,filterResonance:86,filterEnvelope:"steady",wave:"buzz"}},{name:"theremin",midiProgram:40,settings:{type:"harmonics",eqFilter:[{type:"low-pass",cutoffHz:8e3,linearGain:.7071}],effects:["vibrato","reverb"],vibrato:"heavy",reverb:33,transition:"slide in pattern",fadeInSeconds:.0263,fadeOutTicks:-6,chord:"simultaneous",harmonics:[100,71,57,43,29,29,14,14,14,14,14,14,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],unison:"none",envelopes:[]}},{name:"sonar ping",midiProgram:121,settings:{type:"spectrum",eqFilter:[],effects:["note filter","reverb"],noteFilter:[{type:"low-pass",cutoffHz:1681.79,linearGain:.5}],reverb:33,transition:"normal",fadeInSeconds:.0125,fadeOutTicks:72,chord:"simultaneous",spectrum:[100,43,29,29,14,14,14,14,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],envelopes:[{target:"noteFilterAllFreqs",envelope:"twang 2"}]}}])}]);var S=t&&t.t||function(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],s=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&s>=t.length&&(t=void 0),{value:t&&t[s++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},P=t&&t.i||function(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var s,n,o=i.call(t),r=[];try{for(;(void 0===e||e-- >0)&&!(s=o.next()).done;)r.push(s.value)}catch(t){n={error:t}}finally{try{s&&!s.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return r},F=t&&t.o||function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(P(arguments[e]));return t};function E(t,e){var i,s,n,o,r,h;try{for(var a=S(e),l=a.next();!l.done;l=a.next()){var c=l.value;if(c instanceof Node)t.appendChild(c);else if("string"==typeof c)t.appendChild(document.createTextNode(c));else if("function"==typeof c)E(t,[c()]);else if(Array.isArray(c))E(t,c);else if(c&&"undefined"!=typeof Symbol&&"function"==typeof c[Symbol.iterator])E(t,F(c));else if(c&&c.constructor===Object&&t instanceof Element)try{for(var u=(n=void 0,S(Object.keys(c))),f=u.next();!f.done;f=u.next()){var p=f.value,d=c[p];if("class"===p)"string"==typeof d?t.setAttribute("class",d):Array.isArray(c)||d&&"undefined"!=typeof Symbol&&"function"==typeof d[Symbol.iterator]?t.setAttribute("class",F(d).join(" ")):console.warn("Invalid "+p+' value "'+d+'" on '+t.tagName+" element.");else if("style"===p)if(d&&d.constructor===Object)try{for(var m=(r=void 0,S(Object.keys(d))),y=m.next();!y.done;y=m.next()){var g=y.value;g in t.style?t.style[g]=d[g]:t.style.setProperty(g,d[g])}}catch(t){r={error:t}}finally{try{y&&!y.done&&(h=m.return)&&h.call(m)}finally{if(r)throw r.error}}else t.setAttribute(p,d);else"function"==typeof d?t[p]=d:"boolean"==typeof d?d?t.setAttribute(p,""):t.removeAttribute(p):t.setAttribute(p,d)}}catch(t){n={error:t}}finally{try{f&&!f.done&&(o=u.return)&&o.call(u)}finally{if(n)throw n.error}}else t.appendChild(document.createTextNode(c))}}catch(t){i={error:t}}finally{try{l&&!l.done&&(s=a.return)&&s.call(a)}finally{if(i)throw i.error}}return t}var I="http://www.w3.org/2000/svg";var q,T,C,L,D=t&&t.t||function(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],s=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&s>=t.length&&(t=void 0),{value:t&&t[s++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},z=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return document.createRange().createContextualFragment(t.join())},A=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var i=document.createDocumentFragment(),s=(new DOMParser).parseFromString('<svg xmlns="http://www.w3.org/2000/svg">'+t.join()+"</svg>","image/svg+xml").documentElement;null!==s.firstChild;)document.importNode(s.firstChild,!0),i.appendChild(s.firstChild);return i},R=function(t){z[t]=function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return E(document.createElement(t),e)}};try{for(var O=D("a abbr address area article aside audio b base bdi bdo blockquote br button canvas caption cite code col colgroup datalist dd del details dfn dialog div dl dt em embed fieldset figcaption figure footer form h1 h2 h3 h4 h5 h6 header hr i iframe img input ins kbd label legend li link main map mark menu menuitem meta meter nav noscript object ol optgroup option output p param picture pre progress q rp rt ruby s samp script section select small source span strong style sub summary sup table tbody td template textarea tfoot th thead time title tr track u ul var video wbr".split(" ")),B=O.next();!B.done;B=O.next()){R(B.value)}}catch(t){q={error:t}}finally{try{B&&!B.done&&(T=O.return)&&T.call(O)}finally{if(q)throw q.error}}var N=function(t){if(A[t]=function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return E(document.createElementNS(I,t),e)},/-/.test(t)){var e=t.replace(/-/g,"_");A[e]=function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return E(document.createElementNS(I,t),e)}}};try{for(var H=D("a altGlyph altGlyphDef altGlyphItem animate animateMotion animateTransform circle clipPath color-profile cursor defs desc discard ellipse feBlend feColorMatrix feComponentTransfer feComposite feConvolveMatrix feDiffuseLighting feDisplacementMap feDistantLight feDropShadow feFlood feFuncA feFuncB feFuncG feFuncR feGaussianBlur feImage feMerge feMergeNode feMorphology feOffset fePointLight feSpecularLighting feSpotLight feTile feTurbulence filter font font-face font-face-format font-face-name font-face-src font-face-uri foreignObject g glyph glyphRef hkern image line linearGradient marker mask metadata missing-glyph mpath path pattern polygon polyline radialGradient rect script set stop style svg switch symbol text textPath title tref tspan use view vkern".split(" ")),G=H.next();!G.done;G=H.next()){N(G.value)}}catch(t){C={error:t}}finally{try{G&&!G.done&&(L=H.return)&&L.call(H)}finally{if(C)throw C.error}}class ${static getChannelColor(t,e){return e<t.pitchChannelCount?$.pitchChannels[e%$.pitchChannels.length]:$.noiseChannels[(e-t.pitchChannelCount)%$.noiseChannels.length]}static setTheme(t){this.h.textContent=this.themes[t];const e=document.querySelector("meta[name='theme-color']");null!=e&&e.setAttribute("content",getComputedStyle(document.documentElement).getPropertyValue("--ui-widget-background"))}}$.themes={"dark classic":"\n\t\t\t:root {\n\t\t\t\t--page-margin: black;\n\t\t\t\t--editor-background: black;\n\t\t\t\t--hover-preview: white;\n\t\t\t\t--playhead: white;\n\t\t\t\t--primary-text: white;\n\t\t\t\t--secondary-text: #999;\n\t\t\t\t--inverted-text: black;\n\t\t\t\t--text-selection: rgba(119,68,255,0.99);\n\t\t\t\t--box-selection-fill: rgba(255,255,255,0.2);\n\t\t\t\t--loop-accent: #74f;\n\t\t\t\t--link-accent: #98f;\n\t\t\t\t--ui-widget-background: #444;\n\t\t\t\t--ui-widget-focus: #777;\n\t\t\t\t--pitch-background: #444;\n\t\t\t\t--tonic: #864;\n\t\t\t\t--fifth-note: #468;\n\t\t\t\t--white-piano-key: #bbb;\n\t\t\t\t--black-piano-key: #444;\n\t\t\t\t--pitch1-secondary-channel: #0099A1;\n\t\t\t\t--pitch1-primary-channel:   #25F3FF;\n\t\t\t\t--pitch1-secondary-note:    #00BDC7;\n\t\t\t\t--pitch1-primary-note:      #92F9FF;\n\t\t\t\t--pitch2-secondary-channel: #A1A100;\n\t\t\t\t--pitch2-primary-channel:   #FFFF25;\n\t\t\t\t--pitch2-secondary-note:    #C7C700;\n\t\t\t\t--pitch2-primary-note:      #FFFF92;\n\t\t\t\t--pitch3-secondary-channel: #C75000;\n\t\t\t\t--pitch3-primary-channel:   #FF9752;\n\t\t\t\t--pitch3-secondary-note:    #FF771C;\n\t\t\t\t--pitch3-primary-note:      #FFCDAB;\n\t\t\t\t--pitch4-secondary-channel: #00A100;\n\t\t\t\t--pitch4-primary-channel:   #50FF50;\n\t\t\t\t--pitch4-secondary-note:    #00C700;\n\t\t\t\t--pitch4-primary-note:      #A0FFA0;\n\t\t\t\t--pitch5-secondary-channel: #D020D0;\n\t\t\t\t--pitch5-primary-channel:   #FF90FF;\n\t\t\t\t--pitch5-secondary-note:    #E040E0;\n\t\t\t\t--pitch5-primary-note:      #FFC0FF;\n\t\t\t\t--pitch6-secondary-channel: #7777B0;\n\t\t\t\t--pitch6-primary-channel:   #A0A0FF;\n\t\t\t\t--pitch6-secondary-note:    #8888D0;\n\t\t\t\t--pitch6-primary-note:      #D0D0FF;\n\t\t\t\t--pitch7-secondary-channel: #8AA100;\n\t\t\t\t--pitch7-primary-channel:   #DEFF25;\n\t\t\t\t--pitch7-secondary-note:    #AAC700;\n\t\t\t\t--pitch7-primary-note:      #E6FF92;\n\t\t\t\t--pitch8-secondary-channel: #DF0019;\n\t\t\t\t--pitch8-primary-channel:   #FF98A4;\n\t\t\t\t--pitch8-secondary-note:    #FF4E63;\n\t\t\t\t--pitch8-primary-note:      #FFB2BB;\n\t\t\t\t--pitch9-secondary-channel: #00A170;\n\t\t\t\t--pitch9-primary-channel:   #50FFC9;\n\t\t\t\t--pitch9-secondary-note:    #00C78A;\n\t\t\t\t--pitch9-primary-note:      #83FFD9;\n\t\t\t\t--pitch10-secondary-channel:#A11FFF;\n\t\t\t\t--pitch10-primary-channel:  #CE8BFF;\n\t\t\t\t--pitch10-secondary-note:   #B757FF;\n\t\t\t\t--pitch10-primary-note:     #DFACFF;\n\t\t\t\t--noise1-secondary-channel: #6F6F6F;\n\t\t\t\t--noise1-primary-channel:   #AAAAAA;\n\t\t\t\t--noise1-secondary-note:    #A7A7A7;\n\t\t\t\t--noise1-primary-note:      #E0E0E0;\n\t\t\t\t--noise2-secondary-channel: #996633;\n\t\t\t\t--noise2-primary-channel:   #DDAA77;\n\t\t\t\t--noise2-secondary-note:    #CC9966;\n\t\t\t\t--noise2-primary-note:      #F0D0BB;\n\t\t\t\t--noise3-secondary-channel: #4A6D8F;\n\t\t\t\t--noise3-primary-channel:   #77AADD;\n\t\t\t\t--noise3-secondary-note:    #6F9FCF;\n\t\t\t\t--noise3-primary-note:      #BBD7FF;\n\t\t\t\t--noise4-secondary-channel: #7A4F9A;\n\t\t\t\t--noise4-primary-channel:   #AF82D2;\n\t\t\t\t--noise4-secondary-note:    #9E71C1;\n\t\t\t\t--noise4-primary-note:      #D4C1EA;\n\t\t\t\t--noise5-secondary-channel: #607837;\n\t\t\t\t--noise5-primary-channel:   #A2BB77;\n\t\t\t\t--noise5-secondary-note:    #91AA66;\n\t\t\t\t--noise5-primary-note:      #C5E2B2;\n\t\t\t}\n\t\t","light classic":"\n\t\t\t:root {\n\t\t\t\t-webkit-text-stroke-width: 0.5px;\n\t\t\t\t--page-margin: #685d88;\n\t\t\t\t--editor-background: white;\n\t\t\t\t--hover-preview: black;\n\t\t\t\t--playhead: rgba(0,0,0,0.5);\n\t\t\t\t--primary-text: black;\n\t\t\t\t--secondary-text: #777;\n\t\t\t\t--inverted-text: white;\n\t\t\t\t--text-selection: rgba(200,170,255,0.99);\n\t\t\t\t--box-selection-fill: rgba(0,0,0,0.1);\n\t\t\t\t--loop-accent: #98f;\n\t\t\t\t--link-accent: #74f;\n\t\t\t\t--ui-widget-background: #ececec;\n\t\t\t\t--ui-widget-focus: #eee;\n\t\t\t\t--pitch-background: #ececec;\n\t\t\t\t--tonic: #f0d6b6;\n\t\t\t\t--fifth-note: #bbddf0;\n\t\t\t\t--white-piano-key: #eee;\n\t\t\t\t--black-piano-key: #666;\n\t\t\t\t--pitch1-secondary-channel: #6CD9ED;\n\t\t\t\t--pitch1-primary-channel:   #00A0BD;\n\t\t\t\t--pitch1-secondary-note:    #34C2DC;\n\t\t\t\t--pitch1-primary-note:      #00758A;\n\t\t\t\t--pitch2-secondary-channel: #E3C941;\n\t\t\t\t--pitch2-primary-channel:   #B49700;\n\t\t\t\t--pitch2-secondary-note:    #D1B628;\n\t\t\t\t--pitch2-primary-note:      #836E00;\n\t\t\t\t--pitch3-secondary-channel: #FF9D61;\n\t\t\t\t--pitch3-primary-channel:   #E14E00;\n\t\t\t\t--pitch3-secondary-note:    #F67D3C;\n\t\t\t\t--pitch3-primary-note:      #B64000;\n\t\t\t\t--pitch4-secondary-channel: #4BE24B;\n\t\t\t\t--pitch4-primary-channel:   #00A800;\n\t\t\t\t--pitch4-secondary-note:    #2DC82D;\n\t\t\t\t--pitch4-primary-note:      #008000;\n\t\t\t\t--pitch5-secondary-channel: #FF90FF;\n\t\t\t\t--pitch5-primary-channel:   #E12EDF;\n\t\t\t\t--pitch5-secondary-note:    #EC6EEC;\n\t\t\t\t--pitch5-primary-note:      #A600A5;\n\t\t\t\t--pitch6-secondary-channel: #B5B5FE;\n\t\t\t\t--pitch6-primary-channel:   #6969FD;\n\t\t\t\t--pitch6-secondary-note:    #9393FE;\n\t\t\t\t--pitch6-primary-note:      #4A4AD7;\n\t\t\t\t--pitch7-secondary-channel: #C2D848;\n\t\t\t\t--pitch7-primary-channel:   #8EA800;\n\t\t\t\t--pitch7-secondary-note:    #B0C82D;\n\t\t\t\t--pitch7-primary-note:      #6C8000;\n\t\t\t\t--pitch8-secondary-channel: #FF90A4;\n\t\t\t\t--pitch8-primary-channel:   #E12E4D;\n\t\t\t\t--pitch8-secondary-note:    #EC6E85;\n\t\t\t\t--pitch8-primary-note:      #A6001D;\n\t\t\t\t--pitch9-secondary-channel: #41E3B5;\n\t\t\t\t--pitch9-primary-channel:   #00B481;\n\t\t\t\t--pitch9-secondary-note:    #28D1A1;\n\t\t\t\t--pitch9-primary-note:      #00835E;\n\t\t\t\t--pitch10-secondary-channel:#CA77FF;\n\t\t\t\t--pitch10-primary-channel:  #9609FF;\n\t\t\t\t--pitch10-secondary-note:   #B54FFF;\n\t\t\t\t--pitch10-primary-note:     #8400E3;\n\t\t\t\t--noise1-secondary-channel: #C1C1C1;\n\t\t\t\t--noise1-primary-channel:   #898989;\n\t\t\t\t--noise1-secondary-note:    #ADADAD;\n\t\t\t\t--noise1-primary-note:      #6C6C6C;\n\t\t\t\t--noise2-secondary-channel: #E8BB8C;\n\t\t\t\t--noise2-primary-channel:   #BD7D3A;\n\t\t\t\t--noise2-secondary-note:    #D1A374;\n\t\t\t\t--noise2-primary-note:      #836342;\n\t\t\t\t--noise3-secondary-channel: #9BC4EB;\n\t\t\t\t--noise3-primary-channel:   #4481BE;\n\t\t\t\t--noise3-secondary-note:    #7CA7D3;\n\t\t\t\t--noise3-primary-note:      #476685;\n\t\t\t\t--noise4-secondary-channel: #C5A5E0;\n\t\t\t\t--noise4-primary-channel:   #8553AE;\n\t\t\t\t--noise4-secondary-note:    #B290CC;\n\t\t\t\t--noise4-primary-note:      #684F7D;\n\t\t\t\t--noise5-secondary-channel: #B8CE93;\n\t\t\t\t--noise5-primary-channel:   #87A74F;\n\t\t\t\t--noise5-secondary-note:    #ABC183;\n\t\t\t\t--noise5-primary-note:      #68784C;\n\t\t\t}\n\t\t\t\n\t\t\t.beepboxEditor button, .beepboxEditor select {\n\t\t\t\tbox-shadow: inset 0 0 0 1px var(--secondary-text);\n\t\t\t}\n\t\t"},$.pageMargin="var(--page-margin)",$.editorBackground="var(--editor-background)",$.hoverPreview="var(--hover-preview)",$.playhead="var(--playhead)",$.primaryText="var(--primary-text)",$.secondaryText="var(--secondary-text)",$.invertedText="var(--inverted-text)",$.textSelection="var(--text-selection)",$.boxSelectionFill="var(--box-selection-fill)",$.loopAccent="var(--loop-accent)",$.linkAccent="var(--link-accent)",$.uiWidgetBackground="var(--ui-widget-background)",$.uiWidgetFocus="var(--ui-widget-focus)",$.pitchBackground="var(--pitch-background)",$.tonic="var(--tonic)",$.fifthNote="var(--fifth-note)",$.whitePianoKey="var(--white-piano-key)",$.blackPianoKey="var(--black-piano-key)",$.pitchChannels=a([{name:"pitch1",secondaryChannel:"var(--pitch1-secondary-channel)",primaryChannel:"var(--pitch1-primary-channel)",secondaryNote:"var(--pitch1-secondary-note)",primaryNote:"var(--pitch1-primary-note)"},{name:"pitch2",secondaryChannel:"var(--pitch2-secondary-channel)",primaryChannel:"var(--pitch2-primary-channel)",secondaryNote:"var(--pitch2-secondary-note)",primaryNote:"var(--pitch2-primary-note)"},{name:"pitch3",secondaryChannel:"var(--pitch3-secondary-channel)",primaryChannel:"var(--pitch3-primary-channel)",secondaryNote:"var(--pitch3-secondary-note)",primaryNote:"var(--pitch3-primary-note)"},{name:"pitch4",secondaryChannel:"var(--pitch4-secondary-channel)",primaryChannel:"var(--pitch4-primary-channel)",secondaryNote:"var(--pitch4-secondary-note)",primaryNote:"var(--pitch4-primary-note)"},{name:"pitch5",secondaryChannel:"var(--pitch5-secondary-channel)",primaryChannel:"var(--pitch5-primary-channel)",secondaryNote:"var(--pitch5-secondary-note)",primaryNote:"var(--pitch5-primary-note)"},{name:"pitch6",secondaryChannel:"var(--pitch6-secondary-channel)",primaryChannel:"var(--pitch6-primary-channel)",secondaryNote:"var(--pitch6-secondary-note)",primaryNote:"var(--pitch6-primary-note)"},{name:"pitch7",secondaryChannel:"var(--pitch7-secondary-channel)",primaryChannel:"var(--pitch7-primary-channel)",secondaryNote:"var(--pitch7-secondary-note)",primaryNote:"var(--pitch7-primary-note)"},{name:"pitch8",secondaryChannel:"var(--pitch8-secondary-channel)",primaryChannel:"var(--pitch8-primary-channel)",secondaryNote:"var(--pitch8-secondary-note)",primaryNote:"var(--pitch8-primary-note)"},{name:"pitch9",secondaryChannel:"var(--pitch9-secondary-channel)",primaryChannel:"var(--pitch9-primary-channel)",secondaryNote:"var(--pitch9-secondary-note)",primaryNote:"var(--pitch9-primary-note)"},{name:"pitch10",secondaryChannel:"var(--pitch10-secondary-channel)",primaryChannel:"var(--pitch10-primary-channel)",secondaryNote:"var(--pitch10-secondary-note)",primaryNote:"var(--pitch10-primary-note)"}]),$.noiseChannels=a([{name:"noise1",secondaryChannel:"var(--noise1-secondary-channel)",primaryChannel:"var(--noise1-primary-channel)",secondaryNote:"var(--noise1-secondary-note)",primaryNote:"var(--noise1-primary-note)"},{name:"noise2",secondaryChannel:"var(--noise2-secondary-channel)",primaryChannel:"var(--noise2-primary-channel)",secondaryNote:"var(--noise2-secondary-note)",primaryNote:"var(--noise2-primary-note)"},{name:"noise3",secondaryChannel:"var(--noise3-secondary-channel)",primaryChannel:"var(--noise3-primary-channel)",secondaryNote:"var(--noise3-secondary-note)",primaryNote:"var(--noise3-primary-note)"},{name:"noise4",secondaryChannel:"var(--noise4-secondary-channel)",primaryChannel:"var(--noise4-primary-channel)",secondaryNote:"var(--noise4-secondary-note)",primaryNote:"var(--noise4-primary-note)"},{name:"noise5",secondaryChannel:"var(--noise5-secondary-channel)",primaryChannel:"var(--noise5-primary-channel)",secondaryNote:"var(--noise5-secondary-note)",primaryNote:"var(--noise5-primary-note)"}]),$.h=document.head.appendChild(z.style({type:"text/css"}));const _=document.body.appendChild(z.div({style:"width:30px; height:30px; overflow: auto;"},z.div({style:"width:100%;height:40px"})));_.firstChild.clientWidth<30&&document.documentElement.classList.add("obtrusive-scrollbars"),document.body.removeChild(_),document.head.appendChild(z.style({type:"text/css"},`\n\n/* Note: "#" symbols need to be encoded as "%23" in SVG data urls, otherwise they are interpreted as fragment identifiers! */\n:root {\n\t--button-size: 26px;\n\t--settings-area-width: 192px;\n\t--play-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M -4 -8 L -4 8 L 9 0 z" fill="gray"/></svg>');\n\t--pause-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="-4" y="-8" width="4" height="16" fill="gray"/><rect x="5" y="-8" width="4" height="16" fill="gray"/></svg>');\n\t--prev-bar-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="-6" y="-6" width="2" height="12" fill="gray"/><path d="M 6 -6 L 6 6 L -3 0 z" fill="gray"/></svg>');\n\t--next-bar-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="4" y="-6" width="2" height="12" fill="gray"/><path d="M -6 -6 L -6 6 L 3 0 z" fill="gray"/></svg>');\n\t--volume-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"><path d="M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z" fill="gray"/></svg>');\n\t--unmuted-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="3 3 20 20"><path d="M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z" fill="gray"/></svg>');\n\t--muted-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="3 3 20 20"><path d="M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z" fill="gray"/></svg>');\n\t--menu-down-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M -4 -2 L 4 -2 L 0 3 z" fill="gray"/></svg>');\n\t--select-arrows-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M -4 -3 L 4 -3 L 0 -8 z M -4 3 L 4 3 L 0 8 z" fill="gray"/></svg>');\n\t--file-page-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-5 -21 26 26"><path d="M 2 0 L 2 -16 L 10 -16 L 14 -12 L 14 0 z M 3 -1 L 13 -1 L 13 -11 L 9 -11 L 9 -15 L 3 -15 z" fill="gray"/></svg>');\n\t--edit-pencil-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-5 -21 26 26"><path d="M 0 0 L 1 -4 L 4 -1 z M 2 -5 L 10 -13 L 13 -10 L 5 -2 zM 11 -14 L 13 -16 L 14 -16 L 16 -14 L 16 -13 L 14 -11 z" fill="gray"/></svg>');\n\t--preferences-gear-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M 5.78 -1.6 L 7.93 -0.94 L 7.93 0.94 L 5.78 1.6 L 4.85 3.53 L 5.68 5.61 L 4.21 6.78 L 2.36 5.52 L 0.27 5.99 L -0.85 7.94 L -2.68 7.52 L -2.84 5.28 L -4.52 3.95 L -6.73 4.28 L -7.55 2.59 L -5.9 1.07 L -5.9 -1.07 L -7.55 -2.59 L -6.73 -4.28 L -4.52 -3.95 L -2.84 -5.28 L -2.68 -7.52 L -0.85 -7.94 L 0.27 -5.99 L 2.36 -5.52 L 4.21 -6.78 L 5.68 -5.61 L 4.85 -3.53 M 2.92 0.67 L 2.92 -0.67 L 2.35 -1.87 L 1.3 -2.7 L 0 -3 L -1.3 -2.7 L -2.35 -1.87 L -2.92 -0.67 L -2.92 0.67 L -2.35 1.87 L -1.3 2.7 L -0 3 L 1.3 2.7 L 2.35 1.87 z" fill="gray"/></svg>');\n\t--customize-dial-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"> \t\t\t<g transform="translate(0,1)" fill="gray"> \t\t\t\t<circle cx="0" cy="0" r="6.5" stroke="gray" stroke-width="1" fill="none"/> \t\t\t\t<rect x="-1" y="-5" width="2" height="4" transform="rotate(30)"/> \t\t\t\t<circle cx="-7.79" cy="4.5" r="0.75"/> \t\t\t\t<circle cx="-9" cy="0" r="0.75"/> \t\t\t\t<circle cx="-7.79" cy="-4.5" r="0.75"/> \t\t\t\t<circle cx="-4.5" cy="-7.79" r="0.75"/> \t\t\t\t<circle cx="0" cy="-9" r="0.75"/> \t\t\t\t<circle cx="4.5" cy="-7.79" r="0.75"/> \t\t\t\t<circle cx="7.79" cy="-4.5" r="0.75"/> \t\t\t\t<circle cx="9" cy="0" r="0.75"/> \t\t\t\t<circle cx="7.79" cy="4.5" r="0.75"/> \t\t\t</g> \t\t</svg>');\n\t--instrument-copy-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-5 -21 26 26"><path d="M 0 -15 L 1 -15 L 1 0 L 13 0 L 13 1 L 0 1 L 0 -15 z M 2 -1 L 2 -17 L 10 -17 L 14 -13 L 14 -1 z M 3 -2 L 13 -2 L 13 -12 L 9 -12 L 9 -16 L 3 -16 z" fill="currentColor"></path></svg>');\n\t--instrument-paste-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"><path d="M 8 18 L 6 18 L 6 5 L 17 5 L 17 7 M 9 8 L 16 8 L 20 12 L 20 22 L 9 22 z" stroke="currentColor" fill="none"></path><path d="M 9 3 L 14 3 L 14 6 L 9 6 L 9 3 z M 16 8 L 20 12 L 16 12 L 16 8 z" fill="currentColor"></path></svg>');\n\t--export-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -8 3 L -8 8 L 8 8 L 8 3 L 6 3 L 6 6 L -6 6 L -6 3 z M 0 2 L -4 -2 L -1 -2 L -1 -8 L 1 -8 L 1 -2 L 4 -2 z"/></svg>');\n\t--close-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -7.07 -5.66 L -5.66 -7.07 L 0 -1.4 L 5.66 -7.07 L 7.07 -5.66 L 1.4 0 L 7.07 5.66 L 5.66 7.07 L 0 1.4 L -5.66 7.07 L -7.07 5.66 L -1.4 0 z"/></svg>');\n\t--add-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -8 -1 L -1 -1 L -1 -8  L 1 -8 L 1 -1 L 8 -1 L 8 1 L 1 1 L 1 8 L -1 8 L -1 1 L -8 1 z"/></svg>');\n\t--zoom-in-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="-10 -10 20 20"><circle cx="-1" cy="-1" r="6" stroke-width="2" stroke="gray" fill="none"></circle><path stroke="gray" stroke-width="2" d="M 3 3 L 7 7 M -1 -4 L -1 2 M -4 -1 L 2 -1" fill="none"></path></svg>');\n\t--zoom-out-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="-10 -10 20 20"><circle cx="-1" cy="-1" r="6" stroke-width="2" stroke="gray" fill="none"></circle><path stroke="gray" stroke-width="2" d="M 3 3 L 7 7 M -4 -1 L 2 -1" fill="none"></path></svg>');\n\t--checkmark-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -9 -2 L -8 -3 L -3 2 L 9 -8 L 10 -7 L -3 8 z"/></svg>');\n\t--drum-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 32 40"> \t\t\t<defs> \t\t\t\t<linearGradient id="gold1" x1="0%" y1="0%" x2="100%" y2="0%"> \t\t\t\t\t<stop offset="0%" stop-color="%237e3302"/> \t\t\t\t\t<stop offset="40%" stop-color="%23ffec6b"/> \t\t\t\t\t<stop offset="100%" stop-color="%237e3302"/> \t\t\t\t</linearGradient> \t\t\t\t<linearGradient id="gold2" x1="0%" y1="0%" x2="100%" y2="0%"> \t\t\t\t\t<stop offset="0%" stop-color="%23faaf7d"/> \t\t\t\t\t<stop offset="15%" stop-color="%23fffba9"/> \t\t\t\t\t<stop offset="40%" stop-color="%23ffffe3"/> \t\t\t\t\t<stop offset="65%" stop-color="%23fffba9"/> \t\t\t\t\t<stop offset="100%" stop-color="%23faaf7d"/> \t\t\t\t</linearGradient> \t\t\t\t<radialGradient id="gold3" cx="0%" cy="0%" r="100%"> \t\t\t\t\t<stop offset="0%" stop-color="%23ffffe3"/> \t\t\t\t\t<stop offset="50%" stop-color="%23ffec6b"/> \t\t\t\t\t<stop offset="100%" stop-color="%237e3302"/> \t\t\t\t</radialGradient> \t\t\t\t<linearGradient id="red" x1="0%" y1="0%" x2="100%" y2="0%"> \t\t\t\t\t<stop offset="0%" stop-color="%23641919"/> \t\t\t\t\t<stop offset="40%" stop-color="%23cd2c2c"/> \t\t\t\t\t<stop offset="100%" stop-color="%23641919"/> \t\t\t\t</linearGradient> \t\t\t\t<radialGradient id="membrane"> \t\t\t\t\t<stop offset="10%" stop-color="%23cccccc" /> \t\t\t\t\t<stop offset="90%" stop-color="%23f6f6f7" /> \t\t\t\t\t<stop offset="100%" stop-color="%23999" /> \t\t\t\t</radialGradient> \t\t\t</defs> \t\t\t<ellipse cx="16" cy="26" rx="16" ry="14" fill="rgba(0,0,0,0.5)"/> \t\t\t<ellipse cx="16" cy="25" rx="16" ry="14" fill="url(%23gold1)"/> \t\t\t<rect x="0" y="23" width="32" height="2" fill="url(%23gold1)"/> \t\t\t<ellipse cx="16" cy="23" rx="16" ry="14" fill="url(%23gold2)"/> \t\t\t<ellipse cx="16" cy="23" rx="15" ry="13" fill="url(%23red)"/> \t\t\t<rect x="1" y="17" width="30" height="6" fill="url(%23red)"/> \t\t\t<rect x="5" y="27" width="1" height="5" rx="0.5" fill="rgba(0,0,0,0.5)"/> \t\t\t<rect x="15" y="31" width="2" height="5" rx="1" fill="rgba(0,0,0,0.5)"/> \t\t\t<rect x="26" y="27" width="1" height="5" rx="0.5" fill="rgba(0,0,0,0.5)"/> \t\t\t<rect x="5" y="26" width="1" height="5" rx="0.5" fill="url(%23gold3)"/> \t\t\t<rect x="15" y="30" width="2" height="5" rx="1" fill="url(%23gold3)"/> \t\t\t<rect x="26" y="26" width="1" height="5" rx="0.5" fill="url(%23gold3)"/> \t\t\t<ellipse cx="16" cy="18" rx="15" ry="13" fill="rgba(0,0,0,0.5)"/> \t\t\t<ellipse cx="16" cy="16" rx="16" ry="14" fill="url(%23gold1)"/> \t\t\t<rect x="0" y="14" width="32" height="2" fill="url(%23gold1)"/> \t\t\t<ellipse cx="16" cy="14" rx="16" ry="14" fill="url(%23gold2)"/> \t\t\t<ellipse cx="16" cy="14" rx="15" ry="13" fill="url(%23membrane)"/> \t\t</svg>');\n\t--piano-key-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="15" preserveAspectRatio="none" viewBox="0 -1 32 15"> \t\t\t<defs> \t\t\t\t<linearGradient id="shadow" x1="0%" y1="0%" x2="100%" y2="0%"> \t\t\t\t\t<stop offset="0%" stop-color="rgba(0,0,0,0.5)"/> \t\t\t\t\t<stop offset="100%" stop-color="transparent"/> \t\t\t\t</linearGradient> \t\t\t</defs> \t\t\t<rect x="-1" y="1" width="31" height="1" rx="0.6" fill="rgba(255,255,255,0.4)"/> \t\t\t<path d="M -1 11 L 30 11 L 30 2 L 33 -1 L 33 14 L -1 14 z" fill="rgba(0,0,0,0.7)"/> \t\t\t<rect x="-1" y="-1" width="19" height="15" fill="url(%23shadow)"/> \t\t</svg>');\n}\n\n\n.obtrusive-scrollbars, .obtrusive-scrollbars * {\n\tscrollbar-width: thin;\n\tscrollbar-color: ${$.uiWidgetBackground} ${$.editorBackground};\n}\n.obtrusive-scrollbars::-webkit-scrollbar, .obtrusive-scrollbars *::-webkit-scrollbar {\n\twidth: 12px;\n}\n.obtrusive-scrollbars::-webkit-scrollbar-track, .obtrusive-scrollbars *::-webkit-scrollbar-track {\n\tbackground: ${$.editorBackground};\n}\n.obtrusive-scrollbars::-webkit-scrollbar-thumb, .obtrusive-scrollbars *::-webkit-scrollbar-thumb {\n\tbackground-color: ${$.uiWidgetBackground};\n\tborder: 3px solid ${$.editorBackground};\n}\n\n\n.beepboxEditor {\n\tdisplay: grid;\n    grid-template-columns: minmax(0, 1fr) max-content;\n    grid-template-rows: max-content 1fr; /* max-content minmax(0, 1fr); Chrome 80 grid layout regression. https://bugs.chromium.org/p/chromium/issues/detail?id=1050307 */\n    grid-template-areas: "pattern-area settings-area" "track-area settings-area";\n\tgrid-column-gap: 6px;\n\tgrid-row-gap: 6px;\n\tposition: relative;\n\ttouch-action: manipulation;\n\tcursor: default;\n\tfont-size: 13px;\n\toverflow: hidden;\n\tcolor: ${$.primaryText};\n\tbackground: ${$.editorBackground};\n}\n\n.beepboxEditor .noSelection {\n\t-webkit-touch-callout: none;\n\t-webkit-user-select: none;\n\t-moz-user-select: none;\n\t-ms-user-select: none;\n\tuser-select: none;\n}\n\n.beepboxEditor div {\n\tmargin: 0;\n\tpadding: 0;\n}\n\n.beepboxEditor .pattern-area {\n\tgrid-area: pattern-area;\n\theight: 481px;\n\tdisplay: flex;\n\tflex-direction: row;\n\tposition: relative;\n}\n\n.beepboxEditor .track-area {\n\tgrid-area: track-area;\n}\n\n.beepboxEditor .loopEditor {\n\theight: 20px;\n\tposition: sticky;\n\tbottom: 0;\n\tpadding: 5px 0;\n\tbackground-color: ${$.editorBackground};\n}\n\n.beepboxEditor .settings-area {\n\tgrid-area: settings-area;\n\tdisplay: grid;\n    grid-template-columns: auto;\n    grid-template-rows: min-content min-content min-content min-content min-content;\n    grid-template-areas: "version-area" "play-pause-area" "menu-area" "song-settings-area" "instrument-settings-area";\n\tgrid-column-gap: 6px;\n}\n\n.beepboxEditor .version-area{ grid-area: version-area; }\n.beepboxEditor .play-pause-area{ grid-area: play-pause-area; }\n.beepboxEditor .menu-area{ grid-area: menu-area; }\n.beepboxEditor .song-settings-area{ grid-area: song-settings-area; }\n.beepboxEditor .instrument-settings-area{ grid-area: instrument-settings-area; }\n\n.beepboxEditor .tip {\n\tcursor: help;\n\tcolor: ${$.secondaryText};\n\ttext-decoration: none;\n}\n\n.beepboxEditor .tip:hover {\n\tcolor: ${$.linkAccent};\n\ttext-decoration: underline;\n}\n.beepboxEditor .tip:active {\n\tcolor: ${$.primaryText};\n}\n\n.beepboxEditor .volume-speaker {\n\tflex-shrink: 0;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: ${$.secondaryText};\n\t-webkit-mask-image: var(--volume-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--volume-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .drum-button {\n\tflex: 1;\n\tbackground-color: transparent;\n\tbackground-image: var(--drum-symbol);\n\tbackground-repeat: no-repeat;\n\tbackground-position: center;\n}\n\n.beepboxEditor .piano-button {\n\tflex: 1;\n\tposition: relative;\n\tdisplay: flex;\n\talign-items: center;\n}\n.beepboxEditor .piano-button::before {\n\tcontent: "";\n\tposition: absolute;\n\tleft: 0;\n\ttop: 0;\n\twidth: 100%;\n\theight: 100%;\n\tpointer-events: none;\n\tbackground-image: var(--piano-key-symbol);\n\tbackground-repeat: no-repeat;\n\tbackground-position: center;\n\tbackground-size: 100% 115.38%;\n}\n.beepboxEditor .piano-button.disabled::after {\n\tcontent: "";\n\tposition: absolute;\n\tright: 0;\n\ttop: 0;\n\twidth: 70%;\n\theight: 100%;\n\tpointer-events: none;\n\tbackground: ${$.editorBackground};\n\t-webkit-mask-image: linear-gradient(90deg, transparent 0%, gray 70%, gray 100%);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: linear-gradient(90deg, transparent 0%, gray 70%, gray 100%);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .customize-instrument {\n\tmargin: 2px 0;\n}\n.beepboxEditor .customize-instrument::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--customize-dial-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--customize-dial-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .instrumentCopyPasteRow {\n\tgap: 2px;\n}\n\n.beepboxEditor .copy-instrument {\n\tmargin: 2px 0;\n\tflex-grow: 1;\n}\n.beepboxEditor .copy-instrument::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--instrument-copy-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--instrument-copy-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .paste-instrument {\n\tmargin: 2px 0;\n\tflex-grow: 1;\n}\n.beepboxEditor .paste-instrument::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--instrument-paste-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--instrument-paste-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .envelopeEditor {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .envelope-row {\n\tdisplay: flex;\n\tmargin: 2px 0;\n\tgap: 2px;\n}\n\n.beepboxEditor .add-envelope {\n\twidth: var(--button-size);\n}\n.beepboxEditor .add-envelope::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--add-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--add-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n.beepboxEditor .add-envelope:disabled {\n\tvisibility: hidden;\n}\n\n.beepboxEditor .effects-menu {\n\twidth: var(--button-size);\n\tposition: relative;\n}\n.beepboxEditor .effects-menu::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--menu-down-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--menu-down-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor .zoomInButton, .beepboxEditor .zoomOutButton {\n\twidth: var(--button-size);\n\tposition: absolute;\n\tright: 10px;\n}\n.beepboxEditor .zoomInButton {\n\ttop: 10px;\n}\n.beepboxEditor .zoomOutButton {\n\ttop: 50px;\n}\n.beepboxEditor .zoomInButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--zoom-in-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--zoom-in-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n.beepboxEditor .zoomOutButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--zoom-out-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--zoom-out-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor .delete-envelope {\n\twidth: var(--button-size);\n\tflex-shrink: 0;\n\tflex-grow: 0;\n}\n.beepboxEditor .delete-envelope::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--close-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--close-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n.beepboxEditor .delete-envelope:disabled {\n\tvisibility: hidden;\n}\n\n.beepboxEditor .menu.file::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--file-page-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--file-page-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .menu.edit::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--edit-pencil-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--edit-pencil-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .menu.preferences::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--preferences-gear-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--preferences-gear-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor .mute-button::before {\n\tcontent: "";\n\tpointer-events: none;\n\twidth: 100%;\n\theight: 100%;\n\tbackground: ${$.primaryText};\n\tdisplay: inline-block;\n\t-webkit-mask-image: var(--unmuted-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\t-webkit-mask-size: contain;\n\tmask-image: var(--unmuted-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\tmask-size: contain;\n}\n\n.beepboxEditor .mute-button.muted::before {\n\tbackground: ${$.editorBackground};\n\t-webkit-mask-image: var(--muted-symbol);\n\tmask-image: var(--muted-symbol);\n}\n\n.beepboxEditor .promptContainer {\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\twidth: 100%;\n\theight: 100%;\n\tdisplay: flex;\n\tjustify-content: center;\n\talign-items: center;\n\tz-index: 100;\n}\n\n.beepboxEditor .promptContainer::before {\n\tcontent: "";\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\twidth: 100%;\n\theight: 100%;\n\tbackground: ${$.editorBackground};\n\topacity: 0.5;\n\tdisplay: flex;\n}\n\n.beepboxEditor .prompt {\n\tmargin: auto;\n\ttext-align: center;\n\tbackground: ${$.editorBackground};\n\tborder-radius: 15px;\n\tborder: 4px solid ${$.uiWidgetBackground};\n\tcolor: ${$.primaryText};\n\tpadding: 20px;\n\tdisplay: flex;\n\tflex-direction: column;\n\tposition: relative;\n\tbox-shadow: 5px 5px 20px 10px rgba(0,0,0,0.5);\n}\n\n.beepboxEditor .prompt > *:not(:first-child):not(.cancelButton) {\n\tmargin-top: 1.5em;\n}\n\n.beepboxEditor .prompt h2 {\n\tfont-size: 2em;\n\tmargin: 0 16px;\n\tfont-weight: normal;\n}\n\n.beepboxEditor .prompt p {\n\ttext-align: left;\n\tmargin: 1em 0;\n}\n\n.beepboxEditor .layout-option {\n\tdisplay: flex;\n\tflex-direction: column;\n\tflex: 1;\n\tcursor: pointer;\n\tcolor: ${$.secondaryText};\n}\n\n.beepboxEditor .layout-option input {\n\tdisplay: none;\n}\n\n.beepboxEditor .layout-option input:checked ~ * {\n\tcolor: ${$.primaryText};\n}\n\n.beepboxEditor .selectContainer {\n\tposition: relative;\n}\n.beepboxEditor .selectContainer:not(.menu)::after {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tright: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: 14px;\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--select-arrows-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--select-arrows-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n.beepboxEditor .selectContainer.menu::after {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tright: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--menu-down-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--menu-down-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n.beepboxEditor select {\n\tmargin: 0;\n\tpadding: 0 4px;\n\tdisplay: block;\n\theight: var(--button-size);\n\tborder: none;\n\tborder-radius: 5px;\n\tbackground: ${$.uiWidgetBackground};\n\tcolor: inherit;\n\tfont-size: inherit;\n\tcursor: pointer;\n\tfont-family: inherit;\n\tfont-weight: inherit;\n\n\t-webkit-appearance:none;\n\t-moz-appearance: none;\n\tappearance: none;\n}\n.beepboxEditor .menu select {\n\tpadding: 0 var(--button-size);\n}\n.beepboxEditor select:focus {\n\tbackground: ${$.uiWidgetFocus};\n\toutline: none;\n}\n.beepboxEditor .menu select {\n\ttext-align: center;\n\ttext-align-last: center;\n}\n.beepboxEditor .settings-area select {\n       width: 100%;\n}\n\n/* This makes it look better in firefox on my computer... What about others?\n@-moz-document url-prefix() {\n\t.beepboxEditor select { padding: 0 2px; }\n}\n*/\n.beepboxEditor button {\n\tmargin: 0;\n\tposition: relative;\n\theight: var(--button-size);\n\tborder: none;\n\tborder-radius: 5px;\n\tbackground: ${$.uiWidgetBackground};\n\tcolor: inherit;\n\tfont-size: inherit;\n\tfont-family: inherit;\n\tfont-weight: inherit;\n\tcursor: pointer;\n}\n.beepboxEditor button:focus {\n\tbackground: ${$.uiWidgetFocus};\n\toutline: none;\n}\n\n.beepboxEditor button.cancelButton {\n\tfloat: right;\n\twidth: var(--button-size);\n\tposition: absolute;\n\ttop: 8px;\n\tright: 8px;\n}\n\n.beepboxEditor button.playButton, .beepboxEditor button.pauseButton, .beepboxEditor button.okayButton, .beepboxEditor button.exportButton {\n\tpadding-left: var(--button-size);\n}\n.beepboxEditor button.playButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--play-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--play-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n.beepboxEditor button.pauseButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 0;\n\ttop: 50%;\n\ttransform: translateY(-50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--pause-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--pause-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor button.prevBarButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 50%;\n\ttop: 50%;\n\ttransform: translate(-50%, -50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--prev-bar-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--prev-bar-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor button.nextBarButton::before {\n\tcontent: "";\n\tflex-shrink: 0;\n\tposition: absolute;\n\tleft: 50%;\n\ttop: 50%;\n\ttransform: translate(-50%, -50%);\n\tpointer-events: none;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--next-bar-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--next-bar-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor button.cancelButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--close-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--close-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor button.okayButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\t-webkit-mask-image: var(--checkmark-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n\tmask-image: var(--checkmark-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n}\n\n.beepboxEditor button.exportButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: var(--button-size);\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--export-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--export-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor .instrument-bar {\n\tdisplay: flex;\n\tgap: 2px;\n}\n\n.beepboxEditor .instrument-bar button {\n\tflex-grow: 1;\n\tmin-width: 0;\n\tpadding: 0;\n\tflex-basis: 0;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\tcolor: var(--text-color-lit);\n}\n\n.beepboxEditor .instrument-bar .remove-instrument, .beepboxEditor .instrument-bar .add-instrument {\n\tmax-width: var(--button-size);\n}\n\n.beepboxEditor .instrument-bar > :not(:first-child) {\n\tborder-top-left-radius: 0;\n\tborder-bottom-left-radius: 0;\n}\n\n.beepboxEditor .instrument-bar > :not(.last-button) {\n\tborder-top-right-radius: 0;\n\tborder-bottom-right-radius: 0;\n}\n\n.beepboxEditor .instrument-bar .selected-instrument {\n\tbackground: var(--background-color-lit);\n\tcolor: ${$.invertedText};\n}\n\n.beepboxEditor .instrument-bar .deactivated {\n\tbackground: ${$.editorBackground};\n\tcolor: var(--text-color-dim);\n}\n\n.beepboxEditor .instrument-bar .deactivated.selected-instrument {\n\tbackground: var(--background-color-dim);\n\tcolor: ${$.invertedText};\n}\n\n.beepboxEditor .instrument-bar .remove-instrument::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: 100%;\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--close-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--close-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor .instrument-bar .add-instrument::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: 100%;\n\theight: var(--button-size);\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground: currentColor;\n\tmask-image: var(--add-symbol);\n\tmask-repeat: no-repeat;\n\tmask-position: center;\n\t-webkit-mask-image: var(--add-symbol);\n\t-webkit-mask-repeat: no-repeat;\n\t-webkit-mask-position: center;\n}\n\n.beepboxEditor canvas {\n\toverflow: hidden;\n\tposition: absolute;\n\tdisplay: block;\n}\n\n.beepboxEditor .trackContainer {\n\tflex-grow: 1;\n}\n\n.beepboxEditor .trackAndMuteContainer {\n\tdisplay: flex;\n\talign-items: flex-start;\n\twidth: 100%;\n\tmin-height: 0;\n\tflex: 1;\n\toverflow-x: hidden;\n\tposition: relative;\n}\n\n.beepboxEditor .muteEditor {\n\twidth: 32px;\n\tflex-shrink: 0;\n\tdisplay: flex;\n\tflex-direction: column;\n\talign-items: stretch;\n\tposition: sticky;\n\tleft: 0;\n\tz-index: 1;\n\tbackground: ${$.editorBackground};\n}\n\n.beepboxEditor .selectRow, .beepboxEditor .instrumentCopyPasteRow {\n\tmargin: 2px 0;\n\theight: var(--button-size);\n\tdisplay: flex;\n\tflex-direction: row;\n\talign-items: center;\n\tjustify-content: space-between;\n}\n\n.beepboxEditor .selectRow > :last-child {\n\twidth: 62.5%;\n\tflex-shrink: 0;\n}\n\n.beepboxEditor .menu-area {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n.beepboxEditor .menu-area > * {\n\tmargin: 2px 0;\n}\n.beepboxEditor .menu-area > button {\n\tpadding: 0 var(--button-size);\n\twhite-space: nowrap;\n}\n\n.beepboxEditor .song-settings-area {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .editor-controls {\n\tflex-shrink: 0;\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .instrument-settings-area {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .editor-right-side-top > *, .beepboxEditor .editor-right-side-bottom > * {\n\tflex-shrink: 0;\n}\n\n.beepboxEditor .pitchShiftMarkerContainer {\n\tbox-sizing: border-box;\n\tdisplay: flex;\n\theight: 100%;\n\tleft: 3px;\n\tright: 3px;\n\tposition: absolute;\n\talign-items: center;\n\tpointer-events: none;\n}\n\n.beepboxEditor .pitchShiftMarker {\n\twidth: 0;\n\theight: 0;\n\tposition: absolute;\n}\n\n.beepboxEditor .pitchShiftMarker::before {\n\tcontent: "";\n\twidth: 2px;\n\theight: 20px;\n\ttransform: translate(-50%, -50%);\n\tposition: absolute;\n\tbackground: currentColor;\n\tborder-radius: 3px;\n}\n\n.beepboxEditor input[type=text], .beepboxEditor input[type=number] {\n\tfont-size: inherit;\n\tfont-weight: inherit;\n\tfont-family: inherit;\n\tbackground: transparent;\n\tborder: 1px solid ${$.uiWidgetFocus};\n\tcolor: ${$.primaryText};\n}\n\n.beepboxEditor input[type=text]::selection, .beepboxEditor input[type=number]::selection {\n\tbackground-color: ${$.textSelection};\n\tcolor: ${$.primaryText};\n}\n\n.beepboxEditor input[type=checkbox] {\n  transform: scale(1.5);\n}\n\n.beepboxEditor input[type=range] {\n\t-webkit-appearance: none;\n\tcolor: inherit;\n\twidth: 100%;\n\theight: var(--button-size);\n\tfont-size: inherit;\n\tmargin: 0;\n\tcursor: pointer;\n\tbackground: none;\n\ttouch-action: pan-y;\n}\n.beepboxEditor input[type=range]:focus {\n\toutline: none;\n}\n.beepboxEditor input[type=range]::-webkit-slider-runnable-track {\n\twidth: 100%;\n\theight: 6px;\n\tcursor: pointer;\n\tbackground: ${$.uiWidgetBackground};\n}\n.beepboxEditor input[type=range]::-webkit-slider-thumb {\n\theight: var(--button-size);\n\twidth: 6px;\n\tborder-radius: 3px;\n\tbackground: currentColor;\n\tcursor: pointer;\n\t-webkit-appearance: none;\n\tmargin-top: -10px;\n}\n.beepboxEditor input[type=range]:focus::-webkit-slider-runnable-track {\n\tbackground: ${$.uiWidgetFocus};\n}\n.beepboxEditor input[type=range]::-moz-range-track {\n\twidth: 100%;\n\theight: 6px;\n\tcursor: pointer;\n\tbackground: ${$.uiWidgetBackground};\n}\n.beepboxEditor input[type=range]:focus::-moz-range-track {\n\tbackground: ${$.uiWidgetFocus};\n}\n.beepboxEditor input[type=range]::-moz-range-thumb {\n\theight: var(--button-size);\n\twidth: 6px;\n\tborder-radius: 3px;\n\tborder: none;\n\tbackground: currentColor;\n\tcursor: pointer;\n}\n.beepboxEditor input[type=range]::-ms-track {\n\twidth: 100%;\n\theight: 6px;\n\tcursor: pointer;\n\tbackground: ${$.uiWidgetBackground};\n\tborder-color: transparent;\n}\n.beepboxEditor input[type=range]:focus::-ms-track {\n\tbackground: ${$.uiWidgetFocus};\n}\n.beepboxEditor input[type=range]::-ms-thumb {\n\theight: var(--button-size);\n\twidth: 6px;\n\tborder-radius: 3px;\n\tbackground: currentColor;\n\tcursor: pointer;\n}\n\n/* wide screen */\n@media (min-width: 711px) {\n\t#beepboxEditorContainer {\n\t\tdisplay: table;\n\t}\n\t.beepboxEditor {\n\t\tflex-direction: row;\n\t}\n\t.beepboxEditor:focus-within {\n\t\toutline: 3px solid ${$.uiWidgetBackground};\n\t}\n\t.beepboxEditor .trackAndMuteContainer {\n\t\twidth: 512px;\n\t}\n\t.beepboxEditor .play-pause-area {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t}\n\t.beepboxEditor .playback-bar-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tmargin: 2px 0;\n\t}\n\t.beepboxEditor .playback-volume-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tmargin: 2px 0;\n\t\talign-items: center;\n\t}\n\t.beepboxEditor .pauseButton, .beepboxEditor .playButton {\n\t\tflex-grow: 1;\n\t}\n\t.beepboxEditor .nextBarButton, .beepboxEditor .prevBarButton {\n\t\tflex-grow: 1;\n\t\tmargin-left: 10px;\n\t}\n\t.beepboxEditor .settings-area {\n\t\twidth: var(--settings-area-width);\n\t}\n}\n\n/* narrow screen */\n@media (max-width: 710px) {\n\t.beepboxEditor {\n\t\tgrid-template-columns: minmax(0, 1fr);\n\t\tgrid-template-rows: min-content 6px min-content min-content;\n\t\tgrid-template-areas: "pattern-area" "." "track-area" "settings-area";\n\t\tgrid-row-gap: 0;\n\t}\n\t.beepboxEditor .settings-area {\n\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\n\t\tgrid-template-rows: min-content min-content 1fr min-content;\n\t\tgrid-template-areas:\n\t\t\t"play-pause-area play-pause-area"\n\t\t\t"menu-area instrument-settings-area"\n\t\t\t"song-settings-area instrument-settings-area"\n\t\t\t"version-area version-area";\n\t\tgrid-column-gap: 8px;\n\t\tmargin: 0 4px;\n\t}\n\t.beepboxEditor:focus-within {\n\t\toutline: none;\n\t}\n\t.beepboxEditor .pattern-area {\n\t\tmax-height: 75vh;\n\t}\n\t.beepboxEditor .trackAndMuteContainer {\n\t\toverflow-x: auto;\n\t}\n\t.beepboxEditor .barScrollBar {\n\t\tdisplay: none;\n\t}\n\t.beepboxEditor .play-pause-area {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tmargin: 2px 0;\n\t}\n\t.beepboxEditor .playback-bar-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tflex-grow: 1;\n\t}\n\t.beepboxEditor .playback-volume-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\talign-items: center;\n\t\tflex-grow: 1;\n\t\tmargin: 0 2px;\n\t}\n\t.beepboxEditor .pauseButton, .beepboxEditor .playButton,\n\t.beepboxEditor .nextBarButton, .beepboxEditor .prevBarButton {\n\t\tflex-grow: 1;\n\t\tmargin: 0 2px;\n\t}\n}\n\n`));class U{static setLayout(t){this.h.textContent=this.l[t]}}function V(t,e){for(let i=0;i<t.length;i++)t[i]*=e}function W(t){if(!function(t){return!(!t||t&t-1)}(t))throw new Error("FFT array length must be a power of 2.");return Math.round(Math.log(t)/Math.log(2))}function j(t,e){const i=W(e);if(e<4)throw new Error("FFT array length must be at least 4.");for(let s=i-1;s>=2;s--){const i=1<<s,n=i>>1,o=i<<1,r=2*Math.PI/o,h=Math.cos(r),a=Math.sin(r),l=2*h;for(let s=0;s<e;s+=o){const e=s,o=e+n,r=e+i,c=r+n,u=r+i,f=t[e],p=t[r];t[e]=f+p,t[o]*=2,t[r]=f-p,t[c]*=2;let d=h,m=-a,y=1,g=0;for(let i=1;i<n;i++){const s=e+i,n=r-i,o=r+i,h=u-i,a=t[s],c=t[n],f=t[o],p=t[h],b=a-c,v=f+p;t[s]=a+c,t[n]=p-f,t[o]=b*d-v*m,t[h]=v*d+b*m;const w=l*d-y,k=l*m-g;y=d,g=m,d=w,m=k}}}for(let i=0;i<e;i+=4){const e=i+1,s=i+2,n=i+3,o=t[i],r=2*t[e],h=t[s],a=2*t[n],l=o+h,c=o-h;t[i]=l+r,t[e]=l-r,t[s]=c+a,t[n]=c-a}!function(t,e){const i=W(e);if(i>16)throw new Error("FFT array length must not be greater than 2^16.");const s=16-i;for(let i=0;i<e;i++){let e;if(e=(43690&i)>>1|(21845&i)<<1,e=(52428&e)>>2|(13107&e)<<2,e=(61680&e)>>4|(3855&e)<<4,e=(e>>8|(255&e)<<8)>>s,e>i){let s=t[i];t[i]=t[e],t[e]=s}}}(t,e)}U.l={small:"",long:`\t\t\t/* long layout */\n\t\t\t@media (min-width: 711px) {\n\t\t\t\t#beepboxEditorContainer {\n\t\t\t\t\tmax-width: initial;\n\t\t\t\t\theight: 100vh;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100vh;\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) 390px; /* minmax(0, 1fr) min-content; Chrome 80 grid layout regression. https://bugs.chromium.org/p/chromium/issues/detail?id=1050307 */\n\t\t\t\t\tgrid-template-rows: minmax(481px, 1fr) minmax(0, min-content);\n\t\t\t\t\tgrid-template-areas: "pattern-area settings-area" "track-area track-area";\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .pattern-area {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100%;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .track-area {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\tflex-direction: column;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\tmin-height: 0;\n\t\t\t\t\tflex: 1;\n\t\t\t\t\toverflow: auto;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .instrument-settings-area {\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t\tposition: relative;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .instrument-settings-area > .editor-controls {\n\t\t\t\t\tposition: absolute;\n\t\t\t\t\twidth: 100%;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .song-settings-area {\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.beepboxEditor .settings-area {\n\t\t\t\t\twidth: 390px;\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\n\t\t\t\t\tgrid-template-rows: auto auto auto minmax(0, 1fr);\n\t\t\t\t\tgrid-template-areas:\n\t\t\t\t\t\t"instrument-settings-area version-area"\n\t\t\t\t\t\t"instrument-settings-area play-pause-area"\n\t\t\t\t\t\t"instrument-settings-area menu-area"\n\t\t\t\t\t\t"instrument-settings-area song-settings-area";\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.beepboxEditor .barScrollBar {\n\t\t\t\t\tdisplay: none;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackContainer {\n\t\t\t\t\toverflow: visible;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\n\t\t\t\t\tscrollbar-width: auto;\n\t\t\t\t\tscrollbar-color: ${$.uiWidgetBackground} ${$.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar {\n\t\t\t\t\twidth: 20px;\n\t\t\t\t\theight: 20px;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-track {\n\t\t\t\t\tbackground: ${$.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-thumb {\n\t\t\t\t\tbackground-color: ${$.uiWidgetBackground};\n\t\t\t\t\tborder: 3px solid ${$.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-corner {\n\t\t\t\t\tbackground-color: ${$.editorBackground};\n\t\t\t\t}\n\t\t\t}\n\t\t`,tall:`\t\t\t/* tall layout */\n\t\t\t@media (min-width: 711px) {\n\t\t\t\t#beepboxEditorContainer {\n\t\t\t\t\tmax-width: initial;\n\t\t\t\t\theight: 100vh;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100vh;\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr) 192px;\n\t\t\t\t\tgrid-template-rows: 1fr;\n\t\t\t\t\tgrid-template-areas: "track-area pattern-area settings-area";\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .pattern-area {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100%;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .track-area {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100%;\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\tflex-direction: column;\n\t\t\t\t\tjustify-content: center;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\tmin-height: 0;\n\t\t\t\t\tflex: 0;\n\t\t\t\t\toverflow: auto;\n\t\t\t\t\tflex-basis: initial;\n\t\t\t\t\tflex-grow: 0;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .instrument-settings-area > .editor-controls {\n\t\t\t\t\tposition: absolute;\n\t\t\t\t\twidth: 100%;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.beepboxEditor .settings-area {\n\t\t\t\t\twidth: 192px;\n\t\t\t\t\tposition: relative;\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr);\n\t\t\t\t\tgrid-template-rows: auto auto auto auto minmax(0, 1fr);\n\t\t\t\t\tgrid-template-areas:\n\t\t\t\t\t\t"version-area"\n\t\t\t\t\t\t"play-pause-area"\n\t\t\t\t\t\t"menu-area"\n\t\t\t\t\t\t"song-settings-area"\n\t\t\t\t\t\t"instrument-settings-area";\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .version-area {\n\t\t\t\t\tposition: sticky;\n\t\t\t\t\ttop: 0;\n\t\t\t\t\tz-index: 1;\n\t\t\t\t\tbackground: ${$.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .play-pause-area {\n\t\t\t\t\tposition: sticky;\n\t\t\t\t\ttop: 22px;\n\t\t\t\t\tz-index: 1;\n\t\t\t\t\tbackground: ${$.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .menu-area {\n\t\t\t\t\tposition: sticky;\n\t\t\t\t\ttop: 82px;\n\t\t\t\t\tz-index: 1;\n\t\t\t\t\tbackground: ${$.editorBackground};\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.beepboxEditor .barScrollBar {\n\t\t\t\t\tdisplay: none;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackContainer {\n\t\t\t\t\toverflow: visible;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\n\t\t\t\t\tscrollbar-width: auto;\n\t\t\t\t\tscrollbar-color: ${$.uiWidgetBackground} ${$.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar {\n\t\t\t\t\twidth: 20px;\n\t\t\t\t\theight: 20px;\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-track {\n\t\t\t\t\tbackground: ${$.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-thumb {\n\t\t\t\t\tbackground-color: ${$.uiWidgetBackground};\n\t\t\t\t\tborder: 3px solid ${$.editorBackground};\n\t\t\t\t}\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-corner {\n\t\t\t\t\tbackground-color: ${$.editorBackground};\n\t\t\t\t}\n\t\t\t}\n\t\t`},U.h=document.head.appendChild(z.style({type:"text/css"}));class J{constructor(){this.u=1,this.m=[void 0],this.v=0,this.k=0,this.M=0}pushFront(t){this.M>=this.u&&this.S(),this.k=this.k-1&this.v,this.m[this.k]=t,this.M++}pushBack(t){this.M>=this.u&&this.S(),this.m[this.k+this.M&this.v]=t,this.M++}popFront(){if(this.M<=0)throw new Error("No elements left to pop.");const t=this.m[this.k];return this.m[this.k]=void 0,this.k=this.k+1&this.v,this.M--,t}popBack(){if(this.M<=0)throw new Error("No elements left to pop.");this.M--;const t=this.k+this.M&this.v,e=this.m[t];return this.m[t]=void 0,e}peakFront(){if(this.M<=0)throw new Error("No elements left to pop.");return this.m[this.k]}peakBack(){if(this.M<=0)throw new Error("No elements left to pop.");return this.m[this.k+this.M-1&this.v]}count(){return this.M}set(t,e){if(t<0||t>=this.M)throw new Error("Invalid index");this.m[this.k+t&this.v]=e}get(t){if(t<0||t>=this.M)throw new Error("Invalid index");return this.m[this.k+t&this.v]}remove(t){if(t<0||t>=this.M)throw new Error("Invalid index");if(t<=this.M>>1){for(;t>0;)this.set(t,this.get(t-1)),t--;this.popFront()}else{for(t++;t<this.M;)this.set(t-1,this.get(t)),t++;this.popBack()}}S(){if(this.u>=1073741824)throw new Error("Capacity too big.");this.u=this.u<<1;const t=this.m,e=new Array(this.u),i=0|this.M,s=0|this.k;for(let n=0;n<i;n++)e[n]=t[s+n&this.v];for(let t=i;t<this.u;t++)e[t]=void 0;this.k=0,this.m=e,this.v=this.u-1}}class Y{constructor(){this.a=[1],this.b=[1],this.order=0}linearGain0thOrder(t){this.b[0]=t,this.order=0}lowPass1stOrderButterworth(t){const e=1/Math.tan(.5*t),i=1+e;this.a[1]=(1-e)/i,this.b[1]=this.b[0]=1/i,this.order=1}lowPass1stOrderSimplified(t){const e=2*Math.sin(.5*t);this.a[1]=e-1,this.b[0]=e,this.b[1]=0,this.order=1}highPass1stOrderButterworth(t){const e=1/Math.tan(.5*t),i=1+e;this.a[1]=(1-e)/i,this.b[0]=e/i,this.b[1]=-e/i,this.order=1}highShelf1stOrder(t,e){const i=Math.tan(.5*t),s=Math.sqrt(e),n=(i*s-1)/(i*s+1);this.a[1]=n/1,this.b[0]=(1+n+e*(1-n))/2,this.b[1]=(1+n-e*(1-n))/2,this.order=1}allPass1stOrderInvertPhaseAbove(t){const e=(Math.sin(t)-1)/Math.cos(t);this.a[1]=e,this.b[0]=e,this.b[1]=1,this.order=1}allPass1stOrderFractionalDelay(t){const e=(1-t)/(1+t);this.a[1]=e,this.b[0]=e,this.b[1]=1,this.order=1}lowPass2ndOrderButterworth(t,e){const i=Math.sin(t)/(2*e),s=Math.cos(t),n=1+i;this.a[1]=-2*s/n,this.a[2]=(1-i)/n,this.b[2]=this.b[0]=(1-s)/(2*n),this.b[1]=(1-s)/n,this.order=2}lowPass2ndOrderSimplified(t,e){const i=2*Math.sin(t/2),s=1-1/(2*e),n=s+s/(1-i);this.a[1]=2*i+(i-1)*i*n-2,this.a[2]=(i-1)*(i-i*n-1),this.b[0]=i*i,this.b[1]=0,this.b[2]=0,this.order=2}highPass2ndOrderButterworth(t,e){const i=Math.sin(t)/(2*e),s=Math.cos(t),n=1+i;this.a[1]=-2*s/n,this.a[2]=(1-i)/n,this.b[2]=this.b[0]=(1+s)/(2*n),this.b[1]=-(1+s)/n,this.order=2}peak2ndOrder(t,e,i){const s=Math.sqrt(e),n=i*t/(s>=1?s:1/s),o=Math.tan(.5*n),r=1+o/s;this.b[0]=(1+o*s)/r,this.b[1]=this.a[1]=-2*Math.cos(t)/r,this.b[2]=(1-o*s)/r,this.a[2]=(1-o/s)/r,this.order=2}}class K{constructor(){this.real=0,this.imag=0,this.denom=1}analyze(t,e){this.analyzeComplex(t,Math.cos(e),Math.sin(e))}analyzeComplex(t,e,i){const s=t.a,n=t.b,o=e,r=-i;let h=n[0]+n[1]*o,a=n[1]*r,l=1+s[1]*o,c=s[1]*r,u=o,f=r;for(let e=2;e<=t.order;e++){const t=u*r+f*o;u=u*o-f*r,f=t,h+=n[e]*u,a+=n[e]*f,l+=s[e]*u,c+=s[e]*f}this.denom=l*l+c*c,this.real=h*l+a*c,this.imag=a*l-h*c}magnitude(){return Math.sqrt(this.real*this.real+this.imag*this.imag)/this.denom}angle(){return Math.atan2(this.imag,this.real)}}class Q{constructor(){this.a1=0,this.a2=0,this.b0=1,this.b1=0,this.b2=0,this.a1Delta=0,this.a2Delta=0,this.b0Delta=0,this.b1Delta=0,this.b2Delta=0,this.output1=0,this.output2=0,this.useMultiplicativeInputCoefficients=!1}resetOutput(){this.output1=0,this.output2=0}loadCoefficientsWithGradient(t,e,i,s){if(2!=t.order||2!=e.order)throw new Error;this.a1=t.a[1],this.a2=t.a[2],this.b0=t.b[0],this.b1=t.b[1],this.b2=t.b[2],this.a1Delta=(e.a[1]-t.a[1])*i,this.a2Delta=(e.a[2]-t.a[2])*i,s?(this.b0Delta=Math.pow(e.b[0]/t.b[0],i),this.b1Delta=Math.pow(e.b[1]/t.b[1],i),this.b2Delta=Math.pow(e.b[2]/t.b[2],i)):(this.b0Delta=(e.b[0]-t.b[0])*i,this.b1Delta=(e.b[1]-t.b[1])*i,this.b2Delta=(e.b[2]-t.b[2])*i),this.useMultiplicativeInputCoefficients=s}}const Z=1e-24,X=[48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,45,95],tt=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,62,0,0,1,2,3,4,5,6,7,8,9,0,0,0,0,0,0,0,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,0,0,0,0,63,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,0,0,0,0,0];class et{constructor(t,e,i){this.P=[],this.I=0;for(let s=e;s<i;s++){const e=tt[t.charCodeAt(s)];this.P.push(e>>5&1),this.P.push(e>>4&1),this.P.push(e>>3&1),this.P.push(e>>2&1),this.P.push(e>>1&1),this.P.push(1&e)}}read(t){let e=0;for(;t>0;)e<<=1,e+=this.P[this.I++],t--;return e}readLongTail(t,e){let i=t,s=e;for(;this.P[this.I++];)i+=1<<s,s++;for(;s>0;)s--,this.P[this.I++]&&(i+=1<<s);return i}readPartDuration(){return this.readLongTail(1,3)}readLegacyPartDuration(){return this.readLongTail(1,2)}readPinCount(){return this.readLongTail(1,0)}readPitchInterval(){return this.read(1)?-this.readLongTail(1,3):this.readLongTail(1,3)}}class it{constructor(){this.q=0,this.P=[]}clear(){this.q=0}write(t,e){for(t--;t>=0;)this.P[this.q++]=e>>>t&1,t--}writeLongTail(t,e,i){if(i<t)throw new Error("value out of bounds");i-=t;let s=e;for(;i>=1<<s;)this.P[this.q++]=1,i-=1<<s,s++;for(this.P[this.q++]=0;s>0;)s--,this.P[this.q++]=i>>>s&1}writePartDuration(t){this.writeLongTail(1,3,t)}writePinCount(t){this.writeLongTail(1,0,t)}writePitchInterval(t){t<0?(this.write(1,1),this.writeLongTail(1,3,-t)):(this.write(1,0),this.writeLongTail(1,3,t))}concat(t){for(let e=0;e<t.q;e++)this.P[this.q++]=t.P[e]}encodeBase64(t){for(let e=0;e<this.q;e+=6){const i=this.P[e]<<5|this.P[e+1]<<4|this.P[e+2]<<3|this.P[e+3]<<2|this.P[e+4]<<1|this.P[e+5];t.push(X[i])}return t}lengthBase64(){return Math.ceil(this.q/6)}}function st(t,e,i){return{interval:t,time:e,size:i}}function nt(t,e,i){return i<=(e-=1)?i>=t?i:t:e}function ot(t,e,i){if(t<=i&&i<=e)return i;throw new Error(`Value ${i} not in range [${t}, ${e}]`)}class rt{constructor(t,e,i,s,n=!1){this.pitches=[t],this.pins=[st(0,0,s),st(0,i-e,n?0:s)],this.start=e,this.end=i,this.continuesLastPattern=!1}pickMainInterval(){let t=0,e=0;for(let i=1;i<this.pins.length;i++){const s=this.pins[i-1],n=this.pins[i];if(s.interval==n.interval){const i=n.time-s.time;t<i&&(t=i,e=s.interval)}}if(0==t){let t=0;for(let i=0;i<this.pins.length;i++){const s=this.pins[i];t<s.size&&(t=s.size,e=s.interval)}}return e}clone(){const t=new rt(-1,this.start,this.end,e.noteSizeMax);t.pitches=this.pitches.concat(),t.pins=[];for(const e of this.pins)t.pins.push(st(e.interval,e.time,e.size));return t.continuesLastPattern=this.continuesLastPattern,t}getEndPinIndex(t){let e;for(e=1;e<this.pins.length-1&&!(this.pins[e].time+this.start>t);e++);return e}}class ht{constructor(){this.notes=[],this.instruments=[0]}cloneNotes(){const t=[];for(const e of this.notes)t.push(e.clone());return t}reset(){this.notes.length=0,this.instruments[0]=0,this.instruments.length=1}}class at{constructor(t){this.frequency=0,this.amplitude=0,this.reset(t)}reset(t){this.frequency=0,this.amplitude=t<=1?e.operatorAmplitudeMax:0}}class lt{constructor(t){this.spectrum=[],this.T=null,this.L=!1,this.reset(t)}reset(t){for(let i=0;i<e.spectrumControlPoints;i++)if(t)this.spectrum[i]=Math.round(e.spectrumMax*(1/Math.sqrt(1+i/3)));else{const t=0==i||7==i||11==i||14==i||16==i||18==i||21==i||23==i||i>=25;this.spectrum[i]=t?Math.max(0,Math.round(e.spectrumMax*(1-i/30))):0}this.L=!1}markCustomWaveDirty(){this.L=!1}getCustomWave(t){if(this.L)return this.T;const i=e.spectrumNoiseLength;null!=this.T&&this.T.length==i+1||(this.T=new Float32Array(i+1));const s=this.T;for(let t=0;t<i;t++)s[t]=0;const n=[0,1/7,Math.log2(5/4),3/7,Math.log2(1.5),5/7,6/7];function o(i){return t+Math.floor(i/e.spectrumControlPointsPerOctave)+n[(i+e.spectrumControlPointsPerOctave)%e.spectrumControlPointsPerOctave]}let h=1;for(let t=0;t<e.spectrumControlPoints+1;t++){const n=t<=0?0:this.spectrum[t-1],a=t>=e.spectrumControlPoints?this.spectrum[e.spectrumControlPoints-1]:this.spectrum[t],l=o(t-1);let c=o(t);t>=e.spectrumControlPoints&&(c=14+.25*(c-14)),0==n&&0==a||(h+=.02*r(s,i,l,c,n/e.spectrumMax,a/e.spectrumMax,-.5))}return this.spectrum[e.spectrumControlPoints-1]>0&&(h+=.02*r(s,i,14+.25*(o(e.spectrumControlPoints)-14),14,this.spectrum[e.spectrumControlPoints-1]/e.spectrumMax,0,-.5)),j(s,i),V(s,5/(Math.sqrt(i)*Math.pow(h,.75))),s[i]=s[0],this.L=!0,s}}class ct{constructor(){this.harmonics=[],this.T=null,this.L=!1,this.reset()}reset(){for(let t=0;t<e.harmonicsControlPoints;t++)this.harmonics[t]=0;this.harmonics[0]=e.harmonicsMax,this.harmonics[3]=e.harmonicsMax,this.harmonics[6]=e.harmonicsMax,this.L=!1}markCustomWaveDirty(){this.L=!1}getCustomWave(t){this.R!=t&&(this.R=t,this.L=!1);const i=7==t?e.harmonicsRenderedForPickedString:e.harmonicsRendered;if(this.L)return this.T;const n=e.harmonicsWavelength,r=o(0,null,null);null!=this.T&&this.T.length==n+1||(this.T=new Float32Array(n+1));const h=this.T;for(let t=0;t<n;t++)h[t]=0;let a=1;for(let t=0;t<i;t++){const s=t+1;let o=t<e.harmonicsControlPoints?this.harmonics[t]:this.harmonics[e.harmonicsControlPoints-1];t>=e.harmonicsControlPoints&&(o*=1-(t-e.harmonicsControlPoints)/(i-e.harmonicsControlPoints));const l=o/e.harmonicsMax;let c=Math.pow(2,o-e.harmonicsMax+1)*Math.sqrt(l);t<e.harmonicsControlPoints&&(a+=c),c*=Math.pow(s,-.25),c*=r[t+589],h[n-s]=c}j(h,n);const l=1/Math.pow(a,.7);for(let t=0;t<h.length;t++)h[t]*=l;return s(h),h[n]=h[0],this.L=!0,h}}class ut{constructor(){this.freq=0,this.gain=e.filterGainCenter,this.type=2}set(t,e){this.freq=t,this.gain=e}getHz(){return ut.getHzFromSettingValue(this.freq)}static getHzFromSettingValue(t){return e.filterFreqReferenceHz*Math.pow(2,(t-e.filterFreqReferenceSetting)*e.filterFreqStep)}static getSettingValueFromHz(t){return Math.log2(t/e.filterFreqReferenceHz)/e.filterFreqStep+e.filterFreqReferenceSetting}static getRoundedSettingValueFromHz(t){return Math.max(0,Math.min(e.filterFreqRange-1,Math.round(ut.getSettingValueFromHz(t))))}getLinearGain(t=1){const i=(this.gain-e.filterGainCenter)*e.filterGainStep,s=2==this.type?0:-.5,n=s+(i-s)*t;return Math.pow(2,n)}static getRoundedSettingValueFromLinearGain(t){return Math.max(0,Math.min(e.filterGainRange-1,Math.round(Math.log2(t)/e.filterGainStep+e.filterGainCenter)))}toCoefficients(t,i,s=1,n=1){const o=2*Math.PI*Math.max(e.filterFreqMinHz,Math.min(e.filterFreqMaxHz,s*this.getHz()))/i,r=this.getLinearGain(n);switch(this.type){case 0:t.lowPass2ndOrderButterworth(o,r);break;case 1:t.highPass2ndOrderButterworth(o,r);break;case 2:t.peak2ndOrder(o,r,1);break;default:throw new Error}}getVolumeCompensationMult(){const t=(this.freq-e.filterFreqReferenceSetting)*e.filterFreqStep,i=(this.gain-e.filterGainCenter)*e.filterGainStep;switch(this.type){case 0:const s=Math.pow(2,t)*e.filterFreqReferenceHz/8e3,n=(Math.sqrt(1+4*s)-1)/2,o=Math.log2(n);return Math.pow(.5,.2*Math.max(0,i+1)+Math.min(0,Math.max(-3,.595*o+.35*Math.min(0,i+1))));case 1:return Math.pow(.5,.125*Math.max(0,i+1)+Math.min(0,.3*(-t-Math.log2(e.filterFreqReferenceHz/125))+.2*Math.min(0,i+1)));case 2:const r=t+Math.log2(e.filterFreqReferenceHz/2e3),h=Math.pow(1/(1+Math.pow(r/3,2)),2);return Math.pow(.5,.125*Math.max(0,i)+.1*h*Math.min(0,i));default:throw new Error}}}class ft{constructor(){this.controlPoints=[],this.controlPointCount=0,this.reset()}reset(){this.controlPointCount=0}addPoint(t,e,i){let s;this.controlPoints.length<=this.controlPointCount?(s=new ut,this.controlPoints[this.controlPointCount]=s):s=this.controlPoints[this.controlPointCount],this.controlPointCount++,s.type=t,s.set(e,i)}toJsonObject(){const t=[];for(let i=0;i<this.controlPointCount;i++){const s=this.controlPoints[i];t.push({type:e.filterTypeNames[s.type],cutoffHz:Math.round(100*s.getHz())/100,linearGain:Math.round(1e4*s.getLinearGain())/1e4})}return t}fromJsonObject(t){if(this.controlPoints.length=0,t)for(const i of t){const t=new ut;t.type=e.filterTypeNames.indexOf(i.type),-1==t.type&&(t.type=2),null!=i.cutoffHz?t.freq=ut.getRoundedSettingValueFromHz(i.cutoffHz):t.freq=0,null!=i.linearGain?t.gain=ut.getRoundedSettingValueFromLinearGain(i.linearGain):t.gain=e.filterGainCenter,this.controlPoints.push(t)}this.controlPointCount=this.controlPoints.length}convertLegacySettings(t,e,i){this.reset();const s=2*Math.asin(.475),n=e>1,o=0==e,r=10==t,h=3==i.type||4==i.type||8==i.type||0==i.type,a=48e3,l=8e3*Math.pow(2,.5*(t-10)),c=Math.min(s,2*Math.PI*l/a);if(1==i.type&&!n&&r);else if(o){const t=3.5,e=c*Math.pow(2,t),i=a*(e/(1+e/Math.PI))/(2*Math.PI),s=ut.getRoundedSettingValueFromHz(i),n=ut.getHzFromSettingValue(s),o=2*Math.PI*n/a,r=new Y;r.lowPass1stOrderSimplified(c);const l=new K;l.analyze(r,o);const u=l.magnitude();let f=Math.log2(u);f=.82*(f+t)-t,h&&(f=Math.min(f,-1));const p=Math.pow(2,f),d=ut.getRoundedSettingValueFromLinearGain(p);this.addPoint(0,s,d)}else{const t=.5/(1-.95*Math.sqrt(Math.max(0,e-1)/6)),i=.5/t,s=c+(c*(c/(2*Math.PI*8e3/a)*Math.pow(i,.9)+1)-c)*i;let o;o=h?a*Math.min(s,c*Math.pow(2,.25))/(2*Math.PI):a*s/(2*Math.PI);const r=ut.getRoundedSettingValueFromHz(o);let l;if(h)l=t;else{const e=new Y;e.lowPass2ndOrderSimplified(c,t);const i=new K;i.analyze(e,s),l=i.magnitude()}n||(l=Math.min(l,Math.sqrt(.5)));const u=ut.getRoundedSettingValueFromLinearGain(l);this.addPoint(0,r,u)}}}class pt{constructor(){this.target=0,this.index=0,this.envelope=0,this.reset()}reset(){this.target=0,this.index=0,this.envelope=0}toJsonObject(){const t={target:e.instrumentAutomationTargets[this.target].name,envelope:e.envelopes[this.envelope].name};return e.instrumentAutomationTargets[this.target].maxCount>1&&(t.index=this.index),t}fromJsonObject(t){this.reset();let i=e.instrumentAutomationTargets.dictionary[t.target];null==i&&(i=e.instrumentAutomationTargets.dictionary.noteVolume),this.target=i.index;let s=e.envelopes.dictionary[t.envelope];null==s&&(s=e.envelopes.dictionary.none),this.envelope=s.index,null!=t.index?this.index=nt(0,e.instrumentAutomationTargets[this.target].maxCount,0|t.index):this.index=0}}class dt{constructor(t){this.type=0,this.preset=0,this.chipWave=2,this.chipNoise=1,this.eqFilter=new ft,this.noteFilter=new ft,this.envelopes=[],this.envelopeCount=0,this.fadeIn=0,this.fadeOut=e.fadeOutNeutral,this.transition=e.transitions.dictionary.normal.index,this.pitchShift=0,this.detune=0,this.vibrato=0,this.unison=0,this.effects=0,this.chord=1,this.volume=0,this.pan=e.panCenter,this.pulseWidth=e.pulseWidthRange-1,this.stringSustain=10,this.distortion=0,this.bitcrusherFreq=0,this.bitcrusherQuantization=0,this.chorus=0,this.reverb=0,this.echoSustain=0,this.echoDelay=0,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.operators=[],this.harmonicsWave=new ct,this.drumsetEnvelopes=[],this.drumsetSpectrumWaves=[],this.spectrumWave=new lt(t);for(let t=0;t<e.operatorCount;t++)this.operators[t]=new at(t);for(let t=0;t<e.drumCount;t++)this.drumsetEnvelopes[t]=e.envelopes.dictionary["twang 2"].index,this.drumsetSpectrumWaves[t]=new lt(!0)}setTypeAndReset(t,i){switch(this.type=t,this.preset=t,this.volume=0,this.effects=0,this.chorus=e.chorusRange-1,this.reverb=2,this.echoSustain=Math.floor(.5*(e.echoSustainRange-1)),this.echoDelay=Math.floor(.5*(e.echoDelayRange-1)),this.eqFilter.reset(),this.noteFilter.reset(),this.distortion=Math.floor(.75*(e.distortionRange-1)),this.bitcrusherFreq=Math.floor(.5*(e.bitcrusherFreqRange-1)),this.bitcrusherQuantization=Math.floor(.5*(e.bitcrusherQuantizationRange-1)),this.pan=e.panCenter,this.pitchShift=e.pitchShiftCenter,this.detune=e.detuneCenter,this.vibrato=0,this.unison=0,this.stringSustain=10,this.fadeIn=0,this.fadeOut=e.fadeOutNeutral,this.transition=e.transitions.dictionary.normal.index,this.envelopeCount=0,t){case 0:this.chipWave=2,this.chord=e.chords.dictionary.arpeggio.index;break;case 1:this.chord=e.chords.dictionary["custom interval"].index,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0;for(let t=0;t<this.operators.length;t++)this.operators[t].reset(t);break;case 2:this.chipNoise=1,this.chord=e.chords.dictionary.arpeggio.index;break;case 3:this.chord=e.chords.dictionary.simultaneous.index,this.spectrumWave.reset(i);break;case 4:this.chord=e.chords.dictionary.simultaneous.index;for(let t=0;t<e.drumCount;t++)this.drumsetEnvelopes[t]=e.envelopes.dictionary["twang 2"].index,this.drumsetSpectrumWaves[t].reset(i);break;case 5:this.chord=e.chords.dictionary.simultaneous.index,this.harmonicsWave.reset();break;case 6:this.chord=e.chords.dictionary.arpeggio.index,this.pulseWidth=e.pulseWidthRange-1;break;case 7:this.chord=e.chords.dictionary.strum.index,this.harmonicsWave.reset();break;default:throw new Error("Unrecognized instrument type: "+t)}this.chord!=e.chords.dictionary.simultaneous.index&&(this.effects=2048|this.effects)}convertLegacySettings(t){let i=t.filterCutoff,s=t.filterResonance,n=t.filterEnvelope,o=t.pulseEnvelope,r=t.operatorEnvelopes,h=t.feedbackEnvelope;null==i&&(i=0==this.type?6:10),null==s&&(s=0),null==n&&(n=e.envelopes.dictionary.none),null==o&&(o=e.envelopes.dictionary[6==this.type?"twang 2":"none"]),null==r&&(r=[e.envelopes.dictionary[1==this.type?"note size":"none"],e.envelopes.dictionary.none,e.envelopes.dictionary.none,e.envelopes.dictionary.none]),null==h&&(h=e.envelopes.dictionary.none);const a=e.algorithms[this.algorithm].carrierCount;let l=!0,c=!0,u=0==n.type||0==o.type;if(1==this.type){u=u||0==h.type;for(let t=0;t<r.length;t++)t<a?0!=r[t].type?c=!1:l=!1:u=u||0==r[t].type}this.envelopeCount=0,1==this.type&&(c&&u?this.addEnvelope(e.instrumentAutomationTargets.dictionary.noteVolume.index,0,e.envelopes.dictionary["note size"].index):l&&!u&&this.addEnvelope(e.instrumentAutomationTargets.dictionary.none.index,0,e.envelopes.dictionary["note size"].index)),1==n.type?(this.noteFilter.reset(),this.eqFilter.convertLegacySettings(i,s,n),this.effects&=-33):(this.eqFilter.reset(),this.noteFilter.convertLegacySettings(i,s,n),this.effects|=32,this.addEnvelope(e.instrumentAutomationTargets.dictionary.noteFilterAllFreqs.index,0,n.index)),1!=o.type&&this.addEnvelope(e.instrumentAutomationTargets.dictionary.pulseWidth.index,0,o.index);for(let t=0;t<r.length;t++)t<a&&c||1!=r[t].type&&this.addEnvelope(e.instrumentAutomationTargets.dictionary.operatorAmplitude.index,t,r[t].index);1!=h.type&&this.addEnvelope(e.instrumentAutomationTargets.dictionary.feedbackAmplitude.index,0,h.index)}toJsonObject(){const t={type:e.instrumentTypeNames[this.type],volume:20*(5-this.volume),eqFilter:this.eqFilter.toJsonObject()};this.preset!=this.type&&(t.preset=this.preset);const i=[];for(const t of e.effectOrder)this.effects&1<<t&&i.push(e.effectNames[t]);if(t.effects=i,l(this.effects)&&(t.transition=e.transitions[this.transition].name),c(this.effects)&&(t.chord=this.getChord().name),u(this.effects)&&(t.pitchShiftSemitones=this.pitchShift),f(this.effects)&&(t.detuneCents=Mt.detuneToCents(this.detune-e.detuneCenter)),p(this.effects)&&(t.vibrato=e.vibratos[this.vibrato].name),d(this.effects)&&(t.noteFilter=this.noteFilter.toJsonObject()),m(this.effects)&&(t.distortion=Math.round(100*this.distortion/(e.distortionRange-1))),y(this.effects)&&(t.bitcrusherOctave=(e.bitcrusherFreqRange-1-this.bitcrusherFreq)*e.bitcrusherOctaveStep,t.bitcrusherQuantization=Math.round(100*this.bitcrusherQuantization/(e.bitcrusherQuantizationRange-1))),g(this.effects)&&(t.pan=Math.round(100*(this.pan-e.panCenter)/e.panCenter)),b(this.effects)&&(t.chorus=Math.round(100*this.chorus/(e.chorusRange-1))),v(this.effects)&&(t.echoSustain=Math.round(100*this.echoSustain/(e.echoSustainRange-1)),t.echoDelayBeats=Math.round(1e3*(this.echoDelay+1)*e.echoDelayStepTicks/(e.ticksPerPart*e.partsPerBeat))/1e3),w(this.effects)&&(t.reverb=Math.round(100*this.reverb/(e.reverbRange-1))),4!=this.type&&(t.fadeInSeconds=Math.round(1e4*Mt.fadeInSettingToSeconds(this.fadeIn))/1e4,t.fadeOutTicks=Mt.fadeOutSettingToTicks(this.fadeOut)),5==this.type||7==this.type){t.harmonics=[];for(let i=0;i<e.harmonicsControlPoints;i++)t.harmonics[i]=Math.round(100*this.harmonicsWave.harmonics[i]/e.harmonicsMax)}if(2==this.type)t.wave=e.chipNoises[this.chipNoise].name;else if(3==this.type){t.spectrum=[];for(let i=0;i<e.spectrumControlPoints;i++)t.spectrum[i]=Math.round(100*this.spectrumWave.spectrum[i]/e.spectrumMax)}else if(4==this.type){t.drums=[];for(let i=0;i<e.drumCount;i++){const s=[];for(let t=0;t<e.spectrumControlPoints;t++)s[t]=Math.round(100*this.drumsetSpectrumWaves[i].spectrum[t]/e.spectrumMax);t.drums[i]={filterEnvelope:this.getDrumsetEnvelope(i).name,spectrum:s}}}else if(0==this.type)t.wave=e.chipWaves[this.chipWave].name,t.unison=e.unisons[this.unison].name;else if(6==this.type)t.pulseWidth=Math.round(100*n(this.pulseWidth)*1e5)/1e5;else if(7==this.type)t.unison=e.unisons[this.unison].name,t.stringSustain=Math.round(100*this.stringSustain/(e.stringSustainRange-1));else if(5==this.type)t.unison=e.unisons[this.unison].name;else{if(1!=this.type)throw new Error("Unrecognized instrument type");{const i=[];for(const t of this.operators)i.push({frequency:e.operatorFrequencies[t.frequency].name,amplitude:t.amplitude});t.algorithm=e.algorithms[this.algorithm].name,t.feedbackType=e.feedbacks[this.feedbackType].name,t.feedbackAmplitude=this.feedbackAmplitude,t.operators=i}}const s=[];for(let t=0;t<this.envelopeCount;t++)s.push(this.envelopes[t].toJsonObject());return t.envelopes=s,t}fromJsonObject(t,i,s=0){null==t&&(t={});let n=e.instrumentTypeNames.indexOf(t.type);if(-1==n&&(n=i?2:0),this.setTypeAndReset(n,i),null!=t.preset&&(this.preset=t.preset>>>0),null!=t.volume?this.volume=nt(0,e.volumeRange,Math.round(5-(0|t.volume)/20)):this.volume=0,Array.isArray(t.effects)){let i=0;for(let s=0;s<t.effects.length;s++)i|=1<<e.effectNames.indexOf(t.effects[s]);this.effects=4095&i}else{const e=["none","reverb","chorus","chorus & reverb"];this.effects=e.indexOf(t.effects),-1==this.effects&&(this.effects=2==this.type?0:1)}this.transition=e.transitions.dictionary.normal.index;const o=t.transition||t.envelope;if(null!=o){let i=e.transitions.dictionary[o];if(null==t.fadeInSeconds||null==t.fadeOutTicks){const t={binary:{transition:"interrupt",fadeInSeconds:0,fadeOutTicks:-1},seamless:{transition:"interrupt",fadeInSeconds:0,fadeOutTicks:-1},sudden:{transition:"normal",fadeInSeconds:0,fadeOutTicks:-3},hard:{transition:"normal",fadeInSeconds:0,fadeOutTicks:-3},smooth:{transition:"normal",fadeInSeconds:.025,fadeOutTicks:-3},soft:{transition:"normal",fadeInSeconds:.025,fadeOutTicks:-3},slide:{transition:"slide in pattern",fadeInSeconds:.025,fadeOutTicks:-3},"cross fade":{transition:"normal",fadeInSeconds:.04,fadeOutTicks:6},"hard fade":{transition:"normal",fadeInSeconds:0,fadeOutTicks:48},"medium fade":{transition:"normal",fadeInSeconds:.0125,fadeOutTicks:72},"soft fade":{transition:"normal",fadeInSeconds:.06,fadeOutTicks:96}}[o];null!=t&&(i=e.transitions.dictionary[t.transition],this.fadeIn=Mt.secondsToFadeInSetting(t.fadeInSeconds),this.fadeOut=Mt.ticksToFadeOutSetting(t.fadeOutTicks))}null!=i&&(this.transition=i.index),this.transition!=e.transitions.dictionary.normal.index&&(this.effects=1024|this.effects)}null!=t.fadeInSeconds&&(this.fadeIn=Mt.secondsToFadeInSetting(+t.fadeInSeconds)),null!=t.fadeOutTicks&&(this.fadeOut=Mt.ticksToFadeOutSetting(+t.fadeOutTicks));{const i=t.chord,s={harmony:"simultaneous"},n=e.chords.dictionary[s[i]]||e.chords.dictionary[i];null!=n?this.chord=n.index:2==this.type?this.chord=e.chords.dictionary.arpeggio.index:7==this.type?this.chord=e.chords.dictionary.strum.index:0==this.type?this.chord=e.chords.dictionary.arpeggio.index:1==this.type?this.chord=e.chords.dictionary["custom interval"].index:this.chord=e.chords.dictionary.simultaneous.index}this.unison=e.unisons.dictionary.none.index;const r=t.unison||t.interval||t.chorus;if(null!=r){const t={union:"none",fifths:"fifth",octaves:"octave"},i=e.unisons.dictionary[t[r]]||e.unisons.dictionary[r];null!=i&&(this.unison=i.index)}"custom harmony"==t.chorus&&(this.unison=e.unisons.dictionary.hum.index,this.chord=e.chords.dictionary["custom interval"].index),this.chord==e.chords.dictionary.simultaneous.index||Array.isArray(t.effects)||(this.effects=2048|this.effects),null!=t.pitchShiftSemitones&&(this.pitchShift=nt(0,e.pitchShiftRange,Math.round(+t.pitchShiftSemitones))),null!=t.detuneCents&&(this.detune=nt(0,e.detuneMax+1,Math.round(e.detuneCenter+Mt.centsToDetune(+t.detuneCents)))),this.vibrato=e.vibratos.dictionary.none.index;const h=t.vibrato||t.effect;if(null!=h){const t={"vibrato light":"light","vibrato delayed":"delayed","vibrato heavy":"heavy"},i=e.vibratos.dictionary[t[r]]||e.vibratos.dictionary[h];null!=i&&(this.vibrato=i.index),i!=e.vibratos.dictionary.none&&(this.effects=512|this.effects)}if(null!=t.pan?(this.pan=nt(0,e.panMax+1,Math.round(e.panCenter+(0|t.pan)*e.panCenter/100)),this.pan!=e.panCenter&&(this.effects=4|this.effects)):this.pan=e.panCenter,null!=t.distortion&&(this.distortion=nt(0,e.distortionRange,Math.round((e.distortionRange-1)*(0|t.distortion)/100))),null!=t.bitcrusherOctave&&(this.bitcrusherFreq=e.bitcrusherFreqRange-1-+t.bitcrusherOctave/e.bitcrusherOctaveStep),null!=t.bitcrusherQuantization&&(this.bitcrusherQuantization=nt(0,e.bitcrusherQuantizationRange,Math.round((e.bitcrusherQuantizationRange-1)*(0|t.bitcrusherQuantization)/100))),null!=t.echoSustain&&(this.echoSustain=nt(0,e.echoSustainRange,Math.round((e.echoSustainRange-1)*(0|t.echoSustain)/100))),null!=t.echoDelayBeats&&(this.echoDelay=nt(0,e.echoDelayRange,Math.round(+t.echoDelayBeats*(e.ticksPerPart*e.partsPerBeat)/e.echoDelayStepTicks-1))),isNaN(t.chorus)||(this.chorus=nt(0,e.chorusRange,Math.round((e.chorusRange-1)*(0|t.chorus)/100))),null!=t.reverb?this.reverb=nt(0,e.reverbRange,Math.round((e.reverbRange-1)*(0|t.reverb)/100)):0==s?this.effects=-2&this.effects:this.reverb=s,null!=t.pulseWidth?this.pulseWidth=nt(0,e.pulseWidthRange,Math.round(Math.log2(+t.pulseWidth/50)/.5-1+8)):this.pulseWidth=e.pulseWidthRange-1,null!=t.harmonics)for(let i=0;i<e.harmonicsControlPoints;i++)this.harmonicsWave.harmonics[i]=Math.max(0,Math.min(e.harmonicsMax,Math.round(e.harmonicsMax*+t.harmonics[i]/100)));else this.harmonicsWave.reset();if(null!=t.spectrum)for(let i=0;i<e.spectrumControlPoints;i++)this.spectrumWave.spectrum[i]=Math.max(0,Math.min(e.spectrumMax,Math.round(e.spectrumMax*+t.spectrum[i]/100)));else this.spectrumWave.reset(i);null!=t.stringSustain?this.stringSustain=nt(0,e.stringSustainRange,Math.round((e.stringSustainRange-1)*(0|t.stringSustain)/100)):this.stringSustain=10,2==this.type&&(this.chipNoise=e.chipNoises.findIndex((e=>e.name==t.wave)),-1==this.chipNoise&&(this.chipNoise=1));const a={custom:"note size",steady:"none","pluck 1":"twang 1","pluck 2":"twang 2","pluck 3":"twang 3"},l=t=>null!=a[t]?e.envelopes.dictionary[a[t]]:e.envelopes.dictionary[t];if(4==this.type&&null!=t.drums)for(let i=0;i<e.drumCount;i++){const s=t.drums[i];if(null!=s){if(this.drumsetEnvelopes[i]=e.envelopes.dictionary["twang 2"].index,null!=s.filterEnvelope){const t=l(s.filterEnvelope);null!=t&&(this.drumsetEnvelopes[i]=t.index)}if(null!=s.spectrum)for(let t=0;t<e.spectrumControlPoints;t++)this.drumsetSpectrumWaves[i].spectrum[t]=Math.max(0,Math.min(e.spectrumMax,Math.round(e.spectrumMax*+s.spectrum[t]/100)))}}if(0==this.type){const i={triangle:1,square:2,"pulse wide":3,"pulse narrow":4,sawtooth:5,"double saw":6,"double pulse":7,spiky:8,plateau:0};this.chipWave=null!=i[t.wave]?i[t.wave]:e.chipWaves.findIndex((e=>e.name==t.wave)),-1==this.chipWave&&(this.chipWave=1)}if(1==this.type){this.algorithm=e.algorithms.findIndex((e=>e.name==t.algorithm)),-1==this.algorithm&&(this.algorithm=0),this.feedbackType=e.feedbacks.findIndex((e=>e.name==t.feedbackType)),-1==this.feedbackType&&(this.feedbackType=0),null!=t.feedbackAmplitude?this.feedbackAmplitude=nt(0,e.operatorAmplitudeMax+1,0|t.feedbackAmplitude):this.feedbackAmplitude=0;for(let i=0;i<e.operatorCount;i++){const s=this.operators[i];let n;null!=t.operators&&(n=t.operators[i]),null==n&&(n={}),s.frequency=e.operatorFrequencies.findIndex((t=>t.name==n.frequency)),-1==s.frequency&&(s.frequency=0),null!=n.amplitude?s.amplitude=nt(0,e.operatorAmplitudeMax+1,0|n.amplitude):s.amplitude=0}}if(null!=t.noteFilter?this.noteFilter.fromJsonObject(t.noteFilter):this.noteFilter.reset(),Array.isArray(t.eqFilter))this.eqFilter.fromJsonObject(t.eqFilter);else{this.eqFilter.reset();const i={},s=8e3,n=11,o=8;if(null!=t.filterCutoffHz?i.filterCutoff=nt(0,n,Math.round(n-1+2*Math.log((0|t.filterCutoffHz)/s)/Math.LN2)):i.filterCutoff=0==this.type?6:10,null!=t.filterResonance?i.filterResonance=nt(0,o,Math.round((o-1)*(0|t.filterResonance)/100)):i.filterResonance=0,i.filterEnvelope=l(t.filterEnvelope),i.pulseEnvelope=l(t.pulseEnvelope),i.feedbackEnvelope=l(t.feedbackEnvelope),Array.isArray(t.operators)){i.operatorEnvelopes=[];for(let s=0;s<e.operatorCount;s++){let n;null!=t.operators[s]&&(n=l(t.operators[s].envelope)),i.operatorEnvelopes[s]=null!=n?n:e.envelopes.dictionary.none}}if(null!=t.filter){const e=[10,6,3,0,8,5,2],s=["none","none","none","none","decay 1","decay 2","decay 3"],n=["none","bright","medium","soft","decay bright","decay medium","decay soft"],o={"sustain sharp":1,"sustain medium":2,"sustain soft":3,"decay sharp":4};let r=null!=o[t.filter]?o[t.filter]:n.indexOf(t.filter);-1==r&&(r=0),i.filterCutoff=e[r],i.filterEnvelope=l(s[r]),i.filterResonance=0}this.convertLegacySettings(i)}if(Array.isArray(t.envelopes)){const i=t.envelopes;for(let t=0;t<i.length&&!(this.envelopeCount>=e.maxEnvelopeCount);t++){const e=new pt;e.fromJsonObject(i[t]),this.addEnvelope(e.target,e.index,e.envelope)}}}static frequencyFromPitch(t){return 440*Math.pow(2,(t-69)/12)}static drumsetIndexReferenceDelta(t){return dt.frequencyFromPitch(e.spectrumBasePitch+6*t)/44100}static O(t){return 15+Math.log2(dt.drumsetIndexReferenceDelta(t))}addEnvelope(t,i,s){if(!this.supportsEnvelopeTarget(t,i))throw new Error;if(this.envelopeCount>=e.maxEnvelopeCount)throw new Error;for(;this.envelopes.length<=this.envelopeCount;)this.envelopes[this.envelopes.length]=new pt;const n=this.envelopes[this.envelopeCount];n.target=t,n.index=i,n.envelope=s,this.envelopeCount++}supportsEnvelopeTarget(t,i){const s=e.instrumentAutomationTargets[t];return!(i>=s.maxCount)&&((null==s.compatibleInstruments||-1!=s.compatibleInstruments.indexOf(this.type))&&((null==s.effect||0!=(this.effects&1<<s.effect))&&!(s.isFilter&&i>=this.noteFilter.controlPointCount)))}clearInvalidEnvelopeTargets(){for(let t=0;t<this.envelopeCount;t++){const i=this.envelopes[t].target,s=this.envelopes[t].index;this.supportsEnvelopeTarget(i,s)||(this.envelopes[t].target=e.instrumentAutomationTargets.dictionary.none.index,this.envelopes[t].index=0)}}warmUp(t){if(2==this.type)o(this.chipNoise,j,V);else if(5==this.type)this.harmonicsWave.getCustomWave(this.type);else if(7==this.type)this.harmonicsWave.getCustomWave(this.type);else if(3==this.type)this.spectrumWave.getCustomWave(8);else if(4==this.type)for(let t=0;t<e.drumCount;t++)this.drumsetSpectrumWaves[t].getCustomWave(dt.O(t))}getDrumWave(){if(2==this.type)return o(this.chipNoise,j,V);if(3==this.type)return this.spectrumWave.getCustomWave(8);throw new Error("Unhandled instrument type in getDrumWave")}getDrumsetWave(t){if(4==this.type)return this.drumsetSpectrumWaves[t].getCustomWave(dt.O(t));throw new Error("Unhandled instrument type in getDrumsetWave")}getTransition(){return l(this.effects)?e.transitions[this.transition]:e.transitions.dictionary.normal}getFadeInSeconds(){return 4==this.type?0:Mt.fadeInSettingToSeconds(this.fadeIn)}getFadeOutTicks(){return 4==this.type?e.drumsetFadeOutTicks:Mt.fadeOutSettingToTicks(this.fadeOut)}getChord(){return c(this.effects)?e.chords[this.chord]:e.chords.dictionary.simultaneous}getDrumsetEnvelope(t){if(4!=this.type)throw new Error("Can't getDrumsetEnvelope() for non-drumset.");return e.envelopes[this.drumsetEnvelopes[t]]}}class mt{constructor(){this.octave=0,this.instruments=[],this.patterns=[],this.bars=[],this.muted=!1}}class yt{constructor(t){this.channels=[],null!=t?this.fromBase64String(t):this.initToDefault(!0)}getChannelCount(){return this.pitchChannelCount+this.noiseChannelCount}getMaxInstrumentsPerChannel(){return Math.max(this.layeredInstruments?e.layeredInstrumentCountMax:e.instrumentCountMin,this.patternInstruments?e.patternInstrumentCountMax:e.instrumentCountMin)}getMaxInstrumentsPerPattern(t){return this.getMaxInstrumentsPerPatternForChannel(this.channels[t])}getMaxInstrumentsPerPatternForChannel(t){return this.layeredInstruments?Math.min(e.layeredInstrumentCountMax,t.instruments.length):1}getChannelIsNoise(t){return t>=this.pitchChannelCount}initToDefault(t=!0){if(this.scale=0,this.key=0,this.loopStart=0,this.loopLength=4,this.tempo=150,this.beatsPerBar=8,this.barCount=16,this.patternsPerChannel=8,this.rhythm=1,this.layeredInstruments=!1,this.patternInstruments=!1,t){this.pitchChannelCount=3,this.noiseChannelCount=1;for(let t=0;t<this.getChannelCount();t++){const i=t>=this.pitchChannelCount;this.channels.length<=t&&(this.channels[t]=new mt);const s=this.channels[t];s.octave=i?0:4-t;for(let t=0;t<this.patternsPerChannel;t++)s.patterns.length<=t?s.patterns[t]=new ht:s.patterns[t].reset();s.patterns.length=this.patternsPerChannel;for(let t=0;t<e.instrumentCountMin;t++)s.instruments.length<=t&&(s.instruments[t]=new dt(i)),s.instruments[t].setTypeAndReset(i?2:0,i);s.instruments.length=e.instrumentCountMin;for(let t=0;t<this.barCount;t++)s.bars[t]=t<4?1:0;s.bars.length=this.barCount}this.channels.length=this.getChannelCount()}}toBase64String(){let t,i=[];if(i.push(X[yt.N]),i.push(110,X[this.pitchChannelCount],X[this.noiseChannelCount]),i.push(115,X[this.scale]),i.push(107,X[this.key]),i.push(108,X[this.loopStart>>6],X[63&this.loopStart]),i.push(101,X[this.loopLength-1>>6],X[this.loopLength-1&63]),i.push(116,X[this.tempo>>6],X[63&this.tempo]),i.push(97,X[this.beatsPerBar-1]),i.push(103,X[this.barCount-1>>6],X[this.barCount-1&63]),i.push(106,X[this.patternsPerChannel-1>>6],X[this.patternsPerChannel-1&63]),i.push(114,X[this.rhythm]),i.push(105,X[this.layeredInstruments<<1|this.patternInstruments]),this.layeredInstruments||this.patternInstruments)for(let t=0;t<this.getChannelCount();t++)i.push(X[this.channels[t].instruments.length-e.instrumentCountMin]);i.push(111);for(let t=0;t<this.pitchChannelCount;t++)i.push(X[this.channels[t].octave]);for(let t=0;t<this.getChannelCount();t++)for(let s=0;s<this.channels[t].instruments.length;s++){const n=this.channels[t].instruments[s];i.push(84,X[n.type]),i.push(118,X[n.volume]),i.push(117,X[n.preset>>6],X[63&n.preset]),i.push(102,X[n.eqFilter.controlPointCount]);for(let t=0;t<n.eqFilter.controlPointCount;t++){const e=n.eqFilter.controlPoints[t];i.push(X[e.type],X[e.freq],X[e.gain])}if(i.push(113,X[n.effects>>6],X[63&n.effects]),d(n.effects)){i.push(X[n.noteFilter.controlPointCount]);for(let t=0;t<n.noteFilter.controlPointCount;t++){const e=n.noteFilter.controlPoints[t];i.push(X[e.type],X[e.freq],X[e.gain])}}if(l(n.effects)&&i.push(X[n.transition]),c(n.effects)&&i.push(X[n.chord]),u(n.effects)&&i.push(X[n.pitchShift]),f(n.effects)&&i.push(X[n.detune]),p(n.effects)&&i.push(X[n.vibrato]),m(n.effects)&&i.push(X[n.distortion]),y(n.effects)&&i.push(X[n.bitcrusherFreq],X[n.bitcrusherQuantization]),g(n.effects)&&i.push(X[n.pan]),b(n.effects)&&i.push(X[n.chorus]),v(n.effects)&&i.push(X[n.echoSustain],X[n.echoDelay]),w(n.effects)&&i.push(X[n.reverb]),4!=n.type&&i.push(100,X[n.fadeIn],X[n.fadeOut]),5==n.type||7==n.type){i.push(72);const t=new it;for(let i=0;i<e.harmonicsControlPoints;i++)t.write(e.harmonicsControlPointBits,n.harmonicsWave.harmonics[i]);t.encodeBase64(i)}if(0==n.type)i.push(119,X[n.chipWave]),i.push(104,X[n.unison]);else if(1==n.type){i.push(65,X[n.algorithm]),i.push(70,X[n.feedbackType]),i.push(66,X[n.feedbackAmplitude]),i.push(81);for(let t=0;t<e.operatorCount;t++)i.push(X[n.operators[t].frequency]);i.push(80);for(let t=0;t<e.operatorCount;t++)i.push(X[n.operators[t].amplitude])}else if(2==n.type)i.push(119,X[n.chipNoise]);else if(3==n.type){i.push(83);const t=new it;for(let i=0;i<e.spectrumControlPoints;i++)t.write(e.spectrumControlPointBits,n.spectrumWave.spectrum[i]);t.encodeBase64(i)}else if(4==n.type){i.push(122);for(let t=0;t<e.drumCount;t++)i.push(X[n.drumsetEnvelopes[t]]);i.push(83);const t=new it;for(let i=0;i<e.drumCount;i++)for(let s=0;s<e.spectrumControlPoints;s++)t.write(e.spectrumControlPointBits,n.drumsetSpectrumWaves[i].spectrum[s]);t.encodeBase64(i)}else if(5==n.type)i.push(104,X[n.unison]);else if(6==n.type)i.push(87,X[n.pulseWidth]);else{if(7!=n.type)throw new Error("Unknown instrument type.");i.push(104,X[n.unison]),i.push(73,X[n.stringSustain])}i.push(69,X[n.envelopeCount]);for(let t=0;t<n.envelopeCount;t++)i.push(X[n.envelopes[t].target]),e.instrumentAutomationTargets[n.envelopes[t].target].maxCount>1&&i.push(X[n.envelopes[t].index]),i.push(X[n.envelopes[t].envelope])}i.push(98),t=new it;let s=0;for(;1<<s<this.patternsPerChannel+1;)s++;for(let e=0;e<this.getChannelCount();e++)for(let i=0;i<this.barCount;i++)t.write(s,this.channels[e].bars[i]);t.encodeBase64(i),i.push(112),t=new it;const n=new it,o=yt.getNeededBits(e.noteSizeMax);for(let i=0;i<this.getChannelCount();i++){const s=this.channels[i],r=this.getMaxInstrumentsPerPattern(i),h=yt.getNeededBits(r-e.instrumentCountMin),a=yt.getNeededBits(s.instruments.length-1),l=this.getChannelIsNoise(i),c=l?0:s.octave*e.pitchesPerOctave;let u=l?4:c;const f=l?[4,6,7,2,3,8,0,10]:[0,7,12,19,24,-5,-12],p=[];for(let t=0;t<f.length;t++)f[t]+=c;for(const i of s.patterns){if(this.patternInstruments){const s=ot(e.instrumentCountMin,r,i.instruments.length);t.write(h,s-e.instrumentCountMin);for(let e=0;e<s;e++)t.write(a,i.instruments[e])}if(i.notes.length>0){t.write(1,1);let s=0;for(const r of i.notes){r.start>s&&(t.write(2,0),t.writePartDuration(r.start-s)),n.clear();for(let t=1;t<r.pitches.length;t++)n.write(1,1);r.pitches.length<e.maxChordSize&&n.write(1,0),n.writePinCount(r.pins.length-1),n.write(o,r.pins[0].size);let i=0,h=r.pitches[0],a=h;const l=[];for(let t=1;t<r.pins.length;t++){const e=r.pins[t],s=h+e.interval;a!=s?(n.write(1,1),l.push(s),a=s):n.write(1,0),n.writePartDuration(e.time-i),i=e.time,n.write(o,e.size)}const c=String.fromCharCode.apply(null,n.encodeBase64([])),d=p.indexOf(c);-1==d?(t.write(2,1),t.concat(n)):(t.write(1,1),t.writeLongTail(0,0,d),p.splice(d,1)),p.unshift(c),p.length>10&&p.pop();const m=r.pitches.concat(l);for(let e=0;e<m.length;e++){const i=m[e],s=f.indexOf(i);if(-1==s){let e=0,s=u;if(s<i)for(;s!=i;)s++,-1==f.indexOf(s)&&e++;else for(;s!=i;)s--,-1==f.indexOf(s)&&e--;t.write(1,0),t.writePitchInterval(e)}else t.write(1,1),t.write(3,s),f.splice(s,1);f.unshift(i),f.length>8&&f.pop(),u=e==r.pitches.length-1?r.pitches[0]:i}0==r.start&&t.write(1,r.continuesLastPattern?1:0),s=r.end}s<this.beatsPerBar*e.partsPerBeat&&(t.write(2,0),t.writePartDuration(this.beatsPerBar*e.partsPerBeat-s))}else t.write(1,0)}}let r=t.lengthBase64(),h=[];for(;r>0;)h.unshift(X[63&r]),r>>=6;i.push(X[h.length]),Array.prototype.push.apply(i,h),t.encodeBase64(i);const a=64e3;if(i.length<a)return String.fromCharCode.apply(null,i);{let t="";for(let e=0;e<i.length;e+=a)t+=String.fromCharCode.apply(null,i.slice(e,e+a));return t}}static H(t){return 0==t?t=1:1==t&&(t=0),e.envelopes[nt(0,e.envelopes.length,t)]}fromBase64String(t){if(null==t||""==t)return void this.initToDefault(!0);let i=0;for(;t.charCodeAt(i)<=32;)i++;if(35==t.charCodeAt(i)&&i++,123==t.charCodeAt(i))return void this.fromJsonObject(JSON.parse(0==i?t:t.substring(i)));const s=tt[t.charCodeAt(i++)];if(-1==s||s>yt.N||s<yt.$)return;const n=s<3,o=s<4,r=s<5,h=s<6,a=s<7,k=s<8,M=s<9;if(this.initToDefault(M),n){for(const t of this.channels)t.instruments[0].transition=e.transitions.dictionary.interrupt.index,t.instruments[0].effects|=1024;this.channels[3].instruments[0].chipNoise=0}let x=null;if(M){x=[];for(let t=x.length;t<this.getChannelCount();t++){x[t]=[];for(let i=0;i<e.instrumentCountMin;i++)x[t][i]={}}}let S,P=0,F=0,E=-1;for(;i<t.length;)switch(S=t.charCodeAt(i++)){case 110:this.pitchChannelCount=tt[t.charCodeAt(i++)],this.noiseChannelCount=tt[t.charCodeAt(i++)],this.pitchChannelCount=ot(e.pitchChannelCountMin,e.pitchChannelCountMax,this.pitchChannelCount),this.noiseChannelCount=ot(e.noiseChannelCountMin,e.noiseChannelCountMax,this.noiseChannelCount);for(let t=this.channels.length;t<this.getChannelCount();t++)this.channels[t]=new mt;if(this.channels.length=this.getChannelCount(),M)for(let t=x.length;t<this.getChannelCount();t++){x[t]=[];for(let i=0;i<e.instrumentCountMin;i++)x[t][i]={}}break;case 115:this.scale=tt[t.charCodeAt(i++)],n&&10==this.scale&&(this.scale=11);break;case 107:this.key=nt(0,e.keys.length,a?11-tt[t.charCodeAt(i++)]:tt[t.charCodeAt(i++)]);break;case 108:this.loopStart=r?tt[t.charCodeAt(i++)]:(tt[t.charCodeAt(i++)]<<6)+tt[t.charCodeAt(i++)];break;case 101:this.loopLength=r?tt[t.charCodeAt(i++)]:(tt[t.charCodeAt(i++)]<<6)+tt[t.charCodeAt(i++)]+1;break;case 116:this.tempo=o?[95,120,151,190][tt[t.charCodeAt(i++)]]:a?[88,95,103,111,120,130,140,151,163,176,190,206,222,240,259][tt[t.charCodeAt(i++)]]:tt[t.charCodeAt(i++)]<<6|tt[t.charCodeAt(i++)],this.tempo=nt(e.tempoMin,e.tempoMax+1,this.tempo);break;case 109:M&&(P=tt[t.charCodeAt(i++)],P=nt(0,4,P));break;case 97:this.beatsPerBar=n?[6,7,8,9,10][tt[t.charCodeAt(i++)]]:tt[t.charCodeAt(i++)]+1,this.beatsPerBar=Math.max(e.beatsPerBarMin,Math.min(e.beatsPerBarMax,this.beatsPerBar));break;case 103:{const s=(tt[t.charCodeAt(i++)]<<6)+tt[t.charCodeAt(i++)]+1;this.barCount=ot(e.barCountMin,e.barCountMax,s);for(let t=0;t<this.getChannelCount();t++){for(let e=this.channels[t].bars.length;e<this.barCount;e++)this.channels[t].bars[e]=1;this.channels[t].bars.length=this.barCount}}break;case 106:{let s;s=k?tt[t.charCodeAt(i++)]+1:(tt[t.charCodeAt(i++)]<<6)+tt[t.charCodeAt(i++)]+1,this.patternsPerChannel=ot(1,e.barCountMax,s);const n=this.getChannelCount();for(let t=0;t<n;t++){const e=this.channels[t].patterns;for(let t=e.length;t<this.patternsPerChannel;t++)e[t]=new ht;e.length=this.patternsPerChannel}}break;case 105:if(M){const s=ot(e.instrumentCountMin,e.patternInstrumentCountMax,tt[t.charCodeAt(i++)]+e.instrumentCountMin);this.layeredInstruments=!1,this.patternInstruments=s>1;for(let t=0;t<this.getChannelCount();t++){const e=t>=this.pitchChannelCount;for(let i=this.channels[t].instruments.length;i<s;i++)this.channels[t].instruments[i]=new dt(e);if(this.channels[t].instruments.length=s,h)for(let i=0;i<s;i++)this.channels[t].instruments[i].setTypeAndReset(e?2:0,e);for(let e=x[t].length;e<s;e++)x[t][e]={}}}else{const s=tt[t.charCodeAt(i++)];this.layeredInstruments=0!=(2&s),this.patternInstruments=0!=(1&s);for(let s=0;s<this.getChannelCount();s++){let n=1;(this.layeredInstruments||this.patternInstruments)&&(n=ot(e.instrumentCountMin,this.getMaxInstrumentsPerChannel(),tt[t.charCodeAt(i++)]+e.instrumentCountMin));const o=this.channels[s],r=this.getChannelIsNoise(s);for(let t=o.instruments.length;t<n;t++)o.instruments[t]=new dt(r);o.instruments.length=n}}break;case 114:this.rhythm=tt[t.charCodeAt(i++)];break;case 111:if(n){const s=tt[t.charCodeAt(i++)];this.channels[s].octave=nt(0,e.pitchOctaves,tt[t.charCodeAt(i++)]+1),s>=this.pitchChannelCount&&(this.channels[s].octave=0)}else if(M)for(let s=0;s<this.getChannelCount();s++)this.channels[s].octave=nt(0,e.pitchOctaves,tt[t.charCodeAt(i++)]+1),s>=this.pitchChannelCount&&(this.channels[s].octave=0);else for(let s=0;s<this.pitchChannelCount;s++)this.channels[s].octave=nt(0,e.pitchOctaves,tt[t.charCodeAt(i++)]);break;case 84:{E++,E>=this.channels[F].instruments.length&&(F++,E=0),ot(0,this.channels.length-1,F);const s=this.channels[F].instruments[E],n=ot(0,7,tt[t.charCodeAt(i++)]);s.setTypeAndReset(n,F>=this.pitchChannelCount),a&&(s.effects=0,P>0&&!this.getChannelIsNoise(F)&&(s.reverb=P,s.effects|=1),s.chord!=e.chords.dictionary.simultaneous.index&&(s.effects|=2048))}break;case 117:{const e=tt[t.charCodeAt(i++)]<<6|tt[t.charCodeAt(i++)];this.channels[F].instruments[E].preset=e}break;case 119:if(n){const s=[1,2,3,4,5,6,7,8,0],n=tt[t.charCodeAt(i++)],o=this.channels[n].instruments[0];o.chipWave=nt(0,e.chipWaves.length,0|s[tt[t.charCodeAt(i++)]]),o.convertLegacySettings(x[n][0])}else if(h){const s=[1,2,3,4,5,6,7,8,0];for(let n=0;n<this.getChannelCount();n++)for(const o of this.channels[n].instruments)n>=this.pitchChannelCount?o.chipNoise=nt(0,e.chipNoises.length,tt[t.charCodeAt(i++)]):o.chipWave=nt(0,e.chipWaves.length,0|s[tt[t.charCodeAt(i++)]])}else if(a){const s=[1,2,3,4,5,6,7,8,0];F>=this.pitchChannelCount?this.channels[F].instruments[E].chipNoise=nt(0,e.chipNoises.length,tt[t.charCodeAt(i++)]):this.channels[F].instruments[E].chipWave=nt(0,e.chipWaves.length,0|s[tt[t.charCodeAt(i++)]])}else F>=this.pitchChannelCount?this.channels[F].instruments[E].chipNoise=nt(0,e.chipNoises.length,tt[t.charCodeAt(i++)]):this.channels[F].instruments[E].chipWave=nt(0,e.chipWaves.length,tt[t.charCodeAt(i++)]);break;case 102:if(M)if(a){const s=[10,6,3,0,8,5,2],o=["none","none","none","none","decay 1","decay 2","decay 3"];if(n){const n=tt[t.charCodeAt(i++)],r=this.channels[n].instruments[0],h=x[n][0],a=[1,3,4,5][nt(0,s.length,tt[t.charCodeAt(i++)])];h.filterCutoff=s[a],h.filterResonance=0,h.filterEnvelope=e.envelopes.dictionary[o[a]],r.convertLegacySettings(h)}else if(h)for(let n=0;n<this.getChannelCount();n++)for(let r=0;r<this.channels[n].instruments.length;r++){const h=this.channels[n].instruments[r],a=x[n][r],l=nt(0,s.length,tt[t.charCodeAt(i++)]+1);n<this.pitchChannelCount?(a.filterCutoff=s[l],a.filterResonance=0,a.filterEnvelope=e.envelopes.dictionary[o[l]]):(a.filterCutoff=10,a.filterResonance=0,a.filterEnvelope=e.envelopes.dictionary.none),h.convertLegacySettings(a)}else{const e=nt(0,s.length,tt[t.charCodeAt(i++)]),n=this.channels[F].instruments[E],o=x[F][E];o.filterCutoff=s[e],o.filterResonance=0,n.convertLegacySettings(o)}}else{const e=11,s=this.channels[F].instruments[E],n=x[F][E];n.filterCutoff=nt(0,e,tt[t.charCodeAt(i++)]),s.convertLegacySettings(n)}else{const s=this.channels[F].instruments[E],n=tt[t.charCodeAt(i++)];s.eqFilter.controlPointCount=nt(0,e.filterMaxPoints+1,n);for(let t=s.eqFilter.controlPoints.length;t<s.eqFilter.controlPointCount;t++)s.eqFilter.controlPoints[t]=new ut;for(let n=0;n<s.eqFilter.controlPointCount;n++){const o=s.eqFilter.controlPoints[n];o.type=nt(0,3,tt[t.charCodeAt(i++)]),o.freq=nt(0,e.filterFreqRange,tt[t.charCodeAt(i++)]),o.gain=nt(0,e.filterGainRange,tt[t.charCodeAt(i++)])}for(let t=s.eqFilter.controlPointCount;t<n;t++)i+=3}break;case 121:if(M){const e=8,s=this.channels[F].instruments[E],n=x[F][E];n.filterResonance=nt(0,e,tt[t.charCodeAt(i++)]),s.convertLegacySettings(n)}break;case 122:{const s=this.channels[F].instruments[E];if(M)if(4==s.type)for(let n=0;n<e.drumCount;n++)s.drumsetEnvelopes[n]=yt.H(tt[t.charCodeAt(i++)]).index;else{const e=x[F][E];e.filterEnvelope=yt.H(tt[t.charCodeAt(i++)]),s.convertLegacySettings(e)}else for(let n=0;n<e.drumCount;n++)s.drumsetEnvelopes[n]=nt(0,e.envelopes.length,tt[t.charCodeAt(i++)])}break;case 87:{const s=this.channels[F].instruments[E];if(s.pulseWidth=nt(0,e.pulseWidthRange,tt[t.charCodeAt(i++)]),M){const e=x[F][E];e.pulseEnvelope=yt.H(tt[t.charCodeAt(i++)]),s.convertLegacySettings(e)}}break;case 73:this.channels[F].instruments[E].stringSustain=nt(0,e.stringSustainRange,tt[t.charCodeAt(i++)]);break;case 100:if(M){const s=[{transition:"interrupt",fadeInSeconds:0,fadeOutTicks:-1},{transition:"normal",fadeInSeconds:0,fadeOutTicks:-3},{transition:"normal",fadeInSeconds:.025,fadeOutTicks:-3},{transition:"slide in pattern",fadeInSeconds:.025,fadeOutTicks:-3},{transition:"normal",fadeInSeconds:.04,fadeOutTicks:6},{transition:"normal",fadeInSeconds:0,fadeOutTicks:48},{transition:"normal",fadeInSeconds:.0125,fadeOutTicks:72},{transition:"normal",fadeInSeconds:.06,fadeOutTicks:96}];if(n){const n=tt[t.charCodeAt(i++)],o=s[nt(0,s.length,tt[t.charCodeAt(i++)])],r=this.channels[n].instruments[0];r.fadeIn=Mt.secondsToFadeInSetting(o.fadeInSeconds),r.fadeOut=Mt.ticksToFadeOutSetting(o.fadeOutTicks),r.transition=e.transitions.dictionary[o.transition].index,r.transition!=e.transitions.dictionary.normal.index&&(r.effects|=1024)}else if(h)for(let n=0;n<this.getChannelCount();n++)for(const o of this.channels[n].instruments){const n=s[nt(0,s.length,tt[t.charCodeAt(i++)])];o.fadeIn=Mt.secondsToFadeInSetting(n.fadeInSeconds),o.fadeOut=Mt.ticksToFadeOutSetting(n.fadeOutTicks),o.transition=e.transitions.dictionary[n.transition].index,o.transition!=e.transitions.dictionary.normal.index&&(o.effects|=1024)}else{const n=s[nt(0,s.length,tt[t.charCodeAt(i++)])],o=this.channels[F].instruments[E];o.fadeIn=Mt.secondsToFadeInSetting(n.fadeInSeconds),o.fadeOut=Mt.ticksToFadeOutSetting(n.fadeOutTicks),o.transition=e.transitions.dictionary[n.transition].index,o.transition!=e.transitions.dictionary.normal.index&&(o.effects|=1024)}}else{const s=this.channels[F].instruments[E];s.fadeIn=nt(0,e.fadeInRange,tt[t.charCodeAt(i++)]),s.fadeOut=nt(0,e.fadeOutTicks.length,tt[t.charCodeAt(i++)])}break;case 99:if(M)if(a)if(n){const s=[0,3,2,0],n=["none","none","none","tremolo2"],o=tt[t.charCodeAt(i++)],r=nt(0,s.length,tt[t.charCodeAt(i++)]),h=this.channels[o].instruments[0],a=x[o][0];h.vibrato=s[r],null!=a.filterEnvelope&&1!=a.filterEnvelope.type||(a.filterEnvelope=e.envelopes.dictionary[n[r]],h.convertLegacySettings(a)),h.vibrato!=e.vibratos.dictionary.none.index&&(h.effects|=512)}else if(h){const s=[0,1,2,3,0,0],n=["none","none","none","none","tremolo5","tremolo2"];for(let o=0;o<this.getChannelCount();o++)for(let r=0;r<this.channels[o].instruments.length;r++){const h=nt(0,s.length,tt[t.charCodeAt(i++)]),a=this.channels[o].instruments[r],l=x[o][r];a.vibrato=s[h],null!=l.filterEnvelope&&1!=l.filterEnvelope.type||(l.filterEnvelope=e.envelopes.dictionary[n[h]],a.convertLegacySettings(l)),a.vibrato!=e.vibratos.dictionary.none.index&&(a.effects|=512),0==P||this.getChannelIsNoise(o)||(a.effects|=1,a.reverb=P)}}else{const s=[0,1,2,3,0,0],n=["none","none","none","none","tremolo5","tremolo2"],o=nt(0,s.length,tt[t.charCodeAt(i++)]),r=this.channels[F].instruments[E],h=x[F][E];r.vibrato=s[o],null!=h.filterEnvelope&&1!=h.filterEnvelope.type||(h.filterEnvelope=e.envelopes.dictionary[n[o]],r.convertLegacySettings(h)),r.vibrato!=e.vibratos.dictionary.none.index&&(r.effects|=512),0!=P&&(r.effects|=1,r.reverb=P)}else{const s=this.channels[F].instruments[E],n=nt(0,e.vibratos.length,tt[t.charCodeAt(i++)]);s.vibrato=n,s.vibrato!=e.vibratos.dictionary.none.index&&(s.effects|=512)}break;case 104:if(n){const s=tt[t.charCodeAt(i++)];this.channels[s].instruments[0].unison=nt(0,e.unisons.length,tt[t.charCodeAt(i++)])}else if(h)for(let s=0;s<this.getChannelCount();s++)for(const n of this.channels[s].instruments){const s=tt[t.charCodeAt(i++)];let o=nt(0,e.unisons.length,s);8==s&&(o=2,n.chord=3),n.unison=o}else if(a){const s=tt[t.charCodeAt(i++)];let n=nt(0,e.unisons.length,s);8==s&&(n=2,this.channels[F].instruments[E].chord=3),this.channels[F].instruments[E].unison=n}else this.channels[F].instruments[E].unison=nt(0,e.unisons.length,tt[t.charCodeAt(i++)]);break;case 67:if(M){const s=this.channels[F].instruments[E];s.chord=nt(0,e.chords.length,tt[t.charCodeAt(i++)]),s.chord!=e.chords.dictionary.simultaneous.index&&(s.effects|=2048)}break;case 113:{const s=this.channels[F].instruments[E];if(M){s.effects=4095&tt[t.charCodeAt(i++)],0==P?s.effects&=-2:w(s.effects)&&(s.reverb=P),s.pan!=e.panCenter&&(s.effects|=4),s.vibrato!=e.vibratos.dictionary.none.index&&(s.effects|=4);const n=x[F][E];s.convertLegacySettings(n)}else{if(s.effects=tt[t.charCodeAt(i++)]<<6|tt[t.charCodeAt(i++)],d(s.effects)){const n=tt[t.charCodeAt(i++)];s.noteFilter.controlPointCount=nt(0,e.filterMaxPoints+1,n);for(let t=s.noteFilter.controlPoints.length;t<s.noteFilter.controlPointCount;t++)s.noteFilter.controlPoints[t]=new ut;for(let n=0;n<s.noteFilter.controlPointCount;n++){const o=s.noteFilter.controlPoints[n];o.type=nt(0,3,tt[t.charCodeAt(i++)]),o.freq=nt(0,e.filterFreqRange,tt[t.charCodeAt(i++)]),o.gain=nt(0,e.filterGainRange,tt[t.charCodeAt(i++)])}for(let t=s.noteFilter.controlPointCount;t<n;t++)i+=3}l(s.effects)&&(s.transition=nt(0,e.transitions.length,tt[t.charCodeAt(i++)])),c(s.effects)&&(s.chord=nt(0,e.chords.length,tt[t.charCodeAt(i++)])),u(s.effects)&&(s.pitchShift=nt(0,e.pitchShiftRange,tt[t.charCodeAt(i++)])),f(s.effects)&&(s.detune=nt(0,e.detuneMax+1,tt[t.charCodeAt(i++)])),p(s.effects)&&(s.vibrato=nt(0,e.vibratos.length,tt[t.charCodeAt(i++)])),m(s.effects)&&(s.distortion=nt(0,e.distortionRange,tt[t.charCodeAt(i++)])),y(s.effects)&&(s.bitcrusherFreq=nt(0,e.bitcrusherFreqRange,tt[t.charCodeAt(i++)]),s.bitcrusherQuantization=nt(0,e.bitcrusherQuantizationRange,tt[t.charCodeAt(i++)])),g(s.effects)&&(s.pan=nt(0,e.panMax+1,tt[t.charCodeAt(i++)])),b(s.effects)&&(s.chorus=nt(0,e.chorusRange,tt[t.charCodeAt(i++)])),v(s.effects)&&(s.echoSustain=nt(0,e.echoSustainRange,tt[t.charCodeAt(i++)]),s.echoDelay=nt(0,e.echoDelayRange,tt[t.charCodeAt(i++)])),w(s.effects)&&(s.reverb=nt(0,e.reverbRange,tt[t.charCodeAt(i++)]))}s.effects&=4095}break;case 118:if(n){const s=tt[t.charCodeAt(i++)],n=this.channels[s].instruments[0];n.volume=nt(0,e.volumeRange,tt[t.charCodeAt(i++)]),5==n.volume&&(n.volume=e.volumeRange-1)}else if(h)for(let s=0;s<this.getChannelCount();s++)for(const n of this.channels[s].instruments)n.volume=nt(0,e.volumeRange,tt[t.charCodeAt(i++)]),5==n.volume&&(n.volume=e.volumeRange-1);else if(a){const s=this.channels[F].instruments[E];s.volume=nt(0,e.volumeRange,tt[t.charCodeAt(i++)]),5==s.volume&&(s.volume=e.volumeRange-1)}else{this.channels[F].instruments[E].volume=nt(0,e.volumeRange,tt[t.charCodeAt(i++)])}break;case 76:if(M){this.channels[F].instruments[E].pan=nt(0,e.panMax+1,tt[t.charCodeAt(i++)])}break;case 65:{const s=this.channels[F].instruments[E];if(s.algorithm=nt(0,e.algorithms.length,tt[t.charCodeAt(i++)]),M){const t=x[F][E];s.convertLegacySettings(t)}}break;case 70:this.channels[F].instruments[E].feedbackType=nt(0,e.feedbacks.length,tt[t.charCodeAt(i++)]);break;case 66:this.channels[F].instruments[E].feedbackAmplitude=nt(0,e.operatorAmplitudeMax+1,tt[t.charCodeAt(i++)]);break;case 86:if(M){const e=this.channels[F].instruments[E],s=x[F][E];s.feedbackEnvelope=yt.H(tt[t.charCodeAt(i++)]),e.convertLegacySettings(s)}break;case 81:for(let s=0;s<e.operatorCount;s++)this.channels[F].instruments[E].operators[s].frequency=nt(0,e.operatorFrequencies.length,tt[t.charCodeAt(i++)]);break;case 80:for(let s=0;s<e.operatorCount;s++)this.channels[F].instruments[E].operators[s].amplitude=nt(0,e.operatorAmplitudeMax+1,tt[t.charCodeAt(i++)]);break;case 69:{const s=this.channels[F].instruments[E];if(M){const n=x[F][E];n.operatorEnvelopes=[];for(let s=0;s<e.operatorCount;s++)n.operatorEnvelopes[s]=yt.H(tt[t.charCodeAt(i++)]);s.convertLegacySettings(n)}else{const n=nt(0,e.maxEnvelopeCount+1,tt[t.charCodeAt(i++)]);for(let o=0;o<n;o++){const n=nt(0,e.instrumentAutomationTargets.length,tt[t.charCodeAt(i++)]);let o=0;const r=e.instrumentAutomationTargets[n].maxCount;r>1&&(o=nt(0,r,tt[t.charCodeAt(i++)]));const h=nt(0,e.envelopes.length,tt[t.charCodeAt(i++)]);s.addEnvelope(n,o,h)}}}break;case 83:{const s=this.channels[F].instruments[E];if(3==s.type){const n=Math.ceil(e.spectrumControlPoints*e.spectrumControlPointBits/6),o=new et(t,i,i+n);for(let t=0;t<e.spectrumControlPoints;t++)s.spectrumWave.spectrum[t]=o.read(e.spectrumControlPointBits);s.spectrumWave.markCustomWaveDirty(),i+=n}else{if(4!=s.type)throw new Error("Unhandled instrument type for spectrum song tag code.");{const n=Math.ceil(e.drumCount*e.spectrumControlPoints*e.spectrumControlPointBits/6),o=new et(t,i,i+n);for(let t=0;t<e.drumCount;t++){for(let i=0;i<e.spectrumControlPoints;i++)s.drumsetSpectrumWaves[t].spectrum[i]=o.read(e.spectrumControlPointBits);s.drumsetSpectrumWaves[t].markCustomWaveDirty()}i+=n}}}break;case 72:{const s=this.channels[F].instruments[E],n=Math.ceil(e.harmonicsControlPoints*e.harmonicsControlPointBits/6),o=new et(t,i,i+n);for(let t=0;t<e.harmonicsControlPoints;t++)s.harmonicsWave.harmonics[t]=o.read(e.harmonicsControlPointBits);s.harmonicsWave.markCustomWaveDirty(),i+=n}break;case 98:{let e;if(n){const s=tt[t.charCodeAt(i++)],n=tt[t.charCodeAt(i++)];e=Math.ceil(.5*n);const o=new et(t,i,i+e);for(let t=0;t<n;t++)this.channels[s].bars[t]=o.read(3)+1}else if(r){let s=0;for(;1<<s<this.patternsPerChannel;)s++;e=Math.ceil(this.getChannelCount()*this.barCount*s/6);const n=new et(t,i,i+e);for(let t=0;t<this.getChannelCount();t++)for(let e=0;e<this.barCount;e++)this.channels[t].bars[e]=n.read(s)+1}else{let s=0;for(;1<<s<this.patternsPerChannel+1;)s++;e=Math.ceil(this.getChannelCount()*this.barCount*s/6);const n=new et(t,i,i+e);for(let t=0;t<this.getChannelCount();t++)for(let e=0;e<this.barCount;e++)this.channels[t].bars[e]=n.read(s)}i+=e}break;case 112:{let s,o=0;if(n)s=tt[t.charCodeAt(i++)],i++,o=tt[t.charCodeAt(i++)],o<<=6,o+=tt[t.charCodeAt(i++)];else{s=0;let e=ot(1,4,tt[t.charCodeAt(i++)]);for(;e>0;)o<<=6,o+=tt[t.charCodeAt(i++)],e--}const r=new et(t,i,i+o);i+=o;const h=yt.getNeededBits(e.noteSizeMax);for(;;){const t=this.channels[s],i=this.getChannelIsNoise(s),o=this.getMaxInstrumentsPerPattern(s),l=yt.getNeededBits(o-e.instrumentCountMin),c=yt.getNeededBits(t.instruments.length-1),u=i?0:12*t.octave;let f=i?4:u;const p=i?[4,6,7,2,3,8,0,10]:[0,7,12,19,24,-5,-12],d=[];for(let t=0;t<p.length;t++)p[t]+=u;for(let i=0;i<this.patternsPerChannel;i++){const s=t.patterns[i];if(M)s.instruments[0]=ot(0,t.instruments.length-1,r.read(c)),s.instruments.length=1;else if(this.patternInstruments){const i=ot(e.instrumentCountMin,o,r.read(l)+e.instrumentCountMin);for(let e=0;e<i;e++)s.instruments[e]=ot(0,t.instruments.length-1,r.read(c));s.instruments.length=i}else s.instruments[0]=0,s.instruments.length=e.instrumentCountMin;if(!n&&0==r.read(1)){s.notes.length=0;continue}let u=0;const m=s.notes;let y=0;for(;u<this.beatsPerBar*e.partsPerBeat;){const t=1==r.read(1);let i=!1,s=0;if(t?s=ot(0,d.length-1,r.readLongTail(0,0)):i=1==r.read(1),t||i){let i,n,o;if(t)i=d[s],d.splice(s,1);else{for(i={},i.pitchCount=1;i.pitchCount<e.maxChordSize&&1==r.read(1);)i.pitchCount++;i.pinCount=r.readPinCount(),i.initialSize=r.read(h),i.pins=[],i.length=0,i.bendCount=0;for(let t=0;t<i.pinCount;t++){let t={};t.pitchBend=1==r.read(1),t.pitchBend&&i.bendCount++,i.length+=a?r.readLegacyPartDuration()*e.partsPerBeat/e.rhythms[this.rhythm].stepsPerBeat:r.readPartDuration(),t.time=i.length,t.size=r.read(h),i.pins.push(t)}}d.unshift(i),d.length>10&&d.pop(),m.length<=y?(n=new rt(0,u,u+i.length,i.initialSize),m[y++]=n):(n=m[y++],n.start=u,n.end=u+i.length,n.pins[0].size=i.initialSize);let l=0;const c=[];for(let t=0;t<i.pitchCount+i.bendCount;t++){if(1==r.read(1)){const t=ot(0,p.length-1,r.read(3));o=p[t],p.splice(t,1)}else{const t=r.readPitchInterval();o=f;let e=t;for(;e>0;){for(o++;-1!=p.indexOf(o);)o++;e--}for(;e<0;){for(o--;-1!=p.indexOf(o);)o--;e++}}p.unshift(o),p.length>8&&p.pop(),t<i.pitchCount?n.pitches[l++]=o:c.push(o),f=t==i.pitchCount-1?n.pitches[0]:o}n.pitches.length=l,c.unshift(n.pitches[0]);let g=1;for(const t of i.pins){t.pitchBend&&c.shift();const e=c[0]-n.pitches[0];if(n.pins.length<=g)n.pins[g++]=st(e,t.time,t.size);else{const i=n.pins[g++];i.interval=e,i.time=t.time,i.size=t.size}}n.pins.length=g,0!=n.start||M?n.continuesLastPattern=!1:n.continuesLastPattern=1==r.read(1),u=ot(0,this.beatsPerBar*e.partsPerBeat,n.end)}else{u+=a?r.readLegacyPartDuration()*e.partsPerBeat/e.rhythms[this.rhythm].stepsPerBeat:r.readPartDuration()}}m.length=y}if(n)break;if(s++,s>=this.getChannelCount())break}}break;default:throw new Error("Unrecognized song tag code "+String.fromCharCode(S)+" at index "+(i-1))}}toJsonObject(t=!0,i=1,s=!0){const n=[];for(let o=0;o<this.getChannelCount();o++){const r=this.channels[o],h=[],a=this.getChannelIsNoise(o);for(const t of r.instruments)h.push(t.toJsonObject());const l=[];for(const t of r.patterns){const i=[];for(const s of t.notes){const t=[];for(const i of s.pins)t.push({tick:(i.time+s.start)*e.rhythms[this.rhythm].stepsPerBeat/e.partsPerBeat,pitchBend:i.interval,volume:Math.round(100*i.size/3)});const n={pitches:s.pitches,points:t};0==s.start&&(n.continuesLastPattern=s.continuesLastPattern),i.push(n)}const s={notes:i};this.patternInstruments&&(s.instruments=t.instruments.map((t=>t+1))),l.push(s)}const c=[];if(t)for(let t=0;t<this.loopStart;t++)c.push(r.bars[t]);for(let t=0;t<i;t++)for(let t=this.loopStart;t<this.loopStart+this.loopLength;t++)c.push(r.bars[t]);if(s)for(let t=this.loopStart+this.loopLength;t<this.barCount;t++)c.push(r.bars[t]);const u={type:a?"drum":"pitch",instruments:h,patterns:l,sequence:c};a||(u.octaveScrollBar=r.octave-1),n.push(u)}return{format:yt._,version:yt.N,scale:e.scales[this.scale].name,key:e.keys[this.key].name,introBars:this.loopStart,loopBars:this.loopLength,beatsPerBar:this.beatsPerBar,ticksPerBeat:e.rhythms[this.rhythm].stepsPerBeat,beatsPerMinute:this.tempo,layeredInstruments:this.layeredInstruments,patternInstruments:this.patternInstruments,channels:n}}fromJsonObject(t){if(this.initToDefault(!0),!t)return;if(this.scale=11,null!=t.scale){const i={"romani :)":"dbl harmonic :)","romani :(":"dbl harmonic :(",enigma:"strange"},s=null!=i[t.scale]?i[t.scale]:t.scale,n=e.scales.findIndex((t=>t.name==s));-1!=n&&(this.scale=n)}if(null!=t.key)if("number"==typeof t.key)this.key=(t.key+1200>>>0)%e.keys.length;else if("string"==typeof t.key){const e=t.key,i=e.charAt(0).toUpperCase(),s=e.charAt(1).toLowerCase();let n={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[i];const o={"#":1,"♯":1,b:-1,"♭":-1}[s];null!=n&&(null!=o&&(n+=o),n<0&&(n+=12),n%=12,this.key=n)}null!=t.beatsPerMinute&&(this.tempo=nt(e.tempoMin,e.tempoMax+1,0|t.beatsPerMinute));let i=0;null!=t.reverb&&(i=nt(0,4,0|t.reverb)),null!=t.beatsPerBar&&(this.beatsPerBar=Math.max(e.beatsPerBarMin,Math.min(e.beatsPerBarMax,0|t.beatsPerBar)));let s=4;null!=t.ticksPerBeat&&(s=0|t.ticksPerBeat||4,this.rhythm=e.rhythms.findIndex((t=>t.stepsPerBeat==s)),-1==this.rhythm&&(this.rhythm=1));let n=1,o=1,r=1;if(null!=t.channels)for(const e of t.channels)e.instruments&&(n=Math.max(n,0|e.instruments.length)),e.patterns&&(o=Math.max(o,0|e.patterns.length)),e.sequence&&(r=Math.max(r,0|e.sequence.length));null!=t.layeredInstruments?this.layeredInstruments=!!t.layeredInstruments:this.layeredInstruments=!1,null!=t.patternInstruments?this.patternInstruments=!!t.patternInstruments:this.patternInstruments=n>1,this.patternsPerChannel=Math.min(o,e.barCountMax),this.barCount=Math.min(r,e.barCountMax),null!=t.introBars&&(this.loopStart=nt(0,this.barCount,0|t.introBars)),null!=t.loopBars&&(this.loopLength=nt(1,this.barCount-this.loopStart+1,0|t.loopBars));const h=[],a=[];if(null!=t.channels)for(let n=0;n<t.channels.length;n++){let o=t.channels[n];const r=new mt;let l=!1;if(l=null!=o.type?"drum"==o.type:n>=3,l?a.push(r):h.push(r),null!=o.octaveScrollBar&&(r.octave=nt(0,e.pitchOctaves,1+(0|o.octaveScrollBar)),l&&(r.octave=0)),Array.isArray(o.instruments)){const t=o.instruments;for(let e=0;e<t.length&&!(e>=this.getMaxInstrumentsPerChannel());e++){const s=new dt(l);r.instruments[e]=s,s.fromJsonObject(t[e],l,i)}}for(let t=0;t<this.patternsPerChannel;t++){const i=new ht;let n;if(r.patterns[t]=i,o.patterns&&(n=o.patterns[t]),null!=n){if(this.patternInstruments)if(Array.isArray(n.instruments)){const t=n.instruments,s=nt(e.instrumentCountMin,this.getMaxInstrumentsPerPatternForChannel(r)+1,t.length);for(let e=0;e<s;e++)i.instruments[e]=nt(0,r.instruments.length,(0|t[e])-1);i.instruments.length=s}else i.instruments[0]=nt(0,r.instruments.length,(0|n.instrument)-1),i.instruments.length=1;if(n.notes&&n.notes.length>0){const t=Math.min(this.beatsPerBar*e.partsPerBeat,n.notes.length>>>0);let o=0;for(let r=0;r<n.notes.length&&!(r>=t);r++){const t=n.notes[r];if(!(t&&t.pitches&&t.pitches.length>=1&&t.points&&t.points.length>=2))continue;const h=new rt(0,0,0,0);h.pitches=[],h.pins=[];for(let i=0;i<t.pitches.length;i++){const s=0|t.pitches[i];if(-1==h.pitches.indexOf(s)&&(h.pitches.push(s),h.pitches.length>=e.maxChordSize))break}if(h.pitches.length<1)continue;let a=o,c=0;for(let i=0;i<t.points.length;i++){const n=t.points[i];if(null==n||null==n.tick)continue;const o=null==n.pitchBend?0:0|n.pitchBend,r=Math.round(+n.tick*e.partsPerBeat/s),l=null==n.volume?3:Math.max(0,Math.min(3,Math.round(3*(0|n.volume)/100)));if(!(r>this.beatsPerBar*e.partsPerBeat)){if(0==h.pins.length){if(r<a)continue;h.start=r,c=o}else if(r<=a)continue;a=r,h.pins.push(st(o-c,r-h.start,l))}}if(h.pins.length<2)continue;h.end=h.pins[h.pins.length-1].time+h.start;const u=l?e.drumCount-1:e.maxPitch;let f=u,p=0;for(let t=0;t<h.pitches.length;t++)h.pitches[t]+=c,(h.pitches[t]<0||h.pitches[t]>u)&&(h.pitches.splice(t,1),t--),h.pitches[t]<f&&(f=h.pitches[t]),h.pitches[t]>p&&(p=h.pitches[t]);if(!(h.pitches.length<1)){for(let t=0;t<h.pins.length;t++){const e=h.pins[t];e.interval+f<0&&(e.interval=-f),e.interval+p>u&&(e.interval=u-p),t>=2&&e.interval==h.pins[t-1].interval&&e.interval==h.pins[t-2].interval&&e.size==h.pins[t-1].size&&e.size==h.pins[t-2].size&&(h.pins.splice(t-1,1),t--)}0==h.start?h.continuesLastPattern=!0===t.continuesLastPattern:h.continuesLastPattern=!1,i.notes.push(h),o=h.end}}}}}r.patterns.length=this.patternsPerChannel;for(let t=0;t<this.barCount;t++)r.bars[t]=null!=o.sequence?Math.min(this.patternsPerChannel,o.sequence[t]>>>0):0;r.bars.length=this.barCount}h.length>e.pitchChannelCountMax&&(h.length=e.pitchChannelCountMax),a.length>e.noiseChannelCountMax&&(a.length=e.noiseChannelCountMax),this.pitchChannelCount=h.length,this.noiseChannelCount=a.length,this.channels.length=0,Array.prototype.push.apply(this.channels,h),Array.prototype.push.apply(this.channels,a)}getPattern(t,e){if(e<0||e>=this.barCount)return null;const i=this.channels[t].bars[e];return 0==i?null:this.channels[t].patterns[i-1]}getBeatsPerMinute(){return this.tempo}static getNeededBits(t){return 32-Math.clz32(Math.ceil(t+1)-1)}}yt._="BeepBox",yt.$=2,yt.N=9;class gt{constructor(){this.delayLine=null,this.reset()}reset(){this.delayIndex=-1,this.allPassSample=0,this.allPassPrevInput=0,this.shelfSample=0,this.shelfPrevInput=0,this.fractionalDelaySample=0,this.prevDelayLength=-1,this.delayResetOffset=0}}class bt{constructor(){this.noteSecondsStart=0,this.noteSecondsEnd=0,this.noteTicksStart=0,this.noteTicksEnd=0,this.noteSizeStart=e.noteSizeMax,this.noteSizeEnd=e.noteSizeMax,this.prevNoteSize=e.noteSizeMax,this.nextNoteSize=e.noteSizeMax,this.U=e.noteSizeMax,this.prevNoteSecondsStart=0,this.prevNoteSecondsEnd=0,this.prevNoteTicksStart=0,this.prevNoteTicksEnd=0,this.V=e.noteSizeMax,this.prevSlideStart=!1,this.prevSlideEnd=!1,this.nextSlideStart=!1,this.nextSlideEnd=!1,this.prevSlideRatioStart=0,this.prevSlideRatioEnd=0,this.nextSlideRatioStart=0,this.nextSlideRatioEnd=0,this.envelopeStarts=[],this.envelopeEnds=[],this.lowpassCutoffDecayVolumeCompensation=1;for(let t=0;t<33;t++)this.envelopeStarts[t]=1,this.envelopeEnds[t]=1;this.reset()}reset(){this.noteSecondsEnd=0,this.noteTicksEnd=0,this.U=e.noteSizeMax,this.prevNoteSecondsEnd=0,this.prevNoteTicksEnd=0,this.V=e.noteSizeMax}computeEnvelopes(t,i,s,n,o,r){const h=t.getTransition();null==r||!r.atNoteStart||h.continues||r.forceContinueAtStart||(this.prevNoteSecondsEnd=this.noteSecondsEnd,this.prevNoteTicksEnd=this.noteTicksEnd,this.V=this.U,this.noteSecondsEnd=0,this.noteTicksEnd=0),null!=r&&(null!=r.note?this.U=r.note.pins[r.note.pins.length-1].size:this.U=e.noteSizeMax);const a=n-s,l=this.noteSecondsEnd,c=l+o,u=this.noteTicksEnd,f=u+a,p=this.prevNoteSecondsEnd,d=p+o,m=this.prevNoteTicksEnd,y=m+a,g=1/(e.ticksPerPart*e.partsPerBeat),b=g*s,v=g*n;let w=this.U,k=this.U,M=this.V,x=0,S=!1,P=!1,F=!1,E=!1,I=0,q=0,T=0,C=0;if(null!=r&&null!=r.note&&!r.passedEndOfNote){const t=r.note.getEndPinIndex(i),o=r.note.pins[t-1],a=r.note.pins[t],l=(r.note.start+o.time)*e.ticksPerPart,c=(r.note.start+a.time)*e.ticksPerPart,u=(s-l)/(c-l),f=(n-l)/(c-l);if(w=o.size+(a.size-o.size)*u,k=o.size+(a.size-o.size)*f,h.slides){const t=r.noteStartPart*e.ticksPerPart,i=r.noteEndPart*e.ticksPerPart,o=.5*(i-t),a=Math.min(o,h.slideTicks);null==r.prevNote||r.forceContinueAtStart||(s-t<a&&(S=!0,I=.5*(1-(s-t)/a)),n-t<a&&(P=!0,q=.5*(1-(n-t)/a))),null==r.nextNote||r.forceContinueAtEnd||(x=r.nextNote.pins[0].size,i-s<a&&(F=!0,T=.5*(1-(i-s)/a)),i-n<a&&(E=!0,C=.5*(1-(i-n)/a)))}}let L=1,D=!1;for(let i=0;i<=t.envelopeCount;i++){let s,n,o;if(i==t.envelopeCount){if(D)break;s=e.instrumentAutomationTargets.dictionary.noteVolume,n=0,o=e.envelopes.dictionary["note size"]}else{let r=t.envelopes[i];s=e.instrumentAutomationTargets[r.target],n=r.index,o=e.envelopes[r.envelope],0==o.type&&(D=!0)}if(null!=s.computeIndex){const e=s.computeIndex+n;let i=bt.computeEnvelope(o,l,b,w),r=bt.computeEnvelope(o,c,v,k);if(S){i+=(bt.computeEnvelope(o,p,b,M)-i)*I}if(P){r+=(bt.computeEnvelope(o,d,v,M)-r)*q}if(F){i+=(bt.computeEnvelope(o,0,b,x)-i)*T}if(E){r+=(bt.computeEnvelope(o,0,v,x)-r)*C}if(this.envelopeStarts[e]*=i,this.envelopeEnds[e]*=r,s.isFilter){const e=t.noteFilter;e.controlPointCount>n&&0==e.controlPoints[n].type&&(L=Math.max(L,bt.getLowpassCutoffDecayVolumeCompensation(o)))}}}this.noteSecondsStart=l,this.noteSecondsEnd=c,this.noteTicksStart=u,this.noteTicksEnd=f,this.prevNoteSecondsStart=p,this.prevNoteSecondsEnd=d,this.prevNoteTicksStart=m,this.prevNoteTicksEnd=y,this.prevNoteSize=M,this.nextNoteSize=x,this.noteSizeStart=w,this.noteSizeEnd=k,this.prevSlideStart=S,this.prevSlideEnd=P,this.nextSlideStart=F,this.nextSlideEnd=E,this.prevSlideRatioStart=I,this.prevSlideRatioEnd=q,this.nextSlideRatioStart=T,this.nextSlideRatioEnd=C,this.lowpassCutoffDecayVolumeCompensation=L}clearEnvelopes(t){for(let i=0;i<t.envelopeCount;i++){const s=t.envelopes[i],n=e.instrumentAutomationTargets[s.target];if(null!=n.computeIndex){const t=n.computeIndex+s.index;this.envelopeStarts[t]=1,this.envelopeEnds[t]=1}}this.envelopeStarts[0]=1,this.envelopeEnds[0]=1}static computeEnvelope(t,e,i,s){switch(t.type){case 0:return Mt.noteSizeToVolumeMult(s);case 1:return 1;case 4:return 1/(1+e*t.speed);case 5:return 1-1/(1+e*t.speed);case 6:return.5-.5*Math.cos(2*i*Math.PI*t.speed);case 7:return.75-.25*Math.cos(2*i*Math.PI*t.speed);case 2:return Math.max(1,2-10*e);case 3:const n=.25/Math.sqrt(t.speed);return e<n?e/n:1/(1+(e-n)*t.speed);case 8:return Math.pow(2,-t.speed*e);default:throw new Error("Unrecognized operator envelope type.")}}static getLowpassCutoffDecayVolumeCompensation(t){return 8==t.type?1.25+.025*t.speed:4==t.type?1+.02*t.speed:1}}class vt{constructor(){this.pitches=Array(e.maxChordSize).fill(0),this.pitchCount=0,this.chordSize=0,this.drumsetPitch=null,this.note=null,this.prevNote=null,this.nextNote=null,this.prevNotePitchIndex=0,this.nextNotePitchIndex=0,this.freshlyAllocated=!0,this.atNoteStart=!1,this.isOnLastTick=!1,this.passedEndOfNote=!1,this.forceContinueAtStart=!1,this.forceContinueAtEnd=!1,this.noteStartPart=0,this.noteEndPart=0,this.ticksSinceReleased=0,this.liveInputSamplesHeld=0,this.lastInterval=0,this.sample=0,this.phases=[],this.phaseDeltas=[],this.expressionStarts=[],this.expressionDeltas=[],this.phaseDeltaScales=[],this.prevVibrato=null,this.pulseWidth=0,this.pulseWidthDelta=0,this.pickedStrings=[],this.noteFilters=[],this.noteFilterCount=0,this.initialNoteFilterInput1=0,this.initialNoteFilterInput2=0,this.specialIntervalMult=0,this.specialIntervalExpressionMult=1,this.feedbackOutputs=[],this.feedbackMult=0,this.feedbackDelta=0,this.envelopeComputer=new bt,this.reset()}reset(){this.sample=0;const t=Math.max(e.maxChordSize,e.operatorCount);for(let e=0;e<t;e++)this.phases[e]=0,this.feedbackOutputs[e]=0;for(let t=0;t<this.noteFilterCount;t++)this.noteFilters[t].resetOutput();this.noteFilterCount=0,this.initialNoteFilterInput1=0,this.initialNoteFilterInput2=0,this.liveInputSamplesHeld=0;for(const t of this.pickedStrings)t.reset();this.envelopeComputer.reset(),this.prevVibrato=null,this.drumsetPitch=null}}class wt{constructor(){this.awake=!1,this.computed=!1,this.tonesAddedInThisTick=!1,this.flushingDelayLines=!1,this.deactivateAfterThisTick=!1,this.attentuationProgress=0,this.flushedSamples=0,this.activeTones=new J,this.releasedTones=new J,this.liveInputTones=new J,this.eqFilterVolumeStart=1,this.eqFilterVolumeDelta=0,this.mixVolumeStart=1,this.mixVolumeDelta=0,this.delayInputMultStart=0,this.delayInputMultDelta=0,this.distortionStart=0,this.distortionEnd=0,this.distortionFractionalInput1=0,this.distortionFractionalInput2=0,this.distortionFractionalInput3=0,this.distortionPrevInput=0,this.distortionNextOutput=0,this.bitcrusherPrevInput=0,this.bitcrusherCurrentOutput=0,this.bitcrusherPhase=1,this.bitcrusherPhaseDelta=0,this.bitcrusherPhaseDeltaScale=1,this.bitcrusherScale=1,this.bitcrusherScaleScale=1,this.bitcrusherFoldLevel=1,this.bitcrusherFoldLevelScale=1,this.eqFilters=[],this.eqFilterCount=0,this.initialEqFilterInput1=0,this.initialEqFilterInput2=0,this.panningDelayLine=null,this.panningDelayPos=0,this.panningVolumeStartL=0,this.panningVolumeStartR=0,this.panningVolumeDeltaL=0,this.panningVolumeDeltaR=0,this.panningOffsetStartL=0,this.panningOffsetStartR=0,this.panningOffsetDeltaL=0,this.panningOffsetDeltaR=0,this.chorusDelayLineL=null,this.chorusDelayLineR=null,this.chorusDelayLineDirty=!1,this.chorusDelayPos=0,this.chorusPhase=0,this.chorusStart=0,this.chorusEnd=0,this.echoDelayLineL=null,this.echoDelayLineR=null,this.echoDelayLineDirty=!1,this.echoDelayPos=0,this.echoDelayOffsetStart=0,this.echoDelayOffsetEnd=0,this.echoDelayOffsetLastTick=0,this.echoDelayOffsetRatio=0,this.echoDelayOffsetRatioDelta=0,this.echoDelayOffsetLastTickIsComputed=!1,this.echoMultStart=0,this.echoMultDelta=0,this.echoShelfA1=0,this.echoShelfB0=0,this.echoShelfB1=0,this.echoShelfSampleL=0,this.echoShelfSampleR=0,this.echoShelfPrevInputL=0,this.echoShelfPrevInputR=0,this.reverbDelayLine=null,this.reverbDelayLineDirty=!1,this.reverbDelayPos=0,this.reverbMultStart=0,this.reverbMultDelta=0,this.reverbShelfA1=0,this.reverbShelfB0=0,this.reverbShelfB1=0,this.reverbShelfSample0=0,this.reverbShelfSample1=0,this.reverbShelfSample2=0,this.reverbShelfSample3=0,this.reverbShelfPrevInput0=0,this.reverbShelfPrevInput1=0,this.reverbShelfPrevInput2=0,this.reverbShelfPrevInput3=0}allocateNecessaryBuffers(t,i,s){if(g(i.effects)&&(null==this.panningDelayLine||this.panningDelayLine.length<t.panningDelayBufferSize)&&(this.panningDelayLine=new Float32Array(t.panningDelayBufferSize)),b(i.effects)&&((null==this.chorusDelayLineL||this.chorusDelayLineL.length<t.chorusDelayBufferSize)&&(this.chorusDelayLineL=new Float32Array(t.chorusDelayBufferSize)),(null==this.chorusDelayLineR||this.chorusDelayLineR.length<t.chorusDelayBufferSize)&&(this.chorusDelayLineR=new Float32Array(t.chorusDelayBufferSize))),v(i.effects)){const t=Math.max(e.echoDelayRange>>1,i.echoDelay+1),n=2*Mt.fittingPowerOfTwo(t*e.echoDelayStepTicks*s);if(null==this.echoDelayLineL||null==this.echoDelayLineR)this.echoDelayLineL=new Float32Array(n),this.echoDelayLineR=new Float32Array(n);else if(this.echoDelayLineL.length<n||this.echoDelayLineR.length<n){const t=new Float32Array(n),e=new Float32Array(n),i=this.echoDelayLineL.length-1;for(let s=0;s<this.echoDelayLineL.length;s++)t[s]=this.echoDelayLineL[this.echoDelayPos+s&i],e[s]=this.echoDelayLineL[this.echoDelayPos+s&i];this.echoDelayPos=this.echoDelayLineL.length,this.echoDelayLineL=t,this.echoDelayLineR=e}}w(i.effects)&&null==this.reverbDelayLine&&(this.reverbDelayLine=new Float32Array(e.reverbDelayBufferSize))}deactivate(){this.bitcrusherPrevInput=0,this.bitcrusherCurrentOutput=0,this.bitcrusherPhase=1;for(let t=0;t<this.eqFilterCount;t++)this.eqFilters[t].resetOutput();if(this.eqFilterCount=0,this.initialEqFilterInput1=0,this.initialEqFilterInput2=0,this.distortionFractionalInput1=0,this.distortionFractionalInput2=0,this.distortionFractionalInput3=0,this.distortionPrevInput=0,this.distortionNextOutput=0,this.panningDelayPos=0,null!=this.panningDelayLine)for(let t=0;t<this.panningDelayLine.length;t++)this.panningDelayLine[t]=0;this.echoDelayOffsetLastTickIsComputed=!1,this.echoShelfSampleL=0,this.echoShelfSampleR=0,this.echoShelfPrevInputL=0,this.echoShelfPrevInputR=0,this.reverbShelfSample0=0,this.reverbShelfSample1=0,this.reverbShelfSample2=0,this.reverbShelfSample3=0,this.reverbShelfPrevInput0=0,this.reverbShelfPrevInput1=0,this.reverbShelfPrevInput2=0,this.reverbShelfPrevInput3=0,this.awake=!1,this.flushingDelayLines=!1,this.deactivateAfterThisTick=!1,this.attentuationProgress=0,this.flushedSamples=0}resetAllEffects(){if(this.deactivate(),this.chorusDelayLineDirty){for(let t=0;t<this.chorusDelayLineL.length;t++)this.chorusDelayLineL[t]=0;for(let t=0;t<this.chorusDelayLineR.length;t++)this.chorusDelayLineR[t]=0}if(this.echoDelayLineDirty){for(let t=0;t<this.echoDelayLineL.length;t++)this.echoDelayLineL[t]=0;for(let t=0;t<this.echoDelayLineR.length;t++)this.echoDelayLineR[t]=0}if(this.reverbDelayLineDirty)for(let t=0;t<this.reverbDelayLine.length;t++)this.reverbDelayLine[t]=0;this.chorusPhase=0}compute(t,i,s,n,o){this.computed=!0,this.allocateNecessaryBuffers(t,i,s);const r=t.samplesPerSecond,h=t.tickSampleCountdown,a=h/s,l=(h-n)/s,c=m(i.effects),u=y(i.effects),f=g(i.effects),p=b(i.effects),d=v(i.effects),k=w(i.effects);if(c&&(this.distortionStart=Math.min(1,i.distortion/(e.distortionRange-1)),this.distortionEnd=Math.min(1,i.distortion/(e.distortionRange-1))),u){const s=i.bitcrusherFreq,o=i.bitcrusherFreq,h=i.bitcrusherQuantization,a=i.bitcrusherQuantization,l=e.keys[t.song.key].basePitch,c=dt.frequencyFromPitch(l+60)*Math.pow(2,(e.bitcrusherFreqRange-1-s)*e.bitcrusherOctaveStep),u=dt.frequencyFromPitch(l+60)*Math.pow(2,(e.bitcrusherFreqRange-1-o)*e.bitcrusherOctaveStep),f=Math.min(1,c/r),p=Math.min(1,u/r);this.bitcrusherPhaseDelta=f,this.bitcrusherPhaseDeltaScale=Math.pow(p/f,1/n);const d=2*e.bitcrusherBaseVolume*Math.pow(2,1-Math.pow(2,.5*(e.bitcrusherQuantizationRange-1-h))),m=2*e.bitcrusherBaseVolume*Math.pow(2,1-Math.pow(2,.5*(e.bitcrusherQuantizationRange-1-a)));this.bitcrusherScale=d,this.bitcrusherScaleScale=Math.pow(m/d,1/n);const y=2*e.bitcrusherBaseVolume*Math.pow(1.5,e.bitcrusherQuantizationRange-1-h),g=2*e.bitcrusherBaseVolume*Math.pow(1.5,e.bitcrusherQuantizationRange-1-a);this.bitcrusherFoldLevel=y,this.bitcrusherFoldLevelScale=Math.pow(g/y,1/n)}let M=1;const x=i.eqFilter;for(let t=0;t<x.controlPointCount;t++){const e=x.controlPoints[t];e.toCoefficients(Mt.tempFilterStartCoefficients,r,1,1),e.toCoefficients(Mt.tempFilterEndCoefficients,r,1,1),this.eqFilters.length<=t&&(this.eqFilters[t]=new Q),this.eqFilters[t].loadCoefficientsWithGradient(Mt.tempFilterStartCoefficients,Mt.tempFilterEndCoefficients,1/n,0==e.type),M*=e.getVolumeCompensationMult()}this.eqFilterCount=x.controlPointCount,M=Math.min(3,M);const S=Mt.instrumentVolumeToVolumeMult(i.volume);this.mixVolumeStart=S;const P=S;this.mixVolumeDelta=(P-this.mixVolumeStart)/n;let F=M,E=M,I=1,q=1;if(f){const t=(i.pan-e.panCenter)/e.panCenter,s=Math.max(-1,Math.min(1,t)),o=Math.max(-1,Math.min(1,t)),h=1.414*Math.cos((1+s)*Math.PI*.25),a=1.414*Math.cos((1-s)*Math.PI*.25),l=1.414*Math.cos((1+o)*Math.PI*.25),c=1.414*Math.cos((1-o)*Math.PI*.25),u=r*e.panDelaySecondsMax,f=s*u,p=o*u,d=Math.max(0,f),m=Math.max(0,-f),y=Math.max(0,p),g=Math.max(0,-p);this.panningVolumeStartL=h,this.panningVolumeStartR=a,this.panningVolumeDeltaL=(l-h)/n,this.panningVolumeDeltaR=(c-a)/n,this.panningOffsetStartL=d,this.panningOffsetStartR=m,this.panningOffsetDeltaL=(y-d)/n,this.panningOffsetDeltaR=(g-m)/n}if(p){const t=Math.min(1,i.chorus/(e.chorusRange-1)),s=Math.min(1,i.chorus/(e.chorusRange-1));this.chorusStart=.6*t+.4*Math.pow(t,6),this.chorusEnd=.6*s+.4*Math.pow(s,6)}let T=0;if(d){const o=.9*Math.min(1,Math.pow(i.echoSustain/e.echoSustainRange,1.1)),r=.9*Math.min(1,Math.pow(i.echoSustain/e.echoSustainRange,1.1));this.echoMultStart=o,this.echoMultDelta=(r-o)/n,T=Math.max(o,r);const h=Math.round((i.echoDelay+1)*e.echoDelayStepTicks*s);this.echoDelayOffsetLastTickIsComputed?this.echoDelayOffsetStart=this.echoDelayOffsetLastTick:this.echoDelayOffsetStart=h,t.isAtEndOfTick&&(this.echoDelayOffsetLastTick=h,this.echoDelayOffsetLastTickIsComputed=!0),this.echoDelayOffsetEnd=h,this.echoDelayOffsetRatio=1-a,this.echoDelayOffsetRatioDelta=(a-l)/n;const c=2*Math.PI*e.echoShelfHz/t.samplesPerSecond;Mt.tempFilterStartCoefficients.highShelf1stOrder(c,e.echoShelfGain),this.echoShelfA1=Mt.tempFilterStartCoefficients.a[1],this.echoShelfB0=Mt.tempFilterStartCoefficients.b[0],this.echoShelfB1=Mt.tempFilterStartCoefficients.b[1]}let C=0;if(k){const s=.425*Math.min(1,Math.pow(i.reverb/e.reverbRange,.667)),o=.425*Math.min(1,Math.pow(i.reverb/e.reverbRange,.667));this.reverbMultStart=s,this.reverbMultDelta=(o-s)/n,C=Math.max(s,o);const r=2*Math.PI*e.reverbShelfHz/t.samplesPerSecond;Mt.tempFilterStartCoefficients.highShelf1stOrder(r,e.reverbShelfGain),this.reverbShelfA1=Mt.tempFilterStartCoefficients.a[1],this.reverbShelfB0=Mt.tempFilterStartCoefficients.b[0],this.reverbShelfB1=Mt.tempFilterStartCoefficients.b[1]}if(this.tonesAddedInThisTick)this.attentuationProgress=0,this.flushedSamples=0,this.flushingDelayLines=!1;else if(this.flushingDelayLines){F=0,E=0,I=0,q=0;let i=0;p&&(i+=t.chorusDelayBufferSize),d&&(i+=this.echoDelayLineL.length),k&&(i+=e.reverbDelayBufferSize),this.flushedSamples+=n,this.flushedSamples>=i&&(this.deactivateAfterThisTick=!0)}else{0==this.attentuationProgress?(F*=a,E*=l):(F=0,E=0);const i=1/256,n=-Math.log2(i);let o=0;if(p&&(o+=e.chorusMaxDelay),d){const t=.5*(this.echoDelayOffsetStart+this.echoDelayOffsetEnd)/r,e=Math.pow(T,1/t);o+=-1/Math.log2(e)*n}if(k){const t=2*C,i=e.reverbDelayBufferSize/4/r,s=Math.pow(t,1/i);o+=-1/Math.log2(s)*n}const h=s/r/o,c=this.attentuationProgress+h;c>=1&&(I*=a,q*=l),t.isAtEndOfTick&&(this.attentuationProgress=c,this.attentuationProgress>=1&&(this.flushingDelayLines=!0))}this.eqFilterVolumeStart=F,this.eqFilterVolumeDelta=(E-F)/n,this.delayInputMultStart=I,this.delayInputMultDelta=(q-I)/n}}class kt{constructor(){this.instruments=[],this.muted=!1,this.singleSeamlessInstrument=null}}class Mt{constructor(t=null){this.samplesPerSecond=44100,this.song=null,this.liveInputDuration=0,this.liveInputStarted=!1,this.liveInputPitches=[],this.liveInputChannel=0,this.liveInputInstruments=[],this.loopRepeatCount=-1,this.volume=1,this.playheadInternal=0,this.bar=0,this.prevBar=null,this.nextBar=null,this.beat=0,this.part=0,this.tick=0,this.isAtStartOfTick=!0,this.isAtEndOfTick=!0,this.tickSampleCountdown=0,this.isPlayingSong=!1,this.liveInputEndTime=0,this.browserAutomaticallyClearsAudioBuffer=!0,this.tempDrumSetControlPoint=new ut,this.tempFrequencyResponse=new K,this.channels=[],this.tonePool=new J,this.tempMatchedPitchTones=Array(e.maxChordSize).fill(null),this.limit=0,this.tempMonoInstrumentSampleBuffer=null,this.audioCtx=null,this.scriptNode=null,this.audioProcessCallback=t=>{const e=t.outputBuffer,i=e.getChannelData(0),s=e.getChannelData(1);if(!this.browserAutomaticallyClearsAudioBuffer||0==i[0]&&0==s[0]&&0==i[e.length-1]&&0==s[e.length-1]||(this.browserAutomaticallyClearsAudioBuffer=!1),!this.browserAutomaticallyClearsAudioBuffer){const t=e.length;for(let e=0;e<t;e++)i[e]=0,s[e]=0}performance.now()<this.liveInputEndTime||this.isPlayingSong?this.synthesize(i,s,e.length,this.isPlayingSong):this.deactivateAudio()},this.computeDelayBufferSizes(),null!=t&&this.setSong(t)}syncSongState(){const t=this.song.getChannelCount();for(let e=this.channels.length;e<t;e++)this.channels[e]=new kt;this.channels.length=t;for(let e=0;e<t;e++){const t=this.song.channels[e],i=this.channels[e];for(let e=i.instruments.length;e<t.instruments.length;e++)i.instruments[e]=new wt;if(i.instruments.length=t.instruments.length,i.muted!=t.muted&&(i.muted=t.muted,i.muted))for(const t of i.instruments)t.resetAllEffects()}}warmUpSynthesizer(t){if(null!=t){this.syncSongState();const e=this.getSamplesPerTick();for(let i=0;i<t.getChannelCount();i++)for(let s=0;s<t.channels[i].instruments.length;s++){const n=t.channels[i].instruments[s],o=this.channels[i].instruments[s];Mt.getInstrumentSynthFunction(n),n.warmUp(this.samplesPerSecond),o.allocateNecessaryBuffers(this,n,e)}}}static operatorAmplitudeCurve(t){return(Math.pow(16,t/15)-1)/15}get playing(){return this.isPlayingSong}get playhead(){return this.playheadInternal}set playhead(t){if(null!=this.song){this.playheadInternal=Math.max(0,Math.min(this.song.barCount,t));let i=this.playheadInternal;this.bar=Math.floor(i),i=this.song.beatsPerBar*(i-this.bar),this.beat=Math.floor(i),i=e.partsPerBeat*(i-this.beat),this.part=Math.floor(i),i=e.ticksPerPart*(i-this.part),this.tick=Math.floor(i);const s=this.getSamplesPerTick();i=s*(i-this.tick),this.tickSampleCountdown=s-i,this.prevBar=null}}getSamplesPerBar(){if(null==this.song)throw new Error;return this.getSamplesPerTick()*e.ticksPerPart*e.partsPerBeat*this.song.beatsPerBar}getTicksIntoBar(){return(this.beat*e.partsPerBeat+this.part)*e.ticksPerPart+this.tick}getCurrentPart(){return this.beat*e.partsPerBeat+this.part}getTotalBars(t,e){if(null==this.song)throw new Error;let i=this.song.loopLength*(this.loopRepeatCount+1);return t&&(i+=this.song.loopStart),e&&(i+=this.song.barCount-(this.song.loopStart+this.song.loopLength)),i}setSong(t){"string"==typeof t?this.song=new yt(t):t instanceof yt&&(this.song=t),this.prevBar=null}computeDelayBufferSizes(){this.panningDelayBufferSize=Mt.fittingPowerOfTwo(this.samplesPerSecond*e.panDelaySecondsMax),this.panningDelayBufferMask=this.panningDelayBufferSize-1,this.chorusDelayBufferSize=Mt.fittingPowerOfTwo(this.samplesPerSecond*e.chorusMaxDelay),this.chorusDelayBufferMask=this.chorusDelayBufferSize-1}activateAudio(){null!=this.audioCtx&&null!=this.scriptNode||(this.audioCtx=this.audioCtx||new(window.AudioContext||window.webkitAudioContext),this.samplesPerSecond=this.audioCtx.sampleRate,this.scriptNode=this.audioCtx.createScriptProcessor?this.audioCtx.createScriptProcessor(2048,0,2):this.audioCtx.createJavaScriptNode(2048,0,2),this.scriptNode.onaudioprocess=this.audioProcessCallback,this.scriptNode.channelCountMode="explicit",this.scriptNode.channelInterpretation="speakers",this.scriptNode.connect(this.audioCtx.destination),this.computeDelayBufferSizes()),this.audioCtx.resume()}deactivateAudio(){null!=this.audioCtx&&null!=this.scriptNode&&(this.scriptNode.disconnect(this.audioCtx.destination),this.scriptNode=null,this.audioCtx.close&&this.audioCtx.close(),this.audioCtx=null)}maintainLiveInput(){this.activateAudio(),this.liveInputEndTime=performance.now()+1e4}play(){this.isPlayingSong||(this.isPlayingSong=!0,this.activateAudio(),this.warmUpSynthesizer(this.song))}pause(){this.isPlayingSong&&(this.isPlayingSong=!1)}snapToStart(){this.bar=0,this.snapToBar()}goToBar(t){this.bar=t,this.playheadInternal=this.bar,this.prevBar=null}snapToBar(){this.playheadInternal=this.bar,this.beat=0,this.part=0,this.tick=0,this.tickSampleCountdown=0,this.isAtStartOfTick=!0,this.prevBar=null}resetEffects(){if(this.limit=0,this.freeAllTones(),null!=this.song)for(const t of this.channels)for(const e of t.instruments)e.resetAllEffects()}jumpIntoLoop(){if(this.song&&(this.bar<this.song.loopStart||this.bar>=this.song.loopStart+this.song.loopLength)){const t=this.bar;this.bar=this.song.loopStart,this.playheadInternal+=this.bar-t,this.prevBar=null}}goToNextBar(){if(!this.song)return;this.prevBar=this.bar;const t=this.bar;this.bar++,this.bar>=this.song.barCount&&(this.bar=0),this.playheadInternal+=this.bar-t}goToPrevBar(){if(!this.song)return;this.prevBar=null;const t=this.bar;this.bar--,(this.bar<0||this.bar>=this.song.barCount)&&(this.bar=this.song.barCount-1),this.playheadInternal+=this.bar-t}synthesize(t,i,s,n=!0){if(null==this.song){for(let e=0;e<s;e++)t[e]=0,i[e]=0;return void this.deactivateAudio()}const o=this.song,r=this.getSamplesPerTick();let h=!1;for(;this.tickSampleCountdown<=0;)this.tickSampleCountdown+=r;this.tickSampleCountdown>r&&(this.tickSampleCountdown=r),n&&(this.beat>=o.beatsPerBar&&(this.bar++,this.beat=0,this.part=0,this.tick=0,this.tickSampleCountdown=r,0!=this.loopRepeatCount&&this.bar==o.loopStart+o.loopLength&&(this.bar=o.loopStart,this.loopRepeatCount>0&&this.loopRepeatCount--)),this.bar>=o.barCount&&(this.bar=0,-1!=this.loopRepeatCount&&(h=!0,this.pause()))),this.syncSongState(),(null==this.tempMonoInstrumentSampleBuffer||this.tempMonoInstrumentSampleBuffer.length<s)&&(this.tempMonoInstrumentSampleBuffer=new Float32Array(s));const a=+this.volume,l=1-Math.pow(.5,4/this.samplesPerSecond),c=1-Math.pow(.5,4e3/this.samplesPerSecond);let u=+this.limit,f=0;for(;f<s&&!h;){this.nextBar=this.bar+1,0!=this.loopRepeatCount&&this.nextBar==o.loopStart+o.loopLength&&(this.nextBar=o.loopStart),this.nextBar>=o.barCount&&(this.nextBar=null);const p=s-f,d=Math.ceil(this.tickSampleCountdown),m=Math.min(d,p);this.isAtEndOfTick=m>=this.tickSampleCountdown;for(let s=0;s<o.getChannelCount();s++){const h=o.channels[s],a=this.channels[s];this.determineCurrentActiveTones(o,s,n),this.determineLiveInputTones(o,s);for(let n=0;n<h.instruments.length;n++){const l=h.instruments[n],c=a.instruments[n];let u=0;for(let t=0;t<c.activeTones.count();t++){const e=c.activeTones.get(t);this.playTone(o,s,r,f,m,e,!1,!1),u++}for(let t=0;t<c.liveInputTones.count();t++){const e=c.liveInputTones.get(t);this.playTone(o,s,r,f,m,e,!1,!1),u++}for(let t=0;t<c.releasedTones.count();t++){const i=c.releasedTones.get(t);if(i.ticksSinceReleased>=Math.abs(l.getFadeOutTicks())){this.freeReleasedTone(c,t),t--;continue}const n=u>=e.maximumTonesPerChannel;this.playTone(o,s,r,f,m,i,!0,n),u++}c.awake&&(c.computed||c.compute(this,l,r,m,null),Mt.effectsSynth(this,t,i,f,m,l,c),c.computed=!1)}}const y=f+m;for(let e=f;e<y;e++){const s=t[e],n=i[e],o=Math.max(Math.abs(s),Math.abs(n));u+=(o-u)*(u<o?c:l*(1+u));const r=a/(u>=1?1.05*u:.8*u+.25);t[e]=s*r,i[e]=n*r}if(f+=m,this.isAtStartOfTick=!1,this.tickSampleCountdown-=m,this.tickSampleCountdown<=0){this.isAtStartOfTick=!0;for(const t of this.channels)for(const e of t.instruments){for(let t=0;t<e.releasedTones.count();t++){const i=e.releasedTones.get(t);i.isOnLastTick?(this.freeReleasedTone(e,t),t--):i.ticksSinceReleased++}e.deactivateAfterThisTick&&e.deactivate(),e.tonesAddedInThisTick=!1}this.tick++,this.tickSampleCountdown+=r,this.tick==e.ticksPerPart&&(this.tick=0,this.part++,this.liveInputDuration--,this.part==e.partsPerBeat&&(this.part=0,n&&(this.beat++,this.beat==o.beatsPerBar&&(this.beat=0,this.prevBar=this.bar,this.bar++,0!=this.loopRepeatCount&&this.bar==o.loopStart+o.loopLength&&(this.bar=o.loopStart,this.loopRepeatCount>0&&this.loopRepeatCount--),this.bar>=o.barCount&&(this.bar=0,-1!=this.loopRepeatCount&&(h=!0,this.resetEffects(),this.pause()))))))}}(!Number.isFinite(u)||Math.abs(u)<Z)&&(u=0),this.limit=u,n&&(this.playheadInternal=(((this.tick+1-this.tickSampleCountdown/r)/2+this.part)/e.partsPerBeat+this.beat)/o.beatsPerBar+this.bar)}freeTone(t){this.tonePool.pushBack(t)}newTone(){if(this.tonePool.count()>0){const t=this.tonePool.popBack();return t.freshlyAllocated=!0,t}return new vt}releaseTone(t,e){t.releasedTones.pushFront(e),e.atNoteStart=!1,e.passedEndOfNote=!0}freeReleasedTone(t,e){this.freeTone(t.releasedTones.get(e)),t.releasedTones.remove(e)}freeAllTones(){for(const t of this.channels)for(const e of t.instruments){for(;e.activeTones.count()>0;)this.freeTone(e.activeTones.popBack());for(;e.releasedTones.count()>0;)this.freeTone(e.releasedTones.popBack());for(;e.liveInputTones.count()>0;)this.freeTone(e.liveInputTones.popBack())}}determineLiveInputTones(t,e){const i=t.channels[e],s=this.channels[e],n=this.liveInputPitches;for(let t=0;t<i.instruments.length;t++){const o=s.instruments[t],r=o.liveInputTones;let h=0;if(this.liveInputDuration>0&&e==this.liveInputChannel&&n.length>0&&-1!=this.liveInputInstruments.indexOf(t)){const e=i.instruments[t];if(e.getChord().singleTone){let i;r.count()<=h?(i=this.newTone(),r.pushBack(i)):!e.getTransition().isSeamless&&this.liveInputStarted?(this.releaseTone(o,r.get(h)),i=this.newTone(),r.set(h,i)):i=r.get(h),h++;for(let t=0;t<n.length;t++)i.pitches[t]=n[t];i.pitchCount=n.length,i.chordSize=1,i.instrumentIndex=t,i.note=i.prevNote=i.nextNote=null,i.atNoteStart=this.liveInputStarted,i.forceContinueAtStart=!1,i.forceContinueAtEnd=!1}else for(let i=0;i<n.length;i++){let s;r.count()<=h?(s=this.newTone(),r.pushBack(s)):!e.getTransition().isSeamless&&this.liveInputStarted?(this.releaseTone(o,r.get(h)),s=this.newTone(),r.set(h,s)):s=r.get(h),h++,s.pitches[0]=n[i],s.pitchCount=1,s.chordSize=n.length,s.instrumentIndex=t,s.note=s.prevNote=s.nextNote=null,s.atNoteStart=this.liveInputStarted,s.forceContinueAtStart=!1,s.forceContinueAtEnd=!1}}for(;r.count()>h;)this.releaseTone(o,r.popBack())}this.liveInputStarted=!1}adjacentPatternHasCompatibleInstrumentTransition(t,e,i,s,n,o,r,h,a,l){if(t.patternInstruments&&-1==s.instruments.indexOf(n)){if(i.instruments.length>1||s.instruments.length>1)return null;const t=e.instruments[s.instruments[0]];if(l)return t.getChord();const n=t.getTransition();return o.includeAdjacentPatterns&&n.includeAdjacentPatterns&&n.slides==o.slides?t.getChord():null}return l||o.includeAdjacentPatterns?r:null}static adjacentNotesHaveMatchingPitches(t,e){if(t.pitches.length!=e.pitches.length)return!1;const i=t.pins[t.pins.length-1].interval;for(const s of t.pitches)if(-1==e.pitches.indexOf(s+i))return!1;return!0}determineCurrentActiveTones(t,i,s){const n=t.channels[i],o=this.channels[i],r=t.getPattern(i,this.bar),h=this.getCurrentPart(),a=this.tick+e.ticksPerPart*h;let l=null,c=null,u=null;if(s&&null!=r&&!n.muted){for(let t=0;t<r.notes.length;t++)if(r.notes[t].end<=h)c=r.notes[t];else if(r.notes[t].start<=h&&r.notes[t].end>h)l=r.notes[t];else if(r.notes[t].start>h){u=r.notes[t];break}null!=l&&(null!=c&&c.end!=l.start&&(c=null),null!=u&&u.start!=l.end&&(u=null))}if(null!=r&&(!t.layeredInstruments||1==n.instruments.length||t.patternInstruments&&1==r.instruments.length)){const e=t.patternInstruments?r.instruments[0]:0;if(null!=o.singleSeamlessInstrument&&o.singleSeamlessInstrument!=e&&o.singleSeamlessInstrument<o.instruments.length){const t=o.instruments[o.singleSeamlessInstrument],i=o.instruments[e];for(;t.activeTones.count()>0;)i.activeTones.pushFront(t.activeTones.popBack())}o.singleSeamlessInstrument=e}else o.singleSeamlessInstrument=null;for(let s=0;s<n.instruments.length;s++){const f=o.instruments[s],p=f.activeTones;let d=0;if(null!=l&&(!t.patternInstruments||-1!=r.instruments.indexOf(s))){const o=n.instruments[s];let m=c,y=u;const g=e.partsPerBeat*t.beatsPerBar,b=o.getTransition(),v=o.getChord();let w=!1,k=!1,M=0,x=0;if(0==l.start){let e=null==this.prevBar?null:t.getPattern(i,this.prevBar);if(null!=e){const i=e.notes.length<=0?null:e.notes[e.notes.length-1];if(null!=i&&i.end==g){const o=l.continuesLastPattern&&Mt.adjacentNotesHaveMatchingPitches(i,l),h=this.adjacentPatternHasCompatibleInstrumentTransition(t,n,r,e,s,b,v,l,i,o);null!=h&&(m=i,M=h.singleTone?1:m.pitches.length,w=o)}}}else null!=m&&(M=v.singleTone?1:m.pitches.length);if(l.end==g){let e=null==this.nextBar?null:t.getPattern(i,this.nextBar);if(null!=e){const i=e.notes.length<=0?null:e.notes[0];if(null!=i&&0==i.start){const o=i.continuesLastPattern&&Mt.adjacentNotesHaveMatchingPitches(l,i),h=this.adjacentPatternHasCompatibleInstrumentTransition(t,n,r,e,s,b,v,l,i,o);null!=h&&(y=i,x=h.singleTone?1:y.pitches.length,k=o)}}}else null!=y&&(x=v.singleTone?1:y.pitches.length);if(v.singleTone){const t=e.ticksPerPart*l.start==a&&this.isAtStartOfTick;let i;if(p.count()<=d)i=this.newTone(),p.pushBack(i);else if(!t||(b.isSeamless||w)&&null!=m)i=p.get(d);else{const t=p.get(d);t.isOnLastTick?this.freeTone(t):this.releaseTone(f,t),i=this.newTone(),p.set(d,i)}d++;for(let t=0;t<l.pitches.length;t++)i.pitches[t]=l.pitches[t];i.pitchCount=l.pitches.length,i.chordSize=1,i.instrumentIndex=s,i.note=l,i.noteStartPart=l.start,i.noteEndPart=l.end,i.prevNote=m,i.nextNote=y,i.prevNotePitchIndex=0,i.nextNotePitchIndex=0,i.atNoteStart=t,i.passedEndOfNote=!1,i.forceContinueAtStart=w,i.forceContinueAtEnd=k}else{const t=o.getTransition();if((t.isSeamless&&!t.slides&&0==v.strumParts||w)&&e.ticksPerPart*l.start==a&&this.isAtStartOfTick&&null!=m){for(let t=0;t<p.count();t++){const e=p.get(t),i=e.pitches[0]+e.lastInterval;for(let s=0;s<l.pitches.length;s++)if(l.pitches[s]==i){this.tempMatchedPitchTones[s]=e,p.remove(t),t--;break}}for(;p.count()>0;){const t=p.popFront();for(let e=0;e<this.tempMatchedPitchTones.length;e++)if(null==this.tempMatchedPitchTones[e]){this.tempMatchedPitchTones[e]=t;break}}}let i=0;for(let n=0;n<l.pitches.length;n++){let o=M>n?m:null,r=l,c=x>n?y:null,u=r.start+i,g=!1;if(u>h){if(!(p.count()>n&&(t.isSeamless||w)&&null!=o))break;c=r,r=o,o=null,u=r.start+i,g=!0}let b=r.end;(t.isSeamless||w)&&null!=c&&(b=Math.min(e.partsPerBeat*this.song.beatsPerBar,b+i)),(t.continues||w)&&null!=o||(i+=v.strumParts);const S=e.ticksPerPart*u==a&&this.isAtStartOfTick;let P;if(null!=this.tempMatchedPitchTones[d])P=this.tempMatchedPitchTones[d],this.tempMatchedPitchTones[d]=null,p.pushBack(P);else if(p.count()<=d)P=this.newTone(),p.pushBack(P);else if(!S||(t.isSeamless||w)&&null!=o)P=p.get(d);else{const t=p.get(d);t.isOnLastTick?this.freeTone(t):this.releaseTone(f,t),P=this.newTone(),p.set(d,P)}d++,P.pitches[0]=r.pitches[n],P.pitchCount=1,P.chordSize=r.pitches.length,P.instrumentIndex=s,P.note=r,P.noteStartPart=u,P.noteEndPart=b,P.prevNote=o,P.nextNote=c,P.prevNotePitchIndex=n,P.nextNotePitchIndex=n,P.atNoteStart=S,P.passedEndOfNote=g,P.forceContinueAtStart=w&&null!=o,P.forceContinueAtEnd=k&&null!=c}}}for(;p.count()>d;){const e=p.popBack(),s=t.channels[i];if(e.instrumentIndex<s.instruments.length&&!e.isOnLastTick){const t=this.channels[i].instruments[e.instrumentIndex];this.releaseTone(t,e)}else this.freeTone(e)}for(let t=d;t<this.tempMatchedPitchTones.length;t++){const e=this.tempMatchedPitchTones[t];null!=e&&(e.isOnLastTick?this.freeTone(e):this.releaseTone(f,e),this.tempMatchedPitchTones[t]=null)}}}playTone(t,e,i,s,n,o,r,h){const a=t.channels[e],l=this.channels[e],c=a.instruments[o.instrumentIndex],u=l.instruments[o.instrumentIndex];u.awake=!0,u.tonesAddedInThisTick=!0,u.computed||u.compute(this,c,i,n,o),Mt.computeTone(this,t,e,i,n,o,r,h);Mt.getInstrumentSynthFunction(c)(this,s,n,o,c),o.envelopeComputer.clearEnvelopes(c)}static computeChordExpression(t){return 1/(.25*(t-1)+1)}static computeTone(t,i,s,o,r,a,l,c){const m=i.channels[s].instruments[a.instrumentIndex],y=m.getTransition(),g=m.getChord(),b=g.singleTone?1:Mt.computeChordExpression(a.chordSize),v=i.getChannelIsNoise(s),w=v?e.noiseInterval:1,k=e.ticksPerPart*o/t.samplesPerSecond,M=1/t.samplesPerSecond,x=1/e.partsPerBeat,S=t.tickSampleCountdown,P=1-S/o,F=1-(S-r)/o,E=t.getTicksIntoBar(),I=E/e.ticksPerPart,q=(E+1)/e.ticksPerPart,T=I+(q-I)*P,C=I+(q-I)*F,L=t.getCurrentPart();a.specialIntervalMult=1,a.specialIntervalExpressionMult=1;let D=c,z=0,A=0,R=1,O=1,B=b,N=b,H=16,G=e.keys[i.key].basePitch,$=1,_=48;if(3==m.type)$=e.spectrumBaseExpression,v&&(G=e.spectrumBasePitch,$*=2),H=e.spectrumBasePitch,_=28;else if(4==m.type)G=e.spectrumBasePitch,$=e.drumsetBaseExpression,H=G;else if(2==m.type)G=e.chipNoises[m.chipNoise].basePitch,$=e.noiseBaseExpression,H=G,_=e.chipNoises[m.chipNoise].isSoft?24:60;else if(1==m.type)$=e.fmBaseExpression;else if(0==m.type)$=e.chipBaseExpression;else if(5==m.type)$=e.harmonicsBaseExpression;else if(6==m.type)$=e.pwmBaseExpression;else{if(7!=m.type)throw new Error("Unknown instrument type in computeTone.");$=e.pickedStringBaseExpression}(a.atNoteStart&&!y.isSeamless&&!a.forceContinueAtStart||a.freshlyAllocated)&&a.reset(),a.freshlyAllocated=!1;const U=Math.max(e.maxChordSize,e.operatorCount);for(let t=0;t<U;t++)a.phaseDeltas[t]=0,a.expressionStarts[t]=0,a.expressionDeltas[t]=0,a.phaseDeltaScales[t]=0;if(l){const t=a.ticksSinceReleased+P,i=a.ticksSinceReleased+F;z=A=a.lastInterval;const s=Math.abs(m.getFadeOutTicks());R=Mt.noteSizeToVolumeMult((1-t/s)*e.noteSizeMax),O=Mt.noteSizeToVolumeMult((1-i/s)*e.noteSizeMax),c&&(R*=1-P,O*=1-F),a.ticksSinceReleased+1>=s&&(D=!0)}else if(null==a.note)R=O=1,a.lastInterval=0,a.ticksSinceReleased=0,a.liveInputSamplesHeld+=r;else{const i=a.note,s=a.nextNote,n=a.noteStartPart,o=a.noteEndPart,r=i.getEndPinIndex(L),h=i.pins[r-1],l=i.pins[r],c=n*e.ticksPerPart,u=o*e.ticksPerPart,f=(i.start+h.time)*e.ticksPerPart,p=(i.start+l.time)*e.ticksPerPart;a.ticksSinceReleased=0;const d=L*e.ticksPerPart+t.tick,g=L*e.ticksPerPart+t.tick+1,b=d-c,v=g-c,w=Math.min(1,(d-f)/(p-f)),k=Math.min(1,(g-f)/(p-f));let M=1,x=1,S=h.interval+(l.interval-h.interval)*w,E=h.interval+(l.interval-h.interval)*k;if(a.lastInterval=E,!y.isSeamless&&!a.forceContinueAtEnd||null==s){const t=-m.getFadeOutTicks();if(t>0){const e=u-c;M*=Math.min(1,(e-b)/t),x*=Math.min(1,(e-v)/t),g>=c+e&&(D=!0)}}z=S+(E-S)*P,A=S+(E-S)*F,R=M+(x-M)*P,O=M+(x-M)*F}a.isOnLastTick=D;const V=a.envelopeComputer;V.computeEnvelopes(m,L,e.ticksPerPart*T,e.ticksPerPart*C,k*(C-T),a);const W=a.envelopeComputer.envelopeStarts,j=a.envelopeComputer.envelopeEnds;if(null!=a.note&&y.slides){const t=a.prevNote,e=a.nextNote;if(null!=t){const e=t.pitches[a.prevNotePitchIndex]+t.pins[t.pins.length-1].interval-a.pitches[0];if(V.prevSlideStart&&(z+=e*V.prevSlideRatioStart),V.prevSlideEnd&&(A+=e*V.prevSlideRatioEnd),!g.singleTone){const e=t.pitches.length-a.chordSize;V.prevSlideStart&&(B=Mt.computeChordExpression(a.chordSize+e*V.prevSlideRatioStart)),V.prevSlideEnd&&(N=Mt.computeChordExpression(a.chordSize+e*V.prevSlideRatioEnd))}}if(null!=e){const t=e.pitches[a.nextNotePitchIndex]-(a.pitches[0]+a.note.pins[a.note.pins.length-1].interval);if(V.nextSlideStart&&(z+=t*V.nextSlideRatioStart),V.nextSlideEnd&&(A+=t*V.nextSlideRatioEnd),!g.singleTone){const t=e.pitches.length-a.chordSize;V.nextSlideStart&&(B=Mt.computeChordExpression(a.chordSize+t*V.nextSlideRatioStart)),V.nextSlideEnd&&(N=Mt.computeChordExpression(a.chordSize+t*V.nextSlideRatioEnd))}}}if(u(m.effects)){const t=e.justIntonationSemitones[m.pitchShift]/w;z+=t*W[14],A+=t*j[14]}if(f(m.effects)){const t=W[15],i=j[15];z+=Mt.detuneToCents((m.detune-e.detuneCenter)*t)*e.pitchesPerOctave/1200,A+=Mt.detuneToCents((m.detune-e.detuneCenter)*i)*e.pitchesPerOctave/1200}if(p(m.effects)){const t=e.vibratos[m.vibrato].delayTicks,i=e.vibratos[m.vibrato].amplitude;let s;if(null!=a.prevVibrato)s=a.prevVibrato;else{if(s=i*Mt.getLFOAmplitude(m,k*T)*W[16],t>0){const e=t-V.noteTicksStart;s*=Math.max(0,Math.min(1,1-e/2))}}let n=i*Mt.getLFOAmplitude(m,k*C)*j[16];if(t>0){const e=t-V.noteTicksEnd;n*=Math.max(0,Math.min(1,1-e/2))}a.prevVibrato=n,z+=s,A+=n}if(!y.isSeamless&&!a.forceContinueAtStart||null==a.prevNote){const t=m.getFadeInSeconds();t>0&&(R*=Math.min(1,V.noteSecondsStart/t),O*=Math.min(1,V.noteSecondsEnd/t))}4==m.type&&null==a.drumsetPitch&&(a.drumsetPitch=a.pitches[0],null!=a.note&&(a.drumsetPitch+=a.note.pickMainInterval()),a.drumsetPitch=Math.max(0,Math.min(e.drumCount-1,a.drumsetPitch)));let J=V.lowpassCutoffDecayVolumeCompensation;if(d(m.effects)){const e=m.noteFilter,i=W[1],s=j[1];for(let n=0;n<e.controlPointCount;n++){const o=W[17+n],h=j[17+n],l=W[25+n],c=j[25+n],u=e.controlPoints[n];u.toCoefficients(Mt.tempFilterStartCoefficients,t.samplesPerSecond,i*o,l),u.toCoefficients(Mt.tempFilterEndCoefficients,t.samplesPerSecond,s*h,c),a.noteFilters.length<=n&&(a.noteFilters[n]=new Q),a.noteFilters[n].loadCoefficientsWithGradient(Mt.tempFilterStartCoefficients,Mt.tempFilterEndCoefficients,1/r,0==u.type),J*=u.getVolumeCompensationMult()}a.noteFilterCount=e.controlPointCount}else a.noteFilterCount=0;if(4==m.type){const e=m.getDrumsetEnvelope(a.drumsetPitch);J*=bt.getLowpassCutoffDecayVolumeCompensation(e);let i=bt.computeEnvelope(e,V.noteSecondsStart,x*T,V.noteSizeStart),s=bt.computeEnvelope(e,V.noteSecondsEnd,x*C,V.noteSizeEnd);if(V.prevSlideStart){i+=(bt.computeEnvelope(e,V.prevNoteSecondsStart,x*T,V.prevNoteSize)-i)*V.prevSlideRatioStart}if(V.prevSlideEnd){s+=(bt.computeEnvelope(e,V.prevNoteSecondsEnd,x*C,V.prevNoteSize)-s)*V.prevSlideRatioEnd}if(V.nextSlideStart){i+=(bt.computeEnvelope(e,0,x*T,V.nextNoteSize)-i)*V.nextSlideRatioStart}if(V.nextSlideEnd){s+=(bt.computeEnvelope(e,0,x*C,V.nextNoteSize)-s)*V.nextSlideRatioEnd}const n=t.tempDrumSetControlPoint;n.type=0,n.gain=ut.getRoundedSettingValueFromLinearGain(.5),n.freq=ut.getRoundedSettingValueFromHz(8e3),n.toCoefficients(Mt.tempFilterStartCoefficients,t.samplesPerSecond,i*(1+i),1),n.toCoefficients(Mt.tempFilterEndCoefficients,t.samplesPerSecond,s*(1+s),1),a.noteFilters.length==a.noteFilterCount&&(a.noteFilters[a.noteFilterCount]=new Q),a.noteFilters[a.noteFilterCount].loadCoefficientsWithGradient(Mt.tempFilterStartCoefficients,Mt.tempFilterEndCoefficients,1/r,!0),a.noteFilterCount++}if(J=Math.min(3,J),1==m.type){let s=1,n=0,o=0;const l=g.arpeggiates;if(a.pitchCount>1&&l){const s=Math.floor((t.tick+t.part*e.ticksPerPart)/e.rhythms[i.rhythm].ticksPerArpeggio);o=a.pitches[h(a.pitchCount,i.rhythm,s)]-a.pitches[0]}const c=e.algorithms[m.algorithm].carrierCount;for(let t=0;t<e.operatorCount;t++){const i=e.algorithms[m.algorithm].associatedCarrier[t]-1,h=a.pitches[l?0:t<a.pitchCount?t:i<a.pitchCount?i:0],u=e.operatorFrequencies[m.operators[t].frequency].mult,f=e.operatorCarrierInterval[i]+o,p=G+(h+z)*w+f,d=G+(h+A)*w+f,y=dt.frequencyFromPitch(p),g=dt.frequencyFromPitch(d),b=e.operatorFrequencies[m.operators[t].frequency].hzOffset,v=u*y+b,k=u*g+b,x=W[5+t],S=j[5+t];let P,F;1!=x||1!=S?(P=Math.pow(2,Math.log2(v/y)*x)*y,F=Math.pow(2,Math.log2(k/g)*S)*g):(P=v,F=k),a.phaseDeltas[t]=P*M*e.sineWaveLength,a.phaseDeltaScales[t]=Math.pow(F/P,1/r);const E=Mt.operatorAmplitudeCurve(m.operators[t].amplitude),I=E*e.operatorFrequencies[m.operators[t].frequency].amplitudeSign;let q=I,T=I;if(t<c){const t=Math.pow(2,-(p-H)/_),e=Math.pow(2,-(d-H)/_);q*=$*t*R*J*B,T*=$*e*O*J*N,q*=W[0],T*=j[0],n+=E}else q*=1.5*e.sineWaveLength,T*=1.5*e.sineWaveLength,s*=1-Math.min(1,m.operators[t].amplitude/15);q*=W[9+t],T*=j[9+t],a.expressionStarts[t]=q,a.expressionDeltas[t]=(T-q)/r}s*=(Math.pow(2,2-1.4*m.feedbackAmplitude/15)-1)/3,s*=1-Math.min(1,Math.max(0,n-1)/2),s=1+3*s;for(let t=0;t<c;t++)a.expressionStarts[t]*=s,a.expressionDeltas[t]*=s;const u=.3*e.sineWaveLength*m.feedbackAmplitude/15;let f=u*W[13],p=u*j[13];a.feedbackMult=f,a.feedbackDelta=(p-a.feedbackMult)/r}else{const s=Math.pow(2,(A-z)*w/12/r);let o=a.pitches[0];if(a.pitchCount>1&&(g.arpeggiates||g.customInterval)){const s=Math.floor((t.tick+t.part*e.ticksPerPart)/e.rhythms[i.rhythm].ticksPerArpeggio);if(g.customInterval){const t=a.pitches[1+h(a.pitchCount-1,i.rhythm,s)]-a.pitches[0];a.specialIntervalMult=Math.pow(2,t/12),a.specialIntervalExpressionMult=Math.pow(2,-t/_)}else o=a.pitches[h(a.pitchCount,i.rhythm,s)]}const l=G+(o+z)*w,c=G+(o+A)*w,u=Math.pow(2,-(l-H)/_),f=Math.pow(2,-(c-H)/_);let p=$*J;if(2==m.type&&(p*=e.chipNoises[m.chipNoise].expression),0==m.type&&(p*=e.chipWaves[m.chipWave].expression),6==m.type){const t=n(m.pulseWidth),e=t*W[2],i=t*j[2];a.pulseWidth=e,a.pulseWidthDelta=(i-e)/r}if(7==m.type){p*=Math.pow(2,.7*(1-m.stringSustain/(e.stringSustainRange-1)));const t=e.unisons[m.unison];for(let e=a.pickedStrings.length;e<t.voices;e++)a.pickedStrings[e]=new gt;if(a.atNoteStart&&!y.continues&&!a.forceContinueAtStart)for(const t of a.pickedStrings)t.delayIndex=-1}const d=dt.frequencyFromPitch(l);if(0==m.type||5==m.type||7==m.type){const t=e.unisons[m.unison],i=7==m.type?1:t.voices/2;p*=t.expression*i;const n=W[4],o=j[4],h=Math.pow(2,(t.offset+t.spread)*n/12),l=Math.pow(2,(t.offset+t.spread)*o/12),c=Math.pow(2,(t.offset-t.spread)*n/12)*a.specialIntervalMult,u=Math.pow(2,(t.offset-t.spread)*o/12)*a.specialIntervalMult;a.phaseDeltas[0]=d*M*h,a.phaseDeltas[1]=d*M*c,a.phaseDeltaScales[0]=s*Math.pow(l/h,1/r),a.phaseDeltaScales[1]=s*Math.pow(u/c,1/r)}else a.phaseDeltas[0]=d*M,a.phaseDeltaScales[0]=s;let b=p*R*B*u*W[0],v=p*O*N*f*j[0];a.expressionStarts[0]=b,a.expressionDeltas[0]=(v-b)/r}}static getLFOAmplitude(t,i){let s=0;for(const n of e.vibratos[t.vibrato].periodsSeconds)s+=Math.sin(2*Math.PI*i/n);return s}static getInstrumentSynthFunction(t){if(1==t.type){const i=t.algorithm+"_"+t.feedbackType;if(null==Mt.fmSynthFunctionCache[i]){const s=[];for(const i of Mt.fmSourceTemplate)if(-1!=i.indexOf("// CARRIER OUTPUTS")){const n=[];for(let i=0;i<e.algorithms[t.algorithm].carrierCount;i++)n.push("operator"+i+"Scaled");s.push(i.replace("/*operator#Scaled*/",n.join(" + ")))}else if(-1!=i.indexOf("// INSERT OPERATOR COMPUTATION HERE"))for(let i=e.operatorCount-1;i>=0;i--)for(const n of Mt.operatorSourceTemplate)if(-1!=n.indexOf("/* + operator@Scaled*/")){let o="";for(const s of e.algorithms[t.algorithm].modulatedBy[i])o+=" + operator"+(s-1)+"Scaled";const r=e.feedbacks[t.feedbackType].indices[i];if(r.length>0){o+=" + feedbackMult * (";const t=[];for(const e of r)t.push("operator"+(e-1)+"Output");o+=t.join(" + ")+")"}s.push(n.replace(/\#/g,i+"").replace("/* + operator@Scaled*/",o))}else s.push(n.replace(/\#/g,i+""));else if(-1!=i.indexOf("#"))for(let t=0;t<e.operatorCount;t++)s.push(i.replace(/\#/g,t+""));else s.push(i);Mt.fmSynthFunctionCache[i]=new Function("synth","bufferIndex","runLength","tone","instrument",s.join("\n"))}return Mt.fmSynthFunctionCache[i]}if(0==t.type)return Mt.chipSynth;if(5==t.type)return Mt.harmonicsSynth;if(6==t.type)return Mt.pulseWidthSynth;if(7==t.type)return Mt.pickedStringSynth;if(2==t.type)return Mt.noiseSynth;if(3==t.type)return Mt.spectrumSynth;if(4==t.type)return Mt.drumsetSynth;throw new Error("Unrecognized instrument type: "+t.type)}static chipSynth(t,i,s,n,o){const r=t.tempMonoInstrumentSampleBuffer,h=e.chipWaves[o.chipWave].samples,a=h.length-1,l=n.specialIntervalExpressionMult*e.unisons[o.unison].sign;0!=o.unison||o.getChord().customInterval||(n.phases[1]=n.phases[0]);let c=n.phaseDeltas[0]*a,u=n.phaseDeltas[1]*a;const f=+n.phaseDeltaScales[0],p=+n.phaseDeltaScales[1];let d=+n.expressionStarts[0];const m=+n.expressionDeltas[0];let y=n.phases[0]%1*a,g=n.phases[1]%1*a;const b=n.noteFilters,v=0|n.noteFilterCount;let w=+n.initialNoteFilterInput1,k=+n.initialNoteFilterInput2;const M=Mt.applyFilters,x=0|y,S=0|g,P=x%a,F=S%a,E=y-x,I=g-S;let q=+h[P],T=+h[F];q+=(h[P+1]-q)*E,T+=(h[F+1]-T)*I;const C=i+s;for(let t=i;t<C;t++){y+=c,g+=u;const e=0|y,i=0|g,s=e%a,n=i%a;let o=h[s],x=h[n];const S=y-e,P=g-i;o+=(h[s+1]-o)*S,x+=(h[n+1]-x)*P;const F=(o-q)/c,E=(x-T)/u;q=o,T=x;const I=F+E*l,C=M(I,w,k,v,b);k=w,w=I,c*=f,u*=p;const L=C*d;d+=m,r[t]+=L}n.phases[0]=y/a,n.phases[1]=g/a,t.sanitizeFilters(b),n.initialNoteFilterInput1=w,n.initialNoteFilterInput2=k}static harmonicsSynth(t,i,s,n,o){const r=t.tempMonoInstrumentSampleBuffer,h=o.harmonicsWave.getCustomWave(o.type),a=h.length-1,l=n.specialIntervalExpressionMult*e.unisons[o.unison].sign;0!=o.unison||o.getChord().customInterval||(n.phases[1]=n.phases[0]);let c=n.phaseDeltas[0]*a,u=n.phaseDeltas[1]*a;const f=+n.phaseDeltaScales[0],p=+n.phaseDeltaScales[1];let d=+n.expressionStarts[0];const m=+n.expressionDeltas[0];let y=n.phases[0]%1*a,g=n.phases[1]%1*a;const b=n.noteFilters,v=0|n.noteFilterCount;let w=+n.initialNoteFilterInput1,k=+n.initialNoteFilterInput2;const M=Mt.applyFilters,x=0|y,S=0|g,P=x%a,F=S%a,E=y-x,I=g-S;let q=+h[P],T=+h[F];q+=(h[P+1]-q)*E,T+=(h[F+1]-T)*I;const C=i+s;for(let t=i;t<C;t++){y+=c,g+=u;const e=0|y,i=0|g,s=e%a,n=i%a;let o=h[s],x=h[n];const S=y-e,P=g-i;o+=(h[s+1]-o)*S,x+=(h[n+1]-x)*P;const F=(o-q)/c,E=(x-T)/u;q=o,T=x;const I=F+E*l,C=M(I,w,k,v,b);k=w,w=I,c*=f,u*=p;const L=C*d;d+=m,r[t]+=L}n.phases[0]=y/a,n.phases[1]=g/a,t.sanitizeFilters(b),n.initialNoteFilterInput1=w,n.initialNoteFilterInput2=k}static pickedStringSynth(t,i,s,n,o){const r=e.unisons[o.unison].voices;let h=Mt.pickedStringFunctionCache[r];if(null==h){let t="";t+=`\n\t\t\t\t\n\t\t\t\tconst Config = beepbox.Config;\n\t\t\t\tconst Synth = beepbox.Synth;\n\t\t\t\tconst NoteAutomationStringSustainIndex = 3;\n\t\t\t\tconst voiceCount = ${r};\n\t\t\t\tconst data = synth.tempMonoInstrumentSampleBuffer;\n\t\t\t\t\n\t\t\t\tconst sustainEnvelopeStart = tone.envelopeComputer.envelopeStarts[NoteAutomationStringSustainIndex];\n\t\t\t\tconst sustainEnvelopeEnd   = tone.envelopeComputer.envelopeEnds[  NoteAutomationStringSustainIndex];\n\t\t\t\tconst stringDecayStart = 1.0 - Math.min(1.0, sustainEnvelopeStart * instrument.stringSustain / (Config.stringSustainRange - 1));\n\t\t\t\tconst stringDecayEnd   = 1.0 - Math.min(1.0, sustainEnvelopeEnd   * instrument.stringSustain / (Config.stringSustainRange - 1));\n\t\t\t\t\n\t\t\t\tlet pickedString# = tone.pickedStrings[#];\n\t\t\t\t\n\t\t\t\tconst prevDelayLength# = +pickedString#.prevDelayLength;\n\t\t\t\tlet allPassSample# = +pickedString#.allPassSample;\n\t\t\t\tlet allPassPrevInput# = +pickedString#.allPassPrevInput;\n\t\t\t\tlet shelfSample# = +pickedString#.shelfSample;\n\t\t\t\tlet shelfPrevInput# = +pickedString#.shelfPrevInput;\n\t\t\t\tlet fractionalDelaySample# = +pickedString#.fractionalDelaySample;\n\t\t\t\t\n\t\t\t\tlet expression = +tone.expressionStarts[0];\n\t\t\t\tconst expressionDelta = +tone.expressionDeltas[0];\n\t\t\t\t\n\t\t\t\tconst phaseDeltaStart# = +tone.phaseDeltas[#];\n\t\t\t\tconst phaseDeltaScale# = +tone.phaseDeltaScales[#];\n\t\t\t\tconst phaseDeltaEnd# = phaseDeltaStart# * Math.pow(phaseDeltaScale#, runLength);\n\t\t\t\t\n\t\t\t\tconst radiansPerSampleStart# = Math.PI * 2.0 * phaseDeltaStart#;\n\t\t\t\tconst radiansPerSampleEnd#   = Math.PI * 2.0 * phaseDeltaEnd#;\n\t\t\t\t\n\t\t\t\tconst centerHarmonicStart# = radiansPerSampleStart# * 2.0;\n\t\t\t\tconst centerHarmonicEnd#   = radiansPerSampleEnd# * 2.0;\n\t\t\t\t\n\t\t\t\tconst allPassCenter = 2.0 * Math.PI * Config.pickedStringDispersionCenterFreq / synth.samplesPerSecond;\n\t\t\t\tconst allPassRadiansStart# = Math.min(Math.PI, radiansPerSampleStart# * Config.pickedStringDispersionFreqMult * Math.pow(allPassCenter / radiansPerSampleStart#, Config.pickedStringDispersionFreqScale));\n\t\t\t\tconst allPassRadiansEnd# = Math.min(Math.PI, radiansPerSampleEnd# * Config.pickedStringDispersionFreqMult * Math.pow(allPassCenter / radiansPerSampleEnd#, Config.pickedStringDispersionFreqScale));\n\t\t\t\t\n\t\t\t\tconst shelfRadians = 2.0 * Math.PI * Config.pickedStringShelfHz / synth.samplesPerSecond;\n\t\t\t\tconst decayCurveStart = (Math.pow(100.0, stringDecayStart) - 1.0) / 99.0;\n\t\t\t\tconst decayCurveEnd   = (Math.pow(100.0, stringDecayEnd  ) - 1.0) / 99.0;\n\t\t\t\tconst decayRateStart# = Math.pow(0.5, decayCurveStart * shelfRadians / radiansPerSampleStart#);\n\t\t\t\tconst decayRateEnd#   = Math.pow(0.5, decayCurveEnd   * shelfRadians / radiansPerSampleEnd#);\n\t\t\t\tconst shelfGainStart# = Math.pow(decayRateStart#, Config.stringDecayRate);\n\t\t\t\tconst shelfGainEnd#   = Math.pow(decayRateEnd#,   Config.stringDecayRate);\n\t\t\t\tconst expressionDecayStart# = Math.pow(decayRateStart#, 0.002);\n\t\t\t\tconst expressionDecayEnd#   = Math.pow(decayRateEnd#,   0.002);`;for(let e=0;e<r;e++)t+="\n\t\t\t\t\n\t\t\t\tSynth.tempFilterStartCoefficients.allPass1stOrderInvertPhaseAbove(allPassRadiansStart#);\n\t\t\t\tsynth.tempFrequencyResponse.analyze(Synth.tempFilterStartCoefficients, centerHarmonicStart#);\n\t\t\t\tlet allPassG# = +Synth.tempFilterStartCoefficients.b[0]; /* same as a[1] */\n\t\t\t\tconst allPassPhaseDelayStart# = -synth.tempFrequencyResponse.angle() / centerHarmonicStart#;\n\t\t\t\t\n\t\t\t\tSynth.tempFilterEndCoefficients.allPass1stOrderInvertPhaseAbove(allPassRadiansEnd#);\n\t\t\t\tsynth.tempFrequencyResponse.analyze(Synth.tempFilterEndCoefficients, centerHarmonicEnd#);\n\t\t\t\tconst allPassGEnd# = +Synth.tempFilterEndCoefficients.b[0]; /* same as a[1] */\n\t\t\t\tconst allPassPhaseDelayEnd# = -synth.tempFrequencyResponse.angle() / centerHarmonicEnd#;\n\t\t\t\t\n\t\t\t\tSynth.tempFilterStartCoefficients.highShelf1stOrder(shelfRadians, shelfGainStart#);\n\t\t\t\tsynth.tempFrequencyResponse.analyze(Synth.tempFilterStartCoefficients, centerHarmonicStart#)\n\t\t\t\tlet shelfA1# = +Synth.tempFilterStartCoefficients.a[1]\n\t\t\t\tlet shelfB0# = Synth.tempFilterStartCoefficients.b[0] * expressionDecayStart#\n\t\t\t\tlet shelfB1# = Synth.tempFilterStartCoefficients.b[1] * expressionDecayStart#\n\t\t\t\tconst shelfPhaseDelayStart# = -synth.tempFrequencyResponse.angle() / centerHarmonicStart#;\n\t\t\t\t\n\t\t\t\tSynth.tempFilterEndCoefficients.highShelf1stOrder(shelfRadians, shelfGainEnd#)\n\t\t\t\tsynth.tempFrequencyResponse.analyze(Synth.tempFilterEndCoefficients, centerHarmonicEnd#)\n\t\t\t\tconst shelfA1End# = +Synth.tempFilterEndCoefficients.a[1]\n\t\t\t\tconst shelfB0End# = Synth.tempFilterEndCoefficients.b[0] * expressionDecayEnd#\n\t\t\t\tconst shelfB1End# = Synth.tempFilterEndCoefficients.b[1] * expressionDecayEnd#\n\t\t\t\tconst shelfPhaseDelayEnd# = -synth.tempFrequencyResponse.angle() / centerHarmonicEnd#;".replace(/\#/g,String(e));t+="\n\t\t\t\t\n\t\t\t\tconst periodLengthStart# = 1.0 / phaseDeltaStart#;\n\t\t\t\tconst periodLengthEnd# = 1.0 / phaseDeltaEnd#;\n\t\t\t\tconst minBufferLength# = Math.ceil(Math.max(periodLengthStart#, periodLengthEnd#) * 2);\n\t\t\t\tlet delayLength# = periodLengthStart# - allPassPhaseDelayStart# - shelfPhaseDelayStart#;\n\t\t\t\tconst delayLengthEnd# = periodLengthEnd# - allPassPhaseDelayEnd# - shelfPhaseDelayEnd#;\n\t\t\t\t\n\t\t\t\tconst delayLengthDelta# = (delayLengthEnd# - delayLength#) / runLength;\n\t\t\t\tconst allPassGDelta# = (allPassGEnd# - allPassG#) / runLength;\n\t\t\t\tconst shelfA1Delta# = (shelfA1End# - shelfA1#) / runLength;\n\t\t\t\tconst shelfB0Delta# = (shelfB0End# - shelfB0#) / runLength;\n\t\t\t\tconst shelfB1Delta# = (shelfB1End# - shelfB1#) / runLength;\n\t\t\t\t\n\t\t\t\tconst filters = tone.noteFilters;\n\t\t\t\tconst filterCount = tone.noteFilterCount|0;\n\t\t\t\tlet initialFilterInput1 = +tone.initialNoteFilterInput1;\n\t\t\t\tlet initialFilterInput2 = +tone.initialNoteFilterInput2;\n\t\t\t\tconst applyFilters = Synth.applyFilters;\n\t\t\t\t\n\t\t\t\tconst pitchChanged# = Math.abs(Math.log2(delayLength# / prevDelayLength#)) > 0.01;\n\t\t\t\tlet delayIndex# = pickedString#.delayIndex|0;";for(let e=0;e<r;e++)t+="\n\t\t\t\t\n\t\t\t\tconst reinitializeImpulse# = (delayIndex# == -1 || pitchChanged#);\n\t\t\t\tif (pickedString#.delayLine == null || pickedString#.delayLine.length <= minBufferLength#) {\n\t\t\t\t\t// The delay line buffer will get reused for other tones so might as well\n\t\t\t\t\t// start off with a buffer size that is big enough for most notes.\n\t\t\t\t\tconst likelyMaximumLength = Math.ceil(2 * synth.samplesPerSecond / beepbox.Instrument.frequencyFromPitch(12));\n\t\t\t\t\tconst newDelayLine = new Float32Array(Synth.fittingPowerOfTwo(Math.max(likelyMaximumLength, minBufferLength#)));\n\t\t\t\t\tif (!reinitializeImpulse# && pickedString#.delayLine != null) {\n\t\t\t\t\t\t// If the tone has already started but the buffer needs to be reallocated,\n\t\t\t\t\t\t// transfer the old data to the new buffer.\n\t\t\t\t\t\tconst oldDelayBufferMask = (pickedString#.delayLine.length - 1) >> 0;\n\t\t\t\t\t\tconst startCopyingFromIndex = delayIndex# + pickedString#.delayResetOffset;\n\t\t\t\t\t\tdelayIndex# = pickedString#.delayLine.length - pickedString#.delayResetOffset;\n\t\t\t\t\t\tfor (let i = 0; i < pickedString#.delayLine.length; i++) {\n\t\t\t\t\t\t\tnewDelayLine[i] = pickedString#.delayLine[(startCopyingFromIndex + i) & oldDelayBufferMask];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tpickedString#.delayLine = newDelayLine;\n\t\t\t\t}\n\t\t\t\tconst delayLine# = pickedString#.delayLine;\n\t\t\t\tconst delayBufferMask# = (delayLine#.length - 1) >> 0;\n\t\t\t\t\n\t\t\t\tif (reinitializeImpulse#) {\n\t\t\t\t\t// -1 delay index means the tone was reset.\n\t\t\t\t\t// Also, if the pitch changed suddenly (e.g. from seamless or arpeggio) then reset the wave.\n\t\t\t\t\t\n\t\t\t\t\tdelayIndex# = 0;\n\t\t\t\t\tallPassSample# = 0.0;\n\t\t\t\t\tallPassPrevInput# = 0.0;\n\t\t\t\t\tshelfSample# = 0.0;\n\t\t\t\t\tshelfPrevInput# = 0.0;\n\t\t\t\t\tfractionalDelaySample# = 0.0;\n\t\t\t\t\t\n\t\t\t\t\t// Clear away a region of the delay buffer for the new impulse.\n\t\t\t\t\tconst startImpulseFrom = -delayLength#;\n\t\t\t\t\tconst startZerosFrom = Math.floor(startImpulseFrom - periodLengthStart# / 2);\n\t\t\t\t\tconst stopZerosAt = Math.ceil(startZerosFrom + periodLengthStart# * 2);\n\t\t\t\t\tpickedString#.delayResetOffset = stopZerosAt; // And continue clearing the area in front of the delay line.\n\t\t\t\t\tfor (let i = startZerosFrom; i <= stopZerosAt; i++) {\n\t\t\t\t\t\tdelayLine#[i & delayBufferMask#] = 0.0;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tconst impulseWave = instrument.harmonicsWave.getCustomWave(instrument.type);\n\t\t\t\t\tconst impulseWaveLength = impulseWave.length - 1; // The first sample is duplicated at the end, don't double-count it.\n\t\t\t\t\tconst impulsePhaseDelta = impulseWaveLength / periodLengthStart#;\n\t\t\t\t\t\n\t\t\t\t\tconst fadeDuration = Math.min(periodLengthStart# * 0.2, synth.samplesPerSecond * 0.003);\n\t\t\t\t\tconst startImpulseFromSample = Math.ceil(startImpulseFrom);\n\t\t\t\t\tconst stopImpulseAt = startImpulseFrom + periodLengthStart# + fadeDuration;\n\t\t\t\t\tconst stopImpulseAtSample = stopImpulseAt;\n\t\t\t\t\tlet impulsePhase = (startImpulseFromSample - startImpulseFrom) * impulsePhaseDelta;\n\t\t\t\t\tlet prevWaveIntegral = 0.0;\n\t\t\t\t\tfor (let i = startImpulseFromSample; i <= stopImpulseAtSample; i++) {\n\t\t\t\t\t\tconst impulsePhaseInt = impulsePhase|0;\n\t\t\t\t\t\tconst index = impulsePhaseInt % impulseWaveLength;\n\t\t\t\t\t\tlet nextWaveIntegral = impulseWave[index];\n\t\t\t\t\t\tconst phaseRatio = impulsePhase - impulsePhaseInt;\n\t\t\t\t\t\tnextWaveIntegral += (impulseWave[index+1] - nextWaveIntegral) * phaseRatio;\n\t\t\t\t\t\tconst sample = (nextWaveIntegral - prevWaveIntegral) / impulsePhaseDelta;\n\t\t\t\t\t\tconst fadeIn = Math.min(1.0, (i - startImpulseFrom) / fadeDuration);\n\t\t\t\t\t\tconst fadeOut = Math.min(1.0, (stopImpulseAt - i) / fadeDuration);\n\t\t\t\t\t\tconst combinedFade = fadeIn * fadeOut;\n\t\t\t\t\t\tconst curvedFade = combinedFade * combinedFade * (3.0 - 2.0 * combinedFade); // A cubic sigmoid from 0 to 1.\n\t\t\t\t\t\tdelayLine#[i & delayBufferMask#] += sample * curvedFade;\n\t\t\t\t\t\tprevWaveIntegral = nextWaveIntegral;\n\t\t\t\t\t\timpulsePhase += impulsePhaseDelta;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tdelayIndex# = (delayIndex# & delayBufferMask#) + delayLine#.length;".replace(/\#/g,String(e));t+="\n\t\t\t\t\n\t\t\t\tconst unisonSign = tone.specialIntervalExpressionMult * Config.unisons[instrument.unison].sign;\n\t\t\t\tconst delayResetOffset# = pickedString#.delayResetOffset|0;\n\t\t\t\t\n\t\t\t\tconst stopIndex = bufferIndex + runLength;\n\t\t\t\tfor (let sampleIndex = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\n\t\t\t\t\tconst targetSampleTime# = delayIndex# - delayLength#;\n\t\t\t\t\tconst lowerIndex# = (targetSampleTime# + 0.125) | 0; // Offset to improve stability of all-pass filter.\n\t\t\t\t\tconst upperIndex# = lowerIndex# + 1;\n\t\t\t\t\tconst fractionalDelay# = upperIndex# - targetSampleTime#;\n\t\t\t\t\tconst fractionalDelayG# = (1.0 - fractionalDelay#) / (1.0 + fractionalDelay#); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\n\t\t\t\t\tconst prevInput# = delayLine#[lowerIndex# & delayBufferMask#];\n\t\t\t\t\tconst input# = delayLine#[upperIndex# & delayBufferMask#];\n\t\t\t\t\tfractionalDelaySample# = fractionalDelayG# * input# + prevInput# - fractionalDelayG# * fractionalDelaySample#;\n\t\t\t\t\t\n\t\t\t\t\tallPassSample# = fractionalDelaySample# * allPassG# + allPassPrevInput# - allPassG# * allPassSample#;\n\t\t\t\t\tallPassPrevInput# = fractionalDelaySample#;\n\t\t\t\t\t\n\t\t\t\t\tshelfSample# = shelfB0# * allPassSample# + shelfB1# * shelfPrevInput# - shelfA1# * shelfSample#;\n\t\t\t\t\tshelfPrevInput# = allPassSample#;\n\t\t\t\t\t\n\t\t\t\t\tdelayLine#[delayIndex# & delayBufferMask#] += shelfSample#;\n\t\t\t\t\tdelayLine#[(delayIndex# + delayResetOffset#) & delayBufferMask#] = 0.0;\n\t\t\t\t\tdelayIndex#++;\n\t\t\t\t\t\n\t\t\t\t\tconst inputSample = (";const e=[];for(let t=0;t<r;t++)e.push("fractionalDelaySample"+t+(1==t?" * unisonSign":""));t+=e.join(" + "),t+=") * expression;\n\t\t\t\t\tconst sample = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\n\t\t\t\t\tinitialFilterInput2 = initialFilterInput1;\n\t\t\t\t\tinitialFilterInput1 = inputSample;\n\t\t\t\t\tdata[sampleIndex] += sample;\n\t\t\t\t\t\n\t\t\t\t\texpression += expressionDelta;\n\t\t\t\t\tdelayLength# += delayLengthDelta#;\n\t\t\t\t\tallPassG# += allPassGDelta#;\n\t\t\t\t\tshelfA1# += shelfA1Delta#;\n\t\t\t\t\tshelfB0# += shelfB0Delta#;\n\t\t\t\t\tshelfB1# += shelfB1Delta#;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// Avoid persistent denormal or NaN values in the delay buffers and filter history.\n\t\t\t\tconst epsilon = (1.0e-24);\n\t\t\t\tif (!Number.isFinite(allPassSample#) || Math.abs(allPassSample#) < epsilon) allPassSample# = 0.0;\n\t\t\t\tif (!Number.isFinite(allPassPrevInput#) || Math.abs(allPassPrevInput#) < epsilon) allPassPrevInput# = 0.0;\n\t\t\t\tif (!Number.isFinite(shelfSample#) || Math.abs(shelfSample#) < epsilon) shelfSample# = 0.0;\n\t\t\t\tif (!Number.isFinite(shelfPrevInput#) || Math.abs(shelfPrevInput#) < epsilon) shelfPrevInput# = 0.0;\n\t\t\t\tif (!Number.isFinite(fractionalDelaySample#) || Math.abs(fractionalDelaySample#) < epsilon) fractionalDelaySample# = 0.0;\n\t\t\t\tpickedString#.allPassSample = allPassSample#;\n\t\t\t\tpickedString#.allPassPrevInput = allPassPrevInput#;\n\t\t\t\tpickedString#.shelfSample = shelfSample#;\n\t\t\t\tpickedString#.shelfPrevInput = shelfPrevInput#;\n\t\t\t\tpickedString#.fractionalDelaySample = fractionalDelaySample#;\n\t\t\t\tpickedString#.delayIndex = delayIndex#;\n\t\t\t\tpickedString#.prevDelayLength = delayLength#;\n\t\t\t\t\n\t\t\t\tsynth.sanitizeFilters(filters);\n\t\t\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\n\t\t\t\ttone.initialNoteFilterInput2 = initialFilterInput2;",t=t.replace(/^.*\#.*$/gm,(t=>{const e=[];for(let i=0;i<r;i++)e.push(t.replace(/\#/g,String(i)));return e.join("\n")})),h=new Function("synth","bufferIndex","runLength","tone","instrument",t),Mt.pickedStringFunctionCache[r]=h}h(t,i,s,n,o)}static effectsSynth(t,i,s,n,o,r,h){const a=m(r.effects)&&0!=r.distortion,l=y(r.effects),c=h.eqFilterCount>0,u=g(r.effects)&&r.pan!=e.panCenter,f=b(r.effects)&&0!=r.chorus,p=v(r.effects)&&0!=r.echoSustain,d=w(r.effects)&&0!=r.reverb;let k=0;a&&(k|=1),k<<=1,l&&(k|=1),k<<=1,c&&(k|=1),k<<=1,u&&(k|=1),k<<=1,f&&(k|=1),k<<=1,p&&(k|=1),k<<=1,d&&(k|=1);let M=Mt.effectsFunctionCache[k];if(null==M){let t="";const e=f||d||p;t+="\n\t\t\t\tconst tempMonoInstrumentSampleBuffer = synth.tempMonoInstrumentSampleBuffer;\n\t\t\t\t\n\t\t\t\tlet mixVolume = +instrumentState.mixVolumeStart;\n\t\t\t\tconst mixVolumeDelta = +instrumentState.mixVolumeDelta;",e&&(t+="\n\t\t\t\t\n\t\t\t\tlet delayInputMult = +instrumentState.delayInputMultStart;\n\t\t\t\tconst delayInputMultDelta = +instrumentState.delayInputMultDelta;"),a&&(t+="\n\t\t\t\t\n\t\t\t\tconst distortionBaseVolume = +beepbox.Config.distortionBaseVolume;\n\t\t\t\tconst distortionStart = +Math.pow(1.0 - 0.895 * (Math.pow(20.0, instrumentState.distortionStart) - 1.0) / 19.0, 2.0)\n\t\t\t\tconst distortionEnd   = +Math.pow(1.0 - 0.895 * (Math.pow(20.0, instrumentState.distortionEnd  ) - 1.0) / 19.0, 2.0)\n\t\t\t\tlet distortion = distortionStart;\n\t\t\t\tconst distortionDelta = (distortionEnd - distortionStart) / runLength;\n\t\t\t\tconst distortionDriveStart = (1.0 + 2.0 * instrumentState.distortionStart) / distortionBaseVolume;\n\t\t\t\tconst distortionDriveEnd   = (1.0 + 2.0 * instrumentState.distortionEnd)   / distortionBaseVolume;\n\t\t\t\tlet distortionDrive = distortionDriveStart;\n\t\t\t\tconst distortionDriveDelta = (distortionDriveEnd - distortionDriveStart) / runLength;\n\t\t\t\tconst distortionFractionalResolution = 4.0;\n\t\t\t\tconst distortionOversampleCompensation = distortionBaseVolume / distortionFractionalResolution;\n\t\t\t\tconst distortionFractionalDelay1 = 1.0 / distortionFractionalResolution;\n\t\t\t\tconst distortionFractionalDelay2 = 2.0 / distortionFractionalResolution;\n\t\t\t\tconst distortionFractionalDelay3 = 3.0 / distortionFractionalResolution;\n\t\t\t\tconst distortionFractionalDelayG1 = (1.0 - distortionFractionalDelay1) / (1.0 + distortionFractionalDelay1); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\n\t\t\t\tconst distortionFractionalDelayG2 = (1.0 - distortionFractionalDelay2) / (1.0 + distortionFractionalDelay2); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\n\t\t\t\tconst distortionFractionalDelayG3 = (1.0 - distortionFractionalDelay3) / (1.0 + distortionFractionalDelay3); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\n\t\t\t\tconst distortionNextOutputWeight1 = Math.cos(Math.PI * distortionFractionalDelay1) * 0.5 + 0.5;\n\t\t\t\tconst distortionNextOutputWeight2 = Math.cos(Math.PI * distortionFractionalDelay2) * 0.5 + 0.5;\n\t\t\t\tconst distortionNextOutputWeight3 = Math.cos(Math.PI * distortionFractionalDelay3) * 0.5 + 0.5;\n\t\t\t\tconst distortionPrevOutputWeight1 = 1.0 - distortionNextOutputWeight1;\n\t\t\t\tconst distortionPrevOutputWeight2 = 1.0 - distortionNextOutputWeight2;\n\t\t\t\tconst distortionPrevOutputWeight3 = 1.0 - distortionNextOutputWeight3;\n\t\t\t\t\n\t\t\t\tlet distortionFractionalInput1 = +instrumentState.distortionFractionalInput1;\n\t\t\t\tlet distortionFractionalInput2 = +instrumentState.distortionFractionalInput2;\n\t\t\t\tlet distortionFractionalInput3 = +instrumentState.distortionFractionalInput3;\n\t\t\t\tlet distortionPrevInput = +instrumentState.distortionPrevInput;\n\t\t\t\tlet distortionNextOutput = +instrumentState.distortionNextOutput;"),l&&(t+="\n\t\t\t\t\n\t\t\t\tlet bitcrusherPrevInput = +instrumentState.bitcrusherPrevInput;\n\t\t\t\tlet bitcrusherCurrentOutput = +instrumentState.bitcrusherCurrentOutput;\n\t\t\t\tlet bitcrusherPhase = +instrumentState.bitcrusherPhase;\n\t\t\t\tlet bitcrusherPhaseDelta = +instrumentState.bitcrusherPhaseDelta;\n\t\t\t\tconst bitcrusherPhaseDeltaScale = +instrumentState.bitcrusherPhaseDeltaScale;\n\t\t\t\tlet bitcrusherScale = +instrumentState.bitcrusherScale;\n\t\t\t\tconst bitcrusherScaleScale = +instrumentState.bitcrusherScaleScale;\n\t\t\t\tlet bitcrusherFoldLevel = +instrumentState.bitcrusherFoldLevel;\n\t\t\t\tconst bitcrusherFoldLevelScale = +instrumentState.bitcrusherFoldLevelScale;"),c&&(t+="\n\t\t\t\t\n\t\t\t\tlet filters = instrumentState.eqFilters;\n\t\t\t\tconst filterCount = instrumentState.eqFilterCount|0;\n\t\t\t\tlet initialFilterInput1 = +instrumentState.initialEqFilterInput1;\n\t\t\t\tlet initialFilterInput2 = +instrumentState.initialEqFilterInput2;\n\t\t\t\tconst applyFilters = beepbox.Synth.applyFilters;"),t+="\n\t\t\t\t\n\t\t\t\tlet eqFilterVolume = +instrumentState.eqFilterVolumeStart;\n\t\t\t\tconst eqFilterVolumeDelta = +instrumentState.eqFilterVolumeDelta;",u&&(t+="\n\t\t\t\t\n\t\t\t\tconst panningMask = synth.panningDelayBufferMask >>> 0;\n\t\t\t\tconst panningDelayLine = instrumentState.panningDelayLine;\n\t\t\t\tlet panningDelayPos = instrumentState.panningDelayPos & panningMask;\n\t\t\t\tlet   panningVolumeL      = +instrumentState.panningVolumeStartL;\n\t\t\t\tlet   panningVolumeR      = +instrumentState.panningVolumeStartR;\n\t\t\t\tconst panningVolumeDeltaL = +instrumentState.panningVolumeDeltaL;\n\t\t\t\tconst panningVolumeDeltaR = +instrumentState.panningVolumeDeltaR;\n\t\t\t\tlet   panningOffsetL      = panningDelayPos - instrumentState.panningOffsetStartL + synth.panningDelayBufferSize;\n\t\t\t\tlet   panningOffsetR      = panningDelayPos - instrumentState.panningOffsetStartR + synth.panningDelayBufferSize;\n\t\t\t\tconst panningOffsetDeltaL = 1.0 - instrumentState.panningOffsetDeltaL;\n\t\t\t\tconst panningOffsetDeltaR = 1.0 - instrumentState.panningOffsetDeltaR;"),f&&(t+="\n\t\t\t\t\n\t\t\t\tconst chorusMask = synth.chorusDelayBufferMask >>> 0;\n\t\t\t\tconst chorusDelayLineL = instrumentState.chorusDelayLineL;\n\t\t\t\tconst chorusDelayLineR = instrumentState.chorusDelayLineR;\n\t\t\t\tinstrumentState.chorusDelayLineDirty = true;\n\t\t\t\tlet chorusDelayPos = instrumentState.chorusDelayPos & chorusMask;\n\t\t\t\t\n\t\t\t\tconst chorusStart = +instrumentState.chorusStart;\n\t\t\t\tconst chorusEnd   = +instrumentState.chorusEnd;\n\t\t\t\tlet chorusVoiceMult = chorusStart;\n\t\t\t\tconst chorusVoiceMultDelta = (chorusEnd - chorusStart) / runLength;\n\t\t\t\tlet chorusCombinedMult = 1.0 / Math.sqrt(3.0 * chorusStart * chorusStart + 1.0);\n\t\t\t\tconst chorusCombinedMultEnd = 1.0 / Math.sqrt(3.0 * chorusEnd * chorusEnd + 1.0);\n\t\t\t\tconst chorusCombinedMultDelta = (chorusCombinedMultEnd - chorusCombinedMult) / runLength;\n\t\t\t\t\n\t\t\t\tconst chorusDuration = +beepbox.Config.chorusPeriodSeconds;\n\t\t\t\tconst chorusAngle = Math.PI * 2.0 / (chorusDuration * synth.samplesPerSecond);\n\t\t\t\tconst chorusRange = synth.samplesPerSecond * beepbox.Config.chorusDelayRange;\n\t\t\t\tconst chorusOffset0 = synth.chorusDelayBufferSize - beepbox.Config.chorusDelayOffsets[0][0] * chorusRange;\n\t\t\t\tconst chorusOffset1 = synth.chorusDelayBufferSize - beepbox.Config.chorusDelayOffsets[0][1] * chorusRange;\n\t\t\t\tconst chorusOffset2 = synth.chorusDelayBufferSize - beepbox.Config.chorusDelayOffsets[0][2] * chorusRange;\n\t\t\t\tconst chorusOffset3 = synth.chorusDelayBufferSize - beepbox.Config.chorusDelayOffsets[1][0] * chorusRange;\n\t\t\t\tconst chorusOffset4 = synth.chorusDelayBufferSize - beepbox.Config.chorusDelayOffsets[1][1] * chorusRange;\n\t\t\t\tconst chorusOffset5 = synth.chorusDelayBufferSize - beepbox.Config.chorusDelayOffsets[1][2] * chorusRange;\n\t\t\t\tlet chorusPhase = instrumentState.chorusPhase % (Math.PI * 2.0);\n\t\t\t\tlet chorusTap0Index = chorusDelayPos + chorusOffset0 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[0][0]);\n\t\t\t\tlet chorusTap1Index = chorusDelayPos + chorusOffset1 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[0][1]);\n\t\t\t\tlet chorusTap2Index = chorusDelayPos + chorusOffset2 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[0][2]);\n\t\t\t\tlet chorusTap3Index = chorusDelayPos + chorusOffset3 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[1][0]);\n\t\t\t\tlet chorusTap4Index = chorusDelayPos + chorusOffset4 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[1][1]);\n\t\t\t\tlet chorusTap5Index = chorusDelayPos + chorusOffset5 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[1][2]);\n\t\t\t\tchorusPhase += chorusAngle * runLength;\n\t\t\t\tconst chorusTap0End = chorusDelayPos + chorusOffset0 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[0][0]) + runLength;\n\t\t\t\tconst chorusTap1End = chorusDelayPos + chorusOffset1 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[0][1]) + runLength;\n\t\t\t\tconst chorusTap2End = chorusDelayPos + chorusOffset2 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[0][2]) + runLength;\n\t\t\t\tconst chorusTap3End = chorusDelayPos + chorusOffset3 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[1][0]) + runLength;\n\t\t\t\tconst chorusTap4End = chorusDelayPos + chorusOffset4 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[1][1]) + runLength;\n\t\t\t\tconst chorusTap5End = chorusDelayPos + chorusOffset5 - chorusRange * Math.sin(chorusPhase + beepbox.Config.chorusPhaseOffsets[1][2]) + runLength;\n\t\t\t\tconst chorusTap0Delta = (chorusTap0End - chorusTap0Index) / runLength;\n\t\t\t\tconst chorusTap1Delta = (chorusTap1End - chorusTap1Index) / runLength;\n\t\t\t\tconst chorusTap2Delta = (chorusTap2End - chorusTap2Index) / runLength;\n\t\t\t\tconst chorusTap3Delta = (chorusTap3End - chorusTap3Index) / runLength;\n\t\t\t\tconst chorusTap4Delta = (chorusTap4End - chorusTap4Index) / runLength;\n\t\t\t\tconst chorusTap5Delta = (chorusTap5End - chorusTap5Index) / runLength;"),p&&(t+="\n\t\t\t\t\n\t\t\t\tlet echoMult = +instrumentState.echoMultStart;\n\t\t\t\tconst echoMultDelta = +instrumentState.echoMultDelta;\n\t\t\t\t\n\t\t\t\tconst echoDelayLineL = instrumentState.echoDelayLineL;\n\t\t\t\tconst echoDelayLineR = instrumentState.echoDelayLineR;\n\t\t\t\tconst echoMask = (echoDelayLineL.length - 1) >>> 0;\n\t\t\t\tinstrumentState.echoDelayLineDirty = true;\n\t\t\t\t\n\t\t\t\tlet echoDelayPos = instrumentState.echoDelayPos & echoMask;\n\t\t\t\tconst echoDelayOffsetStart = (echoDelayLineL.length - instrumentState.echoDelayOffsetStart) & echoMask;\n\t\t\t\tconst echoDelayOffsetEnd   = (echoDelayLineL.length - instrumentState.echoDelayOffsetEnd) & echoMask;\n\t\t\t\tlet echoDelayOffsetRatio = +instrumentState.echoDelayOffsetRatio;\n\t\t\t\tconst echoDelayOffsetRatioDelta = +instrumentState.echoDelayOffsetRatioDelta;\n\t\t\t\t\n\t\t\t\tconst echoShelfA1 = +instrumentState.echoShelfA1;\n\t\t\t\tconst echoShelfB0 = +instrumentState.echoShelfB0;\n\t\t\t\tconst echoShelfB1 = +instrumentState.echoShelfB1;\n\t\t\t\tlet echoShelfSampleL = +instrumentState.echoShelfSampleL;\n\t\t\t\tlet echoShelfSampleR = +instrumentState.echoShelfSampleR;\n\t\t\t\tlet echoShelfPrevInputL = +instrumentState.echoShelfPrevInputL;\n\t\t\t\tlet echoShelfPrevInputR = +instrumentState.echoShelfPrevInputR;"),d&&(t+="\n\t\t\t\t\n\t\t\t\tconst reverbMask = beepbox.Config.reverbDelayBufferMask >>> 0; //TODO: Dynamic reverb buffer size.\n\t\t\t\tconst reverbDelayLine = instrumentState.reverbDelayLine;\n\t\t\t\tinstrumentState.reverbDelayLineDirty = true;\n\t\t\t\tlet reverbDelayPos = instrumentState.reverbDelayPos & reverbMask;\n\t\t\t\t\n\t\t\t\tlet reverb = +instrumentState.reverbMultStart;\n\t\t\t\tconst reverbDelta = +instrumentState.reverbMultDelta;\n\t\t\t\t\n\t\t\t\tconst reverbShelfA1 = +instrumentState.reverbShelfA1;\n\t\t\t\tconst reverbShelfB0 = +instrumentState.reverbShelfB0;\n\t\t\t\tconst reverbShelfB1 = +instrumentState.reverbShelfB1;\n\t\t\t\tlet reverbShelfSample0 = +instrumentState.reverbShelfSample0;\n\t\t\t\tlet reverbShelfSample1 = +instrumentState.reverbShelfSample1;\n\t\t\t\tlet reverbShelfSample2 = +instrumentState.reverbShelfSample2;\n\t\t\t\tlet reverbShelfSample3 = +instrumentState.reverbShelfSample3;\n\t\t\t\tlet reverbShelfPrevInput0 = +instrumentState.reverbShelfPrevInput0;\n\t\t\t\tlet reverbShelfPrevInput1 = +instrumentState.reverbShelfPrevInput1;\n\t\t\t\tlet reverbShelfPrevInput2 = +instrumentState.reverbShelfPrevInput2;\n\t\t\t\tlet reverbShelfPrevInput3 = +instrumentState.reverbShelfPrevInput3;"),t+="\n\t\t\t\t\n\t\t\t\tconst stopIndex = bufferIndex + runLength;\n\t\t\t\tfor (let sampleIndex = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\n\t\t\t\t\tlet sample = tempMonoInstrumentSampleBuffer[sampleIndex];\n\t\t\t\t\ttempMonoInstrumentSampleBuffer[sampleIndex] = 0.0;",a&&(t+="\n\t\t\t\t\t\n\t\t\t\t\tconst distortionReverse = 1.0 - distortion;\n\t\t\t\t\tconst distortionNextInput = sample * distortionDrive;\n\t\t\t\t\tsample = distortionNextOutput;\n\t\t\t\t\tdistortionNextOutput = distortionNextInput / (distortionReverse * Math.abs(distortionNextInput) + distortion);\n\t\t\t\t\tdistortionFractionalInput1 = distortionFractionalDelayG1 * distortionNextInput + distortionPrevInput - distortionFractionalDelayG1 * distortionFractionalInput1;\n\t\t\t\t\tdistortionFractionalInput2 = distortionFractionalDelayG2 * distortionNextInput + distortionPrevInput - distortionFractionalDelayG2 * distortionFractionalInput2;\n\t\t\t\t\tdistortionFractionalInput3 = distortionFractionalDelayG3 * distortionNextInput + distortionPrevInput - distortionFractionalDelayG3 * distortionFractionalInput3;\n\t\t\t\t\tconst distortionOutput1 = distortionFractionalInput1 / (distortionReverse * Math.abs(distortionFractionalInput1) + distortion);\n\t\t\t\t\tconst distortionOutput2 = distortionFractionalInput2 / (distortionReverse * Math.abs(distortionFractionalInput2) + distortion);\n\t\t\t\t\tconst distortionOutput3 = distortionFractionalInput3 / (distortionReverse * Math.abs(distortionFractionalInput3) + distortion);\n\t\t\t\t\tdistortionNextOutput += distortionOutput1 * distortionNextOutputWeight1 + distortionOutput2 * distortionNextOutputWeight2 + distortionOutput3 * distortionNextOutputWeight3;\n\t\t\t\t\tsample += distortionOutput1 * distortionPrevOutputWeight1 + distortionOutput2 * distortionPrevOutputWeight2 + distortionOutput3 * distortionPrevOutputWeight3;\n\t\t\t\t\tsample *= distortionOversampleCompensation;\n\t\t\t\t\tdistortionPrevInput = distortionNextInput;\n\t\t\t\t\tdistortion += distortionDelta;\n\t\t\t\t\tdistortionDrive += distortionDriveDelta;"),l&&(t+="\n\t\t\t\t\t\n\t\t\t\t\tbitcrusherPhase += bitcrusherPhaseDelta;\n\t\t\t\t\tif (bitcrusherPhase < 1.0) {\n\t\t\t\t\t\tbitcrusherPrevInput = sample;\n\t\t\t\t\t\tsample = bitcrusherCurrentOutput;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tbitcrusherPhase = bitcrusherPhase % 1.0;\n\t\t\t\t\t\tconst ratio = bitcrusherPhase / bitcrusherPhaseDelta;\n\t\t\t\t\t\t\n\t\t\t\t\t\tconst lerpedInput = sample + (bitcrusherPrevInput - sample) * ratio;\n\t\t\t\t\t\tbitcrusherPrevInput = sample;\n\t\t\t\t\t\t\n\t\t\t\t\t\tconst bitcrusherWrapLevel = bitcrusherFoldLevel * 4.0;\n\t\t\t\t\t\tconst wrappedSample = (((lerpedInput + bitcrusherFoldLevel) % bitcrusherWrapLevel) + bitcrusherWrapLevel) % bitcrusherWrapLevel;\n\t\t\t\t\t\tconst foldedSample = bitcrusherFoldLevel - Math.abs(bitcrusherFoldLevel * 2.0 - wrappedSample);\n\t\t\t\t\t\tconst scaledSample = foldedSample / bitcrusherScale;\n\t\t\t\t\t\tconst oldValue = bitcrusherCurrentOutput;\n\t\t\t\t\t\tconst newValue = (((scaledSample > 0 ? scaledSample + 1 : scaledSample)|0)-.5) * bitcrusherScale;\n\t\t\t\t\t\t\n\t\t\t\t\t\tsample = oldValue + (newValue - oldValue) * ratio;\n\t\t\t\t\t\tbitcrusherCurrentOutput = newValue;\n\t\t\t\t\t}\n\t\t\t\t\tbitcrusherPhaseDelta *= bitcrusherPhaseDeltaScale;\n\t\t\t\t\tbitcrusherScale *= bitcrusherScaleScale;\n\t\t\t\t\tbitcrusherFoldLevel *= bitcrusherFoldLevelScale;"),c&&(t+="\n\t\t\t\t\t\n\t\t\t\t\tconst inputSample = sample;\n\t\t\t\t\tsample = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\n\t\t\t\t\tinitialFilterInput2 = initialFilterInput1;\n\t\t\t\t\tinitialFilterInput1 = inputSample;"),t+="\n\t\t\t\t\t\n\t\t\t\t\tsample *= eqFilterVolume;\n\t\t\t\t\teqFilterVolume += eqFilterVolumeDelta;",t+=u?"\n\t\t\t\t\t\n\t\t\t\t\tpanningDelayLine[panningDelayPos] = sample;\n\t\t\t\t\tconst panningRatioL  = panningOffsetL % 1;\n\t\t\t\t\tconst panningRatioR  = panningOffsetR % 1;\n\t\t\t\t\tconst panningTapLA   = panningDelayLine[(panningOffsetL) & panningMask];\n\t\t\t\t\tconst panningTapLB   = panningDelayLine[(panningOffsetL + 1) & panningMask];\n\t\t\t\t\tconst panningTapRA   = panningDelayLine[(panningOffsetR) & panningMask];\n\t\t\t\t\tconst panningTapRB   = panningDelayLine[(panningOffsetR + 1) & panningMask];\n\t\t\t\t\tconst panningTapL    = panningTapLA + (panningTapLB - panningTapLA) * panningRatioL;\n\t\t\t\t\tconst panningTapR    = panningTapRA + (panningTapRB - panningTapRA) * panningRatioR;\n\t\t\t\t\tlet sampleL = panningTapL * panningVolumeL;\n\t\t\t\t\tlet sampleR = panningTapR * panningVolumeR;\n\t\t\t\t\tpanningDelayPos = (panningDelayPos + 1) & panningMask;\n\t\t\t\t\tpanningVolumeL += panningVolumeDeltaL;\n\t\t\t\t\tpanningVolumeR += panningVolumeDeltaR;\n\t\t\t\t\tpanningOffsetL += panningOffsetDeltaL;\n\t\t\t\t\tpanningOffsetR += panningOffsetDeltaR;":"\n\t\t\t\t\t\n\t\t\t\t\tlet sampleL = sample;\n\t\t\t\t\tlet sampleR = sample;",f&&(t+="\n\t\t\t\t\t\n\t\t\t\t\tconst chorusTap0Ratio = chorusTap0Index % 1;\n\t\t\t\t\tconst chorusTap1Ratio = chorusTap1Index % 1;\n\t\t\t\t\tconst chorusTap2Ratio = chorusTap2Index % 1;\n\t\t\t\t\tconst chorusTap3Ratio = chorusTap3Index % 1;\n\t\t\t\t\tconst chorusTap4Ratio = chorusTap4Index % 1;\n\t\t\t\t\tconst chorusTap5Ratio = chorusTap5Index % 1;\n\t\t\t\t\tconst chorusTap0A = chorusDelayLineL[(chorusTap0Index) & chorusMask];\n\t\t\t\t\tconst chorusTap0B = chorusDelayLineL[(chorusTap0Index + 1) & chorusMask];\n\t\t\t\t\tconst chorusTap1A = chorusDelayLineL[(chorusTap1Index) & chorusMask];\n\t\t\t\t\tconst chorusTap1B = chorusDelayLineL[(chorusTap1Index + 1) & chorusMask];\n\t\t\t\t\tconst chorusTap2A = chorusDelayLineL[(chorusTap2Index) & chorusMask];\n\t\t\t\t\tconst chorusTap2B = chorusDelayLineL[(chorusTap2Index + 1) & chorusMask];\n\t\t\t\t\tconst chorusTap3A = chorusDelayLineR[(chorusTap3Index) & chorusMask];\n\t\t\t\t\tconst chorusTap3B = chorusDelayLineR[(chorusTap3Index + 1) & chorusMask];\n\t\t\t\t\tconst chorusTap4A = chorusDelayLineR[(chorusTap4Index) & chorusMask];\n\t\t\t\t\tconst chorusTap4B = chorusDelayLineR[(chorusTap4Index + 1) & chorusMask];\n\t\t\t\t\tconst chorusTap5A = chorusDelayLineR[(chorusTap5Index) & chorusMask];\n\t\t\t\t\tconst chorusTap5B = chorusDelayLineR[(chorusTap5Index + 1) & chorusMask];\n\t\t\t\t\tconst chorusTap0 = chorusTap0A + (chorusTap0B - chorusTap0A) * chorusTap0Ratio;\n\t\t\t\t\tconst chorusTap1 = chorusTap1A + (chorusTap1B - chorusTap1A) * chorusTap1Ratio;\n\t\t\t\t\tconst chorusTap2 = chorusTap2A + (chorusTap2B - chorusTap2A) * chorusTap2Ratio;\n\t\t\t\t\tconst chorusTap3 = chorusTap3A + (chorusTap3B - chorusTap3A) * chorusTap3Ratio;\n\t\t\t\t\tconst chorusTap4 = chorusTap4A + (chorusTap4B - chorusTap4A) * chorusTap4Ratio;\n\t\t\t\t\tconst chorusTap5 = chorusTap5A + (chorusTap5B - chorusTap5A) * chorusTap5Ratio;\n\t\t\t\t\tchorusDelayLineL[chorusDelayPos] = sampleL * delayInputMult;\n\t\t\t\t\tchorusDelayLineR[chorusDelayPos] = sampleR * delayInputMult;\n\t\t\t\t\tsampleL = chorusCombinedMult * (sampleL + chorusVoiceMult * (chorusTap1 - chorusTap0 - chorusTap2));\n\t\t\t\t\tsampleR = chorusCombinedMult * (sampleR + chorusVoiceMult * (chorusTap4 - chorusTap3 - chorusTap5));\n\t\t\t\t\tchorusDelayPos = (chorusDelayPos + 1) & chorusMask;\n\t\t\t\t\tchorusTap0Index += chorusTap0Delta;\n\t\t\t\t\tchorusTap1Index += chorusTap1Delta;\n\t\t\t\t\tchorusTap2Index += chorusTap2Delta;\n\t\t\t\t\tchorusTap3Index += chorusTap3Delta;\n\t\t\t\t\tchorusTap4Index += chorusTap4Delta;\n\t\t\t\t\tchorusTap5Index += chorusTap5Delta;\n\t\t\t\t\tchorusVoiceMult += chorusVoiceMultDelta;\n\t\t\t\t\tchorusCombinedMult += chorusCombinedMultDelta;"),p&&(t+="\n\t\t\t\t\t\n\t\t\t\t\tconst echoTapStartIndex = (echoDelayPos + echoDelayOffsetStart) & echoMask;\n\t\t\t\t\tconst echoTapEndIndex   = (echoDelayPos + echoDelayOffsetEnd  ) & echoMask;\n\t\t\t\t\tconst echoTapStartL = echoDelayLineL[echoTapStartIndex];\n\t\t\t\t\tconst echoTapEndL   = echoDelayLineL[echoTapEndIndex];\n\t\t\t\t\tconst echoTapStartR = echoDelayLineR[echoTapStartIndex];\n\t\t\t\t\tconst echoTapEndR   = echoDelayLineR[echoTapEndIndex];\n\t\t\t\t\tconst echoTapL = (echoTapStartL + (echoTapEndL - echoTapStartL) * echoDelayOffsetRatio) * echoMult;\n\t\t\t\t\tconst echoTapR = (echoTapStartR + (echoTapEndR - echoTapStartR) * echoDelayOffsetRatio) * echoMult;\n\t\t\t\t\t\n\t\t\t\t\techoShelfSampleL = echoShelfB0 * echoTapL + echoShelfB1 * echoShelfPrevInputL - echoShelfA1 * echoShelfSampleL;\n\t\t\t\t\techoShelfSampleR = echoShelfB0 * echoTapR + echoShelfB1 * echoShelfPrevInputR - echoShelfA1 * echoShelfSampleR;\n\t\t\t\t\techoShelfPrevInputL = echoTapL;\n\t\t\t\t\techoShelfPrevInputR = echoTapR;\n\t\t\t\t\tsampleL += echoShelfSampleL;\n\t\t\t\t\tsampleR += echoShelfSampleR;\n\t\t\t\t\t\n\t\t\t\t\techoDelayLineL[echoDelayPos] = sampleL * delayInputMult;\n\t\t\t\t\techoDelayLineR[echoDelayPos] = sampleR * delayInputMult;\n\t\t\t\t\techoDelayPos = (echoDelayPos + 1) & echoMask;\n\t\t\t\t\techoDelayOffsetRatio += echoDelayOffsetRatioDelta;\n\t\t\t\t\techoMult += echoMultDelta;"),d&&(t+="\n\t\t\t\t\t\n\t\t\t\t\t// Reverb, implemented using a feedback delay network with a Hadamard matrix and lowpass filters.\n\t\t\t\t\t// good ratios:    0.555235 + 0.618033 + 0.818 +   1.0 = 2.991268\n\t\t\t\t\t// Delay lengths:  3041     + 3385     + 4481  +  5477 = 16384 = 2^14\n\t\t\t\t\t// Buffer offsets: 3041    -> 6426   -> 10907 -> 16384\n\t\t\t\t\tconst reverbDelayPos1 = (reverbDelayPos +  3041) & reverbMask;\n\t\t\t\t\tconst reverbDelayPos2 = (reverbDelayPos +  6426) & reverbMask;\n\t\t\t\t\tconst reverbDelayPos3 = (reverbDelayPos + 10907) & reverbMask;\n\t\t\t\t\tconst reverbSample0 = (reverbDelayLine[reverbDelayPos]);\n\t\t\t\t\tconst reverbSample1 = reverbDelayLine[reverbDelayPos1];\n\t\t\t\t\tconst reverbSample2 = reverbDelayLine[reverbDelayPos2];\n\t\t\t\t\tconst reverbSample3 = reverbDelayLine[reverbDelayPos3];\n\t\t\t\t\tconst reverbTemp0 = -(reverbSample0 + sampleL) + reverbSample1;\n\t\t\t\t\tconst reverbTemp1 = -(reverbSample0 + sampleR) - reverbSample1;\n\t\t\t\t\tconst reverbTemp2 = -reverbSample2 + reverbSample3;\n\t\t\t\t\tconst reverbTemp3 = -reverbSample2 - reverbSample3;\n\t\t\t\t\tconst reverbShelfInput0 = (reverbTemp0 + reverbTemp2) * reverb;\n\t\t\t\t\tconst reverbShelfInput1 = (reverbTemp1 + reverbTemp3) * reverb;\n\t\t\t\t\tconst reverbShelfInput2 = (reverbTemp0 - reverbTemp2) * reverb;\n\t\t\t\t\tconst reverbShelfInput3 = (reverbTemp1 - reverbTemp3) * reverb;\n\t\t\t\t\treverbShelfSample0 = reverbShelfB0 * reverbShelfInput0 + reverbShelfB1 * reverbShelfPrevInput0 - reverbShelfA1 * reverbShelfSample0;\n\t\t\t\t\treverbShelfSample1 = reverbShelfB0 * reverbShelfInput1 + reverbShelfB1 * reverbShelfPrevInput1 - reverbShelfA1 * reverbShelfSample1;\n\t\t\t\t\treverbShelfSample2 = reverbShelfB0 * reverbShelfInput2 + reverbShelfB1 * reverbShelfPrevInput2 - reverbShelfA1 * reverbShelfSample2;\n\t\t\t\t\treverbShelfSample3 = reverbShelfB0 * reverbShelfInput3 + reverbShelfB1 * reverbShelfPrevInput3 - reverbShelfA1 * reverbShelfSample3;\n\t\t\t\t\treverbShelfPrevInput0 = reverbShelfInput0;\n\t\t\t\t\treverbShelfPrevInput1 = reverbShelfInput1;\n\t\t\t\t\treverbShelfPrevInput2 = reverbShelfInput2;\n\t\t\t\t\treverbShelfPrevInput3 = reverbShelfInput3;\n\t\t\t\t\treverbDelayLine[reverbDelayPos1] = reverbShelfSample0 * delayInputMult;\n\t\t\t\t\treverbDelayLine[reverbDelayPos2] = reverbShelfSample1 * delayInputMult;\n\t\t\t\t\treverbDelayLine[reverbDelayPos3] = reverbShelfSample2 * delayInputMult;\n\t\t\t\t\treverbDelayLine[reverbDelayPos ] = reverbShelfSample3 * delayInputMult;\n\t\t\t\t\treverbDelayPos = (reverbDelayPos + 1) & reverbMask;\n\t\t\t\t\tsampleL += reverbSample1 + reverbSample2 + reverbSample3;\n\t\t\t\t\tsampleR += reverbSample0 + reverbSample2 - reverbSample3;\n\t\t\t\t\treverb += reverbDelta;"),t+="\n\t\t\t\t\t\n\t\t\t\t\toutputDataL[sampleIndex] += sampleL * mixVolume;\n\t\t\t\t\toutputDataR[sampleIndex] += sampleR * mixVolume;\n\t\t\t\t\tmixVolume += mixVolumeDelta;",e&&(t+="\n\t\t\t\t\t\n\t\t\t\t\tdelayInputMult += delayInputMultDelta;"),t+="\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// Avoid persistent denormal or NaN values in the delay buffers and filter history.\n\t\t\t\tconst epsilon = (1.0e-24);",a&&(t+="\n\t\t\t\t\n\t\t\t\tif (!Number.isFinite(distortionFractionalInput1) || Math.abs(distortionFractionalInput1) < epsilon) distortionFractionalInput1 = 0.0;\n\t\t\t\tif (!Number.isFinite(distortionFractionalInput2) || Math.abs(distortionFractionalInput2) < epsilon) distortionFractionalInput2 = 0.0;\n\t\t\t\tif (!Number.isFinite(distortionFractionalInput3) || Math.abs(distortionFractionalInput3) < epsilon) distortionFractionalInput3 = 0.0;\n\t\t\t\tif (!Number.isFinite(distortionPrevInput) || Math.abs(distortionPrevInput) < epsilon) distortionPrevInput = 0.0;\n\t\t\t\tif (!Number.isFinite(distortionNextOutput) || Math.abs(distortionNextOutput) < epsilon) distortionNextOutput = 0.0;\n\t\t\t\t\n\t\t\t\tinstrumentState.distortionFractionalInput1 = distortionFractionalInput1;\n\t\t\t\tinstrumentState.distortionFractionalInput2 = distortionFractionalInput2;\n\t\t\t\tinstrumentState.distortionFractionalInput3 = distortionFractionalInput3;\n\t\t\t\tinstrumentState.distortionPrevInput = distortionPrevInput;\n\t\t\t\tinstrumentState.distortionNextOutput = distortionNextOutput;"),l&&(t+="\n\t\t\t\t\t\n\t\t\t\tif (Math.abs(bitcrusherPrevInput) < epsilon) bitcrusherPrevInput = 0.0;\n\t\t\t\tif (Math.abs(bitcrusherCurrentOutput) < epsilon) bitcrusherCurrentOutput = 0.0;\n\t\t\t\tinstrumentState.bitcrusherPrevInput = bitcrusherPrevInput;\n\t\t\t\tinstrumentState.bitcrusherCurrentOutput = bitcrusherCurrentOutput;\n\t\t\t\tinstrumentState.bitcrusherPhase = bitcrusherPhase;"),c&&(t+="\n\t\t\t\t\t\n\t\t\t\tsynth.sanitizeFilters(filters);\n\t\t\t\t// The filter input here is downstream from another filter so we\n\t\t\t\t// better make sure it's safe too.\n\t\t\t\tif (!(initialFilterInput1 < 100) || !(initialFilterInput2 < 100)) {\n\t\t\t\t\tinitialFilterInput1 = 0.0;\n\t\t\t\t\tinitialFilterInput2 = 0.0;\n\t\t\t\t}\n\t\t\t\tif (Math.abs(initialFilterInput1) < epsilon) initialFilterInput1 = 0.0;\n\t\t\t\tif (Math.abs(initialFilterInput2) < epsilon) initialFilterInput2 = 0.0;\n\t\t\t\tinstrumentState.initialEqFilterInput1 = initialFilterInput1;\n\t\t\t\tinstrumentState.initialEqFilterInput2 = initialFilterInput2;"),u&&(t+="\n\t\t\t\t\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(panningDelayLine, panningDelayPos, panningMask);\n\t\t\t\tinstrumentState.panningDelayPos = panningDelayPos;"),f&&(t+="\n\t\t\t\t\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(chorusDelayLineL, chorusDelayPos, chorusMask);\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(chorusDelayLineR, chorusDelayPos, chorusMask);\n\t\t\t\tinstrumentState.chorusPhase = chorusPhase;\n\t\t\t\tinstrumentState.chorusDelayPos = chorusDelayPos;"),p&&(t+="\n\t\t\t\t\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(echoDelayLineL, echoDelayPos, echoMask);\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(echoDelayLineR, echoDelayPos, echoMask);\n\t\t\t\tinstrumentState.echoDelayPos = echoDelayPos;\n\t\t\t\t\n\t\t\t\tif (!Number.isFinite(echoShelfSampleL) || Math.abs(echoShelfSampleL) < epsilon) echoShelfSampleL = 0.0;\n\t\t\t\tif (!Number.isFinite(echoShelfSampleR) || Math.abs(echoShelfSampleR) < epsilon) echoShelfSampleR = 0.0;\n\t\t\t\tif (!Number.isFinite(echoShelfPrevInputL) || Math.abs(echoShelfPrevInputL) < epsilon) echoShelfPrevInputL = 0.0;\n\t\t\t\tif (!Number.isFinite(echoShelfPrevInputR) || Math.abs(echoShelfPrevInputR) < epsilon) echoShelfPrevInputR = 0.0;\n\t\t\t\tinstrumentState.echoShelfSampleL = echoShelfSampleL;\n\t\t\t\tinstrumentState.echoShelfSampleR = echoShelfSampleR;\n\t\t\t\tinstrumentState.echoShelfPrevInputL = echoShelfPrevInputL;\n\t\t\t\tinstrumentState.echoShelfPrevInputR = echoShelfPrevInputR;"),d&&(t+="\n\t\t\t\t\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos        , reverbMask);\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos +  3041, reverbMask);\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos +  6426, reverbMask);\n\t\t\t\tbeepbox.Synth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos + 10907, reverbMask);\n\t\t\t\tinstrumentState.reverbDelayPos  = reverbDelayPos;\n\t\t\t\t\n\t\t\t\tif (!Number.isFinite(reverbShelfSample0) || Math.abs(reverbShelfSample0) < epsilon) reverbShelfSample0 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfSample1) || Math.abs(reverbShelfSample1) < epsilon) reverbShelfSample1 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfSample2) || Math.abs(reverbShelfSample2) < epsilon) reverbShelfSample2 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfSample3) || Math.abs(reverbShelfSample3) < epsilon) reverbShelfSample3 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput0) || Math.abs(reverbShelfPrevInput0) < epsilon) reverbShelfPrevInput0 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput1) || Math.abs(reverbShelfPrevInput1) < epsilon) reverbShelfPrevInput1 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput2) || Math.abs(reverbShelfPrevInput2) < epsilon) reverbShelfPrevInput2 = 0.0;\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput3) || Math.abs(reverbShelfPrevInput3) < epsilon) reverbShelfPrevInput3 = 0.0;\n\t\t\t\tinstrumentState.reverbShelfSample0 = reverbShelfSample0;\n\t\t\t\tinstrumentState.reverbShelfSample1 = reverbShelfSample1;\n\t\t\t\tinstrumentState.reverbShelfSample2 = reverbShelfSample2;\n\t\t\t\tinstrumentState.reverbShelfSample3 = reverbShelfSample3;\n\t\t\t\tinstrumentState.reverbShelfPrevInput0 = reverbShelfPrevInput0;\n\t\t\t\tinstrumentState.reverbShelfPrevInput1 = reverbShelfPrevInput1;\n\t\t\t\tinstrumentState.reverbShelfPrevInput2 = reverbShelfPrevInput2;\n\t\t\t\tinstrumentState.reverbShelfPrevInput3 = reverbShelfPrevInput3;"),M=new Function("synth","outputDataL","outputDataR","bufferIndex","runLength","instrument","instrumentState",t),Mt.effectsFunctionCache[k]=M}M(t,i,s,n,o,r,h)}static pulseWidthSynth(t,e,i,s,n){const o=t.tempMonoInstrumentSampleBuffer;let r=s.phaseDeltas[0];const h=+s.phaseDeltaScales[0];let a=+s.expressionStarts[0];const l=+s.expressionDeltas[0];let c=s.phases[0]%1,u=s.pulseWidth;const f=s.pulseWidthDelta,p=s.noteFilters,d=0|s.noteFilterCount;let m=+s.initialNoteFilterInput1,y=+s.initialNoteFilterInput2;const g=Mt.applyFilters,b=e+i;for(let t=e;t<b;t++){const e=c%1,i=(c+u)%1;let s=i-e;if(e<r)s+=.5*((v=e/r)+v-v*v-1);else if(e>1-r){s+=.5*((v=(e-1)/r)+v+v*v+1)}if(i<r)s-=.5*((v=i/r)+v-v*v-1);else if(i>1-r){var v;s-=.5*((v=(i-1)/r)+v+v*v+1)}const n=s,b=g(n,m,y,d,p);y=m,m=n,c+=r,r*=h,u+=f;const w=b*a;a+=l,o[t]+=w}s.phases[0]=c,t.sanitizeFilters(p),s.initialNoteFilterInput1=m,s.initialNoteFilterInput2=y}static noiseSynth(t,i,s,n,o){const r=t.tempMonoInstrumentSampleBuffer;let h=o.getDrumWave(),a=+n.phaseDeltas[0];const l=+n.phaseDeltaScales[0];let c=+n.expressionStarts[0];const u=+n.expressionDeltas[0];let f=n.phases[0]%1*e.chipNoiseLength;0==n.phases[0]&&(f=Math.random()*e.chipNoiseLength);const p=e.chipNoiseLength-1;let d=+n.sample;const m=n.noteFilters,y=0|n.noteFilterCount;let g=+n.initialNoteFilterInput1,b=+n.initialNoteFilterInput2;const v=Mt.applyFilters,w=Math.min(1,n.phaseDeltas[0]*e.chipNoises[o.chipNoise].pitchFilterMult),k=i+s;for(let t=i;t<k;t++){d+=(h[f&p]-d)*w;const e=d,i=v(e,g,b,y,m);b=g,g=e,f+=a,a*=l;const s=i*c;c+=u,r[t]+=s}n.phases[0]=f/e.chipNoiseLength,n.sample=d,t.sanitizeFilters(m),n.initialNoteFilterInput1=g,n.initialNoteFilterInput2=b}static spectrumSynth(t,i,s,n,o){const r=t.tempMonoInstrumentSampleBuffer;let h=o.getDrumWave(),a=128*n.phaseDeltas[0];const l=+n.phaseDeltaScales[0];let c=+n.expressionStarts[0];const u=+n.expressionDeltas[0];let f=+n.sample;const p=n.noteFilters,d=0|n.noteFilterCount;let m=+n.initialNoteFilterInput1,y=+n.initialNoteFilterInput2;const g=Mt.applyFilters;let b=n.phases[0]%1*e.spectrumNoiseLength;0==n.phases[0]&&(b=Mt.findRandomZeroCrossing(h,e.spectrumNoiseLength)+a);const v=e.spectrumNoiseLength-1,w=Math.min(1,a),k=i+s;for(let t=i;t<k;t++){const e=0|b,i=e&v;let s=h[i];const n=b-e;s+=(h[i+1]-s)*n,f+=(s-f)*w;const o=f,k=g(o,m,y,d,p);y=m,m=o,b+=a,a*=l;const M=k*c;c+=u,r[t]+=M}n.phases[0]=b/e.spectrumNoiseLength,n.sample=f,t.sanitizeFilters(p),n.initialNoteFilterInput1=m,n.initialNoteFilterInput2=y}static drumsetSynth(t,i,s,n,o){const r=t.tempMonoInstrumentSampleBuffer;let h=o.getDrumsetWave(n.drumsetPitch),a=n.phaseDeltas[0]/dt.drumsetIndexReferenceDelta(n.drumsetPitch);const l=+n.phaseDeltaScales[0];let c=+n.expressionStarts[0];const u=+n.expressionDeltas[0],f=n.noteFilters,p=0|n.noteFilterCount;let d=+n.initialNoteFilterInput1,m=+n.initialNoteFilterInput2;const y=Mt.applyFilters;let g=n.phases[0]%1*e.spectrumNoiseLength;0==n.phases[0]&&(g=Mt.findRandomZeroCrossing(h,e.spectrumNoiseLength)+a);const b=e.spectrumNoiseLength-1,v=i+s;for(let t=i;t<v;t++){const e=0|g,i=e&b;let s=h[i];const n=g-e;s+=(h[i+1]-s)*n;const o=s,v=y(o,d,m,p,f);m=d,d=o,g+=a,a*=l;const w=v*c;c+=u,r[t]+=w}n.phases[0]=g/e.spectrumNoiseLength,t.sanitizeFilters(f),n.initialNoteFilterInput1=d,n.initialNoteFilterInput2=m}static findRandomZeroCrossing(t,e){let i=Math.random()*e;const s=e-1;let n=i&s,o=t[n];for(let r=128;r>0;r--){const r=n+16&s,h=t[r];if(o*h<=0){for(let r=0;r<16;r++){const r=n+1&s,h=t[r];if(o*h<=0){const t=h-o;i=n,Math.abs(t)>1e-8&&(i+=-o/t),i=Math.max(0,i)%e;break}n=r,o=h}break}n=r,o=h}return i}static instrumentVolumeToVolumeMult(t){return t==e.volumeRange-1?0:Math.pow(2,e.volumeLogScale*t)}static volumeMultToInstrumentVolume(t){return t<=0?e.volumeRange-1:Math.min(e.volumeRange-2,Math.log2(t)/e.volumeLogScale)}static noteSizeToVolumeMult(t){return Math.pow(Math.max(0,t)/e.noteSizeMax,1.5)}static volumeMultToNoteSize(t){return Math.pow(Math.max(0,t),1/1.5)*e.noteSizeMax}static fadeInSettingToSeconds(t){return.0125*(.95*t+.05*t*t)}static secondsToFadeInSetting(t){return nt(0,e.fadeInRange,Math.round((-.95+Math.sqrt(.9025+.2*t/.0125))/.1))}static fadeOutSettingToTicks(t){return e.fadeOutTicks[t]}static ticksToFadeOutSetting(t){let i=e.fadeOutTicks[0];if(t<=i)return 0;for(let s=1;s<e.fadeOutTicks.length;s++){let n=e.fadeOutTicks[s];if(t<=n)return t<(i+n)/2?s-1:s;i=n}return e.fadeOutTicks.length-1}static detuneToCents(t){return t*(Math.abs(t)+1)/2}static centsToDetune(t){return Math.sign(t)*(Math.sqrt(1+8*Math.abs(t))-1)/2}getSamplesPerTick(){if(null==this.song)return 0;const t=this.song.getBeatsPerMinute()/60,i=e.partsPerBeat*t,s=e.ticksPerPart*i;return this.samplesPerSecond/s}static fittingPowerOfTwo(t){return 1<<32-Math.clz32(Math.ceil(t)-1)}sanitizeFilters(t){let e=!1;for(const i of t){const t=Math.abs(i.output1),s=Math.abs(i.output2);if(!(t<100&&s<100)){e=!0;break}t<Z&&(i.output1=0),s<Z&&(i.output2=0)}if(e)for(const e of t)e.output1=0,e.output2=0}static sanitizeDelayLine(t,e,i){for(;;){const s=--e&i,n=Math.abs(t[s]);if(Number.isFinite(n)&&(0==n||n>=Z))break;t[s]=0}}static applyFilters(t,e,i,s,n){for(let o=0;o<s;o++){const s=n[o],r=s.output1,h=s.output2,a=s.a1,l=s.a2,c=s.b0,u=s.b1,f=s.b2;t=c*t+u*e+f*i-a*r-l*h,s.a1=a+s.a1Delta,s.a2=l+s.a2Delta,s.useMultiplicativeInputCoefficients?(s.b0=c*s.b0Delta,s.b1=u*s.b1Delta,s.b2=f*s.b2Delta):(s.b0=c+s.b0Delta,s.b1=u+s.b1Delta,s.b2=f+s.b2Delta),s.output2=r,s.output1=t,i=h,e=r}return t}}Mt.tempFilterStartCoefficients=new Y,Mt.tempFilterEndCoefficients=new Y,Mt.fmSynthFunctionCache={},Mt.effectsFunctionCache=Array(128).fill(void 0),Mt.pickedStringFunctionCache=Array(3).fill(void 0),Mt.fmSourceTemplate=("\n\t\tconst data = synth.tempMonoInstrumentSampleBuffer;\n\t\tconst sineWave = beepbox.Config.sineWave;\n\t\t\n\t\t// I'm adding 1000 to the phase to ensure that it's never negative even when modulated by other waves because negative numbers don't work with the modulus operator very well.\n\t\tlet operator#Phase       = +((tone.phases[#] % 1) + 1000) * beepbox.Config.sineWaveLength;\n\t\tlet operator#PhaseDelta  = +tone.phaseDeltas[#];\n\t\tlet operator#PhaseDeltaScale = +tone.phaseDeltaScales[#];\n\t\tlet operator#OutputMult  = +tone.expressionStarts[#];\n\t\tconst operator#OutputDelta = +tone.expressionDeltas[#];\n\t\tlet operator#Output      = +tone.feedbackOutputs[#];\n\t\tlet feedbackMult         = +tone.feedbackMult;\n\t\tconst feedbackDelta      = +tone.feedbackDelta;\n\t\t\n\t\tconst filters = tone.noteFilters;\n\t\tconst filterCount = tone.noteFilterCount|0;\n\t\tlet initialFilterInput1 = +tone.initialNoteFilterInput1;\n\t\tlet initialFilterInput2 = +tone.initialNoteFilterInput2;\n\t\tconst applyFilters = beepbox.Synth.applyFilters;\n\t\t\n\t\tconst stopIndex = bufferIndex + runLength;\n\t\tfor (let sampleIndex = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\n\t\t\t// INSERT OPERATOR COMPUTATION HERE\n\t\t\tconst fmOutput = (/*operator#Scaled*/); // CARRIER OUTPUTS\n\t\t\t\n\t\t\tconst inputSample = fmOutput;\n\t\t\tconst sample = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\n\t\t\tinitialFilterInput2 = initialFilterInput1;\n\t\t\tinitialFilterInput1 = inputSample;\n\t\t\t\n\t\t\tfeedbackMult += feedbackDelta;\n\t\t\toperator#OutputMult += operator#OutputDelta;\n\t\t\toperator#Phase += operator#PhaseDelta;\n\t\t\toperator#PhaseDelta *= operator#PhaseDeltaScale;\n\t\t\t\n\t\t\tdata[sampleIndex] += sample;\n\t\t}\n\t\t\n\t\ttone.phases[#] = operator#Phase / "+e.sineWaveLength+";\n\t\ttone.feedbackOutputs[#] = operator#Output;\n\t\t\n\t\tsynth.sanitizeFilters(filters);\n\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\n\t\ttone.initialNoteFilterInput2 = initialFilterInput2;\n\t").split("\n"),Mt.operatorSourceTemplate=("\n\t\t\tconst operator#PhaseMix = operator#Phase/* + operator@Scaled*/;\n\t\t\tconst operator#PhaseInt = operator#PhaseMix|0;\n\t\t\tconst operator#Index    = operator#PhaseInt & "+e.sineWaveMask+";\n\t\t\tconst operator#Sample   = sineWave[operator#Index];\n\t\t\toperator#Output         = operator#Sample + (sineWave[operator#Index + 1] - operator#Sample) * (operator#PhaseMix - operator#PhaseInt);\n\t\t\tconst operator#Scaled   = operator#OutputMult * operator#Output;\n\t").split("\n");const{button:xt,div:St,p:Pt,h2:Ft}=z;class Et{constructor(t,e){let i;switch(this.W=t,this.j=xt({class:"cancelButton"}),this.J=()=>{this.W.undo()},this.cleanUp=()=>{this.j.removeEventListener("click",this.J)},e){case"scale":i=St(Ft("Scale"),Pt("This setting limits the available pitches for adding notes. You may think that there's no point in limiting your choices, but the set of pitches you use has a strong influence on the mood and feel of your song, and these scales serve as guides to help you choose appropriate pitches. Don't worry, you can change the scale at any time, so you're not locked into it. Try making little melodies using all the available pitches of a scale to get a sense for how it sounds."),Pt('Most of the scales have a major version, marked with a smiley face, and a minor version, marked with a sad face. Assuming your song uses all pitches in the scale and especially "tonic" pitches (the brown rows in the pattern editor) then major scales tend to sound more playful or optimistic, whereas minor scales sound more serious or sad.'));break;case"key":i=St(Ft("Song Key"),Pt('This setting can shift the frequency of every note in your entire song up or down, aligning the "tonic" pitches (the brown rows in the pattern editor) with the selected "key" pitch.'),Pt('If you\'ve already composed a song but it doesn\'t emphasize "tonic" pitches then the selected key isn\'t very meaningful. You can select the "Detect Key" option in the key menu to automatically align the most emphasized notes with "tonic" pitches.'));break;case"tempo":i=St(Ft("Song Tempo"),Pt('This setting controls the speed of your song, measured in beats-per-minute. A "beat" is the length of the little gray rectangles in the pattern editor. (In conventional music notation, a "quarter note" is usually equivalent to "beat".)'));break;case"reverb":i=St(Ft("Reverb"),Pt('Reverb is like a continuous echo effect. A little bit helps instruments sound more natural. Adding a lot of reverb can add sense of depth or mystery, but too much reverb can kinda "smear" sounds so that it\'s harder to distinguish notes or instruments.'));break;case"rhythm":i=St(Ft("Rhythm"),Pt("This setting determines how beats are divided. The pattern editor helps you align notes to fractions of a beat based on this setting."),Pt("If you've already composed a song but the notes don't align with the selected rhythm, you can select the \"Snap Notes To Rhythm\" option in the rhythm menu to force the notes in the currently selected pattern(s) to align with the selected rhythm."));break;case"instrumentIndex":i=St(Ft("Instrument Number"),Pt('In the "Channel Settings" option from BeepBox\'s "File" menu, there are a couple ways to enable multiple instruments per channel, in which case you can click the + button to add more instruments to a channel.'),Pt("First, you could enable multiple simultaneous instruments per channel. All of the channel's instruments will play all of the notes in the channel at the same time, and you can click an instrument number to view and edit its settings."),Pt("Second, you could enable different instruments per pattern. Only one of the instruments will play at any given time, but you can click the instrument number to change which instrument is used for the currently selected pattern(s)."),Pt("Finally, you can enable them both, in which case you can click an instrument number once to view it, and again to toggle whether the instrument is used for the currently selected pattern(s)."),Pt("Either way, you can also press shift and a number key to select an instrument."));break;case"instrumentVolume":i=St(Ft("Instrument Volume"),Pt("This setting controls the volume of the selected instrument without affecting the volume of the other instruments. This allows you to balance the loudness of each instrument relative to each other."));break;case"pan":i=St(Ft("Instrument Panning"),Pt("If you're listening through headphones or some other stereo sound system, this controls the position of the instrument and where the sound is coming from, ranging from left to right."),Pt("As a suggestion, composers often put lead melodies, drums, and basses in the center, and spread other instruments toward either side. If too many instruments seem like they're coming from the same place, it can feel crowded and harder to distinguish individual sounds, especially if they cover a similar pitch range."));break;case"instrumentType":i=St(Ft("Instrument Type"),Pt("BeepBox comes with many instrument presets, try them out! You can also create your own custom instruments!"),Pt("There are also options for copying and pasting instrument settings and for generating random instruments at the top of the instrument type menu."));break;case"eqFilter":i=St(Ft("EQ Filter"),Pt("Filters are a way of emphasizing or diminishing different parts of a sound. Musical notes have a fundamental (base) frequency, but the sound of a musical note also has parts at higher frequencies and filters can adjust the volume of each of these parts based on their frequency."),Pt("Click in the filter editor to insert, delete, or drag a filter control point. The horizontal position of the point determines which frequencies it affects, and the vertical position determines how the volume is affected at that frequency."),Pt('Insert a new point on the left side of the filter editor to add a "high-pass" filter point, which additionally reduces the volume of lower frequencies, or insert a new point on the right side to add a "low-pass" filter point which reduces the volume of higher frequencies.'),Pt('You can also enable a "Note Filter" as an effect. EQ and note filters are mostly the same, but have different purposes. EQ filters are for basic adjustments, whereas note filters can be moved dynamically with envelopes. Note filters also change how the distortion effect sounds.'));break;case"noteFilter":i=St(Ft("Note Filter"),Pt("Note filters are mostly the same as EQ filters, but have a different purpose. EQ filters are for basic adjustments, whereas note filters can be moved dynamically with envelopes. Note filters also change how the distortion effect sounds."),Pt("Filters are a way of emphasizing or diminishing different parts of a sound. Musical notes have a fundamental (base) frequency, but the sound of a musical note also has parts at higher frequencies and filters can adjust the volume of each of these parts based on their frequency."),Pt("Click in the filter editor to insert, delete, or drag a filter control point. The horizontal position of the point determines which frequencies it affects, and the vertical position determines how the volume is affected at that frequency."),Pt('Insert a new point on the left side of the filter editor to add a "high-pass" filter point, which additionally reduces the volume of lower frequencies, or insert a new point on the right side to add a "low-pass" filter point which reduces the volume of higher frequencies.'));break;case"fadeInOut":i=St(Ft("Fade In/Out"),Pt("This setting controls how long it takes for notes to reach full volume at the beginning or decay to silence at the end."),Pt("An instant fade-in sounds like instruments that are played by hitting or plucking, whereas slower fade-ins sound like instruments that are played by blowing air."),Pt("You can also make the fade-out start before the note ends to leave a gap before the next note starts, or after the note ends to allow the sound of the end of the note to overlap with the start of the next note."));break;case"transition":i=St(Ft("Transition"),Pt("Usually, when one note ends at the same time another begins, the old note will fade out and the new note will fade in based on the fade in/out settings, but this setting can override that, connecting the end of one note to the beginning of the next."),Pt('The "interrupt" transition makes the wave suddenly change from the old note\'s frequency to the new note\'s frequency without any fading, and restarts any envelopes. The "continue" transition is similar but it doesn\'t restart envelopes.'),Pt('The "slide" transition makes the pitch shift quickly but not instantaneously from the old note\'s frequency to the new note\'s frequency, and softly restarts envelopes. The "slide in pattern" transition is the same except it doesn\'t connect the last note in a pattern to the first note in the next pattern.'));break;case"chipWave":i=St(Ft("Chip Wave"),Pt("BeepBox comes with some sound waves based on classic electronic sound chips, as well as several unique waves. This is the basic source of the sound of the instrument, which is modified by the other instrument settings."));break;case"chipNoise":i=St(Ft("Noise"),Pt("BeepBox comes with several basic noise sounds. These do not have any distinct musical pitch, and can be used like drums to create beats and emphasize your song's rhythm."));break;case"pulseWidth":i=St(Ft("Pulse Wave Width"),Pt("This setting controls the shape and sound of a pulse wave. At the minimum width, it sounds light and buzzy. At the maximum width, it is shaped like a classic square wave."));break;case"unison":i=St(Ft("Unison"),Pt("This instrument can play two identical waves at slightly different frequencies. When two waves play at slightly different frequencies, they move in and out of phase with each other over time as different parts of the waves line up. This creates a dynamic, shifting sound. Pianos are a common example of this kind of sound, because each piano key strikes multiple strings that are tuned to slightly different frequencies."),Pt('The distance between two frequencies is called an "interval", and this setting controls how large it is. If the interval is too wide, then the waves may sound out-of-tune and "dissonant". However, if the interval is even larger, then the two frequencies can even be distinct pitches.'));break;case"chords":i=St(Ft("Chords"),Pt("When multiple different notes occur at the same time, this is called a chord. Chords can be created in BeepBox's pattern editor by adding notes above or below another note."),Pt('This setting determines how chords are played. The standard option is "simultaneous" which starts playing all of the pitches in a chord at the same instant. The "strum" option is similar, but plays the notes starting at slightly different times. The "arpeggio" option is used in "chiptune" style music and plays a single tone that rapidly alternates between all of the pitches in the chord.'),Pt('Some BeepBox instruments have an option called "custom interval" which uses the chord notes to control the interval between the waves of a single tone. This can create strange sound effects when combined with FM modulators.'));break;case"vibrato":i=St(Ft("Vibrato"),Pt("This setting causes the frequency of a note to wobble slightly. Singers and violinists often use vibrato."));break;case"algorithm":i=St(Ft("FM Algorithm"),Pt("FM Synthesis is a mysterious but powerful technique for crafting sounds, popularized by Yamaha keyboards and the Sega Genesis/Mega Drive. It may seem confusing, but try playing around with the options until you get a feel for it, or check out some of the preset examples!"),Pt("This FM synthesizer uses up to four waves, numbered 1, 2, 3, and 4. Each wave may have its own frequency and volume."),Pt('There are two kinds of waves: "carrier" waves play a tone out loud, but "modulator" waves distort other waves instead. Wave 1 is always a carrier and plays a tone, but other waves may distort it. The "Algorithm" setting determines which waves are modulators, and which other waves those modulators distort. For example, "1←2" means that wave 2 modulates wave 1, and wave 1 plays out loud.'));break;case"feedbackType":i=St(Ft("Feedback Type"),Pt("Modulators distort in one direction (like 1←2), but you can also use the feedback setting to make any wave distort in the opposite direction (1→2), or even itself (1⟲)."));break;case"feedbackVolume":i=St(Ft("Feedback Distortion"),Pt("This setting controls the amount of feedback distortion based on the feedback type setting."));break;case"operatorFrequency":i=St(Ft("Operator Frequency"),Pt('This setting controls the frequency of an individual FM wave, relative to the fundamental frequency of the note. The multiplier 1× is the same as the fundamental frequency, whereas 2x would be an octave (12 semitones) above it. The frequencies with a "~" are slightly detuned and shift in and out of phase over time compared to the other frequencies.'),Pt('Try different combinations of a "carrier" wave and a "modulator" wave with different frequencies to get a feel for how they sound together.'));break;case"operatorVolume":i=St(Ft("Operator Volume"),Pt('This setting controls the volume of "carrier" waves, or the amount of distortion that "modulator" waves apply to other waves.'));break;case"spectrum":i=St(Ft("Spectrum"),Pt("This setting allows you to draw your own noise spectrum! This is good for making drum sounds."),Pt("If you only use certain frequencies and a soft fade in/out, it's also possible to make howling wind sounds or even musical wind instruments."),Pt("The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies."));break;case"harmonics":i=St(Ft("Harmonics"),Pt("This setting allows you to design your own sound wave! Most musical waves are actually a combination of sine waves at certain frequencies, and this lets you control the volume of each sine wave individually."),Pt("The left side of the harmonics editor controls the sine wave volumes at lower frequencies, and the right side controls higher frequencies."));break;case"effects":i=St(Ft("Effects"),Pt("BeepBox has many different kinds of special effects you can add to instruments. You can turn on multiple effects at once, and they can be configured individually. Try them all out!"));break;case"drumsetEnvelope":i=St(Ft("Drumset Envelope"),Pt("This drumset comes with a low-pass filter, and this setting can dynamically change the low-pass filter frequency over time. Each row in the pattern editor can have a different envelope shape."));break;case"drumsetSpectrum":i=St(Ft("Drumset Spectrum"),Pt("This setting allows you to draw your own noise spectrum! This is good for making drumsets. Each row in the pattern editor gets its own spectrum."),Pt("The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies."));break;case"chorus":i=St(Ft("Chorus"),Pt("The chorus effect combines multiple copies of the instrument's sound and adds a bit of vibrato to simulate an ensemble of instruments or voices. Drag the slider to control how much chorus is added."));break;case"echoSustain":i=St(Ft("Echo Volume"),Pt("The echo effect repeats the instrument's sound after a delay. Each echo is a little bit quieter than the last, and this setting controls how much quieter."));break;case"echoDelay":i=St(Ft("Echo Delay"),Pt("The echo effect repeats the instrument's sound after a delay, and this setting controls how long the delay is."));break;case"pitchShift":i=St(Ft("Pitch Shift"),Pt("This setting makes instruments play higher or lower pitches than the ones displayed in the pattern editor. Be careful that you don't confuse yourself!"),Pt("You can combine this with envelopes to bend pitch over time, or play multiple simultaneous instruments with different pitch shifts for interesting layered sounds."),Pt('The intervals created by this setting are in "just intonation" which means they stay in phase with the original pitch instead of shifting in and out of phase over time. If you want the shifting, add the detune effect!'));break;case"detune":i=St(Ft("Detune"),Pt('This setting slightly adjusts the frequency of notes played by the instrument. You can use a little bit to add a pleasing shifting sound similar to the "unison" feature when combined with other instruments. If you use too much, then the instrument may sound unpleasantly out-of-tune.'));break;case"distortion":i=St(Ft("Distortion"),Pt("This is the famous electric guitar effect! However, there are some things to be aware of."),Pt('First, most chords don\'t sound right when combined with heavy distortion. The only chords commonly used with distorted electric guitars are "power chords" which consist of a root note, a "fifth" note above that, and/or any octaves of those two notes.'),Pt("Second, the distortion sound depends a lot on filtering. In particular, I recommend enabling the note filter effect, and adding both high-pass and low-pass points to the note filter. (Note filters are applied first, then distortion which transforms the sound based on that filtering, then the EQ filter is applied last.)"),Pt("Finally, I recommend adjusting the fade-out setting to allow the end of each note to overlap a little bit with the beginning of the next, but not too much!"));break;case"bitcrusherQuantization":i=St(Ft("Bitcrusher Quantization"),Pt("This effect makes stuff sounds harsher, artificial, and \"low quality\", which is great if that's what you're going for!"));break;case"bitcrusherFreq":i=St(Ft("Frequency Quantization"),Pt("The bitcrusher effect comes with an additional frequency quantization effect! This is a fun one to play with, especially when combined with the note filter effect."),Pt("Every other notch on this slider is aligned with the currently selected key of the song, and the in-between notches are aligned with the tritones of the key."));break;case"stringSustain":i=St(Ft("String sustain"),Pt("This setting controls how quickly the picked string vibration decays."),Pt('Unlike most of BeepBox\'s instrument synthesizer features, a picked string cannot change frequency suddenly while maintaining its decay. If a tone\'s pitch changes suddenly (e.g. if the chord type is set to "arpeggio" or the transition type is set to "continues") then the string will be re-picked and start decaying from the beginning again, even if the envelopes don\'t otherwise restart.'));break;case"envelopes":i=St(Ft("Envelopes"),Pt("Envelopes are a way to dynamically adjust various other settings over time, usually based on how long the note lasts. Press the + button to add an envelope, then use the menus below to select which setting to control and the curve of the envelope. Try different combinations to see how they sound!"),Pt('Most envelope curves restart from the beginning every time a new note plays. The "note size" option is based on the note width as drawn in the pattern editor.'),Pt("Envelope curves move in the range from 0 to 1 (or vice versa), where 0 means as quiet as possible and 1 is the same as the corresponding position selected in the instrument settings above. If multiple envelopes are targetting the same setting, they are multiplied before applying to the setting."));break;default:throw new Error("Unhandled TipPrompt type: "+e)}this.container=St({class:"prompt",style:"width: 300px;"},i,this.j),setTimeout((()=>this.j.focus())),this.j.addEventListener("click",this.J)}}class It{constructor(){this.Y=!0}K(){this.Y=!1}isNoop(){return this.Y}commit(){}}class qt extends It{constructor(t){super(),this.Z=t,this.X=!t}undo(){this.Z?(this.tt(),this.X=!0):(this.et(),this.X=!1)}redo(){this.Z?(this.et(),this.X=!1):(this.tt(),this.X=!0)}it(){return this.X}tt(){throw new Error("Change.doForwards(): Override me.")}et(){throw new Error("Change.doBackwards(): Override me.")}}class Tt extends It{constructor(){super()}append(t){t.isNoop()||this.K()}}class Ct extends qt{constructor(t){super(!1),this.st=null==t?[]:t.concat()}append(t){t.isNoop()||(this.st[this.st.length]=t,this.K())}tt(){for(let t=0;t<this.st.length;t++)this.st[t].redo()}et(){for(let t=this.st.length-1;t>=0;t--)this.st[t].undo()}}function Lt(t,e){const i=t.every((t=>-1!=e.indexOf(t))),s=e.every((e=>-1!=t.indexOf(e)));return i&&s&&e.length==t.length}function Dt(t,e,i){const s=new Set(t);t.length=0,t.push(...s);for(let s=0;s<t.length;s++)t[s]>=e.channels[i].instruments.length&&(t.splice(s,1),s--);t.length>e.getMaxInstrumentsPerPattern(i)&&(t.length=e.getMaxInstrumentsPerPattern(i)),t.length<=0&&(t[0]=0)}function zt(t,e){for(const i of t.notes)for(const t of i.pitches)for(const s of i.pins){const i=(t+s.interval)%12;e[i]||(e[i]=!0)}}function At(t){for(let e=1;e<t.length-1;){const i=t[e-1],s=t[e],n=t[e+1],o=s.time-i.time,r=n.time-s.time;(s.interval-i.interval)*r==(n.interval-s.interval)*o&&(s.size-i.size)*r==(n.size-s.size)*o?t.splice(e,1):e++}}function Rt(t,i,s,n,o){const r=new rt(-1,s,n,e.noteSizeMax,!1);r.pins.length=0,r.pitches.length=0;const h=n-s;for(const e of t.pitches)r.pitches.push(e);for(let e=0;e<t.pins.length;e++){const s=t.pins[e],n=s.time+i;if(n<0){if(e+1>=t.pins.length)throw new Error("Error converting pins in note overflow.");const o=t.pins[e+1],h=o.time+i;if(h>0){const t=-n/(h-n);r.pins.push(st(Math.round(s.interval+t*(o.interval-s.interval)),0,Math.round(s.size+t*(o.size-s.size))))}}else if(n<=h)r.pins.push(st(s.interval,n,s.size));else{if(e<1)throw new Error("Error converting pins in note overflow.");const o=t.pins[e-1],a=o.time+i;if(a<h){const t=(h-a)/(n-a);r.pins.push(st(Math.round(o.interval+t*(s.interval-o.interval)),h,Math.round(o.size+t*(s.size-o.size))))}}}const a=r.pins[0].interval;for(let t=0;t<r.pitches.length;t++)r.pitches[t]+=a;for(let t=0;t<r.pins.length;t++)r.pins[t].interval-=a;let l=!1;if(0==r.start)r.continuesLastPattern=i<0||t.continuesLastPattern;else if(r.continuesLastPattern=!1,o.length>0&&t.continuesLastPattern){const t=o[o.length-1];if(t.end==r.start&&Mt.adjacentNotesHaveMatchingPitches(t,r)){l=!0;const e=t.pins[t.pins.length-1].interval,i=t.end-t.start;for(let s=1;s<r.pins.length;s++){const n=r.pins[s],o=st(n.interval+e,n.time+i,n.size);t.pins.push(o),t.end=t.start+o.time}At(t.pins)}}l||o.push(r)}class Ot extends Tt{constructor(t,i,s){super();const n=[],o=[];for(let r=0;r<t.song.getChannelCount();r++){const h=t.song.channels[r],a=new mt;r<t.song.pitchChannelCount?n.push(a):o.push(a),a.muted=h.muted,a.octave=h.octave;for(const t of h.instruments)a.instruments.push(t);const l=e.partsPerBeat*t.song.beatsPerBar,c=e.partsPerBeat*i;let u=-1,f=null;for(let e=0;e<t.song.barCount;e++){const i=t.song.getPattern(r,e);if(null!=i){const t=e*l;for(const e of i.notes){const n=e.start+t+s,o=e.end+t+s,r=Math.floor(n/c),h=Math.ceil(o/c);for(let t=r;t<h;t++){const s=t*c,r=Math.max(0,n-s),h=Math.min(c,o-s);if(r<h){if(u!=t||null==f){for(u++;u<t;)a.bars[u]=0,u++;f=new ht,a.patterns.push(f),a.bars[u]=a.patterns.length,f.instruments.length=0,f.instruments.push(...i.instruments)}Rt(e,n-s-r,r,h,f.notes)}}}}}}Ye(n),Ye(o),this.append(new je(t,n,o))}}class Bt extends qt{constructor(t,e){super(!1),this.W=t,this.nt=e,this.ot=this.nt.start,this.rt=this.nt.end,this.ht=this.nt.start,this.at=this.nt.end,this.lt=this.nt.pins,this.ct=[],this.ut=this.nt.pitches,this.ft=[],this.dt=this.nt.continuesLastPattern,this.yt=this.nt.continuesLastPattern}gt(t){for(let t=0;t<this.ct.length-1;)this.ct[t].time>=this.ct[t+1].time?this.ct.splice(t,1):t++;At(this.ct);const e=this.ct[0].interval,i=this.ct[0].time;for(let t=0;t<this.ut.length;t++)this.ft[t]=this.ut[t]+e;for(let t=0;t<this.ct.length;t++)this.ct[t].interval-=e,this.ct[t].time-=i;this.ht=this.ot+i,this.at=this.ht+this.ct[this.ct.length-1].time,null!=t&&(this.yt=t),0!=this.ht&&(this.yt=!1),this.tt(),this.K()}tt(){this.nt.pins=this.ct,this.nt.pitches=this.ft,this.nt.start=this.ht,this.nt.end=this.at,this.nt.continuesLastPattern=this.yt,null!=this.W&&this.W.notifier.changed()}et(){this.nt.pins=this.lt,this.nt.pitches=this.ut,this.nt.start=this.ot,this.nt.end=this.rt,this.nt.continuesLastPattern=this.dt,null!=this.W&&this.W.notifier.changed()}}class Nt extends It{constructor(t){super();const e=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];e.preset!=e.type&&(e.preset=e.type,t.notifier.changed(),this.K())}}class Ht extends It{constructor(t,i){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];if(s.preset!=i){const n=x.valueToPreset(i);if(null!=n)if(null!=n.customType)s.type=n.customType,!e.instrumentTypeHasSpecialInterval[s.type]&&e.chords[s.chord].customInterval&&(s.chord=0),s.clearInvalidEnvelopeTargets();else if(null!=n.settings){const i=s.volume,o=s.pan,r=g(s.effects);s.fromJsonObject(n.settings,t.song.getChannelIsNoise(t.channel),1),s.volume=i,s.pan=o,r&&s.pan!=e.panCenter&&(s.effects=4|s.effects)}s.preset=i,t.notifier.changed(),this.K()}}}class Gt extends It{constructor(t){function i(t){let e=0;for(const i of t)e+=i.weight;let i=Math.random()*e;for(const e of t)if(i-=e.weight,i<=0)return e.item;return t[Math.random()*t.length|0].item}function s(t,e,s,n){const o=[];for(let i=t;i<=e;i++)o.push({item:i,weight:1/(Math.pow((i-s)/n,2)+1)});return i(o)}super();class n{constructor(t,e,i,s,n,o){this.chance=t,this.type=e,this.minFreq=i,this.maxFreq=s,this.centerHz=n,this.centerGain=o}}function o(t,i){t.reset();const n=[];for(const o of i){if(Math.random()>o.chance)continue;const i=new ut;i.type=o.type,i.freq=s(o.minFreq,o.maxFreq,ut.getRoundedSettingValueFromHz(o.centerHz),1/e.filterFreqStep),i.gain=s(0,e.filterGainRange-1,e.filterGainCenter+o.centerGain,2/e.filterGainStep),2==i.type&&i.gain==e.filterGainCenter||(n.includes(i.freq)||(n.push(i.freq),t.controlPoints[t.controlPointCount]=i,t.controlPointCount++))}}const r=t.song.getChannelIsNoise(t.channel),h=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];h.effects&=4,h.envelopeCount=0;const a=ut.getRoundedSettingValueFromHz(700),l=e.filterFreqRange-1;if(o(h.eqFilter,[new n(.8,0,a,l,4e3,-1),new n(.4,1,0,a-1,250,-1),new n(.5,2,0,l,2e3,0),new n(.4,2,0,l,1400,0),new n(.3,2,0,l,1e3,0),new n(.2,2,0,l,500,0)]),r){const t=i([{item:2,weight:1},{item:3,weight:3}]);function r(t){let i=0;for(const e of t)e>i&&(i=e);for(let s=0;s<t.length;s++)t[s]=e.harmonicsMax*t[s]/i}switch(h.preset=h.type=t,h.fadeIn=Math.random()<.8?0:s(0,e.fadeInRange-1,0,2),h.fadeOut=s(0,e.fadeOutTicks.length-1,e.fadeOutNeutral,2),Math.random()<.1&&(h.effects|=1024,h.transition=e.transitions.dictionary[i([{item:"normal",weight:30},{item:"interrupt",weight:1},{item:"slide",weight:2}])].index),Math.random()<.2&&(h.effects|=2048,h.chord=e.chords.dictionary[i([{item:"strum",weight:2},{item:"arpeggio",weight:1}])].index),Math.random()<.1&&(h.pitchShift=s(0,e.pitchShiftRange-1,e.pitchShiftCenter,2),h.pitchShift!=e.pitchShiftCenter&&(h.effects|=128,h.addEnvelope(e.instrumentAutomationTargets.dictionary.pitchShift.index,0,e.envelopes.dictionary[i([{item:"flare 1",weight:2},{item:"flare 2",weight:1},{item:"flare 3",weight:1},{item:"twang 1",weight:16},{item:"twang 2",weight:8},{item:"twang 3",weight:4},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"decay 1",weight:4},{item:"decay 2",weight:2},{item:"decay 3",weight:1}])].index))),Math.random()<.1&&(h.effects|=512,h.vibrato=s(0,e.echoSustainRange-1,e.echoSustainRange>>1,2),h.vibrato=e.vibratos.dictionary[i([{item:"light",weight:2},{item:"delayed",weight:2},{item:"heavy",weight:1},{item:"shaky",weight:2}])].index),Math.random()<.8&&(h.effects|=32,o(h.noteFilter,[new n(1,0,a,l,8e3,-1)]),h.addEnvelope(e.instrumentAutomationTargets.dictionary.noteFilterAllFreqs.index,0,e.envelopes.dictionary[i([{item:"punch",weight:4},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:8},{item:"twang 2",weight:8},{item:"twang 3",weight:8},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:4},{item:"decay 2",weight:4},{item:"decay 3",weight:4}])].index)),Math.random()<.1&&(h.effects|=8,h.distortion=s(1,e.distortionRange-1,e.distortionRange-1,2)),Math.random()<.1&&(h.effects|=16,h.bitcrusherFreq=s(0,e.bitcrusherFreqRange-1,e.bitcrusherFreqRange>>1,2),h.bitcrusherQuantization=s(0,e.bitcrusherQuantizationRange-1,e.bitcrusherQuantizationRange>>1,2)),Math.random()<.1&&(h.effects|=2,h.chorus=s(1,e.chorusRange-1,e.chorusRange-1,1)),Math.random()<.1&&(h.echoSustain=s(0,e.echoSustainRange-1,e.echoSustainRange>>1,2),h.echoDelay=s(0,e.echoDelayRange-1,e.echoDelayRange>>1,2),0==h.echoSustain&&0==h.echoDelay||(h.effects|=64)),Math.random()<.5&&(h.effects|=1,h.reverb=s(1,e.reverbRange-1,1,1)),t){case 2:h.chipNoise=Math.random()*e.chipNoises.length|0;break;case 3:{const t=[()=>{const t=[];for(let i=0;i<e.spectrumControlPoints;i++)t[i]=Math.random()<.5?Math.random():0;return t},()=>{let t=1;const i=[t];for(let s=1;s<e.spectrumControlPoints;s++)t*=Math.pow(2,Math.random()-.52),i[s]=t;return i},()=>{let t=1;const i=[t];for(let s=1;s<e.spectrumControlPoints;s++)t*=Math.pow(2,Math.random()-.52),i[s]=t*Math.random();return i}],i=(0,t[Math.random()*t.length|0])();r(i);for(let t=0;t<e.spectrumControlPoints;t++)h.spectrumWave.spectrum[t]=Math.round(i[t]);h.spectrumWave.markCustomWaveDirty()}break;default:throw new Error("Unhandled noise instrument type in random generator.")}}else{const t=i([{item:0,weight:4},{item:6,weight:4},{item:5,weight:5},{item:7,weight:5},{item:3,weight:1},{item:1,weight:5}]);function r(t){let i=0;for(const e of t)e>i&&(i=e);for(let s=0;s<t.length;s++)t[s]=e.harmonicsMax*t[s]/i}switch(h.preset=h.type=t,h.fadeIn=Math.random()<.5?0:s(0,e.fadeInRange-1,0,2),h.fadeOut=s(0,e.fadeOutTicks.length-1,e.fadeOutNeutral,2),0!=t&&5!=t&&7!=t||(h.unison=e.unisons.dictionary[i([{item:"none",weight:10},{item:"shimmer",weight:5},{item:"hum",weight:4},{item:"honky tonk",weight:3},{item:"dissonant",weight:1},{item:"fifth",weight:1},{item:"octave",weight:2},{item:"bowed",weight:2},{item:"piano",weight:5}])].index),Math.random()<.1&&(h.effects|=1024,h.transition=e.transitions.dictionary[i([{item:"interrupt",weight:1},{item:"slide",weight:2}])].index),Math.random()<.2&&(h.effects|=2048,h.chord=e.chords.dictionary[i([{item:"strum",weight:2},{item:"arpeggio",weight:1}])].index),Math.random()<.05&&(h.pitchShift=s(0,e.pitchShiftRange-1,e.pitchShiftCenter,1),h.pitchShift!=e.pitchShiftCenter&&(h.effects|=128,h.addEnvelope(e.instrumentAutomationTargets.dictionary.pitchShift.index,0,e.envelopes.dictionary[i([{item:"flare 1",weight:2},{item:"flare 2",weight:1},{item:"flare 3",weight:1},{item:"twang 1",weight:16},{item:"twang 2",weight:8},{item:"twang 3",weight:4},{item:"decay 1",weight:4},{item:"decay 2",weight:2},{item:"decay 3",weight:1}])].index))),Math.random()<.25&&(h.effects|=512,h.vibrato=s(0,e.echoSustainRange-1,e.echoSustainRange>>1,2),h.vibrato=e.vibratos.dictionary[i([{item:"light",weight:2},{item:"delayed",weight:2},{item:"heavy",weight:1},{item:"shaky",weight:2}])].index),Math.random()<.1&&(h.effects|=8,h.distortion=s(1,e.distortionRange-1,e.distortionRange-1,2)),m(h.effects)&&Math.random()<.8?(h.effects|=32,o(h.noteFilter,[new n(1,0,a,l,2e3,-1),new n(.9,1,0,a-1,500,-1),new n(.4,2,0,l,1400,0)])):Math.random()<.5&&(h.effects|=32,o(h.noteFilter,[new n(1,0,a,l,8e3,-1)]),h.addEnvelope(e.instrumentAutomationTargets.dictionary.noteFilterAllFreqs.index,0,e.envelopes.dictionary[i([{item:"punch",weight:6},{item:"flare 1",weight:2},{item:"flare 2",weight:4},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:4},{item:"twang 3",weight:4},{item:"swell 1",weight:4},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:2},{item:"decay 3",weight:2}])].index)),Math.random()<.1&&(h.effects|=16,h.bitcrusherFreq=s(0,e.bitcrusherFreqRange-1,0,2),h.bitcrusherQuantization=s(0,e.bitcrusherQuantizationRange-1,e.bitcrusherQuantizationRange>>1,2)),Math.random()<.1&&(h.effects|=2,h.chorus=s(1,e.chorusRange-1,e.chorusRange-1,1)),Math.random()<.1&&(h.echoSustain=s(0,e.echoSustainRange-1,e.echoSustainRange>>1,2),h.echoDelay=s(0,e.echoDelayRange-1,e.echoDelayRange>>1,2),0==h.echoSustain&&0==h.echoDelay||(h.effects|=64)),Math.random()<.5&&(h.effects|=1,h.reverb=s(1,e.reverbRange-1,1,1)),t){case 0:h.chipWave=Math.random()*e.chipWaves.length|0;break;case 6:h.pulseWidth=s(0,e.pulseWidthRange-1,e.pulseWidthRange-1,2),Math.random()<.6&&h.addEnvelope(e.instrumentAutomationTargets.dictionary.pulseWidth.index,0,e.envelopes.dictionary[i([{item:"punch",weight:6},{item:"flare 1",weight:2},{item:"flare 2",weight:4},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:4},{item:"twang 3",weight:4},{item:"swell 1",weight:4},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:2},{item:"decay 3",weight:2}])].index);break;case 7:case 5:{7==t&&(h.stringSustain=Math.random()*e.stringSustainRange|0);const i=[()=>{const t=[];for(let i=0;i<e.harmonicsControlPoints;i++)t[i]=Math.random()<.4?Math.random():0;return t[8*Math.random()|0]=Math.pow(Math.random(),.25),t},()=>{let t=1;const i=[t];for(let s=1;s<e.harmonicsControlPoints;s++)t*=Math.pow(2,Math.random()-.55),i[s]=t;return i},()=>{let t=1;const i=[t];for(let s=1;s<e.harmonicsControlPoints;s++)t*=Math.pow(2,Math.random()-.55),i[s]=t*Math.random();return i}],s=(0,i[Math.random()*i.length|0])();r(s);for(let t=0;t<e.harmonicsControlPoints;t++)h.harmonicsWave.harmonics[t]=Math.round(s[t]);h.harmonicsWave.markCustomWaveDirty()}break;case 3:{const t=[];for(let i=0;i<e.spectrumControlPoints;i++){const e=0==i||7==i||11==i||14==i||16==i||18==i||21==i;t[i]=e?Math.pow(Math.random(),.25):.5*Math.pow(Math.random(),3)}r(t);for(let i=0;i<e.spectrumControlPoints;i++)h.spectrumWave.spectrum[i]=Math.round(t[i]);h.spectrumWave.markCustomWaveDirty()}break;case 1:{h.algorithm=Math.random()*e.algorithms.length|0,h.feedbackType=Math.random()*e.feedbacks.length|0;const t=e.algorithms[h.algorithm];for(let i=0;i<t.carrierCount;i++)h.operators[i].frequency=s(0,e.operatorFrequencies.length-1,0,3),h.operators[i].amplitude=s(0,e.operatorAmplitudeMax,e.operatorAmplitudeMax-1,2);for(let n=t.carrierCount;n<e.operatorCount;n++)h.operators[n].frequency=s(3,e.operatorFrequencies.length-1,0,3),h.operators[n].amplitude=Math.pow(Math.random(),2)*e.operatorAmplitudeMax|0,h.envelopeCount<e.maxEnvelopeCount&&Math.random()<.4&&h.addEnvelope(e.instrumentAutomationTargets.dictionary.operatorAmplitude.index,n,e.envelopes.dictionary[i([{item:"punch",weight:2},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:2},{item:"twang 3",weight:2},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:2},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:1},{item:"decay 3",weight:1}])].index),h.envelopeCount<e.maxEnvelopeCount&&Math.random()<.05&&h.addEnvelope(e.instrumentAutomationTargets.dictionary.operatorFrequency.index,n,e.envelopes.dictionary[i([{item:"punch",weight:4},{item:"flare 1",weight:4},{item:"flare 2",weight:2},{item:"flare 3",weight:1},{item:"twang 1",weight:16},{item:"twang 2",weight:2},{item:"twang 3",weight:1},{item:"swell 1",weight:4},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"decay 1",weight:2},{item:"decay 2",weight:1},{item:"decay 3",weight:1}])].index);h.feedbackAmplitude=Math.pow(Math.random(),3)*e.operatorAmplitudeMax|0,h.envelopeCount<e.maxEnvelopeCount&&Math.random()<.4&&h.addEnvelope(e.instrumentAutomationTargets.dictionary.feedbackAmplitude.index,0,e.envelopes.dictionary[i([{item:"punch",weight:2},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:2},{item:"twang 3",weight:2},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:2},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:1},{item:"decay 3",weight:1}])].index)}break;default:throw new Error("Unhandled pitched instrument type in random generator.")}}t.notifier.changed(),this.K()}}class $t extends It{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.transition!=e&&(this.K(),i.transition=e,i.preset=i.type,t.notifier.changed())}}class _t extends It{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()],s=i.effects,n=0!=(s&1<<e),o=n?s&~(1<<e):s|1<<e;i.effects=o,2!=e&&(i.preset=i.type),n&&i.clearInvalidEnvelopeTargets(),this.K(),t.notifier.changed()}}class Ut extends It{constructor(t,e,i,s,n,o){if(super(),e>t.song.patternsPerChannel)throw new Error("invalid pattern");for(let r=i;r<i+n;r++)for(let i=s;i<s+o;i++)t.song.channels[i].bars[r]!=e&&(t.song.channels[i].bars[r]=e,this.K());t.notifier.changed()}}class Vt extends It{constructor(t,e,i){if(super(),t.song.barCount!=e){for(const s of t.song.channels)if(i){for(;s.bars.length<e;)s.bars.unshift(0);t.song.barCount>e&&s.bars.splice(0,t.song.barCount-e)}else{for(;s.bars.length<e;)s.bars.push(0);s.bars.length=e}if(i){const i=e-t.song.barCount;t.bar=Math.max(0,t.bar+i),(i<0||t.barScrollPos>0)&&(t.barScrollPos=Math.max(0,t.barScrollPos+i)),t.song.loopStart=Math.max(0,t.song.loopStart+i)}t.bar=Math.min(t.bar,e-1),t.barScrollPos=Math.max(0,Math.min(e-t.trackVisibleBars,t.barScrollPos)),t.song.loopLength=Math.min(e,t.song.loopLength),t.song.loopStart=Math.min(e-t.song.loopLength,t.song.loopStart),t.song.barCount=e,t.notifier.changed(),this.K()}}}class Wt extends It{constructor(t,i,s){super();const n=Math.min(e.barCountMax,t.song.barCount+s);if(0!=(s=n-t.song.barCount)){for(const e of t.song.channels)for(;e.bars.length<n;)e.bars.splice(i,0,0);t.song.barCount=n,t.bar+=s,t.barScrollPos=Math.min(n-t.trackVisibleBars,t.barScrollPos+s),t.song.loopStart>=i?t.song.loopStart+=s:t.song.loopStart+t.song.loopLength>=i&&(t.song.loopLength+=s),t.notifier.changed(),this.K()}}}class jt extends It{constructor(t,e,i){super();for(const s of t.song.channels)s.bars.splice(e,i),0==s.bars.length&&s.bars.push(0);t.song.barCount=Math.max(1,t.song.barCount-i),t.bar=Math.max(0,t.bar-i),t.barScrollPos=Math.max(0,t.barScrollPos-i),t.song.loopStart>=e?t.song.loopStart=Math.max(0,t.song.loopStart-i):t.song.loopStart+t.song.loopLength>e&&(t.song.loopLength-=i),t.song.loopLength=Math.max(1,Math.min(t.song.barCount-t.song.loopStart,t.song.loopLength)),t.notifier.changed(),this.K()}}class Jt extends It{constructor(t,e,i,s){super(),t.song.channels.splice(e+s,0,...t.song.channels.splice(e,i-e+1)),t.notifier.changed(),this.K()}}class Yt extends It{constructor(t,i,s){if(super(),t.song.pitchChannelCount!=i||t.song.noiseChannelCount!=s){const n=[];function o(i,s,o,r,h,a){for(let l=0;l<i;l++){const i=l+o,c=l+r;if(l<s)n[i]=t.song.channels[c];else{n[i]=new mt,n[i].octave=h;for(let t=0;t<e.instrumentCountMin;t++){const e=new dt(a),s=_e(a),o=x.valueToPreset(s);e.fromJsonObject(o.settings,a),e.preset=s,e.volume=1,n[i].instruments[t]=e}for(let e=0;e<t.song.patternsPerChannel;e++)n[i].patterns[e]=new ht;for(let e=0;e<t.song.barCount;e++)n[i].bars[e]=0}}}o(i,t.song.pitchChannelCount,0,0,3,!1),o(s,t.song.noiseChannelCount,i,t.song.pitchChannelCount,0,!0),t.song.pitchChannelCount=i,t.song.noiseChannelCount=s;for(let e=0;e<t.song.getChannelCount();e++)t.song.channels[e]=n[e];t.song.channels.length=t.song.getChannelCount(),t.channel=Math.min(t.channel,i+s-1),t.channelScrollPos=Math.max(0,Math.min(t.song.getChannelCount()-t.trackVisibleChannels,t.channelScrollPos)),t.notifier.changed(),this.K()}}}class Kt extends Tt{constructor(t,i,s){super();const n=t.song.pitchChannelCount+(s?0:1),o=t.song.noiseChannelCount+(s?1:0);if(n<=e.pitchChannelCountMax&&o<=e.noiseChannelCountMax){const e=s?t.song.pitchChannelCount+t.song.noiseChannelCount:t.song.pitchChannelCount;this.append(new Yt(t,n,o)),this.append(new Jt(t,i,e-1,1))}}}class Qt extends Tt{constructor(t,i,s){for(super();s>=i;){const e=t.song.getChannelIsNoise(s);t.song.channels.splice(s,1),e?t.song.noiseChannelCount--:t.song.pitchChannelCount--,s--}t.song.pitchChannelCount<e.pitchChannelCountMin&&this.append(new Yt(t,e.pitchChannelCountMin,t.song.noiseChannelCount)),this.append(new Zt(t,Math.max(0,i-1),t.bar)),this.K(),t.notifier.changed()}}class Zt extends It{constructor(t,e,i,s=!1){super();const n=t.channel,o=t.bar;t.channel=e,t.bar=i,s||(t.barScrollPos=Math.min(t.bar,Math.max(t.bar-(t.trackVisibleBars-1),t.barScrollPos)),t.channelScrollPos=Math.min(t.channel,Math.max(t.channel-(t.trackVisibleChannels-1),t.channelScrollPos))),t.notifier.changed(),n==e&&o==i||this.K()}}class Xt extends It{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.unison!=e&&(this.K(),i.unison=e,i.preset=i.type,t.notifier.changed())}}class te extends It{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.chord!=e&&(this.K(),i.chord=e,i.preset=i.type,t.notifier.changed())}}class ee extends It{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.vibrato!=e&&(i.vibrato=e,i.preset=i.type,t.notifier.changed(),this.K())}}class ie extends It{constructor(t,e,i){super(),i.markCustomWaveDirty(),e.preset=e.type,t.notifier.changed(),this.K()}}class se extends It{constructor(t,e,i){super(),i.markCustomWaveDirty(),e.preset=e.type,t.notifier.changed(),this.K()}}class ne extends It{constructor(t,e,i){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.drumsetEnvelopes[e]!=i&&(s.drumsetEnvelopes[e]=i,s.preset=s.type,t.notifier.changed(),this.K())}}class oe extends It{constructor(t){super(),this.W=t,this.bt=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()]}commit(){this.isNoop()||(this.bt.preset=this.bt.type,this.W.notifier.changed())}}class re extends oe{constructor(t,e,i){super(t),this.bt.pulseWidth=i,t.notifier.changed(),e!=i&&this.K()}}class he extends oe{constructor(t,e,i){super(t),this.bt.pitchShift=i,t.notifier.changed(),e!=i&&this.K()}}class ae extends oe{constructor(t,e,i){super(t),this.bt.detune=i,t.notifier.changed(),e!=i&&this.K()}}class le extends oe{constructor(t,e,i){super(t),this.bt.distortion=i,t.notifier.changed(),e!=i&&this.K()}}class ce extends oe{constructor(t,e,i){super(t),this.bt.bitcrusherFreq=i,t.notifier.changed(),e!=i&&this.K()}}class ue extends oe{constructor(t,e,i){super(t),this.bt.bitcrusherQuantization=i,t.notifier.changed(),e!=i&&this.K()}}class fe extends oe{constructor(t,e,i){super(t),this.bt.stringSustain=i,t.notifier.changed(),e!=i&&this.K()}}class pe extends qt{constructor(t,i,s,n,o,r=!1){super(r),this.vt=[],this.wt=[],this.kt=[],this.Mt=[],this.W=t,this.bt=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()],this.xt=r?this.bt.preset:this.bt.type,this.St=r?this.bt.type:this.bt.preset,this.Pt=i,this.Ft=s,this.q=n;for(let t=0;t<this.bt.envelopeCount;t++){let s=this.bt.envelopes[t].target,h=this.bt.envelopes[t].index;if(this.vt.push(s),this.wt.push(h),r){const t=e.instrumentAutomationTargets[s];t.isFilter&&5==t.effect==o&&(t.maxCount==e.filterMaxPoints?h==n?(s=e.instrumentAutomationTargets.dictionary.none.index,h=0):h>n&&h--:i.controlPointCount<=1&&(s=e.instrumentAutomationTargets.dictionary.none.index,h=0))}this.kt.push(s),this.Mt.push(h)}this.K(),this.redo()}tt(){this.Pt.controlPoints.splice(this.q,0,this.Ft),this.Pt.controlPointCount++,this.Pt.controlPoints.length=this.Pt.controlPointCount,this.bt.preset=this.xt;for(let t=0;t<this.bt.envelopeCount;t++)this.bt.envelopes[t].target=this.vt[t],this.bt.envelopes[t].index=this.wt[t];this.W.notifier.changed()}et(){this.Pt.controlPoints.splice(this.q,1),this.Pt.controlPointCount--,this.Pt.controlPoints.length=this.Pt.controlPointCount,this.bt.preset=this.St;for(let t=0;t<this.bt.envelopeCount;t++)this.bt.envelopes[t].target=this.kt[t],this.bt.envelopes[t].index=this.Mt[t];this.W.notifier.changed()}}class de extends qt{constructor(t,e,i,s,n,o){super(!1),this.W=t,this.bt=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()],this.xt=this.bt.type,this.St=this.bt.preset,this.Ft=e,this.Et=i,this.It=s,this.qt=n,this.Tt=o,this.K(),this.redo()}tt(){this.Ft.freq=this.It,this.Ft.gain=this.Tt,this.bt.preset=this.xt,this.W.notifier.changed()}et(){this.Ft.freq=this.Et,this.Ft.gain=this.qt,this.bt.preset=this.St,this.W.notifier.changed()}}class me extends qt{constructor(t,e,i){super(!1),this.W=t,this.bt=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()],this.xt=this.bt.type,this.St=this.bt.preset,this.Ct=this.bt.fadeIn,this.Lt=this.bt.fadeOut,this.Dt=e,this.zt=i,this.K(),this.redo()}tt(){this.bt.fadeIn=this.Dt,this.bt.fadeOut=this.zt,this.bt.preset=this.xt,this.W.notifier.changed()}et(){this.bt.fadeIn=this.Ct,this.bt.fadeOut=this.Lt,this.bt.preset=this.St,this.W.notifier.changed()}}class ye extends It{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.algorithm!=e&&(i.algorithm=e,i.preset=i.type,t.notifier.changed(),this.K())}}class ge extends It{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.feedbackType!=e&&(i.feedbackType=e,i.preset=i.type,t.notifier.changed(),this.K())}}class be extends It{constructor(t,e,i){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.operators[e].frequency!=i&&(s.operators[e].frequency=i,s.preset=s.type,t.notifier.changed(),this.K())}}class ve extends oe{constructor(t,e,i,s){super(t),this.bt.operators[e].amplitude=s,t.notifier.changed(),i!=s&&this.K()}}class we extends oe{constructor(t,e,i){super(t),this.bt.feedbackAmplitude=i,t.notifier.changed(),e!=i&&this.K()}}class ke extends It{constructor(t){super();const e=t.song.channels[t.channel],i=t.song.getChannelIsNoise(t.channel),s=t.song.getMaxInstrumentsPerChannel();if(e.instruments.length>=s)return;const n=_e(i),o=x.valueToPreset(n),r=new dt(i);r.fromJsonObject(o.settings,i,1),r.preset=n,r.volume=1,e.instruments.push(r),t.viewedInstrument[t.channel]=e.instruments.length-1,t.notifier.changed(),this.K()}}class Me extends It{constructor(t){super();const i=t.song.channels[t.channel];if(i.instruments.length<=e.instrumentCountMin)return;const s=t.viewedInstrument[t.channel];if(i.instruments.splice(s,1),t.song.patternInstruments)for(const t of i.patterns){for(let e=0;e<t.instruments.length;e++)t.instruments[e]==s?(t.instruments.splice(e,1),e--):t.instruments[e]>s&&t.instruments[e]--;t.instruments.length<=0&&(t.instruments[0]=0)}t.notifier.changed(),this.K()}}class xe extends It{constructor(t,e){super(),t.viewedInstrument[t.channel]!=e&&(t.viewedInstrument[t.channel]=e,t.notifier.changed(),this.K())}}class Se extends It{constructor(t,e,i){super();const s=t.song.layeredInstruments,n=t.song.patternInstruments;if(s!=e||n!=i){t.song.layeredInstruments=e,t.song.patternInstruments=i;for(let e=0;e<t.song.getChannelCount();e++){const s=t.song.channels[e];s.instruments.length>t.song.getMaxInstrumentsPerChannel()&&(s.instruments.length=t.song.getMaxInstrumentsPerChannel());for(let o=0;o<t.song.patternsPerChannel;o++){const r=s.patterns[o];if(!n&&i){for(let t=0;t<s.instruments.length;t++)r.instruments[t]=t;r.instruments.length=s.instruments.length}Dt(r.instruments,t.song,e)}}t.notifier.changed(),this.K()}}}class Pe extends It{constructor(t,e){super(),t.song.key!=e&&(t.song.key=e,t.notifier.changed(),this.K())}}class Fe extends It{constructor(t,e,i,s,n){super(),this.W=t,this.oldStart=e,this.oldLength=i,this.newStart=s,this.newLength=n,this.W.song.loopStart=this.newStart,this.W.song.loopLength=this.newLength,this.W.notifier.changed(),this.oldStart==this.newStart&&this.oldLength==this.newLength||this.K()}}class Ee extends qt{constructor(t,e,i,s,n=!1){super(n),this.W=t,this.nt=e,this.At=i,this.q=s,this.K(),this.redo()}tt(){this.nt.pitches.splice(this.q,0,this.At),this.W.notifier.changed()}et(){this.nt.pitches.splice(this.q,1),this.W.notifier.changed()}}class Ie extends It{constructor(t,e,i){super(),this.oldValue=e,t.song.channels[t.channel].octave=i,t.notifier.changed(),e!=i&&this.K()}}class qe extends Tt{constructor(t,e){super(),t.song.rhythm!=e&&(t.song.rhythm=e,t.notifier.changed(),this.K())}}class Te extends Tt{constructor(t,e,i,s,n,o){super(),this.append(new si(t,e,s,n));let r=0;for(let t=0;t<e.notes.length;t++)if(e.notes[t].start<s){if(e.notes[t].end>s)throw new Error;r=t+1}else if(e.notes[t].start<n)throw new Error;for(;s<n;){for(const o of i){const i=o.start+s,h=o.end+s;if(i>=n)break;const a=new rt(o.pitches[0],i,h,o.pins[0].size,!1);a.pitches.length=0;for(const t of o.pitches)a.pitches.push(t);a.pins.length=0;for(const t of o.pins)a.pins.push(st(t.interval,t.time,t.size));a.continuesLastPattern=!0===o.continuesLastPattern&&0==a.start,e.notes.splice(r++,0,a),a.end>n&&this.append(new ii(t,a,a.start,n))}s+=o}t.notifier.changed(),this.K()}}class Ce extends Tt{constructor(t,e,i){super(),e.fromJsonObject(i,i.isDrum),t.notifier.changed(),this.K()}}class Le extends It{constructor(t,e,i,s){super(),Lt(i,s.instruments)||(s.instruments.length=0,s.instruments.push(...i),Dt(s.instruments,t.song,e),this.K(),t.notifier.changed())}}class De extends It{constructor(t,e){if(super(),t.song.patternsPerChannel!=e){for(let i=0;i<t.song.getChannelCount();i++){const s=t.song.channels[i].bars,n=t.song.channels[i].patterns;for(let t=0;t<s.length;t++)s[t]>e&&(s[t]=0);for(let t=n.length;t<e;t++)n[t]=new ht;n.length=e}t.song.patternsPerChannel=e,t.notifier.changed(),this.K()}}}class ze extends qt{constructor(t,e,i){super(!1),this.Rt=null,this.Ot=null;const s=t.song;if(0!=s.channels[e].bars[i])return;this.W=t,this.Bt=i,this.Nt=e,this.Ht=s.patternsPerChannel,this.Gt=s.patternsPerChannel,this.$t=t.recentPatternInstruments[e].concat();let n=null,o=null;for(let t=1;t<=s.patternsPerChannel;t++){let i=!1;for(let n=0;n<s.barCount;n++)if(s.channels[e].bars[n]==t){i=!0;break}if(i)continue;null==o&&(o=t);if(0==s.channels[e].patterns[t-1].notes.length){n=t;break}}if(null!=n)this._t=n,this.Ot=s.channels[e].patterns[n-1].instruments.concat();else if(s.patternsPerChannel<s.barCount)this.Gt=s.patternsPerChannel+1,this._t=s.patternsPerChannel+1;else{if(null==o)throw new Error;this._t=o,this.Rt=s.channels[e].patterns[o-1].notes,this.Ot=s.channels[e].patterns[o-1].instruments.concat()}this.K(),this.tt()}tt(){const t=this.W.song;for(let e=t.patternsPerChannel;e<this.Gt;e++)for(let i=0;i<t.getChannelCount();i++)t.channels[i].patterns[e]=new ht;t.patternsPerChannel=this.Gt;const e=t.channels[this.Nt].patterns[this._t-1];e.notes=[],e.instruments.length=0,e.instruments.push(...this.$t),t.channels[this.Nt].bars[this.Bt]=this._t,this.W.notifier.changed()}et(){const t=this.W.song,e=t.channels[this.Nt].patterns[this._t-1];null!=this.Rt&&(e.notes=this.Rt),null!=this.Ot&&(e.instruments.length=0,e.instruments.push(...this.Ot)),t.channels[this.Nt].bars[this.Bt]=0;for(let e=0;e<t.getChannelCount();e++)t.channels[e].patterns.length=this.Ht;t.patternsPerChannel=this.Ht,this.W.notifier.changed()}}class Ae extends Bt{constructor(t,e,i,s,n){super(t,e),s-=this.ot;const o=this.lt[i].time,r=Math.min(o,s),h=Math.max(o,s);let a=!1;for(let t=0;t<this.lt.length;t++){const o=e.pins[t],l=o.time;l<r?this.ct.push(st(o.interval,l,o.size)):l>h&&(a||(this.ct.length>0&&(n=e.continuesLastPattern),this.ct.push(st(this.lt[i].interval,s,this.lt[i].size)),a=!0),this.ct.push(st(o.interval,l,o.size)))}a||(n=e.continuesLastPattern,this.ct.push(st(this.lt[i].interval,s,this.lt[i].size))),this.gt(n)}}class Re extends Bt{constructor(t,i,s,n,o,r){super(t,i),s-=this.ot,n-=this.ot,o-=i.pitches[r];let h,a,l,c,u=!1,f=!1,p=0,d=e.noteSizeMax,m=!0;for(n>s?(h=0,a=1,l=i.pins.length,c=t=>{this.ct.push(t)}):(h=i.pins.length-1,a=-1,l=-1,c=t=>{this.ct.unshift(t)});h!=l;h+=a){const t=i.pins[h],e=t.time;for(;;)if(u){if(f){if(e*a==n*a)break;t.interval!=p&&(m=!1),c(st(m?o:t.interval,e,t.size));break}if(e*a<=n*a&&(p=t.interval,d=t.size),e*a<n*a)break;c(st(o,n,d)),f=!0}else{if(e*a<=s*a&&(p=t.interval,d=t.size),e*a<s*a){c(st(t.interval,e,t.size));break}c(st(p,s,d)),u=!0}}f||c(st(o,n,d)),this.gt()}}class Oe extends Ct{constructor(t,i){super();const s=e.partsPerBeat/e.rhythms[t.song.rhythm].stepsPerBeat,n=function(i){let n=e.rhythms[t.song.rhythm].roundUpThresholds;if(null!=n){const t=Math.floor(i/e.partsPerBeat)*e.partsPerBeat,o=i-t;let r=t;for(const t of n){if(!(o>=t))break;r+=s}return r}return Math.round(i/s)*s};let o=0;for(;o<i.notes.length;){const e=i.notes[o];n(e.start)>=n(e.end)?this.append(new ei(t,i,e,o,!0)):(this.append(new Be(t,e,n)),o++)}}}class Be extends Bt{constructor(t,e,i){super(t,e);for(const t of this.lt)this.ct.push(st(t.interval,i(t.time+this.ot)-this.ot,t.size));this.gt()}}class Ne extends Tt{constructor(t,i,s){super();let n=Math.round(i%t.song.beatsPerBar*e.partsPerBeat);if(n<0&&(n+=t.song.beatsPerBar*e.partsPerBeat),0!=n){switch(s){case"wrapAround":{const i=e.partsPerBeat*t.song.beatsPerBar;for(const e of t.song.channels)for(const t of e.patterns){const e=[];for(let s=1;s>=0;s--){const o=s*i;for(const s of t.notes){const t=s.start+n,r=s.end+n,h=Math.max(0,t-o),a=Math.min(i,r-o);h<a&&Rt(s,t-o-h,h,a,e)}}t.notes=e}}break;case"overflow":{let e=t.song.barCount,s=t.song.loopStart,o=t.song.loopLength;if(this.append(new Ot(t,t.song.beatsPerBar,n)),i<0){let i=!0;for(const e of t.song.channels)0!=e.bars[0]&&(i=!1);if(i){for(const e of t.song.channels)e.bars.shift();t.song.barCount--}else e++,s++,t.bar++}for(;t.song.barCount<e;){for(const e of t.song.channels)e.bars.push(0);t.song.barCount++}t.song.loopStart=s,t.song.loopLength=o}break;default:throw new Error("Unrecognized beats-per-bar conversion strategy.")}t.notifier.changed(),this.K()}}}class He extends Tt{constructor(t,i,s){if(super(),t.song.beatsPerBar!=i){switch(s){case"splice":if(t.song.beatsPerBar>i){const s=new Ct;for(let n=0;n<t.song.getChannelCount();n++)for(let o=0;o<t.song.channels[n].patterns.length;o++)s.append(new si(t,t.song.channels[n].patterns[o],i*e.partsPerBeat,t.song.beatsPerBar*e.partsPerBeat))}break;case"stretch":{const e=function(e){return Math.round(e*i/t.song.beatsPerBar)};for(let i=0;i<t.song.getChannelCount();i++)for(let s=0;s<t.song.channels[i].patterns.length;s++){const n=t.song.channels[i].patterns[s];let o=0;for(;o<n.notes.length;){const i=n.notes[o];e(i.start)>=e(i.end)?this.append(new ei(t,n,i,o,!0)):(this.append(new Be(t,i,e)),o++)}}this.append(new Ke(t,t.song.tempo,t.song.tempo*i/t.song.beatsPerBar))}break;case"overflow":this.append(new Ot(t,i,0)),t.song.loopStart=0,t.song.loopLength=t.song.barCount;break;default:throw new Error("Unrecognized beats-per-bar conversion strategy.")}t.song.beatsPerBar=i,t.notifier.changed(),this.K()}}}class Ge extends Tt{constructor(t,e){super(),t.song.scale!=e&&(t.song.scale=e,t.notifier.changed(),this.K())}}class $e extends Tt{constructor(t){super();const i=t.song,s=e.keys[i.key].basePitch,n=[0,0,0,0,0,0,0,0,0,0,0,0];for(let t=0;t<i.pitchChannelCount;t++)for(let o=0;o<i.barCount;o++){const r=i.getPattern(t,o);if(null!=r)for(const t of r.notes){const i=t.pins[0];for(let o=1;o<t.pins.length;o++){const r=t.pins[o];if(i.interval==r.interval){let o=r.time-i.time;o+=Math.max(0,Math.min(e.partsPerBeat,r.time+t.start)-(i.time+t.start)),o*=r.size+i.size;for(const e of t.pitches){n[(s+i.interval+e)%12]+=o}}}}}let o=0,r=0;for(let t=0;t<12;t++){const e=n[t]*(3*n[(t+7)%12]+n[(t+4)%12]+n[(t+3)%12]);r<e&&(r=e,o=t)}if(o!=i.key){const e=i.key-o,s=Math.abs(e);for(let n=0;n<i.pitchChannelCount;n++)for(const o of i.channels[n].patterns)for(let i=0;i<s;i++)this.append(new ri(t,n,o,e>0,!0));i.key=o,t.notifier.changed(),this.K()}}}function _e(t){const e=[];for(let i=0;i<x.presetCategories.length;i++){const s=x.presetCategories[i];if("Novelty Presets"!=s.name)for(let n=0;n<s.presets.length;n++){const o=s.presets[n];null!=o.settings&&1==o.isNoise==t&&e.push((i<<6)+n)}}return e[Math.random()*e.length|0]}function Ue(t){for(let e=0;e<t.channels.length;e++)for(const i of t.channels[e].instruments){const s=t.getChannelIsNoise(e),n=e==t.pitchChannelCount?x.nameToPresetValue(Math.random()>.5?"chip noise":"standard drumset"):_e(s),o=x.valueToPreset(n);i.fromJsonObject(o.settings,s,1),i.preset=n,i.volume=1}}class Ve extends Tt{constructor(t,e){if(super(),t.song.fromBase64String(e),""==e){this.append(new ai(t,0,0)),t.selection.resetBoxSelection(),Ue(t.song),t.song.scale=t.defaultScale;for(let e=0;e<=t.song.channels.length;e++)t.viewedInstrument[e]=0,t.recentPatternInstruments[e]=[0];t.viewedInstrument.length=t.song.channels.length}else this.append(new We(t));t.notifier.changed(),this.K()}}class We extends It{constructor(t){super();const e=Math.min(t.channel,t.song.getChannelCount()-1),i=Math.max(0,Math.min(t.song.barCount-1,t.bar)),s=Math.min(t.bar,Math.max(t.bar-(t.trackVisibleBars-1),Math.max(0,Math.min(t.song.barCount-t.trackVisibleBars,t.barScrollPos)))),n=Math.min(t.channel,Math.max(t.channel-(t.trackVisibleChannels-1),Math.max(0,Math.min(t.song.getChannelCount()-t.trackVisibleChannels,t.channelScrollPos))));t.channel==e&&t.bar==i&&t.channelScrollPos==n&&t.barScrollPos==s||(t.channel=e,t.channel=n,t.bar=i,t.barScrollPos=s,t.notifier.changed(),this.K())}}class je extends Tt{constructor(t,i,s){super();const n=t.song;function o(t,e){for(;t.length>e;){let e=t.length-1,i=0;for(let s=0;s<t.length-1;s++){let n=0;for(const e of t[s].bars)0==e&&n++;n>=i&&(e=s,i=n)}t.splice(e,1)}}for(o(i,e.pitchChannelCountMax),o(s,e.noiseChannelCountMax);i.length<e.pitchChannelCountMin;)i.push(new mt);for(;s.length<e.noiseChannelCountMin;)s.push(new mt);n.barCount=1,n.patternsPerChannel=8;const r=i.concat(s);for(let t=0;t<r.length;t++){const e=r[t];n.barCount=Math.max(n.barCount,e.bars.length),n.patternsPerChannel=Math.max(n.patternsPerChannel,e.patterns.length),n.channels[t]=e}n.channels.length=r.length,n.pitchChannelCount=i.length,n.noiseChannelCount=s.length,n.barCount=Math.min(e.barCountMax,n.barCount),n.patternsPerChannel=Math.min(e.barCountMax,n.patternsPerChannel);for(let t=0;t<n.channels.length;t++){const e=n.channels[t];for(let t=0;t<e.bars.length;t++)(e.bars[t]>n.patternsPerChannel||e.bars[t]<0)&&(e.bars[t]=0);for(;e.bars.length<n.barCount;)e.bars.push(0);e.bars.length=n.barCount,e.instruments.length>n.getMaxInstrumentsPerChannel()&&(e.instruments.length=n.getMaxInstrumentsPerChannel());for(const i of e.patterns)Dt(i.instruments,n,t);for(;e.patterns.length<n.patternsPerChannel;)e.patterns.push(new ht);e.patterns.length=n.patternsPerChannel}n.loopStart=Math.max(0,Math.min(n.barCount-1,n.loopStart)),n.loopLength=Math.min(n.barCount-n.loopStart,n.loopLength),this.append(new We(t)),t.notifier.changed(),this.K()}}function Je(t,e){if(t.length!=e.length)return!1;for(let i=0;i<t.length;i++){const s=t[i],n=e[i];if(n.start!=s.start||n.end!=s.end||n.pitches.length!=s.pitches.length||n.pins.length!=s.pins.length)return!1;for(let t=0;t<s.pitches.length;t++)if(n.pitches[t]!=s.pitches[t])return!1;for(let t=0;t<s.pins.length;t++)if(n.pins[t].interval!=s.pins[t].interval||n.pins[t].time!=s.pins[t].time||n.pins[t].size!=s.pins[t].size)return!1}return!0}function Ye(t){for(const e of t){const t=[];for(let i=0;i<e.bars.length;i++){if(0==e.bars[i])continue;const s=e.patterns[e.bars[i]-1];let n=!1;for(let o=0;o<t.length;o++){const r=t[o];if(Lt(s.instruments,r.instruments)&&r.notes.length==s.notes.length&&Je(s.notes,r.notes)){n=!0,e.bars[i]=o+1;break}}n||(t.push(s),e.bars[i]=t.length)}for(let i=0;i<t.length;i++)e.patterns[i]=t[i];e.patterns.length=t.length}}class Ke extends It{constructor(t,i,s){super(),t.song.tempo=Math.max(e.tempoMin,Math.min(e.tempoMax,Math.round(s))),t.notifier.changed(),i!=s&&this.K()}}class Qe extends oe{constructor(t,e,i){super(t),this.bt.echoDelay=i,t.notifier.changed(),e!=i&&this.K()}}class Ze extends oe{constructor(t,e,i){super(t),this.bt.echoSustain=i,t.notifier.changed(),e!=i&&this.K()}}class Xe extends oe{constructor(t,e,i){super(t),this.bt.chorus=i,t.notifier.changed(),e!=i&&this.K()}}class ti extends oe{constructor(t,e,i){super(t),this.bt.reverb=i,t.notifier.changed(),e!=i&&this.K()}}class ei extends qt{constructor(t,e,i,s,n=!1){super(n),this.W=t,this.Ut=e,this.nt=i,this.q=s,this.K(),this.redo()}tt(){this.Ut.notes.splice(this.q,0,this.nt),this.W.notifier.changed()}et(){this.Ut.notes.splice(this.q,1),this.W.notifier.changed()}}class ii extends Bt{constructor(t,e,i,s){super(t,e);const n=(this.ot<0||e.continuesLastPattern)&&0==i;i-=this.ot,s-=this.ot;let o,r=!1,h=this.lt[0].size,a=this.lt[0].interval,l=!0;for(o=0;o<this.lt.length;o++){const t=this.lt[o];if(t.time<i)h=t.size,a=t.interval;else{if(t.time>i&&!r&&(this.ct.push(st(a,i,h)),r=!0),!(t.time<=s))break;if(this.ct.push(st(t.interval,t.time,t.size)),t.time==s){l=!1;break}}}l&&this.ct.push(st(this.lt[o].interval,s,this.lt[o].size)),this.gt(n)}}class si extends Ct{constructor(t,e,i,s,n){super();let o=0;for(;o<e.notes.length;){const r=e.notes[o];if(r==n&&null!=n)o++;else if(r.end<=i)o++;else{if(r.start>=s)break;if(r.start<i&&r.end>s){const n=r.clone();this.append(new ii(t,r,r.start,i)),o++,this.append(new ei(t,e,n,o,!1)),this.append(new ii(t,n,s,n.end)),o++}else r.start<i?(this.append(new ii(t,r,r.start,i)),o++):r.end>s?(this.append(new ii(t,r,s,r.end)),o++):this.append(new ei(t,e,r,o,!0))}}}}class ni extends Ct{constructor(t,e){super();let i=0;for(;i<e.notes.length;){const s=e.notes[i];if(s.start<t.selection.patternSelectionStart&&t.selection.patternSelectionStart<s.end){const n=s.clone();this.append(new ii(t,s,s.start,t.selection.patternSelectionStart)),i++,this.append(new ei(t,e,n,i,!1)),this.append(new ii(t,n,t.selection.patternSelectionStart,n.end))}else if(s.start<t.selection.patternSelectionEnd&&t.selection.patternSelectionEnd<s.end){const n=s.clone();this.append(new ii(t,s,s.start,t.selection.patternSelectionEnd)),i++,this.append(new ei(t,e,n,i,!1)),this.append(new ii(t,n,t.selection.patternSelectionEnd,n.end)),i++}else i++}}}class oi extends qt{constructor(t,i,s,n,o=!1,r=!1){super(!1),this.W=t,this.nt=s,this.lt=s.pins,this.ct=[],this.ut=s.pitches,this.ft=[];const h=t.song.getChannelIsNoise(i);if(h!=t.song.getChannelIsNoise(t.channel))return;const a=h?e.drumCount-1:e.maxPitch;for(let i=0;i<this.ut.length;i++){let s=this.ut[i];if(r&&!h)s=n?Math.min(a,s+12):Math.max(0,s-12);else if(n){for(let i=s+1;i<=a;i++)if(h||o||e.scales[t.song.scale].flags[i%12]){s=i;break}}else for(let i=s-1;i>=0;i--)if(h||o||e.scales[t.song.scale].flags[i%12]){s=i;break}let l=!1;for(let t=0;t<this.ft.length;t++)if(this.ft[t]==s){l=!0;break}l||this.ft.push(s)}let l=0,c=a;for(let t=1;t<this.ft.length;t++){const e=this.ft[0]-this.ft[t];l<e&&(l=e),c>e+a&&(c=e+a)}for(const i of this.lt){let s=i.interval+this.ut[0];if(s<l&&(s=l),s>c&&(s=c),r&&!h)s=n?Math.min(c,s+12):Math.max(l,s-12);else if(n){for(let i=s+1;i<=c;i++)if(h||o||e.scales[t.song.scale].flags[i%12]){s=i;break}}else for(let i=s-1;i>=l;i--)if(h||o||e.scales[t.song.scale].flags[i%12]){s=i;break}s-=this.ft[0],this.ct.push(st(s,i.time,i.size))}if(0!=this.ct[0].interval)throw new Error("wrong pin start interval");for(let t=1;t<this.ct.length-1;)this.ct[t-1].interval==this.ct[t].interval&&this.ct[t].interval==this.ct[t+1].interval&&this.ct[t-1].size==this.ct[t].size&&this.ct[t].size==this.ct[t+1].size?this.ct.splice(t,1):t++;this.tt(),this.K()}tt(){this.nt.pins=this.ct,this.nt.pitches=this.ft,this.W.notifier.changed()}et(){this.nt.pins=this.lt,this.nt.pitches=this.ut,this.W.notifier.changed()}}class ri extends Ct{constructor(t,e,i,s,n=!1,o=!1){super(),t.selection.patternSelectionActive&&this.append(new ni(t,i));for(const r of i.notes)t.selection.patternSelectionActive&&(r.end<=t.selection.patternSelectionStart||r.start>=t.selection.patternSelectionEnd)||this.append(new oi(t,e,r,s,n,o))}}class hi extends It{constructor(t,e,i,s,n){super(),t.selection.boxSelectionX0=e,t.selection.boxSelectionX1=i,t.selection.boxSelectionY0=s,t.selection.boxSelectionY1=n,t.notifier.changed(),this.K()}}class ai extends qt{constructor(t,e,i){super(!1),this.W=t,this.ot=t.selection.patternSelectionStart,this.rt=t.selection.patternSelectionEnd,this.Vt=t.selection.patternSelectionActive,this.ht=e,this.at=i,this.Wt=e<i,this.tt(),this.K()}tt(){this.W.selection.patternSelectionStart=this.ht,this.W.selection.patternSelectionEnd=this.at,this.W.selection.patternSelectionActive=this.Wt,this.W.notifier.changed()}et(){this.W.selection.patternSelectionStart=this.ot,this.W.selection.patternSelectionEnd=this.rt,this.W.selection.patternSelectionActive=this.Vt,this.W.notifier.changed()}}class li extends Ct{constructor(t,i,s,n,o){if(super(),0==n&&0==o)return;t.selection.patternSelectionActive&&this.append(new ni(t,s));const r=t.selection.patternSelectionStart,h=t.selection.patternSelectionEnd,a=Math.max(0,Math.min(t.song.beatsPerBar*e.partsPerBeat,r+n)),l=Math.max(0,Math.min(t.song.beatsPerBar*e.partsPerBeat,h+n));a==l?this.append(new si(t,s,r,h)):n<0?this.append(new si(t,s,a,Math.min(r,l))):this.append(new si(t,s,Math.max(h,a),l)),this.append(new ai(t,a,l));const c=[];let u=0,f=0;for(;f<s.notes.length;){const e=s.notes[f];e.end<=r||e.start>=h?(f++,e.end<=a&&(u=f)):(c.push(e.clone()),this.append(new ei(t,s,e,f,!0)))}for(const e of c)if(e.start+=n,e.end+=n,!(e.end<=a||e.start>=l)){this.append(new ei(t,s,e,u++,!1)),this.append(new ii(t,e,Math.max(e.start,a),Math.min(l,e.end)));for(let s=0;s<Math.abs(o);s++)this.append(new oi(t,i,e,o>0,t.notesOutsideScale))}}}class ci extends Tt{constructor(t,i,s,n,o){super();for(let r=n;r<n+o;r++){const n={};for(let o=i;o<i+s;o++){const h=t.song.channels[r].bars[o];if(0!=h){if(null==n[String(h)]){let a=!1;for(let e=0;e<t.song.barCount;e++)if((e<i||e>=i+s)&&t.song.channels[r].bars[e]==h){a=!0;break}if(a){const i=t.song.getPattern(r,o);this.append(new Ut(t,0,o,r,1,1)),this.append(new ze(t,r,o));const s=t.song.getPattern(r,o);if(null==s)throw new Error;this.append(new Te(t,s,i.notes,0,e.partsPerBeat*t.song.beatsPerBar,e.partsPerBeat*t.song.beatsPerBar)),s.instruments.length=0,s.instruments.push(...i.instruments),n[String(h)]=t.song.channels[r].bars[o]}else n[String(h)]=h}this.append(new Ut(t,n[String(h)],o,r,1,1))}}}}}class ui extends It{constructor(t,i,s){super(),t.selection.patternSelectionActive&&new ni(t,i);const n=e.maxPitch;for(const e of i.notes){if(t.selection.patternSelectionActive&&(e.end<=t.selection.patternSelectionStart||e.start>=t.selection.patternSelectionEnd))continue;const i=[],o=[];for(let t=0;t<e.pitches.length;t++){const n=e.pitches[t],o=s[n%12]+(n-n%12);-1==i.indexOf(o)&&i.push(o)}let r=0,h=n;for(let t=1;t<i.length;t++){const e=i[0]-i[t];r<e&&(r=e),h>e+n&&(h=e+n)}for(const t of e.pins){let n=t.interval+e.pitches[0];n<r&&(n=r),n>h&&(n=h);const a=s[n%12]+(n-n%12);o.push(st(a-i[0],t.time,t.size))}if(0!=o[0].interval)throw new Error("wrong pin start interval");for(let t=1;t<o.length-1;)o[t-1].interval==o[t].interval&&o[t].interval==o[t+1].interval&&o[t-1].size==o[t].size&&o[t].size==o[t+1].size?o.splice(t,1):t++;e.pitches=i,e.pins=o}this.K(),t.notifier.changed()}}class fi extends It{constructor(t,e,i){super(),t.song.channels[t.channel].instruments[t.getCurrentInstrument()].volume=i,t.notifier.changed(),e!=i&&this.K()}}class pi extends It{constructor(t,e,i){super(),t.song.channels[t.channel].instruments[t.getCurrentInstrument()].pan=i,t.notifier.changed(),e!=i&&this.K()}}class di extends qt{constructor(t,e,i,s,n,o){super(!1),this.W=t,this.nt=e,this.lt=e.pins,this.ct=[];let r=!1;for(const t of e.pins)t.time<i?o?this.ct.push(st(t.interval,t.time,s)):this.ct.push(t):t.time==i?(this.ct.push(st(n,i,s)),r=!0):(o||r||(this.ct.push(st(n,i,s)),r=!0),o?this.ct.push(st(t.interval,t.time,s)):this.ct.push(t));At(this.ct),this.tt(),this.K()}tt(){this.nt.pins=this.ct,this.W.notifier.changed()}et(){this.nt.pins=this.lt,this.W.notifier.changed()}}class mi extends It{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.chipWave!=e&&(i.chipWave=e,i.preset=i.type,t.notifier.changed(),this.K())}}class yi extends It{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.chipNoise!=e&&(i.chipNoise=e,i.preset=i.type,t.notifier.changed(),this.K())}}class gi extends It{constructor(t){super();const e=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];e.addEnvelope(0,0,0),e.preset=e.type,t.notifier.changed(),this.K()}}class bi extends It{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.envelopeCount--;for(let t=e;t<i.envelopeCount;t++)i.envelopes[t].target=i.envelopes[t+1].target,i.envelopes[t].index=i.envelopes[t+1].index,i.envelopes[t].envelope=i.envelopes[t+1].envelope;i.preset=i.type,t.notifier.changed(),this.K()}}class vi extends It{constructor(t,e,i,s){super();const n=t.song.channels[t.channel].instruments[t.getCurrentInstrument()],o=n.envelopes[e].target,r=n.envelopes[e].index;o==i&&r==s||(n.envelopes[e].target=i,n.envelopes[e].index=s,n.preset=n.type,t.notifier.changed(),this.K())}}class wi extends It{constructor(t,e,i){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.envelopes[e].envelope!=i&&(s.envelopes[e].envelope=i,s.preset=s.type,t.notifier.changed(),this.K())}}class ki{constructor(){this.valid=!1,this.prevNote=null,this.curNote=null,this.nextNote=null,this.pitch=0,this.pitchIndex=-1,this.curIndex=0,this.start=0,this.end=0,this.part=0,this.exactPart=0,this.nearPinIndex=0,this.pins=[]}}class Mi{constructor(t,i,s){this.W=t,this.jt=i,this.Jt=s,this.Yt=A.pattern({id:"patternEditorNoteBackground"+this.Jt,x:"0",y:"0",patternUnits:"userSpaceOnUse"}),this.Kt=A.pattern({id:"patternEditorDrumBackground"+this.Jt,x:"0",y:"0",patternUnits:"userSpaceOnUse"}),this.Qt=A.rect({x:"0",y:"0","pointer-events":"none",fill:"url(#patternEditorNoteBackground"+this.Jt+")"}),this.Zt=A.svg(),this.Xt=A.rect({x:"0",y:"0",width:"4",fill:$.playhead,"pointer-events":"none"}),this.te=A.rect({fill:$.boxSelectionFill,stroke:$.hoverPreview,"stroke-width":2,"stroke-dasharray":"5, 3","pointer-events":"none",visibility:"hidden"}),this.ee=A.path({fill:"none",stroke:$.hoverPreview,"stroke-width":"2","pointer-events":"none"}),this.ie=A.svg({style:`background-color: ${$.editorBackground}; touch-action: none; position: absolute;`,width:"100%",height:"100%"},A.defs(this.Yt,this.Kt),this.Qt,this.te,this.Zt,this.ee,this.Xt),this.container=z.div({style:"height: 100%; overflow:hidden; position: relative; flex-grow: 1;"},this.ie),this.se=[],this.ne=A.rect(),this.oe=-1,this.re=0,this.he=0,this.ae=!1,this.le=!1,this.ce=!1,this.ue=!1,this.fe=!1,this.pe=[],this.de=0,this.me=0,this.ye=!1,this.ge=!1,this.be=0,this.ve=!1,this.we=!1,this.ke=!1,this.Me=0,this.xe=0,this.Se=0,this.Pe=!1,this.Fe=null,this.Ee=null,this.Ie=!1,this.qe=new ki,this.Ut=null,this.Te=0,this.Ce=0,this.Le=-1,this.De=-1,this.ze=-1,this.Ae=-1,this.Re=!1,this.Oe=!1,this.Be=-1,this.Ne=-1,this.He=-1,this.Ge=-1,this.resetCopiedPins=()=>{const t=this.$e();this.pe.length=this.W.song.getChannelCount();for(let i=0;i<this.W.song.pitchChannelCount;i++)this.pe[i]=[st(0,0,e.noteSizeMax),st(0,t,e.noteSizeMax)];for(let i=this.W.song.pitchChannelCount;i<this.W.song.getChannelCount();i++)this.pe[i]=[st(0,0,e.noteSizeMax),st(0,t,0)]},this._e=t=>{this.fe&&!this.ge&&!this.ce&&this.ae&&performance.now()>this.be+1e3&&this.qe.valid&&this.W.lastChangeWas(this.Fe)&&(this.Fe.undo(),this.ge=!0,this.Ue(),this.W.notifier.notifyWatchers());const e=Math.floor(this.W.synth.playhead);if(this.W.synth.playing&&(null!=this.Ut&&this.W.song.getPattern(this.W.channel,Math.floor(this.W.synth.playhead))==this.Ut||Math.floor(this.W.synth.playhead)==this.W.bar+this.Jt)){this.Xt.setAttribute("visibility","visible");const t=this.W.synth.playhead-e;Math.abs(t-this.Te)>.1?this.Te=t:this.Te+=.2*(t-this.Te),this.Xt.setAttribute("x",""+M(this.Te*this.Ve-2))}else this.Xt.setAttribute("visibility","hidden");this.W.synth.playing&&this.W.autoFollow&&this.Ge!=e&&(new Zt(this.W,this.W.channel,e),this.W.notifier.notifyWatchers()),this.Ge=e,window.requestAnimationFrame(this._e)},this.We=t=>{this.le||(this.le=!0,this.fe=!1)},this.je=t=>{this.le&&(this.le=!1)},this.Je=t=>{t.preventDefault();const e=this.ie.getBoundingClientRect();this.re=((t.clientX||t.pageX)-e.left)*this.Ve/(e.right-e.left),this.he=((t.clientY||t.pageY)-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.fe=!1,this.ye=t.ctrlKey||t.metaKey,this.ge=t.shiftKey,this.Ue()},this.Ke=t=>{t.preventDefault();const e=this.ie.getBoundingClientRect();this.re=(t.touches[0].clientX-e.left)*this.Ve/(e.right-e.left),this.he=(t.touches[0].clientY-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.fe=!0,this.ye=t.ctrlKey||t.metaKey,this.ge=t.shiftKey,this.be=performance.now(),this.Ue()},this.Qe=t=>{const e=this.ie.getBoundingClientRect();this.re=((t.clientX||t.pageX)-e.left)*this.Ve/(e.right-e.left),this.he=((t.clientY||t.pageY)-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.fe=!1,this.Ze()},this.Xe=t=>{if(!this.ae)return;t.preventDefault();const e=this.ie.getBoundingClientRect();this.re=(t.touches[0].clientX-e.left)*this.Ve/(e.right-e.left),this.he=(t.touches[0].clientY-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.Ze()},this.ti=t=>{if(!this.qe.valid)return;const i=this.W.lastChangeWas(this.Fe);if(this.ae&&i&&null!=this.Fe)if(this.ke)this.W.record(this.Fe),this.Fe=null;else if(this.ve||this.we||this.ge)this.ei(this.Fe),this.Fe=null;else if(this.ce||null==this.qe.curNote||!this.Fe.isNoop()||this.ve||this.we||this.ke||this.ge)this.W.record(this.Fe),this.Fe=null;else{if(null==this.Ut)throw new Error;const t=new Ct;if(t.append(new ai(this.W,0,0)),-1==this.qe.pitchIndex){if(this.qe.curNote.pitches.length==e.maxChordSize&&t.append(new Ee(this.W,this.qe.curNote,this.qe.curNote.pitches[0],0,!0)),t.append(new Ee(this.W,this.qe.curNote,this.qe.pitch,this.qe.curNote.pitches.length)),this.ii(this.qe.curNote),this.W.enableNotePreview&&!this.W.synth.playing){const t=Math.min(e.partsPerBeat,this.qe.end-this.qe.start);this.W.synth.liveInputDuration=t,this.W.synth.liveInputPitches=this.qe.curNote.pitches.concat(),this.W.synth.liveInputStarted=!0}}else 1==this.qe.curNote.pitches.length?t.append(new ei(this.W,this.Ut,this.qe.curNote,this.qe.curIndex,!0)):t.append(new Ee(this.W,this.qe.curNote,this.qe.pitch,this.qe.curNote.pitches.indexOf(this.qe.pitch),!0));this.W.record(t)}this.ae=!1,this.ce=!1,this.ve=!1,this.we=!1,this.ke=!1,this.Ie=!1,this.si(),this.ni()};for(let t=0;t<e.pitchesPerOctave;t++){const e=A.rect();e.setAttribute("x","1"),e.setAttribute("fill",0==t?$.tonic:$.pitchBackground),this.Yt.appendChild(e),this.se[t]=e}this.ne.setAttribute("x","1"),this.ne.setAttribute("y","1"),this.ne.setAttribute("fill",$.pitchBackground),this.Kt.appendChild(this.ne),this.jt?(this.si(),this.ni(),window.requestAnimationFrame(this._e),this.ie.addEventListener("mousedown",this.Je),document.addEventListener("mousemove",this.Qe),document.addEventListener("mouseup",this.ti),this.ie.addEventListener("mouseover",this.We),this.ie.addEventListener("mouseout",this.je),this.ie.addEventListener("touchstart",this.Ke),this.ie.addEventListener("touchmove",this.Xe),this.ie.addEventListener("touchend",this.ti),this.ie.addEventListener("touchcancel",this.ti)):(this.Xt.style.display="none",this.ie.appendChild(A.rect({x:0,y:0,width:1e4,height:1e4,fill:$.editorBackground,style:"opacity: 0.5;"}))),this.resetCopiedPins()}$e(){const t=e.rhythms[this.W.song.rhythm].stepsPerBeat;return t%4==0?e.partsPerBeat/2:t%3==0?e.partsPerBeat/3:t%2==0?e.partsPerBeat/2:e.partsPerBeat}oi(){return e.partsPerBeat/e.rhythms[this.W.song.rhythm].stepsPerBeat}ri(t){const e=this.oi();return Math.floor(t/e)*e}si(){if(this.qe=new ki,this.re<0||this.re>this.Ve||this.he<0||this.he>this.Ye||this.oe<=0)return;const t=this.oi();if(this.qe.exactPart=this.re/this.hi,this.qe.part=Math.floor(Math.max(0,Math.min(this.W.song.beatsPerBar*e.partsPerBeat-t,this.qe.exactPart))/t)*t,null!=this.Ut)for(const t of this.Ut.notes)if(t.end<=this.qe.exactPart)this.qe.prevNote=t,this.qe.curIndex++;else if(t.start<=this.qe.exactPart&&t.end>this.qe.exactPart)this.qe.curNote=t;else if(t.start>this.qe.exactPart){this.qe.nextNote=t;break}let i=this.ai(this.he);if(null!=this.qe.curNote){this.qe.start=this.qe.curNote.start,this.qe.end=this.qe.curNote.end,this.qe.pins=this.qe.curNote.pins;let t,s=0,n=0,o=this.qe.curNote.pins[0];for(let e=1;e<this.qe.curNote.pins.length;e++){t=o,o=this.qe.curNote.pins[e];const i=this.hi*(this.qe.curNote.start+t.time),r=this.hi*(this.qe.curNote.start+o.time);if(this.re>r)continue;if(this.re<i)throw new Error;const h=(this.re-i)/(r-i),a=Math.sqrt(1/Math.sqrt(4)-Math.pow(h-.5,2))-.5,l=Math.abs(o.interval-t.interval);s=t.interval*(1-h)+o.interval*h,n=a*l+.95;break}let r=Number.MAX_VALUE,h=-Number.MAX_VALUE,a=Number.MAX_VALUE;for(const t of this.qe.curNote.pins){r>t.interval&&(r=t.interval),h<t.interval&&(h=t.interval);const e=Math.abs(this.qe.curNote.start+t.time-this.re/this.hi);a>e&&(a=e,this.qe.nearPinIndex=this.qe.curNote.pins.indexOf(t))}if(i-=s,this.qe.pitch=this.li(i,-r,(this.W.song.getChannelIsNoise(this.W.channel)?e.drumCount-1:e.maxPitch)-h),!this.W.song.getChannelIsNoise(this.W.channel)){let t=n;for(let e=0;e<this.qe.curNote.pitches.length;e++){const s=Math.abs(this.qe.curNote.pitches[e]-i+.5);s>t||(t=s,this.qe.pitch=this.qe.curNote.pitches[e])}}for(let t=0;t<this.qe.curNote.pitches.length;t++)if(this.qe.curNote.pitches[t]==this.qe.pitch){this.qe.pitchIndex=t;break}}else{this.qe.pitch=this.li(i,0,e.maxPitch);const t=this.ci[this.ci.length-1].time,s=Math.floor(this.qe.part/e.partsPerBeat),n=this.$e(),o=this.qe.part%e.partsPerBeat;if(1==t)this.qe.start=this.qe.part;else if(t>e.partsPerBeat)this.qe.start=s*e.partsPerBeat;else if(t==e.partsPerBeat)this.qe.start=s*e.partsPerBeat,n<e.partsPerBeat&&o>n&&(this.qe.start+=Math.floor(o/n)*n);else{this.qe.start=s*e.partsPerBeat;let i=e.partsPerBeat%t==0?t:Math.min(t,n);for(;i<n&&e.partsPerBeat%i!=0;)i++;this.qe.start+=Math.floor(o/i)*i}this.qe.end=this.qe.start+t;let r=0,h=this.W.song.beatsPerBar*e.partsPerBeat;if(null!=this.qe.prevNote&&(r=this.qe.prevNote.end),null!=this.qe.nextNote&&(h=this.qe.nextNote.start),this.qe.start<r?(this.qe.start=r,this.qe.end=this.qe.start+t,this.qe.end>h&&(this.qe.end=h)):this.qe.end>h&&(this.qe.end=h,this.qe.start=this.qe.end-t,this.qe.start<r&&(this.qe.start=r)),this.qe.end-this.qe.start==t)this.qe.pins=this.ci;else{this.qe.pins=[];for(const t of this.ci){if(!(t.time<=this.qe.end-this.qe.start)){this.qe.pins.push(st(0,this.qe.end-this.qe.start,t.size));break}if(this.qe.pins.push(st(0,t.time,t.size)),t.time==this.qe.end-this.qe.start)break}}}this.qe.valid=!0}ui(){return this.qe.valid&&this.W.selection.patternSelectionActive&&this.W.selection.patternSelectionStart<=this.qe.exactPart&&this.qe.exactPart<=this.W.selection.patternSelectionEnd}fi(){return this.qe.valid&&this.W.selection.patternSelectionActive&&-1==this.qe.pitchIndex&&this.W.selection.patternSelectionStart-3<=this.qe.exactPart&&this.qe.exactPart<=this.W.selection.patternSelectionStart+1.25}pi(){return this.qe.valid&&this.W.selection.patternSelectionActive&&-1==this.qe.pitchIndex&&this.W.selection.patternSelectionEnd-1.25<=this.qe.exactPart&&this.qe.exactPart<=this.W.selection.patternSelectionEnd+3}ai(t){return Math.max(0,Math.min(this.di-1,this.di-t/this.oe))+this.Ce}li(t,i,s){t<i&&(t=i),t>s&&(t=s);const n=this.W.notesOutsideScale?e.scales.dictionary.expert.flags:e.scales[this.W.song.scale].flags;if(n[Math.floor(t)%e.pitchesPerOctave]||this.W.song.getChannelIsNoise(this.W.channel))return Math.floor(t);{let o=Math.floor(t)+1,r=Math.floor(t)-1;for(;!n[o%e.pitchesPerOctave];)o++;for(;!n[r%e.pitchesPerOctave];)r--;if(o>s)return r<i?i:r;if(r<i)return o;let h=o,a=r+1;return o%e.pitchesPerOctave!=0&&o%e.pitchesPerOctave!=7||(h-=.5),r%e.pitchesPerOctave!=0&&r%e.pitchesPerOctave!=7||(a+=.5),t-a>h-t?o:r}}ii(t){this.ci=[];for(const e of t.pins)this.ci.push(st(0,e.time,e.size));for(let t=1;t<this.ci.length-1;)this.ci[t-1].size==this.ci[t].size&&this.ci[t].size==this.ci[t+1].size?this.ci.splice(t,1):t++;this.pe[this.W.channel]=this.ci}movePlayheadToMouse(){return!!this.le&&(this.W.synth.playhead=this.W.bar+this.Jt+this.re/this.Ve,!0)}Ue(){this.W.enableNotePreview&&this.W.synth.maintainLiveInput(),this.ae=!0,this.de=this.re,this.me=this.he,this.si(),this.ni();const t=new Ct;if(this.Fe=t,this.Ie=this.W.lastChangeWas(this.Ee),this.W.setProspectiveChange(this.Fe),this.fi())this.ve=!0;else if(this.pi())this.we=!0;else if(this.ge)if(this.W.selection.patternSelectionActive&&-1==this.qe.pitchIndex||this.ui())t.append(new ai(this.W,0,0));else if(null!=this.qe.curNote)t.append(new ai(this.W,this.qe.curNote.start,this.qe.curNote.end));else{const i=Math.max(0,Math.min((this.W.song.beatsPerBar-1)*e.partsPerBeat,Math.floor(this.qe.exactPart/e.partsPerBeat)*e.partsPerBeat)),s=i+e.partsPerBeat;t.append(new ai(this.W,i,s))}else if(this.ui())this.ke=!0;else if(this.qe.valid&&null==this.qe.curNote){t.append(new ai(this.W,0,0));const i=new rt(this.qe.pitch,this.qe.start,this.qe.end,e.noteSizeMax,this.W.song.getChannelIsNoise(this.W.channel));i.pins=[];for(const t of this.qe.pins)i.pins.push(st(0,t.time,t.size));t.append(new ze(this.W,this.W.channel,this.W.bar));const s=this.W.getCurrentPattern(this.Jt);if(null==s)throw new Error;if(t.append(new ei(this.W,s,i,this.qe.curIndex)),this.W.enableNotePreview&&!this.W.synth.playing){const t=Math.min(e.partsPerBeat,this.qe.end-this.qe.start);this.W.synth.liveInputDuration=t,this.W.synth.liveInputPitches=[this.qe.pitch],this.W.synth.liveInputStarted=!0}}this.mi()}Ze(){this.W.enableNotePreview&&this.le&&this.W.synth.maintainLiveInput();const t=this.W.lastChangeWas(this.Fe);if(!this.ce&&this.ae&&this.qe.valid&&t){const t=this.re-this.de,e=this.he-this.me;Math.sqrt(t*t+e*e)>5&&(this.ce=!0,this.ue=Math.abs(t)>=Math.abs(e))}if(this.ce&&this.ae&&this.qe.valid&&t){this.Fe.undo();const t=new Ct;this.Fe=t,this.W.setProspectiveChange(this.Fe);const i=this.oi(),s=this.ri(this.re/this.hi);if(this.ve)t.append(new ai(this.W,Math.max(0,Math.min(this.W.song.beatsPerBar*e.partsPerBeat,s)),this.W.selection.patternSelectionEnd)),this.mi();else if(this.we)t.append(new ai(this.W,this.W.selection.patternSelectionStart,Math.max(0,Math.min(this.W.song.beatsPerBar*e.partsPerBeat,s)))),this.mi();else if(this.ke){const t=this.W.getCurrentPattern(this.Jt);if(this.ce&&null!=t){this.Fe.undo();const s=new Ct;this.Fe=s,this.W.setProspectiveChange(this.Fe);const n=e.scales[this.W.song.scale].flags.filter((t=>t)).length,o=this.W.song.getChannelIsNoise(this.W.channel)?1:12/n,r=Math.round((this.re-this.de)/(this.hi*i))*i,h=Math.round((this.me-this.he)/(this.oe*o));s.append(new li(this.W,this.W.channel,t,r,h))}}else if(this.ge){if(this.ce){let i=Math.max(0,Math.min((this.W.song.beatsPerBar-1)*e.partsPerBeat,Math.floor(this.qe.exactPart/e.partsPerBeat)*e.partsPerBeat)),n=i+e.partsPerBeat;if(null!=this.qe.curNote&&(i=Math.max(i,this.qe.curNote.start),n=Math.min(n,this.qe.curNote.end)),s<i){i=0;const t=this.W.getCurrentPattern(this.Jt);if(null!=t)for(let e=0;e<t.notes.length;e++)t.notes[e].start<=s&&(i=t.notes[e].start),t.notes[e].end<=s&&(i=t.notes[e].end);for(let t=0;t<=this.W.song.beatsPerBar;t++){const n=t*e.partsPerBeat;i<=n&&n<=s&&(i=n)}}if(s>n){n=e.partsPerBeat*this.W.song.beatsPerBar;const t=this.W.getCurrentPattern(this.Jt);if(null!=t)for(let e=0;e<t.notes.length;e++){if(t.notes[e].start>=s){n=t.notes[e].start;break}if(t.notes[e].end>=s){n=t.notes[e].end;break}}for(let t=0;t<=this.W.song.beatsPerBar;t++){const i=t*e.partsPerBeat;s<i&&i<n&&(n=i)}}t.append(new ai(this.W,i,n)),this.mi()}}else if(null==this.qe.curNote){let n,o;t.append(new ai(this.W,0,0)),s<this.qe.start?(n=!0,o=this.qe.start-s):(n=!1,o=s-this.qe.start+i);let r,h,a=i;for(let t=i;t<=this.W.song.beatsPerBar*e.partsPerBeat;t+=i){if(1==i){if(t<5);else if(t<=e.partsPerBeat/2){if(t%3!=0&&t%4!=0)continue}else if(t<=1.5*e.partsPerBeat){if(t%6!=0&&t%8!=0)continue}else if(t%e.partsPerBeat!=0)continue}else if(t>=5*i&&t%e.partsPerBeat!=0&&t!=3*e.partsPerBeat/4&&t!=3*e.partsPerBeat/2&&t!=4*e.partsPerBeat/3)continue;const s=t;if(s==o){a=s;break}if(s<o&&(a=s),s>o){a<o-i&&(a=s);break}}n?(h=this.qe.start,r=h-a):(r=this.qe.start,h=r+a);const l=r<0;if(r<0&&(r=0),h>this.W.song.beatsPerBar*e.partsPerBeat&&(h=this.W.song.beatsPerBar*e.partsPerBeat),r<h){t.append(new ze(this.W,this.W.channel,this.W.bar));const i=this.W.getCurrentPattern(this.Jt);if(null==i)throw new Error;let s;for(t.append(new si(this.W,i,r,h)),s=0;s<i.notes.length&&!(i.notes[s].start>=h);s++);const o=new rt(this.qe.pitch,r,h,e.noteSizeMax,this.W.song.getChannelIsNoise(this.W.channel));o.continuesLastPattern=l,t.append(new ei(this.W,i,o,s)),this.ii(o),this.Me=n?r:h,this.xe=this.qe.pitch,this.Se=o.pins[n?0:1].size,this.Pe=!0}this.Ut=this.W.getCurrentPattern(this.Jt)}else if(this.ue){t.append(new ai(this.W,0,0));const s=(this.re-this.de)/this.hi,n=this.qe.curNote.pins[this.qe.nearPinIndex];let o=Math.round((this.qe.curNote.start+n.time+s)/i)*i;const r=o<0;if(o<0&&(o=0),o>this.W.song.beatsPerBar*e.partsPerBeat&&(o=this.W.song.beatsPerBar*e.partsPerBeat),null==this.Ut)throw new Error;if(o<=this.qe.curNote.start&&this.qe.nearPinIndex==this.qe.curNote.pins.length-1||o>=this.qe.curNote.end&&0==this.qe.nearPinIndex)t.append(new ei(this.W,this.Ut,this.qe.curNote,this.qe.curIndex,!0)),this.Pe=!1;else{const e=Math.min(this.qe.curNote.start,o),i=Math.max(this.qe.curNote.end,o);this.Me=o,this.xe=this.qe.curNote.pitches[-1==this.qe.pitchIndex?0:this.qe.pitchIndex]+this.qe.curNote.pins[this.qe.nearPinIndex].interval,this.Se=this.qe.curNote.pins[this.qe.nearPinIndex].size,this.Pe=!0,t.append(new si(this.W,this.Ut,e,i,this.qe.curNote)),t.append(new Ae(this.W,this.qe.curNote,this.qe.nearPinIndex,o,r)),this.ii(this.qe.curNote)}}else if(-1==this.qe.pitchIndex){t.append(new ai(this.W,0,0));const s=Math.max(this.qe.curNote.start,Math.min(this.qe.curNote.end,Math.round(this.re/(this.hi*i))*i))-this.qe.curNote.start;let n,o=this.qe.curNote.pins[0],r=0,h=0;for(let t=1;t<this.qe.curNote.pins.length;t++){if(n=o,o=this.qe.curNote.pins[t],s>o.time)continue;if(s<n.time)throw new Error;const i=(s-n.time)/(o.time-n.time);r=Math.round(n.size*(1-i)+o.size*i+(this.me-this.he)/(75/e.noteSizeMax)),r<0&&(r=0),r>e.noteSizeMax&&(r=e.noteSizeMax),h=this.li(n.interval*(1-i)+o.interval*i+this.qe.curNote.pitches[0],0,e.maxPitch)-this.qe.curNote.pitches[0];break}this.Me=this.qe.curNote.start+s,this.xe=this.qe.curNote.pitches[-1==this.qe.pitchIndex?0:this.qe.pitchIndex]+h,this.Se=r,this.Pe=!0,t.append(new di(this.W,this.qe.curNote,s,r,h,this.ye)),this.ii(this.qe.curNote)}else{if(t.append(new ai(this.W,0,0)),this.Se=this.qe.curNote.pins[this.qe.nearPinIndex].size,null==this.Ut)throw new Error;let n,o;this.re>=this.de?(n=Math.max(this.qe.curNote.start,this.qe.part),o=s+i):(n=Math.min(this.qe.curNote.end,this.qe.part+i),o=s),o<0&&(o=0),o>this.W.song.beatsPerBar*e.partsPerBeat&&(o=this.W.song.beatsPerBar*e.partsPerBeat),o>this.qe.curNote.end&&t.append(new si(this.W,this.Ut,this.qe.curNote.start,o,this.qe.curNote)),o<this.qe.curNote.start&&t.append(new si(this.W,this.Ut,o,this.qe.curNote.end,this.qe.curNote));let r=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(const t of this.qe.curNote.pitches)r>t&&(r=t),h<t&&(h=t);r-=this.qe.curNote.pitches[this.qe.pitchIndex],h-=this.qe.curNote.pitches[this.qe.pitchIndex];const a=this.li(this.ai(this.he),-r,(this.W.song.getChannelIsNoise(this.W.channel)?e.drumCount-1:e.maxPitch)-h);t.append(new Re(this.W,this.qe.curNote,n,o,a,this.qe.pitchIndex)),this.ii(this.qe.curNote),this.Me=o,this.xe=a,this.Pe=!0}}this.ae&&this.qe.valid&&t||(this.si(),this.ni())}ei(t){this.Ee=t,this.W.hasRedoHistory()||this.W.record(this.Ee,this.Ie)}ni(){if(this.fe)if(!this.ae||!this.qe.valid||!this.ce||!this.Pe||this.ge||this.ve||this.we||this.ke)this.ee.setAttribute("visibility","hidden");else{this.ee.setAttribute("visibility","visible");const t=this.hi*this.Me,i=this.yi(this.xe-this.Ce),s=this.oe/2,n=80,o=60;let r="";const h=e.noteSizeMax;r+="M "+M(t)+" "+M(i-s*(this.Se/h))+" ",r+="L "+M(t)+" "+M(i-s*(this.Se/h)-o)+" ",r+="M "+M(t)+" "+M(i+s*(this.Se/h))+" ",r+="L "+M(t)+" "+M(i+s*(this.Se/h)+o)+" ",r+="M "+M(t)+" "+M(i-s*(this.Se/h))+" ",r+="L "+M(t+n)+" "+M(i-s*(this.Se/h))+" ",r+="M "+M(t)+" "+M(i+s*(this.Se/h))+" ",r+="L "+M(t+n)+" "+M(i+s*(this.Se/h))+" ",r+="M "+M(t)+" "+M(i-s*(this.Se/h))+" ",r+="L "+M(t-n)+" "+M(i-s*(this.Se/h))+" ",r+="M "+M(t)+" "+M(i+s*(this.Se/h))+" ",r+="L "+M(t-n)+" "+M(i+s*(this.Se/h))+" ",this.ee.setAttribute("d",r)}else if(this.le&&!this.ae&&this.qe.valid)if(this.ee.setAttribute("visibility","visible"),this.fi()){const t=this.hi*this.W.selection.patternSelectionStart,e=M(t-4),i=M(t+4),s=this.yi(-.5);this.ee.setAttribute("d","M "+e+" 0 L "+e+" "+s+" L "+i+" "+s+" L "+i+" 0 z")}else if(this.pi()){const t=this.hi*this.W.selection.patternSelectionEnd,e=M(t-4),i=M(t+4),s=this.yi(-.5);this.ee.setAttribute("d","M "+e+" 0 L "+e+" "+s+" L "+i+" "+s+" L "+i+" 0 z")}else if(this.ui()){const t=M(this.hi*this.W.selection.patternSelectionStart-2),e=M(this.hi*this.W.selection.patternSelectionEnd+2),i=this.yi(-.5);this.ee.setAttribute("d","M "+t+" 0 L "+t+" "+i+" L "+e+" "+i+" L "+e+" 0 z")}else this.gi(this.ee,this.qe.pitch,this.qe.start,this.qe.pins,this.oe/2+1,!0,this.Ce);else this.ee.setAttribute("visibility","hidden")}mi(){this.W.selection.patternSelectionActive?(this.te.setAttribute("visibility","visible"),this.te.setAttribute("x",String(this.hi*this.W.selection.patternSelectionStart)),this.te.setAttribute("width",String(this.hi*(this.W.selection.patternSelectionEnd-this.W.selection.patternSelectionStart)))):this.te.setAttribute("visibility","hidden")}render(){const t=this.W.getCurrentPattern(this.Jt);this.Ut!=t&&null!=this.Ut&&(this.Fe=null,this.ti(null)),this.Ut=t,this.Ve=this.container.clientWidth,this.Ye=this.container.clientHeight,this.hi=this.Ve/(this.W.song.beatsPerBar*e.partsPerBeat),this.di=this.W.song.getChannelIsNoise(this.W.channel)?e.drumCount:this.W.getVisiblePitchCount(),this.oe=this.Ye/this.di,this.Ce=this.W.getBaseVisibleOctave(this.W.channel)*e.pitchesPerOctave,this.Be==this.W.song.rhythm&&this.Ne==this.W.song.pitchChannelCount&&this.He==this.W.song.noiseChannelCount||(this.Be=this.W.song.rhythm,this.Ne=this.W.song.pitchChannelCount,this.He=this.W.song.noiseChannelCount,this.resetCopiedPins()),this.ci=this.pe[this.W.channel],this.Le==this.Ve&&this.De==this.Ye||(this.Le=this.Ve,this.De=this.Ye,this.Qt.setAttribute("width",""+this.Ve),this.Qt.setAttribute("height",""+this.Ye),this.Xt.setAttribute("height",""+this.Ye),this.te.setAttribute("y","0"),this.te.setAttribute("height",""+this.Ye));const i=this.Ve/this.W.song.beatsPerBar;if(this.ze!=i||this.Ae!=this.oe){this.ze=i,this.Ae=this.oe,this.Yt.setAttribute("width",""+i),this.Yt.setAttribute("height",""+this.oe*e.pitchesPerOctave),this.Kt.setAttribute("width",""+i),this.Kt.setAttribute("height",""+this.oe),this.ne.setAttribute("width",""+(i-2)),this.ne.setAttribute("height",""+(this.oe-2));for(let t=0;t<e.pitchesPerOctave;t++){const s=this.se[t],n=(e.pitchesPerOctave-t)%e.pitchesPerOctave;s.setAttribute("width",""+(i-2)),s.setAttribute("y",""+(n*this.oe+1)),s.setAttribute("height",""+(this.oe-2))}}this.Zt=function(t){const e=t.cloneNode(!1);return t.parentNode.replaceChild(e,t),e}(this.Zt),this.jt&&(this.ae||this.si(),this.ni(),this.mi()),this.Re!=this.W.showFifth&&(this.Re=this.W.showFifth,this.se[7].setAttribute("fill",this.W.showFifth?$.fifthNote:$.pitchBackground));for(let t=0;t<e.pitchesPerOctave;t++)this.se[t].style.visibility=e.scales[this.W.song.scale].flags[t]?"visible":"hidden";if(this.W.song.getChannelIsNoise(this.W.channel)?this.Oe||(this.Oe=!0,this.Qt.setAttribute("fill","url(#patternEditorDrumBackground"+this.Jt+")")):this.Oe&&(this.Oe=!1,this.Qt.setAttribute("fill","url(#patternEditorNoteBackground"+this.Jt+")")),this.W.showChannels)for(let t=this.W.song.getChannelCount()-1;t>=0;t--){if(t==this.W.channel)continue;if(this.W.song.getChannelIsNoise(t)!=this.W.song.getChannelIsNoise(this.W.channel))continue;const i=this.W.song.getPattern(t,this.W.bar+this.Jt);if(null==i)continue;const s=this.W.getBaseVisibleOctave(t)*e.pitchesPerOctave;for(const e of i.notes)for(const i of e.pitches){const n=A.path();n.setAttribute("fill",$.getChannelColor(this.W.song,t).secondaryNote),n.setAttribute("pointer-events","none"),this.gi(n,i,e.start,e.pins,.19*this.oe,!1,s),this.Zt.appendChild(n)}}if(null!=this.Ut){const t=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()],e=t.getChord(),i=t.getTransition(),s=e.customInterval||e.arpeggiates||e.strumParts>0||i.slides;for(const t of this.Ut.notes)for(let e=0;e<t.pitches.length;e++){const i=t.pitches[e];let n=A.path();n.setAttribute("fill",$.getChannelColor(this.W.song,this.W.channel).secondaryNote),n.setAttribute("pointer-events","none"),this.gi(n,i,t.start,t.pins,this.oe/2+1,!1,this.Ce),this.Zt.appendChild(n),n=A.path(),n.setAttribute("fill",$.getChannelColor(this.W.song,this.W.channel).primaryNote),n.setAttribute("pointer-events","none"),this.gi(n,i,t.start,t.pins,this.oe/2+1,!0,this.Ce),this.Zt.appendChild(n);let o=2;if(t.continuesLastPattern){const e=Math.min(this.oe,20);let s;s="M "+M(this.hi*t.start+o)+" "+M(this.yi(i-this.Ce)-.1*e),s+="L "+M(this.hi*t.start+o)+" "+M(this.yi(i-this.Ce)+.1*e),s+="L "+M(this.hi*t.start+o+4)+" "+M(this.yi(i-this.Ce)+.1*e),s+="L "+M(this.hi*t.start+o+4)+" "+M(this.yi(i-this.Ce)+.3*e),s+="L "+M(this.hi*t.start+o+12)+" "+M(this.yi(i-this.Ce)),s+="L "+M(this.hi*t.start+o+4)+" "+M(this.yi(i-this.Ce)-.3*e),s+="L "+M(this.hi*t.start+o+4)+" "+M(this.yi(i-this.Ce)-.1*e);const n=A.path();n.setAttribute("d",s),n.setAttribute("fill",$.invertedText),this.Zt.appendChild(n),o+=12}if(t.pitches.length>1&&s){const s=A.text();s.setAttribute("x",""+M(this.hi*t.start+o)),s.setAttribute("y",""+M(this.yi(i-this.Ce))),s.setAttribute("width","30"),s.setAttribute("fill",$.invertedText),s.setAttribute("text-anchor","start"),s.setAttribute("dominant-baseline","central"),s.setAttribute("pointer-events","none"),s.textContent=""+(e+1),this.Zt.appendChild(s)}}}}gi(t,i,s,n,o,r,h){const a=this.hi*(n[n.length-1].time+n[0].time),l=.5*Math.min(2,a-1);let c=n[0],u="M "+M(this.hi*(s+c.time)+l)+" "+M(this.yi(i-h)+o*(r?c.size/e.noteSizeMax:1))+" ";for(let t=1;t<n.length;t++){let a=c;c=n[t];let f=this.hi*(s+a.time)+(1==t?l:0),p=this.hi*(s+c.time)-(t==n.length-1?l:0),d=this.yi(i+a.interval-h),m=this.yi(i+c.interval-h),y=r?a.size/e.noteSizeMax:1,g=r?c.size/e.noteSizeMax:1;u+="L "+M(f)+" "+M(d-o*y)+" ",a.interval>c.interval&&(u+="L "+M(f+1)+" "+M(d-o*y)+" "),a.interval<c.interval&&(u+="L "+M(p-1)+" "+M(m-o*g)+" "),u+="L "+M(p)+" "+M(m-o*g)+" "}for(let t=n.length-2;t>=0;t--){let a=c;c=n[t];let f=this.hi*(s+a.time)-(t==n.length-2?l:0),p=this.hi*(s+c.time)+(0==t?l:0),d=this.yi(i+a.interval-h),m=this.yi(i+c.interval-h),y=r?a.size/e.noteSizeMax:1,g=r?c.size/e.noteSizeMax:1;u+="L "+M(f)+" "+M(d+o*y)+" ",a.interval<c.interval&&(u+="L "+M(f-1)+" "+M(d+o*y)+" "),a.interval>c.interval&&(u+="L "+M(p+1)+" "+M(m+o*g)+" "),u+="L "+M(p)+" "+M(m+o*g)+" "}u+="z",t.setAttribute("d",u)}yi(t){return this.oe*(this.di-t-.5)}}class xi{constructor(t){this.W=t,this.container=z.div({class:"envelopeEditor"}),this.bi=[],this.vi=[],this.wi=[],this.ki=[],this.Mi=0,this.xi=-1,this.Si=-1,this.Pi=0,this.Fi=t=>{const i=this.vi.indexOf(t.target),s=this.wi.indexOf(t.target);if(-1!=i){const t=parseInt(this.vi[i].value),s=t%e.instrumentAutomationTargets.length,n=t/e.instrumentAutomationTargets.length>>>0;this.W.record(new vi(this.W,i,s,n))}else-1!=s&&this.W.record(new wi(this.W,s,this.wi[s].selectedIndex))},this.Ei=t=>{const e=this.ki.indexOf(t.target);-1!=e&&this.W.record(new bi(this.W,e))},this.container.addEventListener("change",this.Fi),this.container.addEventListener("click",this.Ei)}Ii(t,i){let s=e.instrumentAutomationTargets[t].displayName;return e.instrumentAutomationTargets[t].maxCount>1&&(-1!=s.indexOf("#")?s=s.replace("#",String(i+1)):s+=" "+(i+1)),z.option({value:t+i*e.instrumentAutomationTargets.length},s)}qi(t,i){for(let s=0;s<t.childElementCount;s++){const n=t.children[s],o=parseInt(n.value),r=o%e.instrumentAutomationTargets.length,h=o/e.instrumentAutomationTargets.length>>>0;n.hidden=!i.supportsEnvelopeTarget(r,h)}}render(){const t=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()];if(this.W.alwaysShowSettings||t.preset==t.type){for(let i=this.bi.length;i<t.envelopeCount;i++){const t=z.select();for(let i=0;i<e.instrumentAutomationTargets.length;i++){const s=e.instrumentAutomationTargets[i].interleave;for(let n=0;n<e.instrumentAutomationTargets[i].maxCount;n++)t.appendChild(this.Ii(i,n)),s&&t.appendChild(this.Ii(i+1,n));s&&i++}const s=z.select();for(let t=0;t<e.envelopes.length;t++)s.appendChild(z.option({value:t},e.envelopes[t].name));const n=z.button({type:"button",class:"delete-envelope"}),o=z.div({class:"envelope-row"},z.div({class:"selectContainer",style:"width: 0; flex: 1;"},t),z.div({class:"selectContainer",style:"width: 0; flex: 0.7;"},s),n);this.container.appendChild(o),this.bi[i]=o,this.vi[i]=t,this.wi[i]=s,this.ki[i]=n}for(let e=this.Mi;e<t.envelopeCount;e++)this.bi[e].style.display="",this.qi(this.vi[e],t);for(let e=t.envelopeCount;e<this.Mi;e++)this.bi[e].style.display="none";if(this.xi!=t.eqFilter.controlPointCount||this.Si!=t.noteFilter.controlPointCount||this.Ti!=t.type||this.Pi!=t.effects)for(let e=0;e<this.Mi;e++)this.qi(this.vi[e],t);for(let i=0;i<t.envelopeCount;i++)this.vi[i].value=String(t.envelopes[i].target+t.envelopes[i].index*e.instrumentAutomationTargets.length),this.wi[i].selectedIndex=t.envelopes[i].envelope;this.Mi=t.envelopeCount,this.xi=t.eqFilter.controlPointCount,this.Si=t.noteFilter.controlPointCount,this.Ti=t.type,this.Pi=t.effects}}}class Si{constructor(t){this.W=t,this.Ve=120,this.Ye=26,this.Ci=A.path({fill:$.uiWidgetBackground,"pointer-events":"none"}),this.Li=A.path({fill:"none",stroke:"currentColor","stroke-width":1,"stroke-dasharray":"3, 2","pointer-events":"none"}),this.Di=A.path({fill:"none",stroke:"currentColor","stroke-width":2,"pointer-events":"none"}),this.ie=A.svg({style:`background-color: ${$.editorBackground}; touch-action: none; cursor: crosshair;`,width:"100%",height:"100%",viewBox:"0 0 "+this.Ve+" "+this.Ye,preserveAspectRatio:"none"},this.Ci,this.Li,this.Di),this.container=z.div({class:"fadeInOut",style:"height: 100%;"},this.ie),this.re=0,this.de=0,this.ae=!1,this.ce=!1,this.zi=!1,this.Fe=null,this.Ai=-1,this.Ri=-1,this.Je=t=>{t.preventDefault();const e=this.ie.getBoundingClientRect();this.re=(t.clientX||t.pageX)-e.left,this.Ue()},this.Ke=t=>{t.preventDefault();const e=this.ie.getBoundingClientRect();this.re=t.touches[0].clientX-e.left,this.Ue()},this.Qe=t=>{if(null==this.container.offsetParent)return;const e=this.ie.getBoundingClientRect();this.re=(t.clientX||t.pageX)-e.left,isNaN(this.re)&&(this.re=0),this.Ze()},this.Xe=t=>{if(null==this.container.offsetParent)return;if(!this.ae)return;t.preventDefault();const e=this.ie.getBoundingClientRect();this.re=t.touches[0].clientX-e.left,isNaN(this.re)&&(this.re=0),this.Ze()},this.ti=t=>{if(null!=this.container.offsetParent){if(this.ae&&this.W.lastChangeWas(this.Fe)&&null!=this.Fe)if(this.ce)this.W.record(this.Fe);else{const t=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()];this.zi?this.W.record(new me(this.W,this.Oi(this.re),t.fadeOut)):this.W.record(new me(this.W,t.fadeIn,this.Bi(this.re)))}this.Fe=null,this.ce=!1,this.ae=!1}};const i=this.Ni(e.fadeOutNeutral);this.Li.setAttribute("d",`M ${i} 0 L ${i} ${this.Ye}`),this.container.addEventListener("mousedown",this.Je),document.addEventListener("mousemove",this.Qe),document.addEventListener("mouseup",this.ti),this.container.addEventListener("touchstart",this.Ke),this.container.addEventListener("touchmove",this.Xe),this.container.addEventListener("touchend",this.ti),this.container.addEventListener("touchcancel",this.ti)}Hi(t){return 1+.4*(this.Ve-2)*t/(e.fadeInRange-1)}Oi(t){return nt(0,e.fadeInRange,Math.round((t-1)*(e.fadeInRange-1)/(.4*this.Ve-2)))}Ni(t){return 1+(this.Ve-2)*(.5+.5*t/(e.fadeOutTicks.length-1))}Bi(t){return nt(0,e.fadeOutTicks.length,Math.round((e.fadeOutTicks.length-1)*((t-1)/(this.Ve-2)-.5)/.5))}Ue(){isNaN(this.re)&&(this.re=0),this.de=this.re,this.ae=!0,this.ce=!1;const t=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()],e=this.Hi(t.fadeIn),i=this.Ni(t.fadeOut);this.zi=this.de<(e+i)/2,this.Fe=new Ct,this.W.setProspectiveChange(this.Fe)}Ze(){if(null!=this.Fe&&this.W.lastChangeWas(this.Fe)?this.Fe.undo():this.ae=!1,this.Fe=null,this.ae){const t=new Ct;if(this.Fe=t,this.W.setProspectiveChange(this.Fe),Math.abs(this.re-this.de)>4&&(this.ce=!0),this.ce){const e=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()];this.zi?t.append(new me(this.W,this.Oi(this.Hi(e.fadeIn)+this.re-this.de),e.fadeOut)):t.append(new me(this.W,e.fadeIn,this.Bi(this.Ni(e.fadeOut)+this.re-this.de)))}}}render(){const t=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()];if(this.Ai==t.fadeIn&&this.Ri==t.fadeOut)return;const i=this.Hi(t.fadeIn),s=this.Ni(t.fadeOut);this.Di.setAttribute("d",`M ${i} 0 L ${i} ${this.Ye} M ${s} 0 L ${s} ${this.Ye}`);const n=this.Ni(e.fadeOutNeutral);let o="";o+=`M 0 ${this.Ye} `,o+=`L ${i} 0 `,Mt.fadeOutSettingToTicks(t.fadeOut)>0?(o+=`L ${n} 0 `,o+=`L ${s} ${this.Ye} `):(o+=`L ${s} 0 `,o+=`L ${n} ${this.Ye} `),o+="z",this.Ci.setAttribute("d",o)}}class Pi{constructor(t,e=!1){this.W=t,this.Ve=120,this.Ye=26,this.Gi=A.path({fill:$.uiWidgetBackground,"pointer-events":"none"}),this.$i=A.path({fill:"currentColor","pointer-events":"none"}),this.Li=A.path({fill:"none",stroke:"currentColor","stroke-width":1,"stroke-dasharray":"3, 2","pointer-events":"none"}),this._i=A.circle({fill:"white",stroke:"none","pointer-events":"none",r:4}),this.ie=A.svg({style:`background-color: ${$.editorBackground}; touch-action: none;`,width:"100%",height:"100%",viewBox:"0 0 "+this.Ve+" "+this.Ye,preserveAspectRatio:"none"},this.Gi,this.Li,this._i,this.$i),this.Ui=z.div({style:"position: absolute; bottom: 0; left: 2px; font-size: 8px; line-height: 1; pointer-events: none;"}),this.container=z.div({class:"filterEditor",style:"height: 100%; position: relative;"},this.ie,this.Ui),this.Vi=2,this.Wi=!1,this.ji=!1,this.re=0,this.he=0,this.le=!1,this.ae=!1,this.ce=!1,this.Ji=!1,this.Yi=!1,this.Ki=2,this.Qi=0,this.Zi=0,this.Xi=0,this.Fe=null,this.ts=-1,this.es=-1,this.ss=-1,this.ns=-1,this.os=-1,this.We=t=>{this.le=!0},this.je=t=>{this.le=!1,this.rs()},this.Je=t=>{t.preventDefault(),this.ji=!1;const e=this.ie.getBoundingClientRect();this.re=((t.clientX||t.pageX)-e.left)*this.Ve/(e.right-e.left),this.he=((t.clientY||t.pageY)-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.Ue()},this.Ke=t=>{t.preventDefault(),this.ji=!0;const e=this.ie.getBoundingClientRect();this.re=(t.touches[0].clientX-e.left)*this.Ve/(e.right-e.left),this.he=(t.touches[0].clientY-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.Ue()},this.Qe=t=>{if(null==this.container.offsetParent)return;const e=this.ie.getBoundingClientRect();this.re=((t.clientX||t.pageX)-e.left)*this.Ve/(e.right-e.left),this.he=((t.clientY||t.pageY)-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.ae||this.hs(),this.Ze()},this.Xe=t=>{if(null==this.container.offsetParent)return;this.ae&&t.preventDefault();const e=this.ie.getBoundingClientRect();this.re=(t.touches[0].clientX-e.left)*this.Ve/(e.right-e.left),this.he=(t.touches[0].clientY-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.ae||this.hs(),this.Ze()},this.ti=t=>{if(null!=this.container.offsetParent){if(this.ae&&this.W.lastChangeWas(this.Fe)&&null!=this.Fe){if(this.Ji||this.ce||this.ji)this.W.record(this.Fe);else if(this.Qi<this.Pt.controlPointCount&&-1!=this.Qi){const t=this.Pt.controlPoints[this.Qi];this.W.record(new pe(this.W,this.Pt,t,this.Qi,this.Wi,!0))}this.rs()}this.Fe=null,this.ce=!1,this.Yi=!1,this.ae=!1,this.hs()}},this.Wi=e,this.container.addEventListener("mousedown",this.Je),this.container.addEventListener("mouseover",this.We),this.container.addEventListener("mouseout",this.je),document.addEventListener("mousemove",this.Qe),document.addEventListener("mouseup",this.ti),this.container.addEventListener("touchstart",this.Ke),this.container.addEventListener("touchmove",this.Xe),this.container.addEventListener("touchend",this.ti),this.container.addEventListener("touchcancel",this.ti)}ls(t){return e.filterFreqRange*t/this.Ve-.5}cs(t){return this.Ve*(t+.5)/e.filterFreqRange}us(t){return(e.filterGainRange-1)*(1-(t-.5)/(this.Ye-1))}fs(t){return(this.Ye-1)*(1-t/(e.filterGainRange-1))+.5}Ue(){this.ae=!0;const t=new Ct;this.Fe=t,this.W.setProspectiveChange(this.Fe),this.hs(),this.Ze()}hs(){this.Zi=this.ls(this.re),this.Xi=this.us(this.he),this.Ji=!0,this.Qi=-1;let t=Number.POSITIVE_INFINITY;for(let i=0;i<this.Pt.controlPointCount;i++){const s=this.Pt.controlPoints[i],n=Math.sqrt(Math.pow(this.cs(s.freq)-this.re,2)+Math.pow(this.fs(s.gain)-this.he,2));(n<=13||this.Pt.controlPointCount>=e.filterMaxPoints)&&n<t&&(t=n,this.Qi=i,this.Ji=!1)}if(this.Ji){const t=this.re/this.Ve;this.Ki=t<.2?1:t<.8?2:0}}Ze(){if(null!=this.Fe&&this.W.lastChangeWas(this.Fe)?this.Fe.undo():this.ae=!1,this.Fe=null,this.Yi=!1,this.ae){const t=new Ct;if(this.Fe=t,this.W.setProspectiveChange(this.Fe),this.Ji){const i=Math.max(0,Math.min(e.filterGainRange-1,Math.round(this.us(this.he)))),s=this.ps(this.Pt,this.ls(this.re),-1);if(s>=0&&s<e.filterFreqRange){const e=new ut;e.type=this.Ki,e.freq=s,e.gain=i,t.append(new pe(this.W,this.Pt,e,this.Pt.controlPointCount,this.Wi))}else this.Yi=!0}else if(this.Qi>=this.Pt.controlPointCount||-1==this.Qi)this.Fe=null,this.ae=!1;else{const i=this.ls(this.re)-this.Zi,s=this.us(this.he)-this.Xi,n=this.Pt.controlPoints[this.Qi],o=Math.max(0,Math.min(e.filterGainRange-1,Math.round(n.gain+s))),r=this.ps(this.Pt,n.freq+i,this.Qi);0==Math.round(i)&&0==Math.round(s)&&r==n.freq&&o==n.gain||(this.ce=!0),r>=0&&r<e.filterFreqRange?t.append(new de(this.W,n,n.freq,r,n.gain,o)):(t.append(new pe(this.W,this.Pt,n,this.Qi,this.Wi,!0)),this.Yi=!0)}}(this.ae||this.le)&&this.rs()}ps(t,e,i){const s=Math.round(e);let n=s,o=s,r=s<=e;for(;;){let e=!1;const s=r?n:o;for(let n=0;n<t.controlPointCount;n++)if(n!=i&&t.controlPoints[n].freq==s){e=!0;break}if(!e)return s;r=!r,r&&n--,r||o++}}static ds(t,e,i,s=!1){return`M ${t-i} ${e} a ${i} ${i} 0 1 ${s?1:0} ${2*i} 0 a ${i} ${i} 0 1 ${s?1:0} ${2*-i} 0 `}rs(){this._i.style.display="none",this.Ui.textContent="";let t="",i="";for(let s=0;s<this.Pt.controlPointCount;s++){const n=this.Pt.controlPoints[s],o=this.cs(n.freq),r=this.fs(n.gain);t+=Pi.ds(o,r,this.Vi),1==n.type?i+="M 0 "+r+" L "+o+" "+r+" ":0==n.type&&(i+="M "+this.Ve+" "+r+" L "+o+" "+r+" "),this.Qi==s&&this.le&&!this.ae&&(this._i.setAttribute("cx",String(o)),this._i.setAttribute("cy",String(r)),this._i.style.display=""),(this.Qi==s||this.Ji&&this.ae&&s==this.Pt.controlPointCount-1)&&(this.le||this.ae)&&!this.Yi&&(this.Ui.textContent=s+1+": "+e.filterTypeNames[n.type])}this.$i.setAttribute("d",t),this.Li.setAttribute("d",i),this.Ji&&!this.ae&&this.le&&(this.Ui.textContent="+ "+e.filterTypeNames[this.Ki]);const s=[];for(let t=0;t<this.Pt.controlPointCount;t++){const e=this.Pt.controlPoints[t],i=new Y;e.toCoefficients(i,44800),s.push(i)}const n=new K;let o="M 0 "+this.Ye+" ";for(let t=-1;t<=e.filterFreqRange;t++){const i=ut.getHzFromSettingValue(t),r=2*Math.PI*i/44800,h=Math.cos(r),a=Math.sin(r);let l=1;for(const t of s)n.analyzeComplex(t,h,a),l*=n.magnitude();const c=Math.log2(l)/e.filterGainStep+e.filterGainCenter,u=this.fs(c);o+="L "+M(this.cs(t))+" "+M(u)+" "}o+="L "+this.Ve+" "+this.Ye+" L 0 "+this.Ye+" z ",this.Gi.setAttribute("d",o)}render(){const t=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()],i=this.Wi?t.noteFilter:t.eqFilter;this.Pt!=i&&(this.Fe=null,this.ae=!1),this.Pt=i,this.ae||this.hs();let s=0,n=0,o=0;for(let t=0;t<i.controlPointCount;t++){const r=i.controlPoints[t];s=3*s+r.type,n=n*e.filterFreqRange+r.freq,o=o*e.filterGainRange+r.gain}this.ts==this.Qi&&this.es==i.controlPointCount&&this.ss==s&&this.ns==n&&this.os==o||(this.ts=this.Qi,this.es=i.controlPointCount,this.ss=s,this.ns=n,this.os=o,this.rs())}}class Fi{constructor(t){this.W=t,this.ys=z.div({style:`background: ${$.editorBackground}; position: sticky; bottom: 0; left: 0; width: 32px; height: 30px;`}),this.container=z.div({class:"muteEditor"}),this.gs=[],this.bs=0,this.vs=-1,this.Ei=t=>{const e=this.gs.indexOf(t.target);-1!=e&&(this.W.song.channels[e].muted=!this.W.song.channels[e].muted,this.W.notifier.changed())},this.container.addEventListener("click",this.Ei)}render(){if(!this.W.enableChannelMuting)return;const t=this.W.getChannelHeight();if(this.bs!=this.W.song.getChannelCount()){for(let e=this.bs;e<this.W.song.getChannelCount();e++){const i=z.button({class:"mute-button",title:"Mute (M), Mute All (⇧M), Solo (S), Exclude (⇧S)",style:`height: ${t-4}px; margin: 2px;`});this.container.appendChild(i),this.gs[e]=i}for(let t=this.W.song.getChannelCount();t<this.bs;t++)this.container.removeChild(this.gs[t]);this.gs.length=this.W.song.getChannelCount(),this.container.appendChild(this.ys)}for(let t=0;t<this.W.song.getChannelCount();t++)this.W.song.channels[t].muted?this.gs[t].classList.add("muted"):this.gs[t].classList.remove("muted");if(this.vs!=t)for(let e=0;e<this.W.song.getChannelCount();e++)this.gs[e].style.height=t-4+"px";this.vs==t&&this.bs==this.W.song.getChannelCount()||(this.vs=t,this.bs=this.W.song.getChannelCount())}}class Ei{constructor(t,e,i,s){this.ws=e,this.ks=i,this.Ms=document.createTextNode("1"),this.Ui=A.text({"font-family":"sans-serif","font-size":20,"text-anchor":"middle","font-weight":"bold",fill:"red"},this.Ms),this.xs=A.rect({x:1,y:1}),this.container=A.svg(this.xs,this.Ui),this.Ss=1,this.Ps=!0,this.Fs=!1,this.Es="",this.xs.setAttribute("fill",$.uiWidgetBackground),this.Ui.setAttribute("fill",s)}setSize(t,e){this.container.setAttribute("x",""+this.ws*t),this.container.setAttribute("y",""+this.ks*e),this.xs.setAttribute("width",""+(t-2)),this.xs.setAttribute("height",""+(e-2)),this.Ui.setAttribute("x",""+t/2),this.Ui.setAttribute("y",""+Math.round(e/2+7))}setIndex(t,e,i,s){this.Ss!=t&&(this.Fs||0==t==(0==this.Ss)||this.xs.setAttribute("fill",0==t?"none":$.uiWidgetBackground),this.Ss=t,this.Ms.data=""+t),this.Ps==e&&this.Es==s||(this.Ps=e,i?this.Ui.setAttribute("fill",$.invertedText):this.Ui.setAttribute("fill",s)),this.Fs==i&&this.Es==s||(this.Fs=i,i?(this.xs.setAttribute("fill",s),this.Ui.setAttribute("fill",$.invertedText)):(this.xs.setAttribute("fill",0==this.Ss?$.editorBackground:$.uiWidgetBackground),this.Ui.setAttribute("fill",s))),this.Es=s}}class Ii{constructor(t){this.W=t,this.Is=A.g(),this.qs=A.rect({fill:$.playhead,x:0,y:0,width:4,height:128}),this.Ts=A.rect({fill:"none",stroke:$.hoverPreview,"stroke-width":2,"pointer-events":"none",x:1,y:1,width:30,height:30}),this.Cs=A.path({fill:$.invertedText,stroke:$.invertedText,"stroke-width":1,"pointer-events":"none"}),this.Ls=A.path({fill:$.invertedText,stroke:$.invertedText,"stroke-width":1,"pointer-events":"none"}),this.te=A.rect({fill:$.boxSelectionFill,stroke:$.hoverPreview,"stroke-width":2,"stroke-dasharray":"5, 3","pointer-events":"none",visibility:"hidden",x:1,y:1,width:62,height:62}),this.ie=A.svg({style:`background-color: ${$.editorBackground}; position: absolute;`,height:128},this.Is,this.te,this.Ts,this.Cs,this.Ls,this.qs),this.Ds=z.select({class:"trackSelectBox",style:"background: none; border: none; appearance: none; border-radius: initial; box-shadow: none; color: transparent; position: absolute; touch-action: none;"}),this.container=z.div({class:"noSelection",style:"height: 128px; position: relative; overflow:hidden;"},this.ie,this.Ds),this.zs=[],this.re=0,this.he=0,this.As=0,this.Rs=0,this.Os=0,this.Bs=0,this.le=!1,this.Ns=!1,this.ce=!1,this.Hs=32,this.Gs=32,this.bs=0,this.$s=0,this._s=0,this.Us=-1,this.Vs=-1,this.vs=-1,this.ji=k,this.Ws=()=>{this.W.selection.setPattern(this.Ds.selectedIndex)},this._e=t=>{const e=this.Hs*this.W.synth.playhead-2;this.Us!=e&&(this.Us=e,this.qs.setAttribute("x",""+e)),window.requestAnimationFrame(this._e)},this.js=t=>{this.Ns=!0,this.ce=!0,this.Js(t),this.As=this.Os,this.Rs=this.Bs},this.Ys=t=>{this.Js(t),this.As==this.Os&&this.Rs==this.Bs||t.preventDefault(),this.Ns&&this.Ks(),this.ni()},this.Qs=t=>{this.Ns=!1,this.ce=!1,this.ni()},this.We=t=>{this.le||(this.le=!0)},this.je=t=>{this.le&&(this.le=!1)},this.Je=t=>{t.preventDefault(),this.Ns=!0,this.Zs(t),this.As=this.Os,this.Rs=this.Bs,t.shiftKey?(this.ce=!0,this.W.selection.setTrackSelection(this.W.selection.boxSelectionX0,this.Os,this.W.selection.boxSelectionY0,this.Bs),this.W.selection.selectionUpdated()):(this.ce=!1,this.W.channel==this.Bs&&this.W.bar==this.Os||(this.W.selection.setChannelBar(this.Bs,this.Os),this.ce=!0),this.W.selection.resetBoxSelection())},this.Qe=t=>{this.Zs(t),this.Ns&&(this.As==this.Os&&this.Rs==this.Bs||(this.ce=!0),this.Ks()),this.ni()},this.Xs=t=>{if(this.Ns&&!this.ce&&this.W.channel==this.Bs&&this.W.bar==this.Os){const t=this.he%this.Gs<this.Gs/2,e=this.W.song.patternsPerChannel;this.W.selection.setPattern((this.W.song.channels[this.Bs].bars[this.Os]+(t?1:e))%(e+1))}this.Ns=!1,this.ce=!1,this.ni()},window.requestAnimationFrame(this._e),this.ie.addEventListener("mousedown",this.Je),document.addEventListener("mousemove",this.Qe),document.addEventListener("mouseup",this.Xs),this.ie.addEventListener("mouseover",this.We),this.ie.addEventListener("mouseout",this.je),this.Ds.addEventListener("change",this.Ws),this.Ds.addEventListener("touchstart",this.js),this.Ds.addEventListener("touchmove",this.Ys),this.Ds.addEventListener("touchend",this.Qs),this.Ds.addEventListener("touchcancel",this.Qs);let e=!1;document.addEventListener("mousedown",(()=>{e||(this.ji=!1,this.ni()),e=!0}),!0),document.addEventListener("touchstart",(()=>{e||(this.ji=!0,this.ni()),e=!0}),!0)}movePlayheadToMouse(){return!!this.le&&(this.W.synth.playhead=this.Os+this.re%this.Hs/this.Hs,!0)}Ks(){this.W.selection.setTrackSelection(this.W.selection.boxSelectionX0,this.Os,this.W.selection.boxSelectionY0,this.Bs),this.W.selection.selectionUpdated()}Js(t){const e=this.ie.getBoundingClientRect();this.re=t.touches[0].clientX-e.left,this.he=t.touches[0].clientY-e.top,isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.Os=Math.floor(Math.min(this.W.song.barCount-1,Math.max(0,this.re/this.Hs))),this.Bs=Math.floor(Math.min(this.W.song.getChannelCount()-1,Math.max(0,this.he/this.Gs)))}Zs(t){const e=this.ie.getBoundingClientRect();this.re=(t.clientX||t.pageX)-e.left,this.he=(t.clientY||t.pageY)-e.top,this.Os=Math.floor(Math.min(this.W.song.barCount-1,Math.max(0,this.re/this.Hs))),this.Bs=Math.floor(Math.min(this.W.song.getChannelCount()-1,Math.max(0,this.he/this.Gs)))}ni(){let t=this.Bs,e=this.Os;this.ji&&(e=this.W.bar,t=this.W.channel);const i=e==this.W.bar&&t==this.W.channel;if(!this.le||this.Ns||i?this.Ts.style.visibility="hidden":(this.Ts.setAttribute("x",""+(1+this.Hs*e)),this.Ts.setAttribute("y",""+(1+this.Gs*t)),this.Ts.setAttribute("height",""+(this.Gs-2)),this.Ts.setAttribute("width",""+(this.Hs-2)),this.Ts.style.visibility="visible"),(this.le||this.ji)&&i){const i=this.he%this.Gs<this.Gs/2,s=this.Hs*(e+.8),n=this.Gs*(t+.5),o=.1*this.Gs,r=.4*this.Gs,h=.175*this.Gs;this.Cs.setAttribute("fill",i&&!this.ji?$.hoverPreview:$.invertedText),this.Ls.setAttribute("fill",i||this.ji?$.invertedText:$.hoverPreview),this.Cs.setAttribute("d",`M ${s} ${n-r} L ${s+h} ${n-o} L ${s-h} ${n-o} z`),this.Ls.setAttribute("d",`M ${s} ${n+r} L ${s+h} ${n+o} L ${s-h} ${n+o} z`),this.Cs.style.visibility="visible",this.Ls.style.visibility="visible"}else this.Cs.style.visibility="hidden",this.Ls.style.visibility="hidden";this.Ds.style.left=this.Hs*this.W.bar+"px",this.Ds.style.width=this.Hs+"px",this.Ds.style.top=this.Gs*this.W.channel+"px",this.Ds.style.height=this.Gs+"px";const s=this.W.song.patternsPerChannel+1;for(let t=this._s;t<s;t++)this.Ds.appendChild(z.option({value:t},t));for(let t=s;t<this._s;t++)this.Ds.removeChild(this.Ds.lastChild);this._s=s;const n=this.W.song.channels[this.W.channel].bars[this.W.bar];this.Ds.selectedIndex!=n&&(this.Ds.selectedIndex=n)}render(){if(this.Hs=this.W.getBarWidth(),this.Gs=this.W.getChannelHeight(),this.bs!=this.W.song.getChannelCount()){for(let t=this.bs;t<this.W.song.getChannelCount();t++){this.zs[t]=[];for(let e=0;e<this.$s;e++){const i=new Ei(t,e,t,$.getChannelColor(this.W.song,t).secondaryChannel);i.setSize(this.Hs,this.Gs),this.Is.appendChild(i.container),this.zs[t][e]=i}}for(let t=this.W.song.getChannelCount();t<this.bs;t++)for(let e=0;e<this.$s;e++)this.Is.removeChild(this.zs[t][e].container);this.zs.length=this.W.song.getChannelCount(),this.Ns=!1}if(this.$s!=this.W.song.barCount)for(let t=0;t<this.W.song.getChannelCount();t++){for(let e=this.$s;e<this.W.song.barCount;e++){const i=new Ei(t,e,t,$.getChannelColor(this.W.song,t).secondaryChannel);i.setSize(this.Hs,this.Gs),this.Is.appendChild(i.container),this.zs[t][e]=i}for(let e=this.W.song.barCount;e<this.$s;e++)this.Is.removeChild(this.zs[t][e].container);this.zs[t].length=this.W.song.barCount}if(this.$s!=this.W.song.barCount||this.Vs!=this.Hs){this.$s=this.W.song.barCount;const t=this.Hs*this.W.song.barCount;this.container.style.width=t+"px",this.ie.setAttribute("width",t+""),this.Ns=!1}if(this.vs!=this.Gs||this.Vs!=this.Hs){this.Vs=this.Hs;for(let t=0;t<this.W.song.getChannelCount();t++)for(let e=0;e<this.$s;e++)this.zs[t][e].setSize(this.Hs,this.Gs);this.Ns=!1}if(this.vs!=this.Gs||this.bs!=this.W.song.getChannelCount()){this.vs=this.Gs,this.bs=this.W.song.getChannelCount();const t=this.W.song.getChannelCount()*this.Gs;this.ie.setAttribute("height",""+t),this.qs.setAttribute("height",""+t),this.container.style.height=t+"px"}for(let t=0;t<this.W.song.getChannelCount();t++)for(let e=0;e<this.$s;e++){const i=this.W.song.getPattern(t,e),s=e==this.W.bar&&t==this.W.channel,n=null==i||0==i.notes.length,o=this.zs[t][e];if(e<this.W.song.barCount){const i=$.getChannelColor(this.W.song,t);o.setIndex(this.W.song.channels[t].bars[e],n,s,n&&!s?i.secondaryChannel:i.primaryChannel),o.container.style.visibility="visible"}else o.container.style.visibility="hidden"}this.Ds.style.display=this.ji?"":"none",this.W.selection.boxSelectionWidth>1||this.W.selection.boxSelectionHeight>1?(this.te.setAttribute("x",String(this.Hs*this.W.selection.boxSelectionBar+1)),this.te.setAttribute("y",String(this.Gs*this.W.selection.boxSelectionChannel+1)),this.te.setAttribute("width",String(this.Hs*this.W.selection.boxSelectionWidth-2)),this.te.setAttribute("height",String(this.Gs*this.W.selection.boxSelectionHeight-2)),this.te.setAttribute("visibility","visible")):this.te.setAttribute("visibility","hidden"),this.ni()}}const{button:qi,label:Ti,div:Ci,form:Li,h2:Di,input:zi}=z;class Ai{constructor(t){this.W=t,this.tn=zi({type:"file",accept:".json,application/json,.mid,.midi,audio/midi,audio/x-midi"}),this.en=qi({class:"okayButton",style:"width:45%;"},"Okay"),this.sn=qi({class:"cancelButton"}),this.nn=Li({style:"display: flex; gap: 10px;"},Ti({class:"layout-option"},zi({type:"radio",name:"layout",value:"small"}),A('\t\t\t\t\t<svg viewBox="-4 -1 28 22">\n\t\t\t\t\t\t<rect x="0" y="0" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1"/>\n\t\t\t\t\t\t<rect x="2" y="2" width="11" height="10" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="14" y="2" width="4" height="16" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="2" y="13" width="11" height="5" fill="currentColor"/>\n\t\t\t\t\t</svg>\n\t\t\t\t'),Ci("Small")),Ti({class:"layout-option"},zi({type:"radio",name:"layout",value:"long"}),A('\t\t\t\t\t<svg viewBox="-1 -1 28 22">\n\t\t\t\t\t\t<rect x="0" y="0" width="26" height="20" fill="none" stroke="currentColor" stroke-width="1"/>\n\t\t\t\t\t\t<rect x="2" y="2" width="12" height="10" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="15" y="2" width="4" height="10" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="20" y="2" width="4" height="10" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="2" y="13" width="22" height="5" fill="currentColor"/>\n\t\t\t\t\t</svg>\n\t\t\t\t'),Ci("Long")),Ti({class:"layout-option"},zi({type:"radio",name:"layout",value:"tall"}),A('\t\t\t\t\t<svg viewBox="-1 -1 28 22">\n\t\t\t\t\t\t<rect x="0" y="0" width="26" height="20" fill="none" stroke="currentColor" stroke-width="1"/>\n\t\t\t\t\t\t<rect x="11" y="2" width="8" height="16" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="20" y="2" width="4" height="16" fill="currentColor"/>\n\t\t\t\t\t\t<rect x="2" y="2" width="8" height="16" fill="currentColor"/>\n\t\t\t\t\t</svg>\n\t\t\t\t'),Ci("Tall"))),this.container=Ci({class:"prompt noSelection",style:"width: 300px;"},Di("Layout"),this.nn,Ci({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.en),this.sn),this.J=()=>{this.W.undo()},this.cleanUp=()=>{this.en.removeEventListener("click",this.rn),this.sn.removeEventListener("click",this.J),this.container.removeEventListener("keydown",this.hn)},this.hn=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.rn()},this.rn=()=>{this.W.layout=this.nn.elements.layout.value,this.W.savePreferences(),U.setLayout(this.W.layout),this.J()},this.tn.select(),setTimeout((()=>this.tn.focus())),this.en.addEventListener("click",this.rn),this.sn.addEventListener("click",this.J),this.container.addEventListener("keydown",this.hn),this.nn.elements.layout.value=this.W.layout}}class Ri{constructor(t){this.W=t,this.Ye=20,this.an=0,this.ln=1,this.cn=2,this.un=A.path({fill:"none",stroke:$.loopAccent,"stroke-width":4}),this._i=A.path({fill:$.hoverPreview,"pointer-events":"none"}),this.ie=A.svg({style:"touch-action: pan-y; position: absolute;",height:this.Ye},this.un,this._i),this.container=z.div({class:"loopEditor"},this.ie),this.Hs=32,this.fn=null,this.qe={startBar:-1,mode:-1},this.re=0,this.pn=0,this.dn=0,this.mn=!1,this.yn=!1,this.ae=!1,this.le=!1,this.gn=-1,this.bn=-1,this.$s=0,this.Vs=-1,this.We=t=>{this.le||(this.le=!0,this.ni())},this.je=t=>{this.le&&(this.le=!1,this.ni())},this.Je=t=>{t.preventDefault(),this.ae=!0;const e=this.ie.getBoundingClientRect();this.re=(t.clientX||t.pageX)-e.left,this.si(),this.ni(),this.Qe(t)},this.Ke=t=>{this.ae=!0;const e=this.ie.getBoundingClientRect();this.re=t.touches[0].clientX-e.left,this.si(),this.ni(),this.pn=t.touches[0].clientX,this.dn=t.touches[0].clientY,this.yn=!1,this.mn=!1},this.Qe=t=>{const e=this.ie.getBoundingClientRect();this.re=(t.clientX||t.pageX)-e.left,this.Ze()},this.Xe=t=>{if(!this.ae)return;const e=this.ie.getBoundingClientRect();this.re=t.touches[0].clientX-e.left,this.yn||this.mn||(Math.abs(t.touches[0].clientY-this.dn)>10?this.mn=!0:Math.abs(t.touches[0].clientX-this.pn)>10&&(this.yn=!0)),this.yn&&(this.Ze(),t.preventDefault())},this.vn=t=>{t.preventDefault(),this.mn||(this.Ze(),this.le=!1,this.ti(t),this.ni()),this.ae=!1},this.ti=t=>{null!=this.fn&&this.W.record(this.fn),this.fn=null,this.ae=!1,this.si(),this.wn()},this.kn=()=>{this.wn()},this.si(),this.wn(),this.W.notifier.watch(this.kn),this.container.addEventListener("mousedown",this.Je),document.addEventListener("mousemove",this.Qe),document.addEventListener("mouseup",this.ti),this.container.addEventListener("mouseover",this.We),this.container.addEventListener("mouseout",this.je),this.container.addEventListener("touchstart",this.Ke),this.container.addEventListener("touchmove",this.Xe),this.container.addEventListener("touchend",this.vn),this.container.addEventListener("touchcancel",this.vn)}si(){const t=this.re/this.Hs;this.qe.startBar=t,t>this.W.song.loopStart-.25&&t<this.W.song.loopStart+this.W.song.loopLength+.25?t-this.W.song.loopStart<.5*this.W.song.loopLength?this.qe.mode=this.an:this.qe.mode=this.ln:this.qe.mode=this.cn}Mn(t){let e=Math.round(t-this.W.song.loopLength/2),i=e+this.W.song.loopLength;return e<0&&(i-=e,e=0),i>this.W.song.barCount&&(e-=i-this.W.song.barCount,i=this.W.song.barCount),{start:e,length:i-e}}Ze(){if(this.ae){let t=this.W.song.loopStart,e=this.W.song.loopStart+this.W.song.loopLength;null!=this.fn&&this.W.lastChangeWas(this.fn)&&(t=this.fn.oldStart,e=t+this.fn.oldLength);const i=this.re/this.Hs;let s,n,o;if(this.qe.mode==this.an)s=t+Math.round(i-this.qe.startBar),n=e,s<0&&(s=0),s>=this.W.song.barCount&&(s=this.W.song.barCount),s==n?s=n-1:s>n&&(o=s,s=n,n=o),this.fn=new Fe(this.W,t,e-t,s,n-s);else if(this.qe.mode==this.ln)s=t,n=e+Math.round(i-this.qe.startBar),n<0&&(n=0),n>=this.W.song.barCount&&(n=this.W.song.barCount),n==s?n=s+1:n<s&&(o=s,s=n,n=o),this.fn=new Fe(this.W,t,e-t,s,n-s);else if(this.qe.mode==this.cn){const s=this.Mn(i);this.fn=new Fe(this.W,t,e-t,s.start,s.length)}this.W.synth.jumpIntoLoop(),this.W.autoFollow&&new Zt(this.W,this.W.channel,Math.floor(this.W.synth.playhead),!0),this.W.setProspectiveChange(this.fn)}else this.si(),this.ni()}ni(){const t=this.le&&!this.ae;if(this._i.style.visibility=t?"visible":"hidden",t){const t=this.Ye/2;let e=this.W.song.loopStart*this.Hs,i=(this.W.song.loopStart+this.W.song.loopLength)*this.Hs;if(this.qe.mode==this.an)i=this.W.song.loopStart*this.Hs+2*t;else if(this.qe.mode==this.ln)e=(this.W.song.loopStart+this.W.song.loopLength)*this.Hs-2*t;else{const t=this.Mn(this.qe.startBar);e=t.start*this.Hs,i=(t.start+t.length)*this.Hs}this._i.setAttribute("d",`M ${e+t} 4 L ${i-t} 4 A ${t-4} ${t-4} 0 0 1 ${i-t} ${this.Ye-4} L ${e+t} ${this.Ye-4} A ${t-4} ${t-4} 0 0 1 ${e+t} 4 z`)}}wn(){this.Hs=this.W.getBarWidth();const t=this.Ye/2,e=this.W.song.loopStart*this.Hs,i=(this.W.song.loopStart+this.W.song.loopLength)*this.Hs;if(this.$s!=this.W.song.barCount||this.Vs!=this.Hs){this.$s=this.W.song.barCount,this.Vs=this.Hs;const t=this.Hs*this.W.song.barCount;this.container.style.width=t+"px",this.ie.setAttribute("width",t+"")}this.gn==e&&this.bn==i||(this.gn=e,this.bn=i,this.un.setAttribute("d",`M ${e+t} 2 L ${i-t} 2 A ${t-2} ${t-2} 0 0 1 ${i-t} ${this.Ye-2} L ${e+t} ${this.Ye-2} A ${t-2} ${t-2} 0 0 1 ${e+t} 2 z`)),this.ni()}}class Oi{constructor(t,i){this.W=t,this.xn=i,this.Ve=120,this.Ye=26,this.Sn=A.path({fill:$.uiWidgetBackground,"pointer-events":"none"}),this.Pn=A.svg({"pointer-events":"none"}),this.Fn=A.svg({"pointer-events":"none"}),this.En=A.path({fill:"none",stroke:"currentColor","stroke-width":2,"pointer-events":"none"}),this.In=A.path({fill:"currentColor","pointer-events":"none"}),this.ie=A.svg({style:`background-color: ${$.editorBackground}; touch-action: none; cursor: crosshair;`,width:"100%",height:"100%",viewBox:"0 0 "+this.Ve+" "+this.Ye,preserveAspectRatio:"none"},this.Sn,this.Pn,this.Fn,this.En,this.In),this.container=z.div({class:"spectrum",style:"height: 100%;"},this.ie),this.re=0,this.he=0,this.qn=0,this.Tn=0,this.ae=!1,this.fn=null,this.Cn="",this.Re=!0,this.Je=t=>{t.preventDefault(),this.ae=!0;const e=this.ie.getBoundingClientRect();this.re=((t.clientX||t.pageX)-e.left)*this.Ve/(e.right-e.left),this.he=((t.clientY||t.pageY)-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.qn=this.ls(this.re),this.Tn=this.Ln(this.he),this.Ze()},this.Ke=t=>{t.preventDefault(),this.ae=!0;const e=this.ie.getBoundingClientRect();this.re=(t.touches[0].clientX-e.left)*this.Ve/(e.right-e.left),this.he=(t.touches[0].clientY-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.qn=this.ls(this.re),this.Tn=this.Ln(this.he),this.Ze()},this.Qe=t=>{if(null==this.container.offsetParent)return;const e=this.ie.getBoundingClientRect();this.re=((t.clientX||t.pageX)-e.left)*this.Ve/(e.right-e.left),this.he=((t.clientY||t.pageY)-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.Ze()},this.Xe=t=>{if(null==this.container.offsetParent)return;if(!this.ae)return;t.preventDefault();const e=this.ie.getBoundingClientRect();this.re=(t.touches[0].clientX-e.left)*this.Ve/(e.right-e.left),this.he=(t.touches[0].clientY-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.Ze()},this.ti=t=>{this.ae&&(this.W.record(this.fn),this.fn=null),this.ae=!1};for(let t=0;t<e.spectrumControlPoints;t+=e.spectrumControlPointsPerOctave)this.Pn.appendChild(A.rect({fill:$.tonic,x:(t+1)*this.Ve/(e.spectrumControlPoints+2)-1,y:0,width:2,height:this.Ye}));for(let t=4;t<=e.spectrumControlPoints;t+=e.spectrumControlPointsPerOctave)this.Fn.appendChild(A.rect({fill:$.fifthNote,x:(t+1)*this.Ve/(e.spectrumControlPoints+2)-1,y:0,width:2,height:this.Ye}));this.container.addEventListener("mousedown",this.Je),document.addEventListener("mousemove",this.Qe),document.addEventListener("mouseup",this.ti),this.container.addEventListener("touchstart",this.Ke),this.container.addEventListener("touchmove",this.Xe),this.container.addEventListener("touchend",this.ti),this.container.addEventListener("touchcancel",this.ti)}ls(t){return(e.spectrumControlPoints+2)*t/this.Ve-1}Ln(t){return e.spectrumMax*(1-(t-1)/(this.Ye-2))}Ze(){if(this.ae){const t=this.ls(this.re),i=this.Ln(this.he),s=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()],n=null==this.xn?s.spectrumWave:s.drumsetSpectrumWaves[this.xn];if(t!=this.qn){const s=(i-this.Tn)/(t-this.qn),o=this.Tn-this.qn*s,r=Math.ceil(Math.min(this.qn,t)),h=Math.floor(Math.max(this.qn,t));for(let t=r;t<=h;t++)t<0||t>=e.spectrumControlPoints||(n.spectrum[t]=Math.max(0,Math.min(e.spectrumMax,Math.round(t*s+o))))}n.spectrum[Math.max(0,Math.min(e.spectrumControlPoints-1,Math.round(t)))]=Math.max(0,Math.min(e.spectrumMax,Math.round(i))),this.qn=t,this.Tn=i,this.fn=new ie(this.W,s,n),this.W.setProspectiveChange(this.fn)}}render(){const t=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()],i=null==this.xn?t.spectrumWave:t.drumsetSpectrumWaves[this.xn],s=t=>(1-t/e.spectrumMax)*(this.Ye-1)+1;let n=0,o="M 0 "+M(this.Ye)+" ";for(let t=0;t<e.spectrumControlPoints;t++){let r=i.spectrum[t];o+=0!=n||0!=r?"L ":"M ",o+=M((t+1)*this.Ve/(e.spectrumControlPoints+2))+" "+M(s(r))+" ",n=r}const r=s(n);n>0&&(o+="L "+(this.Ve-1)+" "+M(r)+" "),this.Cn!=o&&(this.Cn=o,this.En.setAttribute("d",o),this.Sn.setAttribute("d",o+"L "+this.Ve+" "+M(r)+" L "+this.Ve+" "+M(this.Ye)+" L 0 "+M(this.Ye)+" z "),this.In.setAttribute("d","M "+this.Ve+" "+M(r)+" L "+(this.Ve-4)+" "+M(r-4)+" L "+(this.Ve-4)+" "+M(r+4)+" z"),this.In.style.display=n>0?"":"none"),this.Re!=this.W.showFifth&&(this.Re=this.W.showFifth,this.Fn.style.display=this.W.showFifth?"":"none")}}class Bi{constructor(t){this.W=t,this.Ve=120,this.Ye=26,this.Pn=A.svg({"pointer-events":"none"}),this.Fn=A.svg({"pointer-events":"none"}),this.En=A.path({fill:"none",stroke:"currentColor","stroke-width":2,"pointer-events":"none"}),this.Dn=[],this.zn=A.svg({"pointer-events":"none"}),this.ie=A.svg({style:`background-color: ${$.editorBackground}; touch-action: none; cursor: crosshair;`,width:"100%",height:"100%",viewBox:"0 0 "+this.Ve+" "+this.Ye,preserveAspectRatio:"none"},this.Pn,this.Fn,this.En,this.zn),this.container=z.div({class:"harmonics",style:"height: 100%;"},this.ie),this.re=0,this.he=0,this.qn=0,this.Tn=0,this.ae=!1,this.fn=null,this.Cn="",this.Re=!0,this.Je=t=>{t.preventDefault(),this.ae=!0;const e=this.ie.getBoundingClientRect();this.re=((t.clientX||t.pageX)-e.left)*this.Ve/(e.right-e.left),this.he=((t.clientY||t.pageY)-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.qn=this.ls(this.re),this.Tn=this.Ln(this.he),this.Ze()},this.Ke=t=>{t.preventDefault(),this.ae=!0;const e=this.ie.getBoundingClientRect();this.re=(t.touches[0].clientX-e.left)*this.Ve/(e.right-e.left),this.he=(t.touches[0].clientY-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.qn=this.ls(this.re),this.Tn=this.Ln(this.he),this.Ze()},this.Qe=t=>{if(null==this.container.offsetParent)return;const e=this.ie.getBoundingClientRect();this.re=((t.clientX||t.pageX)-e.left)*this.Ve/(e.right-e.left),this.he=((t.clientY||t.pageY)-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.Ze()},this.Xe=t=>{if(null==this.container.offsetParent)return;if(!this.ae)return;t.preventDefault();const e=this.ie.getBoundingClientRect();this.re=(t.touches[0].clientX-e.left)*this.Ve/(e.right-e.left),this.he=(t.touches[0].clientY-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.re)&&(this.re=0),isNaN(this.he)&&(this.he=0),this.Ze()},this.ti=t=>{this.ae&&(this.W.record(this.fn),this.fn=null),this.ae=!1};for(let t=1;t<=e.harmonicsControlPoints;t*=2)this.Pn.appendChild(A.rect({fill:$.tonic,x:(t-.5)*(this.Ve-8)/(e.harmonicsControlPoints-1)-1,y:0,width:2,height:this.Ye}));for(let t=3;t<=e.harmonicsControlPoints;t*=2)this.Fn.appendChild(A.rect({fill:$.fifthNote,x:(t-.5)*(this.Ve-8)/(e.harmonicsControlPoints-1)-1,y:0,width:2,height:this.Ye}));for(let t=0;t<4;t++){const e=A.rect({fill:"currentColor",x:this.Ve-2*t-1,y:0,width:1,height:this.Ye});this.Dn.push(e),this.zn.appendChild(e)}this.container.addEventListener("mousedown",this.Je),document.addEventListener("mousemove",this.Qe),document.addEventListener("mouseup",this.ti),this.container.addEventListener("touchstart",this.Ke),this.container.addEventListener("touchmove",this.Xe),this.container.addEventListener("touchend",this.ti),this.container.addEventListener("touchcancel",this.ti)}ls(t){return(e.harmonicsControlPoints-1)*t/(this.Ve-8)-.5}Ln(t){return e.harmonicsMax*(1-t/this.Ye)}Ze(){if(this.ae){const t=this.ls(this.re),i=this.Ln(this.he),s=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()],n=s.harmonicsWave;if(t!=this.qn){const s=(i-this.Tn)/(t-this.qn),o=this.Tn-this.qn*s,r=Math.ceil(Math.min(this.qn,t)),h=Math.floor(Math.max(this.qn,t));for(let t=r;t<=h;t++)t<0||t>=e.harmonicsControlPoints||(n.harmonics[t]=Math.max(0,Math.min(e.harmonicsMax,Math.round(t*s+o))))}n.harmonics[Math.max(0,Math.min(e.harmonicsControlPoints-1,Math.round(t)))]=Math.max(0,Math.min(e.harmonicsMax,Math.round(i))),this.qn=t,this.Tn=i,this.fn=new se(this.W,s,n),this.W.setProspectiveChange(this.fn)}}render(){const t=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()].harmonicsWave,i=t=>(1-t/e.harmonicsMax)*this.Ye;let s=M(this.Ye),n="";for(let o=0;o<e.harmonicsControlPoints-1;o++){if(0==t.harmonics[o])continue;let r=M((o+.5)*(this.Ve-8)/(e.harmonicsControlPoints-1));n+="M "+r+" "+s+" ",n+="L "+r+" "+M(i(t.harmonics[o]))+" "}const o=i(t.harmonics[e.harmonicsControlPoints-1]);for(let t=0;t<4;t++){const e=this.Dn[t];e.setAttribute("y",M(o)),e.setAttribute("height",M(this.Ye-o))}this.Cn!=n&&(this.Cn=n,this.En.setAttribute("d",n)),this.Re!=this.W.showFifth&&(this.Re=this.W.showFifth,this.Fn.style.display=this.W.showFifth?"":"none")}}class Ni{constructor(t,e){this.W=t,this.An=e,this.Ve=512,this.Ye=20,this.Rn=A.svg({"pointer-events":"none"}),this.On=A.rect({fill:$.uiWidgetBackground,x:0,y:2,width:10,height:this.Ye-4}),this.Bn=A.rect({fill:"none",stroke:$.hoverPreview,"stroke-width":2,"pointer-events":"none",x:0,y:1,width:10,height:this.Ye-2}),this.Nn=A.path({fill:$.hoverPreview,"pointer-events":"none"}),this.Hn=A.path({fill:$.hoverPreview,"pointer-events":"none"}),this.ie=A.svg({style:`background-color: ${$.editorBackground}; touch-action: pan-y; position: absolute;`,width:this.Ve,height:this.Ye},this.Rn,this.On,this.Bn,this.Nn,this.Hn),this.container=z.div({class:"barScrollBar",style:"width: 512px; height: 20px; overflow: hidden; position: relative;"},this.ie),this.re=0,this.ae=!1,this.le=!1,this.Gn=!1,this.$n=-1,this._n=-1,this.Un=t=>{this.W.barScrollPos=this.An.scrollLeft/this.W.getBarWidth()},this.We=t=>{this.le||(this.le=!0,this.ni())},this.je=t=>{this.le&&(this.le=!1,this.ni())},this.Je=t=>{t.preventDefault(),this.ae=!0;const e=this.ie.getBoundingClientRect();this.re=(t.clientX||t.pageX)-e.left,this.ni(),this.re>=this.W.barScrollPos*this.Vn&&this.re<=(this.W.barScrollPos+this.W.trackVisibleBars)*this.Vn&&(this.Gn=!0,this.Wn=this.re)},this.Ke=t=>{t.preventDefault(),this.ae=!0;const e=this.ie.getBoundingClientRect();this.re=t.touches[0].clientX-e.left,this.ni(),this.re>=this.W.barScrollPos*this.Vn&&this.re<=(this.W.barScrollPos+this.W.trackVisibleBars)*this.Vn&&(this.Gn=!0,this.Wn=this.re)},this.Qe=t=>{const e=this.ie.getBoundingClientRect();this.re=(t.clientX||t.pageX)-e.left,this.Ze()},this.Xe=t=>{if(!this.ae)return;t.preventDefault();const e=this.ie.getBoundingClientRect();this.re=t.touches[0].clientX-e.left,this.Ze()},this.ti=t=>{!this.Gn&&this.ae&&(this.re<(this.W.barScrollPos+8)*this.Vn?(this.W.barScrollPos>0&&this.W.barScrollPos--,this.W.notifier.changed()):(this.W.barScrollPos<this.W.song.barCount-this.W.trackVisibleBars&&this.W.barScrollPos++,this.W.notifier.changed())),this.ae=!1,this.Gn=!1,this.ni()};const i=.5*this.Ye;this.Nn.setAttribute("d",`M 9 ${i} L 20 ${i+6} L 20 ${i-6} z`),this.Hn.setAttribute("d",`M ${this.Ve-9} ${i} L ${this.Ve-20} ${i+6} L ${this.Ve-20} ${i-6} z`),this.container.addEventListener("mousedown",this.Je),document.addEventListener("mousemove",this.Qe),document.addEventListener("mouseup",this.ti),this.container.addEventListener("mouseover",this.We),this.container.addEventListener("mouseout",this.je),this.container.addEventListener("touchstart",this.Ke),this.container.addEventListener("touchmove",this.Xe),this.container.addEventListener("touchend",this.ti),this.container.addEventListener("touchcancel",this.ti),this.An.addEventListener("scroll",this.Un,{capture:!1,passive:!0})}Ze(){if(this.Gn){for(;this.re-this.Wn<.5*-this.Vn&&this.W.barScrollPos>0;)this.W.barScrollPos--,this.Wn-=this.Vn,this.W.notifier.changed();for(;this.re-this.Wn>.5*this.Vn&&this.W.barScrollPos<this.W.song.barCount-this.W.trackVisibleBars;)this.W.barScrollPos++,this.Wn+=this.Vn,this.W.notifier.changed()}this.le&&this.ni()}ni(){let t=!1,e=!1,i=!1;this.le&&!this.ae&&(this.re<this.W.barScrollPos*this.Vn?t=!0:this.re>(this.W.barScrollPos+this.W.trackVisibleBars)*this.Vn?e=!0:i=!0),this.Nn.style.visibility=t?"visible":"hidden",this.Hn.style.visibility=e?"visible":"hidden",this.Bn.style.visibility=i?"visible":"hidden"}render(){this.Vn=(this.Ve-1)/Math.max(this.W.trackVisibleBars,this.W.song.barCount);const t=this.$n!=this.W.song.barCount;if(t){for(this.$n=this.W.song.barCount;this.Rn.firstChild;)this.Rn.removeChild(this.Rn.firstChild);for(let t=0;t<=this.W.song.barCount;t++){const e=t%16==0?0:t%4==0?this.Ye/8:this.Ye/3;this.Rn.appendChild(A.rect({fill:$.uiWidgetBackground,x:t*this.Vn-1,y:e,width:2,height:this.Ye-2*e}))}}(t||this._n!=this.W.barScrollPos)&&(this._n=this.W.barScrollPos,this.On.setAttribute("x",String(this.Vn*this.W.barScrollPos)),this.On.setAttribute("width",String(this.Vn*this.W.trackVisibleBars)),this.Bn.setAttribute("x",String(this.Vn*this.W.barScrollPos)),this.Bn.setAttribute("width",String(this.Vn*this.W.trackVisibleBars))),this.ni(),this.An.scrollLeft=this.W.barScrollPos*this.W.getBarWidth(),this.An.scrollTop=this.W.channelScrollPos*this.W.getChannelHeight()}}class Hi{constructor(t){this.W=t,this.Ve=20,this.Ye=481,this.jn=4,this.Jn=e.pitchOctaves,this.Yn=(this.Ye-this.jn)/this.Jn,this.On=A.rect({fill:$.uiWidgetBackground,x:2,y:0,width:this.Ve-4}),this.Bn=A.rect({fill:"none",stroke:$.hoverPreview,"stroke-width":2,"pointer-events":"none",x:1,y:0,width:this.Ve-2}),this.Cs=A.path({fill:$.hoverPreview,"pointer-events":"none"}),this.Ls=A.path({fill:$.hoverPreview,"pointer-events":"none"}),this.ie=A.svg({style:`background-color: ${$.editorBackground}; touch-action: pan-x; position: absolute;`,width:this.Ve,height:"100%",viewBox:"0 0 20 481",preserveAspectRatio:"none"}),this.container=z.div({id:"octaveScrollBarContainer",style:"width: 20px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0;"},this.ie),this.he=0,this.ae=!1,this.le=!1,this.Gn=!1,this.Kn=-1,this.Qn=-1,this.fn=null,this.We=t=>{this.le||(this.le=!0,this.ni())},this.je=t=>{this.le&&(this.le=!1,this.ni())},this.Je=t=>{t.preventDefault(),this.ae=!0;const e=this.ie.getBoundingClientRect();this.he=((t.clientY||t.pageY)-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.he)&&(this.he=0),this.W.song.getChannelIsNoise(this.W.channel)||(this.ni(),this.he>=this.Zn-this.Xn&&this.he<=this.Zn&&(this.Gn=!0,this.fn=null,this.Wn=this.he))},this.Ke=t=>{t.preventDefault(),this.ae=!0;const e=this.ie.getBoundingClientRect();this.he=(t.touches[0].clientY-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.he)&&(this.he=0),this.W.song.getChannelIsNoise(this.W.channel)||(this.ni(),this.he>=this.Zn-this.Xn&&this.he<=this.Zn&&(this.Gn=!0,this.fn=null,this.Wn=this.he))},this.Qe=t=>{const e=this.ie.getBoundingClientRect();this.he=((t.clientY||t.pageY)-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.he)&&(this.he=0),this.Ze()},this.Xe=t=>{if(!this.ae)return;t.preventDefault();const e=this.ie.getBoundingClientRect();this.he=(t.touches[0].clientY-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.he)&&(this.he=0),this.Ze()},this.ti=t=>{if(!this.W.song.getChannelIsNoise(this.W.channel)&&this.ae)if(this.Gn)null!=this.fn&&this.W.record(this.fn);else{const t=this.W.getVisibleOctaveCount(),i=e.pitchOctaves-t,s=this.W.lastChangeWas(this.fn),n=s?this.fn.oldValue:this.W.song.channels[this.W.channel].octave,o=this.W.getBaseVisibleOctave(this.W.channel);this.he<this.Zn-.5*this.Xn?o<i&&(this.fn=new Ie(this.W,n,Math.floor(o+1+.5*t)),this.W.record(this.fn,s)):o>0&&(this.fn=new Ie(this.W,n,Math.floor(o-1+.5*t)),this.W.record(this.fn,s))}this.ae=!1,this.Gn=!1,this.ni()},this.kn=()=>{this.Zn=this.Ye-this.Yn*this.W.getBaseVisibleOctave(this.W.channel),this.ie.style.visibility=this.W.song.getChannelIsNoise(this.W.channel)?"hidden":"visible";const t=this.W.getVisibleOctaveCount();this.Kn==this.Zn&&this.Qn==t||(this.Kn=this.Zn,this.Qn=t,this.Xn=this.Yn*t+this.jn,this.On.setAttribute("height",String(this.Xn)),this.Bn.setAttribute("height",String(this.Xn)),this.On.setAttribute("y",String(this.Zn-this.Xn)),this.Bn.setAttribute("y",String(this.Zn-this.Xn))),this.ni()},this.W.notifier.watch(this.kn),this.kn(),this.ie.appendChild(this.On);for(let t=0;t<=this.Jn;t++)this.ie.appendChild(A.rect({fill:$.tonic,x:0,y:t*this.Yn,width:this.Ve,height:this.jn}));this.ie.appendChild(this.Bn),this.ie.appendChild(this.Cs),this.ie.appendChild(this.Ls);const i=.5*this.Ve;this.Cs.setAttribute("d",`M ${i} 9 L ${i+6} 20 L ${i-6} 20 z`),this.Ls.setAttribute("d",`M ${i} ${this.Ye-9} L ${i+6} ${this.Ye-20} L ${i-6} ${this.Ye-20} z`),this.container.addEventListener("mousedown",this.Je),document.addEventListener("mousemove",this.Qe),document.addEventListener("mouseup",this.ti),this.container.addEventListener("mouseover",this.We),this.container.addEventListener("mouseout",this.je),this.container.addEventListener("touchstart",this.Ke),this.container.addEventListener("touchmove",this.Xe),this.container.addEventListener("touchend",this.ti),this.container.addEventListener("touchcancel",this.ti)}Ze(){if(!this.W.song.getChannelIsNoise(this.W.channel)){if(this.Gn){const t=this.W.getVisibleOctaveCount(),i=e.pitchOctaves-t,s=this.W.lastChangeWas(this.fn)?this.fn.oldValue:this.W.song.channels[this.W.channel].octave;let n=this.W.getBaseVisibleOctave(this.W.channel);for(;this.he-this.Wn<.5*-this.Yn&&n<i;)n++,this.Wn-=this.Yn;for(;this.he-this.Wn>.5*this.Yn&&n>0;)n--,this.Wn+=this.Yn;this.fn=new Ie(this.W,s,Math.floor(n+.5*t)),this.W.setProspectiveChange(this.fn)}this.le&&this.ni()}}ni(){let t=!1,e=!1,i=!1;this.le&&!this.ae&&(this.he<this.Zn-this.Xn?t=!0:this.he>this.Zn?e=!0:i=!0),this.Cs.style.visibility=t?"inherit":"hidden",this.Ls.style.visibility=e?"inherit":"hidden",this.Bn.style.visibility=i?"inherit":"hidden"}}class Gi{constructor(t){this.W=t,this.eo=z.div({style:"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;"}),this.io=z.div({style:"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;"}),this.so=z.div({style:`width: 100%; height: 40px; border: 2px solid ${$.primaryText}; position: absolute; box-sizing: border-box; pointer-events: none;`}),this.container=z.div({style:"width: 32px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0; touch-action: none;"},this.eo,this.io,this.so),this.Ye=481,this.no=[],this.oo=[],this.he=0,this.ae=!1,this.le=!1,this.ro=-1,this.ho=-1,this.Oe=!1,this.ao=-1,this.lo=-1,this.We=t=>{this.le||(this.le=!0,this.ni())},this.je=t=>{this.le&&(this.le=!1,this.ni())},this.Je=t=>{t.preventDefault(),this.W.synth.maintainLiveInput(),this.ae=!0;const e=this.container.getBoundingClientRect();this.he=((t.clientY||t.pageY)-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.he)&&(this.he=0),this.co(),this.ni()},this.Qe=t=>{(this.ae||this.le)&&this.W.synth.maintainLiveInput();const e=this.container.getBoundingClientRect();this.he=((t.clientY||t.pageY)-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.he)&&(this.he=0),this.uo(),this.ae&&this.co(),this.ni()},this.Xs=t=>{this.ae&&this.fo(),this.ae=!1,this.ni()},this.Ke=t=>{t.preventDefault(),this.W.synth.maintainLiveInput(),this.ae=!0;const e=this.container.getBoundingClientRect();this.he=(t.touches[0].clientY-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.he)&&(this.he=0),this.uo(),this.co()},this.Xe=t=>{t.preventDefault(),this.W.synth.maintainLiveInput();const e=this.container.getBoundingClientRect();this.he=(t.touches[0].clientY-e.top)*this.Ye/(e.bottom-e.top),isNaN(this.he)&&(this.he=0),this.uo(),this.ae&&this.co()},this.vn=t=>{t.preventDefault(),this.fo()},this.kn=()=>{const t=this.W.song.getChannelIsNoise(this.W.channel);if(this.di=t?e.drumCount:this.W.getVisiblePitchCount(),this.oe=this.Ye/this.di,this.uo(),this.ae&&this.co(),this.W.synth.liveInputChannel=this.W.channel,this.W.synth.liveInputInstruments=this.W.recentPatternInstruments[this.W.channel],this.W.showLetters&&(this.ho!=this.W.song.scale||this.ao!=this.W.song.key||this.Oe!=t||this.lo!=this.di)){if(this.ho=this.W.song.scale,this.ao=this.W.song.key,this.Oe=t,this.eo.style.display=t?"none":"flex",this.io.style.display=t?"flex":"none",!t){if(this.lo!=this.di){this.eo.innerHTML="";for(let t=0;t<this.di;t++){const e=z.div({class:"piano-label",style:"font-weight: bold; -webkit-text-stroke-width: 0; font-size: 11px; font-family: sans-serif; position: absolute; padding-left: 15px;"}),i=z.div({class:"piano-button",style:"background: gray;"},e);this.eo.appendChild(i),this.oo[t]=e,this.no[t]=i}this.oo.length=this.di,this.no.length=this.di,this.lo=this.di}for(let t=0;t<this.di;t++){const i=(t+e.keys[this.W.song.key].basePitch)%e.pitchesPerOctave,s=e.keys[i].isWhiteKey;if(this.no[t].style.background=s?$.whitePianoKey:$.blackPianoKey,e.scales[this.W.song.scale].flags[t%e.pitchesPerOctave]){let s;if(this.no[t].classList.remove("disabled"),this.oo[t].style.display="",e.keys[i].isWhiteKey)s=e.keys[i].name;else{const n=e.blackKeyNameParents[t%e.pitchesPerOctave];s=e.keys[(i+e.pitchesPerOctave+n)%e.pitchesPerOctave].name,1==n?s+="♭":-1==n&&(s+="♯")}const n=this.oo[t];n.style.color=e.keys[i].isWhiteKey?"black":"white",n.textContent=s}else this.no[t].classList.add("disabled"),this.oo[t].style.display="none"}}this.ni()}};for(let t=0;t<e.drumCount;t++){const i=100*(1-t/e.drumCount*.35),s=1+(t-e.drumCount/2)/e.drumCount*.5;this.io.appendChild(z.div({class:"drum-button",style:`background-size: ${i}% ${i}%; filter: brightness(${s})`}))}this.container.addEventListener("mousedown",this.Je),document.addEventListener("mousemove",this.Qe),document.addEventListener("mouseup",this.Xs),this.container.addEventListener("mouseover",this.We),this.container.addEventListener("mouseout",this.je),this.container.addEventListener("touchstart",this.Ke),this.container.addEventListener("touchmove",this.Xe),this.container.addEventListener("touchend",this.vn),this.container.addEventListener("touchcancel",this.vn),this.W.notifier.watch(this.kn),this.kn()}uo(){const t=e.scales[this.W.song.scale].flags,i=Math.max(0,Math.min(this.di-1,this.di-this.he/this.oe));if(t[Math.floor(i)%e.pitchesPerOctave]||this.W.song.getChannelIsNoise(this.W.channel))this.po=Math.floor(i);else{let s=Math.floor(i)+1,n=Math.floor(i)-1;for(;!t[s%e.pitchesPerOctave];)s++;for(;!t[n%e.pitchesPerOctave];)n--;let o=s,r=n+1;s%e.pitchesPerOctave!=0&&s%e.pitchesPerOctave!=7||(o-=.5),n%e.pitchesPerOctave!=0&&n%e.pitchesPerOctave!=7||(r+=.5),this.po=i-r>o-i?s:n}}co(){const t=this.W.getBaseVisibleOctave(this.W.channel)*e.pitchesPerOctave,i=this.po+t;this.ro!=i&&(this.ro=i,this.W.synth.liveInputDuration=Number.MAX_SAFE_INTEGER,this.W.synth.liveInputPitches=[this.ro],this.W.synth.liveInputStarted=!0)}fo(){this.ro=-1,this.W.synth.liveInputDuration=0}ni(){if(this.so.style.visibility=!this.le||this.ae?"hidden":"visible",!this.le||this.ae)return;const t=this.container.getBoundingClientRect(),e=this.oe/(this.Ye/(t.bottom-t.top));this.so.style.left="0px",this.so.style.top=e*(this.di-this.po-1)+"px",this.so.style.height=e+"px"}}const{button:$i,div:_i,span:Ui,h2:Vi,input:Wi,br:ji,select:Ji,option:Yi}=z;class Ki{constructor(t){this.W=t,this.do=Wi({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.mo=Ji({style:"width: 100%;"},Yi({value:"splice"},"Splice beats at end of bars."),Yi({value:"stretch"},"Stretch notes to fit in bars."),Yi({value:"overflow"},"Overflow notes across bars.")),this.sn=$i({class:"cancelButton"}),this.en=$i({class:"okayButton",style:"width:45%;"},"Okay"),this.container=_i({class:"prompt noSelection",style:"width: 250px;"},Vi("Beats Per Bar"),_i({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},_i({style:"text-align: right;"},"Beats per bar:",ji(),Ui({style:`font-size: smaller; color: ${$.secondaryText};`},"(Multiples of 3 or 4 are recommended)")),this.do),_i({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},_i({class:"selectContainer",style:"width: 100%;"},this.mo)),_i({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.en),this.sn),this.J=()=>{this.W.undo()},this.cleanUp=()=>{this.en.removeEventListener("click",this.yo),this.sn.removeEventListener("click",this.J),this.do.removeEventListener("keypress",Ki.bo),this.do.removeEventListener("blur",Ki.vo),this.container.removeEventListener("keydown",this.hn)},this.hn=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.yo()},this.yo=()=>{window.localStorage.setItem("beatCountStrategy",this.mo.value),this.W.prompt=null,this.W.record(new He(this.W,Ki.wo(this.do),this.mo.value),!0)},this.do.value=this.W.song.beatsPerBar+"",this.do.min=e.beatsPerBarMin+"",this.do.max=e.beatsPerBarMax+"";const i=window.localStorage.getItem("beatCountStrategy");null!=i&&(this.mo.value=i),this.do.select(),setTimeout((()=>this.do.focus())),this.en.addEventListener("click",this.yo),this.sn.addEventListener("click",this.J),this.do.addEventListener("keypress",Ki.bo),this.do.addEventListener("blur",Ki.vo),this.container.addEventListener("keydown",this.hn)}static bo(t){const e=t.which?t.which:t.keyCode;return 46!=e&&e>31&&(e<48||e>57)&&(t.preventDefault(),!0)}static vo(t){const e=t.target;e.value=String(Ki.wo(e))}static wo(t){return Math.floor(Math.max(Number(t.min),Math.min(Number(t.max),Number(t.value))))}}const{button:Qi,div:Zi,span:Xi,h2:ts,input:es,br:is,select:ss,option:ns}=z;class os{constructor(t){this.W=t,this.do=es({style:"width: 3em; margin-left: 1em;",type:"number",step:"0.01",value:"0"}),this.mo=ss({style:"width: 100%;"},ns({value:"overflow"},"Overflow notes across bars."),ns({value:"wrapAround"},"Wrap notes around within bars.")),this.sn=Qi({class:"cancelButton"}),this.en=Qi({class:"okayButton",style:"width:45%;"},"Okay"),this.container=Zi({class:"prompt noSelection",style:"width: 250px;"},ts("Move Notes Sideways"),Zi({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},Zi({style:"text-align: right;"},"Beats to move:",is(),Xi({style:`font-size: smaller; color: ${$.secondaryText};`},"(Negative is left, positive is right)")),this.do),Zi({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},Zi({class:"selectContainer",style:"width: 100%;"},this.mo)),Zi({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.en),this.sn),this.J=()=>{this.W.undo()},this.cleanUp=()=>{this.en.removeEventListener("click",this.yo),this.sn.removeEventListener("click",this.J),this.do.removeEventListener("blur",os.vo),this.container.removeEventListener("keydown",this.hn)},this.hn=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.yo()},this.yo=()=>{window.localStorage.setItem("moveNotesSidewaysStrategy",this.mo.value),this.W.prompt=null,this.W.record(new Ne(this.W,+this.do.value,this.mo.value),!0)},this.do.min=-this.W.song.beatsPerBar+"",this.do.max=this.W.song.beatsPerBar+"";const e=window.localStorage.getItem("moveNotesSidewaysStrategy");null!=e&&(this.mo.value=e),this.do.select(),setTimeout((()=>this.do.focus())),this.en.addEventListener("click",this.yo),this.sn.addEventListener("click",this.J),this.do.addEventListener("blur",os.vo),this.container.addEventListener("keydown",this.hn)}static vo(t){const i=t.target;let s=+i.value;s=Math.round(s*e.partsPerBeat)/e.partsPerBeat,s=Math.round(100*s)/100,i.value=Math.max(+i.min,Math.min(+i.max,s))+""}}const{button:rs,div:hs,span:as,h2:ls,input:cs,br:us,select:fs,option:ps}=z;class ds{constructor(t){this.W=t,this.ko=cs({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Mo=fs({style:"width: 100%;"},ps({value:"end"},"Apply change at end of song."),ps({value:"beginning"},"Apply change at beginning of song.")),this.sn=rs({class:"cancelButton"}),this.en=rs({class:"okayButton",style:"width:45%;"},"Okay"),this.container=hs({class:"prompt noSelection",style:"width: 250px;"},ls("Song Length"),hs({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},hs({style:"display: inline-block; text-align: right;"},"Bars per song:",us(),as({style:`font-size: smaller; color: ${$.secondaryText};`},"(Multiples of 4 are recommended)")),this.ko),hs({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},hs({class:"selectContainer",style:"width: 100%;"},this.Mo)),hs({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.en),this.sn),this.J=()=>{this.W.undo()},this.cleanUp=()=>{this.en.removeEventListener("click",this.yo),this.sn.removeEventListener("click",this.J),this.ko.removeEventListener("keypress",ds.bo),this.ko.removeEventListener("blur",ds.vo),this.container.removeEventListener("keydown",this.hn)},this.hn=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.yo()},this.yo=()=>{window.localStorage.setItem("barCountPosition",this.Mo.value);const t=new Tt;t.append(new Vt(this.W,ds.wo(this.ko),"beginning"==this.Mo.value)),this.W.prompt=null,this.W.record(t,!0)},this.ko.value=this.W.song.barCount+"",this.ko.min=e.barCountMin+"",this.ko.max=e.barCountMax+"";const i=window.localStorage.getItem("barCountPosition");null!=i&&(this.Mo.value=i),this.ko.select(),setTimeout((()=>this.ko.focus())),this.en.addEventListener("click",this.yo),this.sn.addEventListener("click",this.J),this.ko.addEventListener("keypress",ds.bo),this.ko.addEventListener("blur",ds.vo),this.container.addEventListener("keydown",this.hn)}static bo(t){const e=t.which?t.which:t.keyCode;return 46!=e&&e>31&&(e<48||e>57)&&(t.preventDefault(),!0)}static vo(t){const e=t.target;e.value=String(ds.wo(e))}static wo(t){return Math.floor(Math.max(Number(t.min),Math.min(Number(t.max),Number(t.value))))}}const{button:ms,div:ys,label:gs,br:bs,h2:vs,input:ws}=z;class ks{constructor(t){this.W=t,this.xo=ws({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.So=ws({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Po=ws({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Fo=ws({style:"width: 3em; margin-left: 1em;",type:"checkbox"}),this.Eo=ws({style:"width: 3em; margin-left: 1em;",type:"checkbox"}),this.sn=ms({class:"cancelButton"}),this.en=ms({class:"okayButton",style:"width:45%;"},"Okay"),this.container=ys({class:"prompt noSelection",style:"width: 250px; text-align: right;"},vs("Channel Settings"),gs({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Pitch channels:",this.So),gs({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Drum channels:",this.Po),gs({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Available patterns per channel:",this.xo),gs({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Simultaneous instruments",bs(),"per channel:",this.Fo),gs({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Different instruments",bs(),"per pattern:",this.Eo),gs({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.en),this.sn),this.J=()=>{this.W.undo()},this.cleanUp=()=>{this.en.removeEventListener("click",this.yo),this.sn.removeEventListener("click",this.J),this.xo.removeEventListener("keypress",ks.bo),this.So.removeEventListener("keypress",ks.bo),this.Po.removeEventListener("keypress",ks.bo),this.xo.removeEventListener("blur",this.vo),this.So.removeEventListener("blur",this.vo),this.Po.removeEventListener("blur",this.vo),this.container.removeEventListener("keydown",this.hn)},this.hn=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.yo()},this.vo=t=>{const e=t.target;e.value=String(ks.wo(e))},this.yo=()=>{const t=new Tt;t.append(new Se(this.W,this.Fo.checked,this.Eo.checked)),t.append(new De(this.W,ks.wo(this.xo))),t.append(new Yt(this.W,ks.wo(this.So),ks.wo(this.Po))),this.W.prompt=null,this.W.record(t,!0)},this.xo.value=this.W.song.patternsPerChannel+"",this.xo.min="1",this.xo.max=e.barCountMax+"",this.So.value=this.W.song.pitchChannelCount+"",this.So.min=e.pitchChannelCountMin+"",this.So.max=e.pitchChannelCountMax+"",this.Po.value=this.W.song.noiseChannelCount+"",this.Po.min=e.noiseChannelCountMin+"",this.Po.max=e.noiseChannelCountMax+"",this.Fo.checked=this.W.song.layeredInstruments,this.Eo.checked=this.W.song.patternInstruments,this.So.select(),setTimeout((()=>this.So.focus())),this.en.addEventListener("click",this.yo),this.sn.addEventListener("click",this.J),this.xo.addEventListener("keypress",ks.bo),this.So.addEventListener("keypress",ks.bo),this.Po.addEventListener("keypress",ks.bo),this.xo.addEventListener("blur",this.vo),this.So.addEventListener("blur",this.vo),this.Po.addEventListener("blur",this.vo),this.container.addEventListener("keydown",this.hn)}static bo(t){const e=t.which?t.which:t.keyCode;return 46!=e&&e>31&&(e<48||e>57)&&(t.preventDefault(),!0)}static wo(t){return Math.floor(Math.max(Number(t.min),Math.min(Number(t.max),Number(t.value))))}}function Ms(t,e){const i=new ArrayBuffer(e);let s=0,n=Math.min(t.byteLength,i.byteLength);const o=[8,4,2,1];for(const e of o)if(n>=e){const o=r(e,t,i,s,n);s=o.nextOffset,n=o.leftBytes}return i;function r(t,e,i,s,n){let o=Uint8Array;switch(t){case 8:o=Float64Array;break;case 4:o=Float32Array;break;case 2:o=Uint16Array;break;default:o=Uint8Array}const r=new o(e,s,n/t|0),h=new o(i,s,n/t|0);for(let t=0;t<h.length;t++)h[t]=r[t];return{nextOffset:r.byteOffset+r.byteLength,leftBytes:n-h.length*t}}}class xs{constructor(t){this.Io=0,this.qo=0,this.To=new ArrayBuffer(t),this.Co=new DataView(this.To)}Lo(t){this.qo+=t,this.qo>this.To.byteLength&&(this.To=Ms(this.To,Math.max(2*this.To.byteLength,this.qo)),this.Co=new DataView(this.To))}getWriteIndex(){return this.Io}rewriteUint32(t,e){this.Co.setUint32(t,e>>>0,!1)}writeUint32(t){t>>>=0,this.Lo(4),this.Co.setUint32(this.Io,t,!1),this.Io=this.qo}writeUint24(t){t>>>=0,this.Lo(3),this.Co.setUint8(this.Io,t>>16&255),this.Co.setUint8(this.Io+1,t>>8&255),this.Co.setUint8(this.Io+2,255&t),this.Io=this.qo}writeUint16(t){t>>>=0,this.Lo(2),this.Co.setUint16(this.Io,t,!1),this.Io=this.qo}writeUint8(t){t>>>=0,this.Lo(1),this.Co.setUint8(this.Io,t),this.Io=this.qo}writeInt8(t){t|=0,this.Lo(1),this.Co.setInt8(this.Io,t),this.Io=this.qo}writeMidi7Bits(t){if((t>>>=0)>=128)throw new Error("7 bit value contained 8th bit!");this.Lo(1),this.Co.setUint8(this.Io,t),this.Io=this.qo}writeMidiVariableLength(t){if((t>>>=0)>268435455)throw new Error("writeVariableLength value too big.");let e=!1;for(let i=0;i<4;i++){const s=t>>>21-7*i&127;0==s&&3!=i||(e=!0),e&&this.writeUint8((3==i?0:128)|s)}}writeMidiAscii(t){this.writeMidiVariableLength(t.length);for(let e=0;e<t.length;e++){const i=t.charCodeAt(e);if(i>127)throw new Error("Trying to write unicode character as ascii.");this.writeUint8(i)}}toCompactArrayBuffer(){return Ms(this.To,this.qo)}}const Ss=8192,Ps={35:{frequency:0,duration:2,volume:3},36:{frequency:0,duration:2,volume:3},37:{frequency:5,duration:1,volume:3},38:{frequency:4,duration:2,volume:3},39:{frequency:5,duration:2,volume:3},40:{frequency:4,duration:2,volume:3},41:{frequency:1,duration:2,volume:3},42:{frequency:8,duration:1,volume:3},43:{frequency:1,duration:2,volume:3},44:{frequency:8,duration:1,volume:2},45:{frequency:2,duration:2,volume:3},46:{frequency:8,duration:4,volume:3},47:{frequency:2,duration:2,volume:3},48:{frequency:3,duration:2,volume:3},49:{frequency:7,duration:4,volume:3},50:{frequency:3,duration:2,volume:3},51:{frequency:6,duration:4,volume:2},52:{frequency:7,duration:4,volume:3},53:{frequency:6,duration:2,volume:3},54:{frequency:11,duration:2,volume:3},55:{frequency:9,duration:4,volume:3},56:{frequency:7,duration:1,volume:2},57:{frequency:7,duration:4,volume:3},58:{frequency:10,duration:2,volume:2},59:{frequency:6,duration:4,volume:3},69:{frequency:10,duration:2,volume:3},70:{frequency:10,duration:2,volume:3},73:{frequency:10,duration:1,volume:2},74:{frequency:10,duration:2,volume:2}};function Fs(t){return Math.pow(t/127,4)/.3844015376046128}const{button:Es,div:Is,h2:qs,input:Ts,select:Cs,option:Ls}=z;function Ds(t,e,i){return t+i*(e-t)}function zs(t,e){if(navigator.msSaveOrOpenBlob)return void navigator.msSaveOrOpenBlob(t,e);const i=document.createElement("a");if(null!=i.download){const s=URL.createObjectURL(t);setTimeout((function(){URL.revokeObjectURL(s)}),6e4),i.href=s,i.download=e,setTimeout((function(){i.dispatchEvent(new MouseEvent("click"))}),0)}else{const e=URL.createObjectURL(t);setTimeout((function(){URL.revokeObjectURL(e)}),6e4),window.open(e,"_blank")||(window.location.href=e)}}class As{constructor(t){this.W=t,this.Do=Ts({type:"text",style:"width: 10em;",value:"BeepBox-Song",maxlength:250,autofocus:"autofocus"}),this.zo=Ts({type:"checkbox"}),this.Ao=Ts({style:"width: 2em;",type:"number",min:"1",max:"4",step:"1"}),this.Ro=Ts({type:"checkbox"}),this.Oo=Cs({style:"width: 100%;"},Ls({value:"wav"},".wav"),Ls({value:"mp3"},".mp3"),Ls({value:"midi"},".mid"),Ls({value:"json"},".json (for any BeepBox version)"),Ls({value:"html"},".html (opens BeepBox)")),this.sn=Es({class:"cancelButton"}),this.Bo=Es({class:"exportButton",style:"width:45%;"},"Export"),this.container=Is({class:"prompt noSelection",style:"width: 200px;"},qs("Export Options"),Is({style:"display: flex; flex-direction: row; align-items: center; justify-content: space-between;"},"File name:",this.Do),Is({style:"display: table; width: 100%;"},Is({style:"display: table-row;"},Is({style:"display: table-cell;"},"Intro:"),Is({style:"display: table-cell;"},"Loop Count:"),Is({style:"display: table-cell;"},"Outro:")),Is({style:"display: table-row;"},Is({style:"display: table-cell; vertical-align: middle;"},this.zo),Is({style:"display: table-cell; vertical-align: middle;"},this.Ao),Is({style:"display: table-cell; vertical-align: middle;"},this.Ro))),Is({style:"text-align: left;"},"File Type:"),Is({class:"selectContainer",style:"width: 100%;"},this.Oo),Is({style:"text-align: left;"},"(Be patient, exporting may take some time...)"),Is({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.Bo),this.sn),this.J=()=>{this.W.undo()},this.cleanUp=()=>{this.Do.removeEventListener("input",As.No),this.Ao.removeEventListener("blur",As.vo),this.Bo.removeEventListener("click",this.Ho),this.sn.removeEventListener("click",this.J),this.container.removeEventListener("keydown",this.hn)},this.hn=t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.Ho()},this.Ho=()=>{switch(window.localStorage.setItem("exportFormat",this.Oo.value),this.Oo.value){case"wav":this.Go();break;case"mp3":this.$o();break;case"midi":this._o();break;case"json":this.Uo();break;case"html":this.Vo();break;default:throw new Error("Unhandled file export type.")}},this.Ao.value="1",0==this.W.song.loopStart?(this.zo.checked=!1,this.zo.disabled=!0):(this.zo.checked=!0,this.zo.disabled=!1),this.W.song.loopStart+this.W.song.loopLength==this.W.song.barCount?(this.Ro.checked=!1,this.Ro.disabled=!0):(this.Ro.checked=!0,this.Ro.disabled=!1);const e=window.localStorage.getItem("exportFormat");null!=e&&(this.Oo.value=e),this.Do.select(),setTimeout((()=>this.Do.focus())),this.Do.addEventListener("input",As.No),this.Ao.addEventListener("blur",As.vo),this.Bo.addEventListener("click",this.Ho),this.sn.addEventListener("click",this.J),this.container.addEventListener("keydown",this.hn)}static No(t){const e=t.target,i=/[\+\*\$\?\|\{\}\\\/<>#%!`&'"=:@]/gi;if(i.test(e.value)){let t=e.selectionStart;e.value=e.value.replace(i,""),t--,e.setSelectionRange(t,t)}}static vo(t){const e=t.target;e.value=Math.floor(Math.max(Number(e.min),Math.min(Number(e.max),Number(e.value))))+""}Wo(t){const e=new Mt(this.W.song);if(e.samplesPerSecond=t,e.loopRepeatCount=Number(this.Ao.value)-1,!this.zo.checked)for(let t=0;t<this.W.song.loopStart;t++)e.goToNextBar();const i=Math.ceil(e.getSamplesPerBar()*e.getTotalBars(this.zo.checked,this.Ro.checked)),s=new Float32Array(i),n=new Float32Array(i);return e.synthesize(s,n,i),{recordedSamplesL:s,recordedSamplesR:n}}Go(){const t=48e3,{recordedSamplesL:e,recordedSamplesR:i}=this.Wo(t),s=e.length,n=2*s;let o=0;const r=new ArrayBuffer(44+2*n),h=new DataView(r);h.setUint32(o,1380533830,!1),o+=4,h.setUint32(o,36+2*n,!0),o+=4,h.setUint32(o,1463899717,!1),o+=4,h.setUint32(o,1718449184,!1),o+=4,h.setUint32(o,16,!0),o+=4,h.setUint16(o,1,!0),o+=2,h.setUint16(o,2,!0),o+=2,h.setUint32(o,t,!0),o+=4,h.setUint32(o,192e3,!0),o+=4,h.setUint16(o,4,!0),o+=2,h.setUint16(o,16,!0),o+=2,h.setUint32(o,1684108385,!1),o+=4,h.setUint32(o,2*n,!0),o+=4;{const t=32767;for(let n=0;n<s;n++){let s=Math.floor(Math.max(-1,Math.min(1,e[n]))*t),r=Math.floor(Math.max(-1,Math.min(1,i[n]))*t);h.setInt16(o,s,!0),o+=2,h.setInt16(o,r,!0),o+=2}}zs(new Blob([r],{type:"audio/wav"}),this.Do.value.trim()+".wav"),this.J()}$o(){const t=()=>{const{recordedSamplesL:t,recordedSamplesR:e}=this.Wo(44100),i=1152,s=new window.lamejs.Mp3Encoder(2,44100,192),n=[],o=new Int16Array(t.length),r=new Int16Array(e.length);for(let i=0;i<t.length;i++)o[i]=Math.floor(32767*Math.max(-1,Math.min(1,t[i]))),r[i]=Math.floor(32767*Math.max(-1,Math.min(1,e[i])));for(let t=0;t<o.length;t+=i){const e=o.subarray(t,t+i),h=r.subarray(t,t+i),a=s.encodeBuffer(e,h);a.length>0&&n.push(a)}const h=s.flush();h.length>0&&n.push(h);zs(new Blob(n,{type:"audio/mp3"}),this.Do.value.trim()+".mp3"),this.J()};if("lamejs"in window)t();else{var e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js",e.onload=t,document.head.appendChild(e)}}_o(){const t=this.W.song,i=2*e.ticksPerPart*e.partsPerBeat,s=2*e.ticksPerPart,n=t.getBeatsPerMinute(),o=Math.round(6e7/n),r=i*t.beatsPerBar,a=24,l=[];if(this.zo.checked)for(let e=0;e<t.loopStart;e++)l.push(e);for(let e=0;e<Number(this.Ao.value);e++)for(let e=t.loopStart;e<t.loopStart+t.loopLength;e++)l.push(e);if(this.Ro.checked)for(let e=t.loopStart+t.loopLength;e<t.barCount;e++)l.push(e);const c=[{isMeta:!0,channel:-1,midiChannel:-1,isNoise:!1,isDrumset:!1}];let u=0,f=!1;for(let t=0;t<this.W.song.getChannelCount();t++)if(f||4!=this.W.song.channels[t].instruments[0].type){if(u>=16)continue;c.push({isMeta:!1,channel:t,midiChannel:u++,isNoise:this.W.song.getChannelIsNoise(t),isDrumset:!1}),9==u&&u++}else c.push({isMeta:!1,channel:t,midiChannel:9,isNoise:!0,isDrumset:!0}),f=!0;const p=new xs(1024);p.writeUint32(1297377380),p.writeUint32(6),p.writeUint16(1),p.writeUint16(c.length),p.writeUint16(i);for(const n of c){p.writeUint32(1297379947);const{isMeta:c,channel:u,midiChannel:f,isNoise:m,isDrumset:y}=n,g=p.getWriteIndex();p.writeUint32(0);let b=0,v=0;const w=function(t){if(t<b)throw new Error("Midi event time cannot go backwards.");p.writeMidiVariableLength(t-b),b=t},k=function(t,e){if(!(e>=0&&e<=127))throw new Error("Midi control event value out of range: "+e);p.writeUint8(176|f),p.writeMidi7Bits(t),p.writeMidi7Bits(0|e)};if(c){w(0),p.writeUint8(255),p.writeMidi7Bits(1),p.writeMidiAscii("Composed with https://www.beepbox.co"),w(0),p.writeUint8(255),p.writeMidi7Bits(81),p.writeMidiVariableLength(3),p.writeUint24(o),w(0),p.writeUint8(255),p.writeMidi7Bits(88),p.writeMidiVariableLength(4),p.writeUint8(t.beatsPerBar),p.writeUint8(2),p.writeUint8(24),p.writeUint8(8);const i=e.scales[t.scale].flags[3]&&!e.scales[t.scale].flags[4],s=t.key;let n=s;for(1==(1&s)&&(n+=6),i&&(n+=9);n>6;)n-=12;w(0),p.writeUint8(255),p.writeMidi7Bits(89),p.writeMidiVariableLength(2),p.writeInt8(n),p.writeUint8(i?1:0),this.zo.checked&&(v+=r*t.loopStart),w(v),p.writeUint8(255),p.writeMidi7Bits(6),p.writeMidiAscii("Loop Start");for(let e=0;e<parseInt(this.Ao.value);e++)v+=r*t.loopLength,w(v),p.writeUint8(255),p.writeMidi7Bits(6),p.writeMidiAscii(e<Number(this.Ao.value)-1?"Loop Repeat":"Loop End");if(this.Ro.checked&&(v+=r*(t.barCount-t.loopStart-t.loopLength)),v!=r*l.length)throw new Error("Miscalculated number of bars.")}else{let n=$.getChannelColor(t,u).name+" channel";w(0),p.writeUint8(255),p.writeMidi7Bits(3),p.writeMidiAscii(n),w(0),k(101,0),w(0),k(100,0),w(0),k(6,a),w(0),k(38,0),w(0),k(101,127),w(0),k(100,127);let o=-1;function c(i){const s=t.channels[u].instruments[i],n=x.valueToPreset(s.preset);if(o!=i){if(o=i,w(v),p.writeUint8(255),p.writeMidi7Bits(4),p.writeMidiAscii("Instrument "+(i+1)),!y){let t=81;if(null!=n&&null!=n.midiProgram)t=n.midiProgram;else if(4==s.type)t=116;else if(2==s.type||3==s.type)t=m?116:75;else if(0==s.type)As.midiChipInstruments.length>s.chipWave&&(t=As.midiChipInstruments[s.chipWave]);else if(6==s.type||1==s.type||5==s.type)t=81;else{if(7!=s.type)throw new Error("Unrecognized instrument type.");t=25}w(v),p.writeUint8(192|f),p.writeMidi7Bits(t)}w(v);let t=(r=Mt.instrumentVolumeToVolumeMult(s.volume),127*Math.pow(.3844015376046128*r,.25));k(7,Math.min(127,Math.round(t))),w(v);let h=63*(s.pan/e.panCenter-1)+64;k(10,Math.min(127,Math.round(h)))}var r}null==t.getPattern(u,0)&&c(0);let g=Ss,b=127,M=!1;const S=m?e.spectrumBasePitch:e.keys[t.key].basePitch,P=m?e.noiseInterval:1;for(const n of l){const o=t.getPattern(u,n);if(null!=o){const n=o.instruments[0],r=t.channels[u].instruments[n],l=x.valueToPreset(r.preset);c(n);let F=r.getChord().arpeggiates,E=F?1:e.maxChordSize;r.getChord().customInterval&&(0==r.type||5==r.type?(E=2,F=!0):1==r.type?E=e.operatorCount:console.error("Unrecognized instrument type for harmonizing arpeggio: "+r.type));for(let n=0;n<o.notes.length;n++){const r=o.notes[n],c=v+r.start*s;let u=c,I=r.pins[0].size,q=r.pins[0].interval;const T=[-1,-1,-1,-1],C=[-1,-1,-1,-1],L=Math.min(E,r.pitches.length),D=y?Math.max(1,Math.round(90*r.pins[0].size/e.noteSizeMax)):90;let z=r.pickMainInterval(),A=z*P;if(!y){let t=a,e=-24;for(let i=1;i<r.pins.length;i++){const s=r.pins[i].interval*P;t=Math.min(t,s+a),e=Math.max(e,s-a)}A=Math.min(t,Math.max(e,A))}for(let n=1;n<r.pins.length;n++){const o=c+r.pins[n].time*s,M=r.pins[n].size,E=r.pins[n].interval,R=o-u;for(let n=0;n<R;n++){const o=u+n,O=Ds(I,M,n/R),B=Ds(q,E,n/R)*P-A,N=Math.max(0,Math.min(16383,Math.round(8192*(1+B/a)))),H=Math.min(127,Math.round((d=Mt.noteSizeToVolumeMult(O),127*Math.pow(d,.25))));N!=g&&(w(o),p.writeUint8(224|f),p.writeMidi7Bits(127&N),p.writeMidi7Bits(N>>7&127),g=N),H==b||y||(w(o),k(11,H),b=H);const G=o==c;for(let n=0;n<L;n++){let a=r.pitches[n];if(y){a+=z;const t=[36,41,45,48,40,39,59,49,46,55,69,54];if(a<0||a>=t.length)throw new Error("Could not find corresponding drumset pitch. "+a);a=t[a]}else{if(F&&r.pitches.length>n+1&&n==L-1){const l=(o-v)%i,c=e.rhythms[t.rhythm].ticksPerArpeggio*s/e.ticksPerPart,u=Math.floor(l/c);a=r.pitches[n+h(r.pitches.length-n,t.rhythm,u)]}a=S+a*P+A,null!=l&&null!=l.midiSubharmonicOctaves?a+=12*l.midiSubharmonicOctaves:m&&(a+=12*+x.presetCategories.dictionary["Drum Presets"].presets.dictionary["taiko drum"].midiSubharmonicOctaves),m&&(a*=2)}a=Math.max(0,Math.min(127,a)),C[n]=a,G||T[n]==C[n]||(w(o),p.writeUint8(128|f),p.writeMidi7Bits(T[n]),p.writeMidi7Bits(D))}for(let t=0;t<L;t++)(G||T[t]!=C[t])&&(w(o),p.writeUint8(144|f),p.writeMidi7Bits(C[t]),p.writeMidi7Bits(D),T[t]=C[t])}u=o,I=M,q=E}const R=v+r.end*s;for(let t=0;t<L;t++)w(R),p.writeUint8(128|f),p.writeMidi7Bits(T[t]),p.writeMidi7Bits(D);M=!0}}else M&&(M=!1,127!=b&&(b=127,w(v),k(11,b)),g!=Ss&&(g=Ss,w(v),p.writeUint8(224|f),p.writeMidi7Bits(127&g),p.writeMidi7Bits(g>>7&127)));v+=r}}w(v),p.writeUint8(255),p.writeMidi7Bits(47),p.writeMidiVariableLength(0),p.rewriteUint32(g,p.getWriteIndex()-g-4)}var d;zs(new Blob([p.toCompactArrayBuffer()],{type:"audio/midi"}),this.Do.value.trim()+".mid"),this.J()}Uo(){const t=this.W.song.toJsonObject(this.zo.checked,Number(this.Ao.value),this.Ro.checked),e=JSON.stringify(t,null,"\t");zs(new Blob([e],{type:"application/json"}),this.Do.value.trim()+".json"),this.J()}Vo(){const t=`<!DOCTYPE html><meta charset="utf-8">\n\nYou should be redirected to the song at:<br /><br />\n\n<a id="destination" href="${new URL("#"+this.W.song.toBase64String(),location.href).href}"></a>\n\n<style>\n\t:root {\n\t\tcolor: white;\n\t\tbackground: black;\n\t\tfont-family:\n\t\tsans-serif;\n\t}\n\ta {\n\t\tcolor: #98f;\n\t}\n\ta[href]::before {\n\t\tcontent: attr(href);\n\t}\n</style>\n\n<script>\n\tlocation.assign(document.querySelector("a#destination").href);\n<\/script>\n`;zs(new Blob([t],{type:"text/html"}),this.Do.value.trim()+".html"),this.J()}}As.midiChipInstruments=[74,71,80,70,68,81,81,81,81];class Rs{constructor(t){this.I=0,this.Co=t}getReadIndex(){return this.I}readUint32(){if(this.I+4>this.Co.byteLength)throw new Error("Reading past the end of the buffer.");const t=this.Co.getUint32(this.I,!1);return this.I+=4,t}readUint24(){return this.readUint8()<<16|this.readUint8()<<8|this.readUint8()}readUint16(){if(this.I+2>this.Co.byteLength)throw new Error("Reading past the end of the buffer.");const t=this.Co.getUint16(this.I,!1);return this.I+=2,t}readUint8(){if(this.I+1>this.Co.byteLength)throw new Error("Reading past the end of the buffer.");const t=this.Co.getUint8(this.I);return this.I++,t}readInt8(){if(this.I+1>this.Co.byteLength)throw new Error("Reading past the end of the buffer.");const t=this.Co.getInt8(this.I);return this.I++,t}peakUint8(){if(this.I+1>this.Co.byteLength)throw new Error("Reading past the end of the buffer.");return this.Co.getUint8(this.I)}readMidi7Bits(){const t=this.readUint8();return t>=128&&console.log("7 bit value contained 8th bit! value "+t+", index "+this.I),127&t}readMidiVariableLength(){let t=0;for(let e=0;e<4;e++){const e=this.readUint8();if(t+=127&e,!(128&e))break;t<<=7}return t}skipBytes(t){this.I+=t}hasMore(){return this.Co.byteLength>this.I}getReaderForNextBytes(t){if(this.I+t>this.Co.byteLength)throw new Error("Reading past the end of the buffer.");const e=new Rs(new DataView(this.Co.buffer,this.Co.byteOffset+this.I,t));return this.skipBytes(t),e}}const{button:Os,p:Bs,div:Ns,h2:Hs,input:Gs}=z;class $s{constructor(t){this.W=t,this.tn=Gs({type:"file",accept:".json,application/json,.mid,.midi,audio/midi,audio/x-midi"}),this.sn=Os({class:"cancelButton"}),this.container=Ns({class:"prompt noSelection",style:"width: 300px;"},Hs("Import"),Bs({style:"text-align: left; margin: 0.5em 0;"},"BeepBox songs can be exported and re-imported as .json files. You could also use other means to make .json files for BeepBox as long as they follow the same structure."),Bs({style:"text-align: left; margin: 0.5em 0;"},"BeepBox can also (crudely) import .mid files. There are many tools available for creating .mid files. Shorter and simpler songs are more likely to work well."),this.tn,this.sn),this.J=()=>{this.W.undo()},this.cleanUp=()=>{this.tn.removeEventListener("change",this.jo),this.sn.removeEventListener("click",this.J)},this.jo=()=>{const t=this.tn.files[0];if(!t)return;const e=t.name.slice(2+(t.name.lastIndexOf(".")-1>>>0));if("json"==e){const e=new FileReader;e.addEventListener("load",(t=>{this.W.prompt=null,this.W.goBackToStart(),this.W.record(new Ve(this.W,e.result),!0,!0)})),e.readAsText(t)}else if("midi"==e||"mid"==e){const e=new FileReader;e.addEventListener("load",(t=>{this.W.prompt=null,this.W.goBackToStart(),this.Jo(e.result)})),e.readAsArrayBuffer(t)}else console.error("Unrecognized file extension."),this.J()},this.tn.select(),setTimeout((()=>this.tn.focus())),this.tn.addEventListener("change",this.jo),this.sn.addEventListener("click",this.J)}Jo(t){const i=new Rs(new DataView(t));let s=null;const n=[];for(;i.hasMore();){const t=i.readUint32(),e=i.readUint32();if(1297377380==t)null==s?s=i.getReaderForNextBytes(e):console.error("This MIDI file has more than one header chunk.");else if(1297379947==t){const t=i.getReaderForNextBytes(e);t.hasMore()&&n.push({reader:t,nextEventMidiTick:t.readMidiVariableLength(),ended:!1,runningStatus:-1})}else i.skipBytes(e)}if(null==s)return console.error("No header chunk found in this MIDI file."),void this.J();const o=s.readUint16();s.readUint16();const r=s.readUint16();let h=0;const a=[],l=2==o;if(l)a.push(h);else for(let t=0;t<n.length;t++)a.push(t);const c=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],u=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],f=[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],d=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],m=[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],y=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],g=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],b=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],v=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];let w=5e5,k=8,M=0,S=!1,P=0;for(;;){let t=Number.MAX_VALUE,i=!1;for(const s of a){const o=n[s];for(;!o.ended&&o.nextEventMidiTick==P;){const s=128&o.reader.peakUint8()?o.reader.readUint8():o.runningStatus,r=240&s,x=15&s;240!=r&&(o.runningStatus=s);let E=!1;switch(r){case 128:{const t=o.reader.readMidi7Bits();o.reader.readMidi7Bits(),g[x].push({midiTick:P,pitch:t,velocity:0,program:-1,instrumentVolume:-1,instrumentPan:-1,on:!1})}break;case 144:{const t=o.reader.readMidi7Bits(),i=o.reader.readMidi7Bits();if(0==i)g[x].push({midiTick:P,pitch:t,velocity:0,program:-1,instrumentVolume:-1,instrumentPan:-1,on:!1});else{const s=Math.max(0,Math.min(e.volumeRange-1,Math.round(Mt.volumeMultToInstrumentVolume(Fs(m[x]))))),n=Math.max(0,Math.min(e.panMax,Math.round(((y[x]-64)/63+1)*e.panCenter)));g[x].push({midiTick:P,pitch:t,velocity:Math.max(0,Math.min(1,(i+14)/90)),program:d[x],instrumentVolume:s,instrumentPan:n,on:!0})}}break;case 160:o.reader.readMidi7Bits(),o.reader.readMidi7Bits();break;case 176:{const t=o.reader.readMidi7Bits(),e=o.reader.readMidi7Bits();switch(t){case 6:0==c[x]&&0==u[x]&&(f[x]=e);break;case 7:m[x]=e;break;case 10:y[x]=e;break;case 11:v[x].push({midiTick:P,size:Mt.volumeMultToNoteSize((F=e,Math.pow(F/127,4)))});break;case 38:0==c[x]&&0==u[x]&&(p[x]=e);break;case 100:u[x]=e;break;case 101:c[x]=e}}break;case 192:{const t=o.reader.readMidi7Bits();d[x]=t}break;case 208:o.reader.readMidi7Bits();break;case 224:{const t=o.reader.readMidi7Bits(),e=((o.reader.readMidi7Bits()<<7|t)/8192-1)*(f[x]+.01*p[x]);b[x].push({midiTick:P,interval:e})}break;case 240:if(255==s){const t=o.reader.readMidi7Bits(),i=o.reader.readMidiVariableLength();if(47==t)E=!0,o.reader.skipBytes(i);else if(81==t)w=o.reader.readUint24(),o.reader.skipBytes(i-3);else if(88==t){const t=o.reader.readUint8();let s=o.reader.readUint8();for(o.reader.readUint8(),o.reader.readUint8(),o.reader.skipBytes(i-4),k=4*t;0==(1&k)&&(s>0||k>e.beatsPerBarMax)&&k>=2*e.beatsPerBarMin;)k>>=1,s-=1;k=Math.max(e.beatsPerBarMin,Math.min(e.beatsPerBarMax,k))}else 89==t?(M=o.reader.readInt8(),S=1==o.reader.readUint8(),o.reader.skipBytes(i-2)):o.reader.skipBytes(i)}else{if(240!=s&&247!=s)return console.error("Unrecognized event status: "+s),void this.J();{const t=o.reader.readMidiVariableLength();o.reader.skipBytes(t)}}break;default:return console.error("Unrecognized event type: "+r),void this.J()}!E&&o.reader.hasMore()?o.nextEventMidiTick=P+o.reader.readMidiVariableLength():(o.ended=!0,l&&(h++,h<n.length&&(a[0]=h,n[h].nextEventMidiTick+=P,t=Math.min(t,n[h].nextEventMidiTick),i=!0)))}o.ended||(i=!0,t=Math.min(t,o.nextEventMidiTick))}if(!i)break;P=t}var F;const E=Math.max(e.tempoMin,Math.min(e.tempoMax,Math.round(6e7/w))),I=r/e.partsPerBeat,q=e.partsPerBeat*k,T=Math.ceil(P/I/q);function C(t){return Math.round(t/I)}let L=M;for(S&&(L+=3),1==(1&L)&&(L+=6);L<0;)L+=12;L%=12;const D=[],z=[];for(let t=0;t<16;t++){if(0==g[t].length)continue;const i=new mt,s=x.midiProgramToPresetValue(g[t][0].program),n=null==s?null:x.valueToPreset(s),o=9==t,h=o||null!=n&&1==n.isNoise,a=h?e.spectrumBasePitch:e.keys[L].basePitch,l=h?e.noiseInterval:1,c=h?.5:1,u=h?e.drumCount-1:e.maxPitch;h?o?z.unshift(i):z.push(i):D.push(i);let f=1,p=0,d=0,m=e.panCenter;if(o){const s=[];let n=-1,o=null,r=0,h=!1;const a=x.nameToPresetValue("standard drumset"),l=x.valueToPreset(a),c=new dt(!1);c.fromJsonObject(l.settings,!1,1),c.preset=a,i.instruments.push(c);for(let a=0;a<=g[t].length;a++){const l=a==g[t].length?null:g[t][a],p=null==l?Number.MAX_SAFE_INTEGER:C(l.midiTick);if(s.length>0&&p>r&&(null==l||l.on)){const t=Math.floor(r/q),a=t*q;if(n!=t||null==o){for(n++;n<t;)i.bars[n]=0,n++;o=new ht,i.patterns.push(o),i.bars[n]=i.patterns.length,o.instruments[0]=0,o.instruments.length=1}(!h||c.volume>d)&&(c.volume=d,c.pan=m,h=!0);const l=[];let y=u,g=0,b=1;for(const t of s){const e=Ps[t];-1==l.indexOf(e.frequency)&&l.push(e.frequency),b=Math.max(b,Math.round(e.volume*f)),y=Math.min(y,e.duration),g=Math.max(g,e.duration)}const v=Math.min(g,Math.max(y,2)),w=r-a,k=Math.min(q,Math.min(p-a,w+6*v)),M=new rt(-1,w,k,b,!0);M.pitches.length=0;for(let t=0;t<Math.min(e.maxChordSize,l.length);t++){const i=l[t+Math.max(0,l.length-e.maxChordSize)];-1==M.pitches.indexOf(i)&&M.pitches.push(i)}o.notes.push(M),s.length=0}null!=l&&l.on&&null!=Ps[l.pitch]&&(s.push(l.pitch),r=p,f=l.velocity,d=l.instrumentVolume,m=l.instrumentPan)}}else{let s=0,n=e.noteSizeMax,o=0,y=0;function w(e){for(;o<b[t].length&&b[t][o].midiTick<=e;)s=b[t][o].interval,o++}function M(e){for(;y<v[t].length&&v[t][y].midiTick<=e;)n=v[t][y].size,y++}const S=[],P=[];let F=-1,E=null,T=0,L=0,D=0,z=0;for(let o of g[t]){const t=o.midiTick,y=C(t);if(P.length>0&&y>L){const o=Math.floor(L/q),g=Math.ceil(y/q);let b=!1;for(let v=o;v<g;v++){const o=v*q,g=v*k*r,C=(v+1)*k*r,A=Math.max(0,L-o),R=Math.min(q,y-o),O=Math.max(g,T),B=Math.min(C,t);if(A<R){const t=x.midiProgramToPresetValue(p),r=null==t?null:x.valueToPreset(t);if(F!=v||null==E){for(F++;F<v;)i.bars[F]=0,F++;if(E=new ht,i.patterns.push(E),i.bars[F]=i.patterns.length,null==S[p]){const e=new dt(h);S[p]=e,null!=t&&null!=r&&1==r.isNoise==h?(e.fromJsonObject(r.settings,h,1),e.preset=t):(e.setTypeAndReset(h?2:0,h),e.chord=0),e.volume=d,e.pan=m,i.instruments.push(e)}E.instruments[0]=i.instruments.indexOf(S[p]),E.instruments.length=1}null!=S[p]&&(S[p].volume=Math.min(S[p].volume,d),S[p].pan=Math.min(S[p].pan,m));const y=new rt(-1,A,R,e.noteSizeMax,!1);y.pins.length=0,y.continuesLastPattern=b&&0==A,b=!0,w(O),M(O);const g=P[0]*c-a,k=Math.round((g+s)/l),q=Math.round(s-a);let T=st(0,0,Math.round(f*n));y.pins.push(T);const C=[{part:0,pitch:k,size:T.size,keyPitch:!1,keySize:!1}];let L=0,N=(g+s)/l,H=f*n;for(let t=A+1;t<=R;t++){const e=Math.max(O,Math.min(B-1,Math.round(I*(t+o)))),i=t-A,r=t==R;w(e),M(e);const h=(s+g)/l,a=f*n,c=Math.round(h),u=Math.abs(h-c)<.01,p=Math.abs(N-Math.round(N))<.01?Math.abs(h-N)>=1:Math.floor(h)!=Math.floor(N),d=u||p,m=Math.round(a),b=Math.abs(a-m)<.01,v=Math.abs(H-Math.round(H))?Math.abs(a-H)>=1:Math.floor(a)!=Math.floor(H),x=b||v;if(N=h,H=a,d||x||r){const t={part:i,pitch:c,size:m,keyPitch:d||r,keySize:x||r},e=C[L];let s=!1,n=Number.MAX_VALUE;if(t.keyPitch){const i=(t.pitch-e.pitch)/(t.part-e.part);let o=Math.abs(i),r=!1,h=Number.MAX_VALUE;for(let t=L+1;t<C.length;t++){const s=C[t];if(s.keyPitch){const n=e.pitch+i*(s.part-e.part),a=Math.abs(n-s.pitch);o<a&&(o=a,r=!0,h=t)}}r&&(s=!0,n=Math.min(n,h))}if(t.keySize){const i=(t.size-e.size)/(t.part-e.part);let o=Math.abs(i),r=!1,h=Number.MAX_VALUE;for(let t=L+1;t<C.length;t++){const s=C[t];if(s.keySize){const n=e.size+i*(s.part-e.part),a=Math.abs(n-s.size);o<a&&(o=a,r=!0,h=t)}}r&&(s=!0,n=Math.min(n,h))}if(s){const t=C[n];y.pins.push(st(t.pitch-k,t.part,t.size)),L=n}C.push(t)}}const G=C[C.length-1];y.pins.push(st(G.pitch-k,G.part,G.size));let $=u,_=0;for(const t of y.pins)$=Math.min($,u-t.interval),_=Math.min(_,-t.interval);y.pitches.length=0;for(let t=0;t<Math.min(e.maxChordSize,P.length);t++){let i=P[t+Math.max(0,P.length-e.maxChordSize)]*c;null!=r&&null!=r.midiSubharmonicOctaves&&(i-=12*r.midiSubharmonicOctaves);const s=Math.max(_,Math.min($,Math.round((i+q)/l)));if(-1==y.pitches.indexOf(s)){y.pitches.push(s);const t=y.end-y.start;D+=s*t,z+=t}}E.notes.push(y)}}}-1!=P.indexOf(o.pitch)&&P.splice(P.indexOf(o.pitch),1),o.on&&(P.push(o.pitch),f=o.velocity,p=o.program,d=o.instrumentVolume,m=o.instrumentPan),T=t,L=y}const A=D/z;i.octave=h?0:Math.max(0,Math.min(e.pitchOctaves-1,Math.floor(A/12)))}for(;i.bars.length<T;)i.bars.push(0)}function A(t,e){for(;t.length>e;){let e=t.length-2,i=t.length-1,s=Number.MAX_VALUE,n=Number.MAX_VALUE;for(let o=0;o<t.length-1;o++)for(let r=o+1;r<t.length;r++){const h=t[o],a=t[r];let l=0,c=0;for(let t=0;t<h.bars.length&&t<a.bars.length;t++)0!=h.bars[t]&&0!=a.bars[t]&&l++,0==h.bars[t]&&0==a.bars[t]&&c++;l<=s&&(l<s||c<n)&&(e=o,i=r,s=l,n=c)}const o=t[e],r=t[i],h=o.instruments.length,a=o.patterns.length;for(const t of r.instruments)o.instruments.push(t);for(const t of r.patterns)t.instruments[0]+=h,o.patterns.push(t);for(let t=0;t<o.bars.length&&t<r.bars.length;t++)0==o.bars[t]&&0!=r.bars[t]&&(o.bars[t]=r.bars[t]+a);t.splice(i,1)}}A(D,e.pitchChannelCountMax),A(z,e.noiseChannelCountMax);this.W.goBackToStart();for(const t of this.W.song.channels)t.muted=!1;this.W.prompt=null,this.W.record(new class extends Tt{constructor(t){super();const e=t.song;e.tempo=E,e.beatsPerBar=k,e.key=L,e.scale=11,e.rhythm=1,e.layeredInstruments=!1,e.patternInstruments=D.some((t=>t.instruments.length>1))||z.some((t=>t.instruments.length>1)),Ye(D),Ye(z),this.append(new je(t,D,z)),e.loopStart=0,e.loopLength=e.barCount,this.K(),t.notifier.changed()}}(this.W),!0,!0)}}const _s="songVersion: ";function Us(t){return JSON.parse(t.substring(_s.length))}function Vs(t){return _s+JSON.stringify(t)}function Ws(){return(Math.random()*(-1>>>0)>>>0).toString(32)}function js(t,e){return e.versions[0].time-t.versions[0].time}function Js(t,e){return e.time-t.time}class Ys{constructor(){this.Yo=new yt}static getAllRecoveredSongs(){const t=[],e={};for(let i=0;i<localStorage.length;i++){const s=localStorage.key(i);if(0==s.indexOf(_s)){const i=Us(s);let n=e[i.uid];null==n&&(n={versions:[]},e[i.uid]=n,t.push(n)),n.versions.push(i)}}for(const e of t)e.versions.sort(Js);return t.sort(js),t}saveVersion(t,e){const i=Math.round(Date.now());clearTimeout(this.Ko),this.Ko=setTimeout((()=>{try{this.Yo.fromBase64String(e)}catch(t){return void window.alert('Whoops, the song data appears to have been corrupted! Please try to recover the last working version of the song from the "Recover Recent Song..." option in BeepBox\'s "File" menu.')}const s=Ys.getAllRecoveredSongs();let n=null;for(const e of s)e.versions[0].uid==t&&(n=e);null==n&&(n={versions:[]},s.unshift(n));let o=n.versions,r=1e3;if(o.length>0){const t=o[0].time;r=o[0].work+Math.min(18e4,i-t)}const h={uid:t,time:i,work:r},a=Vs(h);o.unshift(h),localStorage.setItem(a,e);let l=6e4;const c=Math.pow(2,.5);for(var u=1;u<o.length;u++){if(o[u].work-(u==o.length-1?0:o[u+1].work)<l){let t=u;if(u<o.length-1){const e=o[u].time,i=o[u-1].time;e-o[u+1].time<.5*(i-e)&&(t=u+1)}localStorage.removeItem(Vs(o[t]));break}l*=c}for(;s.length>8;){let t=null,e=Number.POSITIVE_INFINITY;for(let n=Math.round(4);n<s.length;n++){const o=s[n],r=1/((i-o.versions[0].time)/432e5+1),h=(o.versions[0].work+3e5)*r;e>h&&(e=h,t=o)}for(const e of t.versions)localStorage.removeItem(Vs(e));s.splice(s.indexOf(t),1)}}),750)}}const{button:Ks,div:Qs,h2:Zs,p:Xs,select:tn,option:en,iframe:sn}=z;class nn{constructor(t){this.W=t,this.Qo=Qs(),this.sn=Ks({class:"cancelButton"}),this.container=Qs({class:"prompt",style:"width: 300px;"},Zs("Song Recovery"),Qs({style:"max-height: 385px; overflow-y: auto;"},Xs("This is a TEMPORARY list of songs you have recently modified. Please keep your own backups of songs you care about!"),this.Qo,Xs('(If "Display Song Data in URL" is enabled in your preferences, then you may also be able to find song versions in your browser history. However, song recovery won\'t work if you were browsing in private/incognito mode.)')),this.sn),this.J=()=>{this.W.undo()},this.cleanUp=()=>{this.sn.removeEventListener("click",this.J)},this.sn.addEventListener("click",this.J);const e=Ys.getAllRecoveredSongs();0==e.length&&this.Qo.appendChild(Xs("There are no recovered songs available yet. Try making a song!"));for(const t of e){const e=tn({style:"width: 100%;"});for(const i of t.versions)e.appendChild(en({value:i.time},new Date(i.time).toLocaleString()));const i=sn({style:"width: 100%; height: 60px; border: none; display: block;"});i.src="player/#song="+window.localStorage.getItem(Vs(t.versions[0]));const s=Qs({style:"margin: 4px 0;"},Qs({class:"selectContainer",style:"width: 100%; margin: 2px 0;"},e),i);this.Qo.appendChild(s),e.addEventListener("change",(()=>{const s=t.versions[e.selectedIndex];i.contentWindow.location.replace("player/#song="+window.localStorage.getItem(Vs(s))),i.contentWindow.dispatchEvent(new Event("hashchange"))}))}}}const{a:on,button:rn,div:hn,input:an,select:ln,span:cn,optgroup:un,option:fn}=z;function pn(t,e){for(let i=0;i<e.length;i++)t.appendChild(fn({value:i},e[i]));return t}function dn(t){const e=ln();e.appendChild(un({label:"Edit"},fn({value:"copyInstrument"},"Copy Instrument (⇧C)"),fn({value:"pasteInstrument"},"Paste Instrument (⇧V)"),fn({value:"randomPreset"},"Random Preset (R)"),fn({value:"randomGenerated"},"Random Generated (⇧R)")));const i=un({label:x.presetCategories[0].name});t?(i.appendChild(fn({value:2},x.valueToPreset(2).name)),i.appendChild(fn({value:3},x.valueToPreset(3).name)),i.appendChild(fn({value:4},x.valueToPreset(4).name))):(i.appendChild(fn({value:0},x.valueToPreset(0).name)),i.appendChild(fn({value:6},x.valueToPreset(6).name)),i.appendChild(fn({value:5},x.valueToPreset(5).name)),i.appendChild(fn({value:7},x.valueToPreset(7).name)),i.appendChild(fn({value:3},x.valueToPreset(3).name)),i.appendChild(fn({value:1},x.valueToPreset(1).name))),e.appendChild(i);for(let i=1;i<x.presetCategories.length;i++){const s=x.presetCategories[i],n=un({label:s.name});let o=!1;for(let e=0;e<s.presets.length;e++){const r=s.presets[e];1==r.isNoise==t&&(n.appendChild(fn({value:(i<<6)+e},r.name)),o=!0)}o&&e.appendChild(n)}return e}function mn(t,e){const i=e.toString();t.value!=i&&(t.value=i)}class yn{constructor(t,e,i){this.input=t,this.W=e,this.Zo=i,this.fn=null,this.Xo=0,this.tr=0,this.er=()=>{this.W.lastChangeWas(this.fn)||(this.tr=this.Xo),this.fn=this.Zo(this.tr,parseInt(this.input.value)),this.W.setProspectiveChange(this.fn)},this.ir=()=>{this.W.record(this.fn),this.fn=null},t.addEventListener("input",this.er),t.addEventListener("change",this.ir)}updateValue(t){this.Xo=t,this.input.value=String(t)}}class gn{constructor(t){this.W=t,this.prompt=null,this.sr=new Mi(this.W,!1,-1),this.nr=new Mi(this.W,!0,0),this.rr=new Mi(this.W,!1,1),this.hr=new Fi(this.W),this.ar=new Ii(this.W),this.lr=new Ri(this.W),this.cr=new Hi(this.W),this.ur=new Gi(this.W),this.pr=rn({style:"width: 80px;",type:"button"}),this.dr=rn({class:"prevBarButton",style:"width: 40px;",type:"button",title:"Previous Bar (left bracket)"}),this.mr=rn({class:"nextBarButton",style:"width: 40px;",type:"button",title:"Next Bar (right bracket)"}),this.yr=an({title:"main volume",style:"width: 5em; flex-grow: 1; margin: 0;",type:"range",min:"0",max:"75",value:"50",step:"1"}),this.gr=ln({style:"width: 100%;"},fn({selected:!0,disabled:!0,hidden:!1},"File"),fn({value:"new"},"+ New Blank Song"),fn({value:"import"},"↑ Import Song... ("+x.ctrlSymbol+"O)"),fn({value:"export"},"↓ Export Song... ("+x.ctrlSymbol+"S)"),fn({value:"copyUrl"},"⎘ Copy Song URL"),fn({value:"shareUrl"},"⤳ Share Song URL"),fn({value:"shortenUrl"},"… Shorten Song URL"),fn({value:"viewPlayer"},"▶ View in Song Player"),fn({value:"copyEmbed"},"⎘ Copy HTML Embed Code"),fn({value:"songRecovery"},"⚠ Recover Recent Song...")),this.vr=ln({style:"width: 100%;"},fn({selected:!0,disabled:!0,hidden:!1},"Edit"),fn({value:"undo"},"Undo (Z)"),fn({value:"redo"},"Redo (Y)"),fn({value:"copy"},"Copy Pattern (C)"),fn({value:"pasteNotes"},"Paste Pattern Notes (V)"),fn({value:"pasteNumbers"},"Paste Pattern Numbers ("+x.ctrlSymbol+"⇧V)"),fn({value:"insertBars"},"Insert Bar (⏎)"),fn({value:"deleteBars"},"Delete Selected Bars (⌫)"),fn({value:"insertChannel"},"Insert Channel ("+x.ctrlSymbol+"⏎)"),fn({value:"deleteChannel"},"Delete Selected Channels ("+x.ctrlSymbol+"⌫)"),fn({value:"selectAll"},"Select All (A)"),fn({value:"selectChannel"},"Select Channel (⇧A)"),fn({value:"duplicatePatterns"},"Duplicate Reused Patterns (D)"),fn({value:"transposeUp"},"Move Notes Up (+ or ⇧+)"),fn({value:"transposeDown"},"Move Notes Down (- or ⇧-)"),fn({value:"moveNotesSideways"},"Move All Notes Sideways..."),fn({value:"beatsPerBar"},"Change Beats Per Bar..."),fn({value:"barCount"},"Change Song Length..."),fn({value:"channelSettings"},"Channel Settings... (Q)")),this.wr=ln({style:"width: 100%;"},fn({selected:!0,disabled:!0,hidden:!1},"Preferences"),fn({value:"autoPlay"},"Auto Play On Load"),fn({value:"autoFollow"},"Auto Follow Track"),fn({value:"enableNotePreview"},"Preview Added Notes"),fn({value:"showLetters"},"Show Piano Keys"),fn({value:"showFifth"},'Highlight "Fifth" Notes'),fn({value:"notesOutsideScale"},"Allow Notes Outside Scale"),fn({value:"setDefaultScale"},"Use Current Scale as Default"),fn({value:"showChannels"},"Show All Channels"),fn({value:"showScrollBar"},"Octave Scroll Bar"),fn({value:"alwaysShowSettings"},"Customize All Instruments"),fn({value:"instrumentCopyPaste"},"Instrument Copy/Paste Buttons"),fn({value:"enableChannelMuting"},"Enable Channel Muting"),fn({value:"displayBrowserUrl"},"Display Song Data in URL"),fn({value:"layout"},"Choose Layout..."),fn({value:"colorTheme"},"Light Theme")),this.kr=pn(ln(),e.scales.map((t=>t.name))),this.Mr=pn(ln(),e.keys.map((t=>t.name)).reverse()),this.Sr=new yn(an({style:"margin: 0; width: 4em; flex-grow: 1; vertical-align: middle;",type:"range",min:"0",max:"14",value:"7",step:"1"}),this.W,((t,e)=>new Ke(this.W,t,Math.round(120*Math.pow(2,(-4+e)/9))))),this.Pr=an({style:"width: 3em; margin-left: 0.4em; vertical-align: middle;",type:"number",step:"1"}),this.Fr=new yn(an({style:"margin: 0;",type:"range",min:"0",max:e.chorusRange-1,value:"0",step:"1"}),this.W,((t,e)=>new Xe(this.W,t,e))),this.Er=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("chorus")},"Chorus:"),this.Fr.input),this.qr=new yn(an({style:"margin: 0;",type:"range",min:"0",max:e.reverbRange-1,value:"0",step:"1"}),this.W,((t,e)=>new ti(this.W,t,e))),this.Tr=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("reverb")},"Reverb:"),this.qr.input),this.Cr=new yn(an({style:"margin: 0;",type:"range",min:"0",max:e.echoSustainRange-1,value:"0",step:"1"}),this.W,((t,e)=>new Ze(this.W,t,e))),this.Lr=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("echoSustain")},"Echo:"),this.Cr.input),this.Dr=new yn(an({style:"margin: 0;",type:"range",min:"0",max:e.echoDelayRange-1,value:"0",step:"1"}),this.W,((t,e)=>new Qe(this.W,t,e))),this.zr=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("echoDelay")},"Echo Delay:"),this.Dr.input),this.Ar=pn(ln(),e.rhythms.map((t=>t.name))),this.Rr=dn(!1),this.Or=dn(!0),this.Br=pn(ln(),e.algorithms.map((t=>t.name))),this.Nr=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("algorithm")},"Algorithm:"),hn({class:"selectContainer"},this.Br)),this.Hr=[],this.Gr=rn({type:"button",class:"add-instrument last-button"}),this.$r=rn({type:"button",class:"remove-instrument"}),this._r=hn({class:"instrument-bar"},this.$r,this.Gr),this.Ur=hn({class:"selectRow",style:"display: none;"},cn({class:"tip",onclick:()=>this.Ir("instrumentIndex")},"Instrument:"),this._r),this.Vr=rn({type:"button",class:"copy-instrument"},"Copy"),this.Wr=rn({type:"button",class:"paste-instrument"},"Paste"),this.jr=hn({class:"instrumentCopyPasteRow",style:"display: none;"},this.Vr,this.Wr),this.Jr=new yn(an({style:"margin: 0;",type:"range",min:-(e.volumeRange-1),max:"0",value:"0",step:"1"}),this.W,((t,e)=>new fi(this.W,t,-e))),this.Yr=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("instrumentVolume")},"Volume:"),this.Jr.input),this.Kr=new yn(an({style:"margin: 0;",type:"range",min:"0",max:e.panMax,value:e.panCenter,step:"1"}),this.W,((t,e)=>new pi(this.W,t,e))),this.Qr=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("pan")},"Panning:"),this.Kr.input),this.Zr=pn(ln(),e.chipWaves.map((t=>t.name))),this.Xr=pn(ln(),e.chipNoises.map((t=>t.name))),this.th=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("chipWave")},"Wave:"),hn({class:"selectContainer"},this.Zr)),this.eh=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("chipNoise")},"Noise:"),hn({class:"selectContainer"},this.Xr)),this.ih=new Si(this.W),this.sh=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("fadeInOut")},"Fade In/Out:"),this.ih.container),this.nh=pn(ln(),e.transitions.map((t=>t.name))),this.oh=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("transition")},"Transition:"),hn({class:"selectContainer"},this.nh)),this.rh=ln(fn({selected:!0,disabled:!0,hidden:!1})),this.hh=new Pi(this.W),this.ah=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("eqFilter")},"EQ Filter:"),this.hh.container),this.lh=new Pi(this.W,!0),this.uh=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("noteFilter")},"Note Filter:"),this.lh.container),this.fh=new yn(an({style:"margin: 0;",type:"range",min:"0",max:e.pulseWidthRange-1,value:"0",step:"1"}),this.W,((t,e)=>new re(this.W,t,e))),this.ph=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("pulseWidth")},"Pulse Width:"),this.fh.input),this.dh=new yn(an({style:"margin: 0;",type:"range",min:"0",max:e.pitchShiftRange-1,value:"0",step:"1"}),this.W,((t,e)=>new he(this.W,t,e))),this.mh=[hn({class:"pitchShiftMarker",style:{color:$.tonic}}),hn({class:"pitchShiftMarker",style:{color:$.tonic,left:"50%"}}),hn({class:"pitchShiftMarker",style:{color:$.tonic,left:"100%"}})],this.yh=[hn({class:"pitchShiftMarker",style:{color:$.fifthNote,left:700/24+"%"}}),hn({class:"pitchShiftMarker",style:{color:$.fifthNote,left:1900/24+"%"}})],this.gh=hn({style:"display: flex; position: relative;"},this.dh.input,hn({class:"pitchShiftMarkerContainer"},this.mh,this.yh)),this.bh=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("pitchShift")},"Pitch Shift:"),this.gh),this.wh=new yn(an({style:"margin: 0;",type:"range",min:"0",max:e.detuneMax,value:"0",step:"1"}),this.W,((t,e)=>new ae(this.W,t,e))),this.kh=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("detune")},"Detune:"),this.wh.input),this.Mh=new yn(an({style:"margin: 0;",type:"range",min:"0",max:e.distortionRange-1,value:"0",step:"1"}),this.W,((t,e)=>new le(this.W,t,e))),this.xh=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("distortion")},"Distortion:"),this.Mh.input),this.Sh=new yn(an({style:"margin: 0;",type:"range",min:"0",max:e.bitcrusherQuantizationRange-1,value:"0",step:"1"}),this.W,((t,e)=>new ue(this.W,t,e))),this.Ph=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("bitcrusherQuantization")},"Bit Crush:"),this.Sh.input),this.Fh=new yn(an({style:"margin: 0;",type:"range",min:"0",max:e.bitcrusherFreqRange-1,value:"0",step:"1"}),this.W,((t,e)=>new ce(this.W,t,e))),this.Eh=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("bitcrusherFreq")},"Freq Crush:"),this.Fh.input),this.Ih=new yn(an({style:"margin: 0;",type:"range",min:"0",max:e.stringSustainRange-1,value:"0",step:"1"}),this.W,((t,e)=>new fe(this.W,t,e))),this.qh=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("stringSustain")},"Sustain:"),this.Ih.input),this.Th=pn(ln(),e.unisons.map((t=>t.name))),this.Ch=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("unison")},"Unison:"),hn({class:"selectContainer"},this.Th)),this.Lh=pn(ln(),e.chords.map((t=>t.name))),this.Dh=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("chords")},"Chords:"),hn({class:"selectContainer"},this.Lh)),this.zh=pn(ln(),e.vibratos.map((t=>t.name))),this.Ah=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("vibrato")},"Vibrato:"),hn({class:"selectContainer"},this.zh)),this.Rh=hn({class:"editor-controls"}),this.Oh=pn(ln(),e.feedbacks.map((t=>t.name))),this.Bh=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("feedbackType")},"Feedback:"),hn({class:"selectContainer"},this.Oh)),this.Nh=new Oi(this.W,null),this.Hh=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("spectrum")},"Spectrum:"),this.Nh.container),this.Gh=new Bi(this.W),this.$h=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("harmonics")},"Harmonics:"),this.Gh.container),this._h=new xi(this.W),this.Uh=hn({class:"editor-controls"}),this.Vh=new yn(an({type:"range",min:"0",max:e.operatorAmplitudeMax,value:"0",step:"1",title:"Feedback Amplitude"}),this.W,((t,e)=>new we(this.W,t,e))),this.Wh=hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("feedbackVolume")},"Fdback Vol:"),this.Vh.input),this.jh=rn({type:"button",class:"customize-instrument"},"Customize Instrument"),this.Jh=rn({type:"button",class:"add-envelope"}),this.Yh=hn({class:"editor-controls"},this.ah,this.sh,this.th,this.eh,this.Nr,this.Rh,this.Bh,this.Wh,this.Hh,this.$h,this.Uh,this.ph,this.qh,this.Ch,hn({style:"margin: 2px 0; margin-left: 2em; display: flex; align-items: center;"},cn({style:"flex-grow: 1; text-align: center;"},cn({class:"tip",onclick:()=>this.Ir("effects")},"Effects")),hn({class:"effects-menu"},this.rh)),this.oh,this.Dh,this.bh,this.kh,this.Ah,this.uh,this.xh,this.Ph,this.Eh,this.Qr,this.Er,this.Lr,this.zr,this.Tr,hn({style:"margin: 2px 0; margin-left: 2em; display: flex; align-items: center;"},cn({style:"flex-grow: 1; text-align: center;"},cn({class:"tip",onclick:()=>this.Ir("envelopes")},"Envelopes")),this.Jh),this._h.container),this.Kh=hn({class:"editor-controls"},hn({style:`margin: 3px 0; text-align: center; color: ${$.secondaryText};`},"Instrument Settings"),this.Ur,this.jr,this.Yr,hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("instrumentType")},"Type:"),hn({class:"selectContainer"},this.Rr,this.Or)),this.jh,this.Yh),this.Qh=hn({class:"promptContainer",style:"display: none;"}),this.Zh=rn({class:"zoomInButton",type:"button",title:"Zoom In"}),this.Xh=rn({class:"zoomOutButton",type:"button",title:"Zoom Out"}),this.ta=hn({style:"flex: 1; height: 100%; display: flex; overflow: hidden; justify-content: center;"},this.sr.container,this.nr.container,this.rr.container),this.ea=hn({class:"pattern-area"},this.ur.container,this.ta,this.cr.container,this.Zh,this.Xh),this.An=hn({class:"trackContainer"},this.ar.container,this.lr.container),this.ia=hn({style:"position: absolute; width: 100%; height: 100%; pointer-events: none;"}),this.sa=hn({class:"trackAndMuteContainer"},this.hr.container,this.An,this.ia),this.na=new Ni(this.W,this.sa),this.oa=hn({class:"track-area"},this.sa,this.na.container),this.ra=hn({class:"instrument-settings-area"},this.Kh),this.ha=hn({class:"settings-area noSelection"},hn({class:"version-area"},hn({style:`text-align: center; margin: 3px 0; color: ${$.secondaryText};`},x.versionDisplayName," ",on({class:"tip",target:"_blank",href:x.releaseNotesURL},x.version))),hn({class:"play-pause-area"},hn({class:"playback-bar-controls"},this.pr,this.dr,this.mr),hn({class:"playback-volume-controls"},cn({class:"volume-speaker"}),this.yr)),hn({class:"menu-area"},hn({class:"selectContainer menu file"},this.gr),hn({class:"selectContainer menu edit"},this.vr),hn({class:"selectContainer menu preferences"},this.wr)),hn({class:"song-settings-area"},hn({class:"editor-controls"},hn({style:`margin: 3px 0; text-align: center; color: ${$.secondaryText};`},"Song Settings"),hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("scale")},"Scale:"),hn({class:"selectContainer"},this.kr)),hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("key")},"Key:"),hn({class:"selectContainer"},this.Mr)),hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("tempo")},"Tempo:"),cn({style:"display: flex;"},this.Sr.input,this.Pr)),hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("rhythm")},"Rhythm:"),hn({class:"selectContainer"},this.Ar)))),this.ra),this.mainLayer=hn({class:"beepboxEditor",tabIndex:"0"},this.ea,this.oa,this.ha,this.Qh),this.aa=!1,this.la=null,this.ca=-1,this.ua=0,this.fa=!1,this.pa=[],this.da=[],this.ma=[],this.ya=[],this.ga=[],this.ba=()=>{this.mainLayer.focus({preventScroll:!0})},this.whenUpdated=()=>{this.hr.container.style.display=this.W.enableChannelMuting?"":"none";const t=this.ia.getBoundingClientRect();if(this.W.trackVisibleBars=Math.floor((t.right-t.left-(this.W.enableChannelMuting?32:0))/this.W.getBarWidth()),this.W.trackVisibleChannels=Math.floor((t.bottom-t.top-30)/this.W.getChannelHeight()),this.na.render(),this.hr.render(),this.ar.render(),this.ur.container.style.display=this.W.showLetters?"":"none",this.cr.container.style.display=this.W.showScrollBar?"":"none",this.na.container.style.display=this.W.song.barCount>this.W.trackVisibleBars?"":"none",this.W.getFullScreen()){const t=5*(this.ta.clientHeight/this.W.getVisiblePitchCount()),e=this.ta.clientWidth/(3*this.W.song.beatsPerBar),i=this.ta.clientWidth/(this.W.song.beatsPerBar+2),s=Math.max(e,Math.min(i,t))*this.W.song.beatsPerBar;this.sr.container.style.width=s+"px",this.nr.container.style.width=s+"px",this.rr.container.style.width=s+"px",this.sr.container.style.flexShrink="0",this.nr.container.style.flexShrink="0",this.rr.container.style.flexShrink="0",this.sr.container.style.display="",this.rr.container.style.display="",this.sr.render(),this.rr.render(),this.Zh.style.display="",this.Xh.style.display="",this.Zh.style.right=this.W.showScrollBar?"24px":"4px",this.Xh.style.right=this.W.showScrollBar?"24px":"4px"}else this.nr.container.style.width="",this.nr.container.style.flexShrink="",this.sr.container.style.display="none",this.rr.container.style.display="none",this.Zh.style.display="none",this.Xh.style.display="none";this.nr.render();const i=[(this.W.autoPlay?"✓ ":"　")+"Auto Play On Load",(this.W.autoFollow?"✓ ":"　")+"Auto Follow Track",(this.W.enableNotePreview?"✓ ":"　")+"Preview Added Notes",(this.W.showLetters?"✓ ":"　")+"Show Piano Keys",(this.W.showFifth?"✓ ":"　")+'Highlight "Fifth" Notes',(this.W.notesOutsideScale?"✓ ":"　")+"Allow Notes Outside Scale",(this.W.defaultScale==this.W.song.scale?"✓ ":"　")+"Use Current Scale as Default",(this.W.showChannels?"✓ ":"　")+"Show All Channels",(this.W.showScrollBar?"✓ ":"　")+"Octave Scroll Bar",(this.W.alwaysShowSettings?"✓ ":"　")+"Customize All Instruments",(this.W.instrumentCopyPaste?"✓ ":"　")+"Instrument Copy/Paste Buttons",(this.W.enableChannelMuting?"✓ ":"　")+"Enable Channel Muting",(this.W.displayBrowserUrl?"✓ ":"　")+"Display Song Data in URL","　Choose Layout...",("light classic"==this.W.colorTheme?"✓ ":"　")+"Light Theme"];for(let t=0;t<i.length;t++){const e=this.wr.children[t+1];e.textContent!=i[t]&&(e.textContent=i[t])}const s=this.W.song.channels[this.W.channel],o=this.W.getCurrentInstrument(),r=s.instruments[o],h=this.mainLayer.contains(document.activeElement),a=document.activeElement,k=$.getChannelColor(this.W.song,this.W.channel);for(let t=this.rh.childElementCount-1;t<e.effectOrder.length;t++)this.rh.appendChild(fn({value:t}));this.rh.selectedIndex=0;for(let t=0;t<e.effectOrder.length;t++){let i=e.effectOrder[t];const s=(0!=(r.effects&1<<i)?"✓ ":"　")+e.effectNames[i],n=this.rh.children[t+1];n.textContent!=s&&(n.textContent=s)}if(mn(this.kr,this.W.song.scale),this.kr.title=e.scales[this.W.song.scale].realName,mn(this.Mr,e.keys.length-1-this.W.song.key),this.Sr.updateValue(Math.max(0,Math.min(28,Math.round(4+9*Math.log2(this.W.song.tempo/120))))),this.Pr.value=this.W.song.tempo.toString(),mn(this.Ar,this.W.song.rhythm),this.W.song.getChannelIsNoise(this.W.channel)?(this.Rr.style.display="none",this.Or.style.display="",mn(this.Or,r.preset)):(this.Rr.style.display="",this.Or.style.display="none",mn(this.Rr,r.preset)),this.W.instrumentCopyPaste?this.jr.style.display="":this.jr.style.display="none",this.W.alwaysShowSettings||r.preset==r.type){if(this.jh.style.display="none",this.Yh.style.display="",2==r.type?(this.eh.style.display="",mn(this.Xr,r.chipNoise)):this.eh.style.display="none",3==r.type?(this.Hh.style.display="",this.Nh.render()):this.Hh.style.display="none",5==r.type||7==r.type?(this.$h.style.display="",this.Gh.render()):this.$h.style.display="none",7==r.type?(this.qh.style.display="",this.Ih.updateValue(r.stringSustain)):this.qh.style.display="none",4==r.type){this.Uh.style.display="",this.sh.style.display="none";for(let t=0;t<e.drumCount;t++)mn(this.ga[t],r.drumsetEnvelopes[t]),this.ya[t].render()}else this.Uh.style.display="none",this.sh.style.display="",this.ih.render();if(0==r.type?(this.th.style.display="",mn(this.Zr,r.chipWave)):this.th.style.display="none",1==r.type){this.Nr.style.display="",this.Rh.style.display="",this.Bh.style.display="",this.Wh.style.display="",mn(this.Br,r.algorithm),mn(this.Oh,r.feedbackType),this.Vh.updateValue(r.feedbackAmplitude);for(let t=0;t<e.operatorCount;t++){const i=t<e.algorithms[r.algorithm].carrierCount;this.pa[t].style.color=i?$.primaryText:"",mn(this.ma[t],r.operators[t].frequency),this.da[t].updateValue(r.operators[t].amplitude);const s=(i?"Voice ":"Modulator ")+(t+1);this.ma[t].title=s+" Frequency",this.da[t].input.title=s+(i?" Volume":" Amplitude")}}else this.Nr.style.display="none",this.Rh.style.display="none",this.Bh.style.display="none",this.Wh.style.display="none";if(6==r.type?(this.ph.style.display="",this.fh.input.title=M(100*n(r.pulseWidth))+"%",this.fh.updateValue(r.pulseWidth)):this.ph.style.display="none",l(r.effects)?(this.oh.style.display="",mn(this.nh,r.transition)):this.oh.style.display="none",c(r.effects)?(this.Dh.style.display="",mn(this.Lh,r.chord)):this.Dh.style.display="none",u(r.effects)){this.bh.style.display="",this.dh.updateValue(r.pitchShift),this.dh.input.title=r.pitchShift-e.pitchShiftCenter+" semitone(s)";for(const t of this.yh)t.style.display=this.W.showFifth?"":"none"}else this.bh.style.display="none";f(r.effects)?(this.kh.style.display="",this.wh.updateValue(r.detune),this.wh.input.title=Mt.detuneToCents(r.detune-e.detuneCenter)+" cent(s)"):this.kh.style.display="none",p(r.effects)?(this.Ah.style.display="",mn(this.zh,r.vibrato)):this.Ah.style.display="none",d(r.effects)?(this.uh.style.display="",this.lh.render()):this.uh.style.display="none",m(r.effects)?(this.xh.style.display="",this.Mh.updateValue(r.distortion)):this.xh.style.display="none",y(r.effects)?(this.Ph.style.display="",this.Eh.style.display="",this.Sh.updateValue(r.bitcrusherQuantization),this.Fh.updateValue(r.bitcrusherFreq)):(this.Ph.style.display="none",this.Eh.style.display="none"),g(r.effects)?(this.Qr.style.display="",this.Kr.updateValue(r.pan)):this.Qr.style.display="none",b(r.effects)?(this.Er.style.display="",this.Fr.updateValue(r.chorus)):this.Er.style.display="none",v(r.effects)?(this.Lr.style.display="",this.Cr.updateValue(r.echoSustain),this.zr.style.display="",this.Dr.updateValue(r.echoDelay),this.Dr.input.title=Math.round((r.echoDelay+1)*e.echoDelayStepTicks/(e.ticksPerPart*e.partsPerBeat)*1e3)/1e3+" beat(s)"):(this.Lr.style.display="none",this.zr.style.display="none"),w(r.effects)?(this.Tr.style.display="",this.qr.updateValue(r.reverb)):this.Tr.style.display="none",0==r.type||5==r.type||7==r.type?(this.Ch.style.display="",mn(this.Th,r.unison)):this.Ch.style.display="none",this._h.render()}else this.jh.style.display="",this.Yh.style.display="none";for(let t=0;t<e.chords.length;t++){let i=!e.instrumentTypeHasSpecialInterval[r.type]&&e.chords[t].customInterval;const s=this.Lh.children[t];i?s.hasAttribute("hidden")||s.setAttribute("hidden",""):s.removeAttribute("hidden")}if(this.W.song.layeredInstruments||this.W.song.patternInstruments){this.Ur.style.display="",this._r.style.setProperty("--text-color-lit",k.primaryNote),this._r.style.setProperty("--text-color-dim",k.secondaryNote),this._r.style.setProperty("--background-color-lit",k.primaryChannel),this._r.style.setProperty("--background-color-dim",k.secondaryChannel);const t=this.W.song.getMaxInstrumentsPerChannel();for(;this.Hr.length<s.instruments.length;){const t=rn(String(this.Hr.length+1));this.Hr.push(t),this._r.insertBefore(t,this.$r)}for(let t=this.ua;t<s.instruments.length;t++)this.Hr[t].style.display="";for(let t=s.instruments.length;t<this.ua;t++)this.Hr[t].style.display="none";for(this.ua=s.instruments.length;this.Hr.length>t;)this._r.removeChild(this.Hr.pop());if(this.$r.style.display=s.instruments.length>e.instrumentCountMin?"":"none",this.Gr.style.display=s.instruments.length<t?"":"none",s.instruments.length<t?this.$r.classList.remove("last-button"):this.$r.classList.add("last-button"),s.instruments.length>1){if(this.ca!=o){const t=this.Hr[this.ca];null!=t&&t.classList.remove("selected-instrument");this.Hr[o].classList.add("selected-instrument"),this.ca=o}}else{const t=this.Hr[this.ca];null!=t&&t.classList.remove("selected-instrument"),this.ca=-1}if(this.W.song.layeredInstruments&&this.W.song.patternInstruments){for(let t=0;t<s.instruments.length;t++)-1!=this.W.recentPatternInstruments[this.W.channel].indexOf(t)?this.Hr[t].classList.remove("deactivated"):this.Hr[t].classList.add("deactivated");this.fa=!0}else if(this.fa){for(let t=0;t<s.instruments.length;t++)this.Hr[t].classList.remove("deactivated");this.fa=!1}}else this.Ur.style.display="none";if(this.Kh.style.color=k.primaryNote,this.hh.render(),this.Jr.updateValue(-r.volume),this.Jh.disabled=r.envelopeCount>=e.maxEnvelopeCount,this.yr.value=String(this.W.volume),h&&null!=a&&0==a.clientWidth&&this.ba(),this.va(this.W.prompt),this.W.autoFollow&&!this.W.synth.playing&&this.W.synth.goToBar(this.W.bar),this.W.addedEffect){const t=this.Jh.getBoundingClientRect(),e=this.ra.getBoundingClientRect(),i=this.ha.getBoundingClientRect();this.ra.scrollTop+=Math.max(0,t.top-(e.top+e.height)),this.ha.scrollTop+=Math.max(0,t.top-(i.top+i.height)),this.W.addedEffect=!1}this.W.addedEnvelope&&(this.ra.scrollTop=this.ra.scrollHeight,this.ha.scrollTop=this.ha.scrollHeight,this.W.addedEnvelope=!1)},this.wa=t=>!t.ctrlKey||(t.preventDefault(),!1),this.ka=t=>{switch(t.keyCode){case 8:case 13:case 38:case 40:case 37:case 39:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:t.stopPropagation()}},this.hn=t=>{if(this.prompt)27==t.keyCode&&this.W.undo();else switch(t.keyCode){case 27:t.ctrlKey||t.metaKey||(new ai(this.W,0,0),this.W.selection.resetBoxSelection());break;case 32:t.shiftKey?(this.ar.movePlayheadToMouse()||this.nr.movePlayheadToMouse())&&(this.W.synth.playing||this.Ma()):this.xa(),t.preventDefault(),this.ba();break;case 90:t.shiftKey?this.W.redo():this.W.undo(),t.preventDefault();break;case 89:this.W.redo(),t.preventDefault();break;case 67:t.shiftKey?this.Sa():this.W.selection.copy(),t.preventDefault();break;case 13:t.ctrlKey||t.metaKey?this.W.selection.insertChannel():this.W.selection.insertBars(),t.preventDefault();break;case 8:t.ctrlKey||t.metaKey?this.W.selection.deleteChannel():this.W.selection.deleteBars(),t.preventDefault();break;case 65:t.shiftKey?this.W.selection.selectChannel():this.W.selection.selectAll(),t.preventDefault();break;case 68:t.ctrlKey||t.metaKey||(this.W.selection.duplicatePatterns(),t.preventDefault());break;case 70:t.ctrlKey||t.metaKey||(this.W.synth.snapToStart(),this.W.autoFollow&&this.W.selection.setChannelBar(this.W.channel,Math.floor(this.W.synth.playhead)),t.preventDefault());break;case 72:t.ctrlKey||t.metaKey||(this.W.synth.goToBar(this.W.bar),this.W.synth.snapToBar(),this.W.autoFollow&&this.W.selection.setChannelBar(this.W.channel,Math.floor(this.W.synth.playhead)),t.preventDefault());break;case 77:t.ctrlKey||t.metaKey||this.W.enableChannelMuting&&(this.W.selection.muteChannels(t.shiftKey),t.preventDefault());break;case 81:t.ctrlKey||t.metaKey||(this.Ir("channelSettings"),t.preventDefault());break;case 83:t.ctrlKey||t.metaKey?(this.Ir("export"),t.preventDefault()):this.W.enableChannelMuting&&(this.W.selection.soloChannels(t.shiftKey),t.preventDefault());break;case 79:(t.ctrlKey||t.metaKey)&&(this.Ir("import"),t.preventDefault());break;case 86:(t.ctrlKey||t.metaKey)&&t.shiftKey?this.W.selection.pasteNumbers():t.shiftKey?this.Pa():this.W.selection.pasteNotes(),t.preventDefault();break;case 73:if(!t.ctrlKey&&!t.metaKey&&t.shiftKey){const i=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()].toJsonObject();delete i.preset,delete i.volume,delete i.pan;const s=i.effects.indexOf(e.effectNames[2]);-1!=s&&i.effects.splice(s,1);for(let t=0;t<i.envelopes.length;t++){const e=i.envelopes[t];"panning"!=e.target&&"none"!=e.target&&"none"!=e.envelope||(i.envelopes.splice(t,1),t--)}this.Fa(JSON.stringify(i)),t.preventDefault()}break;case 82:t.ctrlKey||t.metaKey||(t.shiftKey?this.Ea():this.Ia(),t.preventDefault());break;case 219:t.ctrlKey||t.metaKey||(this.W.synth.goToPrevBar(),this.W.autoFollow&&this.W.selection.setChannelBar(this.W.channel,Math.floor(this.W.synth.playhead)),t.preventDefault());break;case 221:t.ctrlKey||t.metaKey||(this.W.synth.goToNextBar(),this.W.autoFollow&&this.W.selection.setChannelBar(this.W.channel,Math.floor(this.W.synth.playhead)),t.preventDefault());break;case 189:case 173:t.ctrlKey||t.metaKey||(this.W.selection.transpose(!1,t.shiftKey),t.preventDefault());break;case 187:case 61:case 171:t.ctrlKey||t.metaKey||(this.W.selection.transpose(!0,t.shiftKey),t.preventDefault());break;case 38:t.ctrlKey||t.metaKey?this.W.selection.swapChannels(-1):t.shiftKey?(this.W.selection.boxSelectionY1=Math.max(0,this.W.selection.boxSelectionY1-1),this.W.selection.scrollToSelection(),this.W.selection.selectionUpdated()):(this.W.selection.setChannelBar((this.W.channel-1+this.W.song.getChannelCount())%this.W.song.getChannelCount(),this.W.bar),this.W.selection.resetBoxSelection()),t.preventDefault();break;case 40:t.ctrlKey||t.metaKey?this.W.selection.swapChannels(1):t.shiftKey?(this.W.selection.boxSelectionY1=Math.min(this.W.song.getChannelCount()-1,this.W.selection.boxSelectionY1+1),this.W.selection.scrollToSelection(),this.W.selection.selectionUpdated()):(this.W.selection.setChannelBar((this.W.channel+1)%this.W.song.getChannelCount(),this.W.bar),this.W.selection.resetBoxSelection()),t.preventDefault();break;case 37:t.shiftKey?(this.W.selection.boxSelectionX1=Math.max(0,this.W.selection.boxSelectionX1-1),this.W.selection.scrollToSelection(),this.W.selection.selectionUpdated()):(this.W.selection.setChannelBar(this.W.channel,(this.W.bar+this.W.song.barCount-1)%this.W.song.barCount),this.W.selection.resetBoxSelection()),t.preventDefault();break;case 39:t.shiftKey?(this.W.selection.boxSelectionX1=Math.min(this.W.song.barCount-1,this.W.selection.boxSelectionX1+1),this.W.selection.scrollToSelection(),this.W.selection.selectionUpdated()):(this.W.selection.setChannelBar(this.W.channel,(this.W.bar+1)%this.W.song.barCount),this.W.selection.resetBoxSelection()),t.preventDefault();break;case 48:t.ctrlKey||t.metaKey||(this.W.selection.nextDigit("0",t.shiftKey),t.preventDefault());break;case 49:t.ctrlKey||t.metaKey||(this.W.selection.nextDigit("1",t.shiftKey),t.preventDefault());break;case 50:t.ctrlKey||t.metaKey||(this.W.selection.nextDigit("2",t.shiftKey),t.preventDefault());break;case 51:t.ctrlKey||t.metaKey||(this.W.selection.nextDigit("3",t.shiftKey),t.preventDefault());break;case 52:t.ctrlKey||t.metaKey||(this.W.selection.nextDigit("4",t.shiftKey),t.preventDefault());break;case 53:t.ctrlKey||t.metaKey||(this.W.selection.nextDigit("5",t.shiftKey),t.preventDefault());break;case 54:t.ctrlKey||t.metaKey||(this.W.selection.nextDigit("6",t.shiftKey),t.preventDefault());break;case 55:t.ctrlKey||t.metaKey||(this.W.selection.nextDigit("7",t.shiftKey),t.preventDefault());break;case 56:t.ctrlKey||t.metaKey||(this.W.selection.nextDigit("8",t.shiftKey),t.preventDefault());break;case 57:t.ctrlKey||t.metaKey||(this.W.selection.nextDigit("9",t.shiftKey),t.preventDefault());break;default:this.W.selection.digits="",this.W.selection.instrumentDigits=""}},this.qa=()=>{this.W.synth.goToPrevBar()},this.Ta=()=>{this.W.synth.goToNextBar()},this.xa=()=>{this.W.synth.playing?this.Ca():(this.W.synth.snapToBar(),this.Ma())},this.La=()=>{this.W.setVolume(Number(this.yr.value))},this.Sa=()=>{const t=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()].toJsonObject();t.isDrum=this.W.song.getChannelIsNoise(this.W.channel),window.localStorage.setItem("instrumentCopy",JSON.stringify(t)),this.ba()},this.Pa=()=>{const t=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()],e=JSON.parse(String(window.localStorage.getItem("instrumentCopy")));null!=e&&e.isDrum==this.W.song.getChannelIsNoise(this.W.channel)&&this.W.record(new Ce(this.W,t,e)),this.ba()},this.Da=()=>{this.W.record(new Ke(this.W,-1,0|parseInt(this.Pr.value)))},this.za=()=>{if(isNaN(this.kr.value)){if("forceScale"===this.kr.value)this.W.selection.forceScale();this.W.notifier.changed()}else this.W.record(new Ge(this.W,this.kr.selectedIndex))},this.Aa=()=>{if(isNaN(this.Mr.value)){if("detectKey"===this.Mr.value)this.W.record(new $e(this.W));this.W.notifier.changed()}else this.W.record(new Pe(this.W,e.keys.length-1-this.Mr.selectedIndex))},this.Ra=()=>{if(isNaN(this.Ar.value)){if("forceRhythm"===this.Ar.value)this.W.selection.forceRhythm();this.W.notifier.changed()}else this.W.record(new qe(this.W,this.Ar.selectedIndex))},this.Oa=()=>{this.Ba(this.Rr.value)},this.Na=()=>{this.Ba(this.Or.value)},this.Ha=()=>{this.W.record(new ge(this.W,this.Oh.selectedIndex))},this.Ga=()=>{this.W.record(new ye(this.W,this.Br.selectedIndex))},this.$a=t=>{if(t.target==this.Gr)this.W.record(new ke(this.W));else if(t.target==this.$r)this.W.record(new Me(this.W));else{const e=this.Hr.indexOf(t.target);-1!=e&&this.W.selection.selectInstrument(e)}this.ba()},this._a=()=>{this.W.record(new Nt(this.W))},this.Ua=()=>{this.W.record(new mi(this.W,this.Zr.selectedIndex))},this.Va=()=>{this.W.record(new yi(this.W,this.Xr.selectedIndex))},this.Wa=()=>{this.W.record(new $t(this.W,this.nh.selectedIndex))},this.ja=()=>{const t=this.W.song.channels[this.W.channel].instruments[this.W.getCurrentInstrument()],i=t.effects,s=e.effectOrder[this.rh.selectedIndex-1];this.W.record(new _t(this.W,s)),this.rh.selectedIndex=0,t.effects>i&&(this.W.addedEffect=!0)},this.Ja=()=>{this.W.record(new ee(this.W,this.zh.selectedIndex))},this.Ya=()=>{this.W.record(new Xt(this.W,this.Th.selectedIndex))},this.Ka=()=>{this.W.record(new te(this.W,this.Lh.selectedIndex))},this.Qa=()=>{this.W.record(new gi(this.W)),this.ba(),this.W.addedEnvelope=!0},this.Za=()=>{this.W.visibleOctaves=Math.max(1,this.W.visibleOctaves-1),this.W.savePreferences(),this.W.notifier.changed(),this.ba()},this.Xa=()=>{this.W.visibleOctaves=Math.min(e.pitchOctaves,this.W.visibleOctaves+1),this.W.savePreferences(),this.W.notifier.changed(),this.ba()},this.tl=t=>{switch(this.gr.value){case"new":this.W.goBackToStart();for(const t of this.W.song.channels)t.muted=!1;this.W.record(new Ve(this.W,""),!1,!0);break;case"export":this.Ir("export");break;case"import":this.Ir("import");break;case"copyUrl":this.Fa(new URL("#"+this.W.song.toBase64String(),location.href).href);break;case"shareUrl":navigator.share({url:new URL("#"+this.W.song.toBase64String(),location.href).href});break;case"shortenUrl":window.open("https://tinyurl.com/api-create.php?url="+encodeURIComponent(new URL("#"+this.W.song.toBase64String(),location.href).href));break;case"viewPlayer":location.href="player/#song="+this.W.song.toBase64String();break;case"copyEmbed":this.Fa(`<iframe width="384" height="60" style="border: none;" src="${new URL("player/#song="+this.W.song.toBase64String(),location.href).href}"></iframe>`);break;case"songRecovery":this.Ir("songRecovery")}this.gr.selectedIndex=0},this.el=t=>{switch(this.vr.value){case"undo":this.W.undo();break;case"redo":this.W.redo();break;case"copy":this.W.selection.copy();break;case"insertBars":this.W.selection.insertBars();break;case"deleteBars":this.W.selection.deleteBars();break;case"insertChannel":this.W.selection.insertChannel();break;case"deleteChannel":this.W.selection.deleteChannel();break;case"pasteNotes":this.W.selection.pasteNotes();break;case"pasteNumbers":this.W.selection.pasteNumbers();break;case"transposeUp":this.W.selection.transpose(!0,!1);break;case"transposeDown":this.W.selection.transpose(!1,!1);break;case"selectAll":this.W.selection.selectAll();break;case"selectChannel":this.W.selection.selectChannel();break;case"duplicatePatterns":this.W.selection.duplicatePatterns();break;case"barCount":this.Ir("barCount");break;case"beatsPerBar":this.Ir("beatsPerBar");break;case"moveNotesSideways":this.Ir("moveNotesSideways");break;case"channelSettings":this.Ir("channelSettings")}this.vr.selectedIndex=0},this.il=t=>{switch(this.wr.value){case"autoPlay":this.W.autoPlay=!this.W.autoPlay;break;case"autoFollow":this.W.autoFollow=!this.W.autoFollow;break;case"enableNotePreview":this.W.enableNotePreview=!this.W.enableNotePreview;break;case"showLetters":this.W.showLetters=!this.W.showLetters;break;case"showFifth":this.W.showFifth=!this.W.showFifth;break;case"notesOutsideScale":this.W.notesOutsideScale=!this.W.notesOutsideScale;break;case"setDefaultScale":this.W.defaultScale=this.W.song.scale;break;case"showChannels":this.W.showChannels=!this.W.showChannels;break;case"showScrollBar":this.W.showScrollBar=!this.W.showScrollBar;break;case"alwaysShowSettings":this.W.alwaysShowSettings=!this.W.alwaysShowSettings;break;case"instrumentCopyPaste":this.W.instrumentCopyPaste=!this.W.instrumentCopyPaste;break;case"enableChannelMuting":this.W.enableChannelMuting=!this.W.enableChannelMuting;for(const t of this.W.song.channels)t.muted=!1;break;case"displayBrowserUrl":this.W.toggleDisplayBrowserUrl();break;case"layout":this.Ir("layout");break;case"colorTheme":this.W.colorTheme="light classic"==this.W.colorTheme?"dark classic":"light classic",$.setTheme(this.W.colorTheme)}this.wr.selectedIndex=0,this.W.notifier.changed(),this.W.savePreferences()},this.W.notifier.watch(this.whenUpdated),window.addEventListener("resize",this.whenUpdated),"share"in navigator||this.gr.removeChild(this.gr.querySelector("[value='shareUrl']")),this.kr.appendChild(un({label:"Edit"},fn({value:"forceScale"},"Snap Notes To Scale"))),this.Mr.appendChild(un({label:"Edit"},fn({value:"detectKey"},"Detect Key"))),this.Ar.appendChild(un({label:"Edit"},fn({value:"forceRhythm"},"Snap Notes To Rhythm"))),this.Rh.appendChild(hn({class:"selectRow",style:`color: ${$.secondaryText}; height: 1em; margin-top: 0.5em;`},hn({style:"margin-right: .1em; visibility: hidden;"},"1."),hn({style:"width: 3em; margin-right: .3em;",class:"tip",onclick:()=>this.Ir("operatorFrequency")},"Freq:"),hn({class:"tip",onclick:()=>this.Ir("operatorVolume")},"Volume:")));for(let t=0;t<e.operatorCount;t++){const i=t,s=hn({style:`margin-right: .1em; color: ${$.secondaryText};`},t+1+"."),n=pn(ln({style:"width: 100%;",title:"Frequency"}),e.operatorFrequencies.map((t=>t.name))),o=new yn(an({type:"range",min:"0",max:e.operatorAmplitudeMax,value:"0",step:"1",title:"Volume"}),this.W,((t,e)=>new ve(this.W,i,t,e))),r=hn({class:"selectRow"},s,hn({class:"selectContainer",style:"width: 3em; margin-right: .3em;"},n),o.input);this.Rh.appendChild(r),this.pa[t]=r,this.da[t]=o,this.ma[t]=n,n.addEventListener("change",(()=>{this.W.record(new be(this.W,i,n.selectedIndex))}))}this.Uh.appendChild(hn({class:"selectRow"},cn({class:"tip",onclick:()=>this.Ir("drumsetEnvelope")},"Envelope:"),cn({class:"tip",onclick:()=>this.Ir("drumsetSpectrum")},"Spectrum:")));for(let t=e.drumCount-1;t>=0;t--){const i=t,s=new Oi(this.W,i);s.container.addEventListener("mousedown",this.ba),this.ya[t]=s;const n=pn(ln({style:"width: 100%;",title:"Filter Envelope"}),e.envelopes.map((t=>t.name)));this.ga[t]=n,n.addEventListener("change",(()=>{this.W.record(new ne(this.W,i,n.selectedIndex))}));const o=hn({class:"selectRow"},hn({class:"selectContainer",style:"width: 5em; margin-right: .3em;"},n),this.ya[t].container);this.Uh.appendChild(o)}if(this.gr.addEventListener("change",this.tl),this.vr.addEventListener("change",this.el),this.wr.addEventListener("change",this.il),this.Pr.addEventListener("change",this.Da),this.kr.addEventListener("change",this.za),this.Mr.addEventListener("change",this.Aa),this.Ar.addEventListener("change",this.Ra),this.Rr.addEventListener("change",this.Oa),this.Or.addEventListener("change",this.Na),this.Br.addEventListener("change",this.Ga),this._r.addEventListener("click",this.$a),this.Vr.addEventListener("click",this.Sa),this.Wr.addEventListener("click",this.Pa),this.jh.addEventListener("click",this._a),this.Oh.addEventListener("change",this.Ha),this.Zr.addEventListener("change",this.Ua),this.Xr.addEventListener("change",this.Va),this.nh.addEventListener("change",this.Wa),this.rh.addEventListener("change",this.ja),this.Th.addEventListener("change",this.Ya),this.Lh.addEventListener("change",this.Ka),this.zh.addEventListener("change",this.Ja),this.pr.addEventListener("click",this.xa),this.dr.addEventListener("click",this.qa),this.mr.addEventListener("click",this.Ta),this.yr.addEventListener("input",this.La),this.Zh.addEventListener("click",this.Za),this.Xh.addEventListener("click",this.Xa),this.ea.addEventListener("mousedown",this.ba),this.oa.addEventListener("mousedown",this.ba),this.ih.container.addEventListener("mousedown",this.ba),this.Nh.container.addEventListener("mousedown",this.ba),this.hh.container.addEventListener("mousedown",this.ba),this.lh.container.addEventListener("mousedown",this.ba),this.Gh.container.addEventListener("mousedown",this.ba),this.Pr.addEventListener("keydown",this.ka,!1),this.Jh.addEventListener("click",this.Qa),this.ea.addEventListener("contextmenu",this.wa),this.oa.addEventListener("contextmenu",this.wa),this.mainLayer.addEventListener("keydown",this.hn),this.Qh.addEventListener("click",(t=>{t.target==this.Qh&&this.W.undo()})),k){const t=this.wr.querySelector("[value=autoPlay]");t.disabled=!0,t.setAttribute("hidden","")}if(window.screen.availWidth<710||window.screen.availHeight<710){const t=this.wr.querySelector("[value=layout]");t.disabled=!0,t.setAttribute("hidden","")}}Ir(t){this.W.openPrompt(t),this.va(t)}va(t){if(this.la!=t&&(this.la=t,this.prompt&&(!this.aa||this.prompt instanceof Et||this.Ma(),this.aa=!1,this.Qh.style.display="none",this.Qh.removeChild(this.prompt.container),this.prompt.cleanUp(),this.prompt=null,this.ba()),t)){switch(t){case"export":this.prompt=new As(this.W);break;case"import":this.prompt=new $s(this.W);break;case"songRecovery":this.prompt=new nn(this.W);break;case"barCount":this.prompt=new ds(this.W);break;case"beatsPerBar":this.prompt=new Ki(this.W);break;case"moveNotesSideways":this.prompt=new os(this.W);break;case"channelSettings":this.prompt=new ks(this.W);break;case"layout":this.prompt=new Ai(this.W);break;default:this.prompt=new Et(this.W,t)}this.prompt&&(this.prompt instanceof Et||(this.aa=this.W.synth.playing,this.Ca()),this.Qh.style.display="",this.Qh.appendChild(this.prompt.container))}}updatePlayButton(){this.W.synth.playing?(this.pr.classList.remove("playButton"),this.pr.classList.add("pauseButton"),this.pr.title="Pause (Space)",this.pr.textContent="Pause"):(this.pr.classList.remove("pauseButton"),this.pr.classList.add("playButton"),this.pr.title="Play (Space)",this.pr.textContent="Play")}Fa(t){if(navigator.clipboard&&navigator.clipboard.writeText)return void navigator.clipboard.writeText(t).catch((()=>{window.prompt("Copy to clipboard:",t)}));const e=document.createElement("textarea");e.textContent=t,document.body.appendChild(e),e.select();const i=document.execCommand("copy");e.remove(),this.ba(),i||window.prompt("Copy this:",t)}Ma(){this.W.synth.play(),this.updatePlayButton()}Ca(){this.W.synth.pause(),this.W.synth.resetEffects(),this.W.autoFollow&&this.W.synth.goToBar(this.W.bar),this.W.synth.snapToBar(),this.updatePlayButton()}Ia(){const t=this.W.song.getChannelIsNoise(this.W.channel);this.W.record(new Ht(this.W,_e(t)))}Ea(){this.W.record(new Gt(this.W))}Ba(t){if(isNaN(t)){switch(t){case"copyInstrument":this.Sa();break;case"pasteInstrument":this.Pa();break;case"randomPreset":this.Ia();break;case"randomGenerated":this.Ea()}this.W.notifier.changed()}else this.W.record(new Ht(this.W,parseInt(t)))}}class bn{constructor(t){this.W=t,this.boxSelectionX0=0,this.boxSelectionY0=0,this.boxSelectionX1=0,this.boxSelectionY1=0,this.digits="",this.instrumentDigits="",this.patternSelectionStart=0,this.patternSelectionEnd=0,this.patternSelectionActive=!1,this.sl=null,this.nl=null,this.ol=null,this.rl=null}toJSON(){return{x0:this.boxSelectionX0,x1:this.boxSelectionX1,y0:this.boxSelectionY0,y1:this.boxSelectionY1,start:this.patternSelectionStart,end:this.patternSelectionEnd}}fromJSON(t){null!=t&&(this.boxSelectionX0=+t.x0,this.boxSelectionX1=+t.x1,this.boxSelectionY0=+t.y0,this.boxSelectionY1=+t.y1,this.patternSelectionStart=+t.start,this.patternSelectionEnd=+t.end,this.digits="",this.instrumentDigits="",this.patternSelectionActive=this.patternSelectionStart<this.patternSelectionEnd)}selectionUpdated(){this.W.notifier.changed(),this.digits="",this.instrumentDigits=""}get boxSelectionBar(){return Math.min(this.boxSelectionX0,this.boxSelectionX1)}get boxSelectionChannel(){return Math.min(this.boxSelectionY0,this.boxSelectionY1)}get boxSelectionWidth(){return Math.abs(this.boxSelectionX0-this.boxSelectionX1)+1}get boxSelectionHeight(){return Math.abs(this.boxSelectionY0-this.boxSelectionY1)+1}scrollToSelection(){this.W.barScrollPos=Math.min(this.W.barScrollPos,this.boxSelectionX1),this.W.barScrollPos=Math.max(this.W.barScrollPos,this.boxSelectionX1-(this.W.trackVisibleBars-1)),this.W.channelScrollPos=Math.min(this.W.channelScrollPos,this.boxSelectionY1),this.W.channelScrollPos=Math.max(this.W.channelScrollPos,this.boxSelectionY1-(this.W.trackVisibleChannels-1))}setChannelBar(t,e){if(t==this.W.channel&&e==this.W.bar)return;const i=this.W.lastChangeWas(this.ol);this.ol=new Tt,this.ol.append(new Zt(this.W,t,e)),this.W.hasRedoHistory()||this.W.record(this.ol,i),this.selectionUpdated()}setPattern(t){this.W.record(new Ut(this.W,t,this.boxSelectionBar,this.boxSelectionChannel,this.boxSelectionWidth,this.boxSelectionHeight))}nextDigit(t,e){const i=this.W.song.channels[this.boxSelectionChannel];if(e){this.instrumentDigits+=t;var s=parseInt(this.instrumentDigits),n=this.W.getCurrentPattern();if(0!=s&&s<=i.instruments.length&&null!=n)return void this.selectInstrument(s-1);if(this.instrumentDigits=t,0!=(s=parseInt(this.instrumentDigits))&&s<=i.instruments.length&&null!=n)return void this.selectInstrument(s-1);this.instrumentDigits=""}else{this.digits.length>0&&this.digits!=String(i.bars[this.boxSelectionBar])&&(this.digits=""),this.digits+=t;let e=parseInt(this.digits);if(e<=this.W.song.patternsPerChannel)return void this.setPattern(e);if(this.digits=t,e=parseInt(this.digits),e<=this.W.song.patternsPerChannel)return void this.setPattern(e);this.digits=""}}insertBars(){this.W.record(new Wt(this.W,this.boxSelectionBar+this.boxSelectionWidth,this.boxSelectionWidth));const t=this.boxSelectionWidth;this.boxSelectionX0+=t,this.boxSelectionX1+=t}insertChannel(){const t=new Tt,e=this.boxSelectionChannel+this.boxSelectionHeight,i=this.W.song.getChannelIsNoise(e-1);t.append(new Kt(this.W,e,i)),t.isNoop()||(this.boxSelectionY0=this.boxSelectionY1=e,t.append(new Zt(this.W,e,this.W.bar)),this.W.record(t))}deleteBars(){const t=new Tt;if(this.W.selection.patternSelectionActive){(this.boxSelectionWidth>1||this.boxSelectionHeight>1)&&t.append(new ci(this.W,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const e of this.hl())for(const i of this.al(e))t.append(new si(this.W,i,this.W.selection.patternSelectionStart,this.W.selection.patternSelectionEnd));t.append(new ai(this.W,0,0))}else{t.append(new jt(this.W,this.boxSelectionBar,this.boxSelectionWidth));const e=this.boxSelectionWidth;this.boxSelectionX0=Math.max(0,this.boxSelectionX0-e),this.boxSelectionX1=Math.max(0,this.boxSelectionX1-e)}this.W.record(t)}deleteChannel(){this.W.record(new Qt(this.W,this.boxSelectionChannel,this.boxSelectionChannel+this.boxSelectionHeight-1)),this.boxSelectionY0=this.boxSelectionY1=this.W.channel}*hl(){for(let t=this.boxSelectionChannel;t<this.boxSelectionChannel+this.boxSelectionHeight;t++)yield t}*ll(){for(let t=this.boxSelectionBar;t<this.boxSelectionBar+this.boxSelectionWidth;t++)yield t}*al(t){const e={};for(const i of this.ll()){const s=this.W.song.channels[t].bars[i];if(0==s)continue;if(e[String(s)])continue;e[String(s)]=!0;const n=this.W.song.getPattern(t,i);if(null==n)throw new Error;yield n}}cl(t,e){const i=Array.from(t.instruments).map((t=>t>>>0));return Dt(i,this.W.song,e),i}ul(t,e){for(let i=0;i<this.W.song.barCount;i++)if(this.W.song.channels[t].bars[i]==e)return!1;return!0}copy(){const t=[];for(const e of this.hl()){const i={},s=[];for(const t of this.ll()){const n=this.W.song.channels[e].bars[t];if(s.push(n),null==i[String(n)]){const s=this.W.song.getPattern(e,t);let o=this.W.recentPatternInstruments[e],r=[];if(null!=s)if(o=s.instruments.concat(),this.patternSelectionActive)for(const t of s.cloneNotes())t.end<=this.patternSelectionStart||t.start>=this.patternSelectionEnd||(t.start-=this.patternSelectionStart,t.end-=this.patternSelectionStart,(t.start<0||t.end>this.patternSelectionEnd-this.patternSelectionStart)&&new ii(null,t,Math.max(t.start,0),Math.min(this.patternSelectionEnd-this.patternSelectionStart,t.end)),r.push(t));else r=s.notes;i[String(n)]={instruments:o,notes:r}}}const n={isNoise:this.W.song.getChannelIsNoise(e),patterns:i,bars:s};t.push(n)}const i={partDuration:this.patternSelectionActive?this.patternSelectionEnd-this.patternSelectionStart:this.W.song.beatsPerBar*e.partsPerBeat,channels:t};window.localStorage.setItem("selectionCopy",JSON.stringify(i))}pasteNotes(){const t=JSON.parse(String(window.localStorage.getItem("selectionCopy")));if(null==t)return;const i=t.channels||[],s=t.partDuration>>>0,n=new Tt,o=this.boxSelectionWidth>1||this.boxSelectionHeight>1,r=o?this.boxSelectionHeight:Math.min(i.length,this.W.song.getChannelCount()-this.boxSelectionChannel);for(let t=0;t<r;t++){const h=i[t%i.length],a=this.boxSelectionChannel+t,l=!!h.isNoise,c=h.patterns||{},u=h.bars||[];if(0==u.length)continue;if(l!=this.W.song.getChannelIsNoise(a))continue;const f=o?this.boxSelectionWidth:Math.min(u.length,this.W.song.barCount-this.boxSelectionBar);if(o||1!=u.length||1!=i.length)if(this.patternSelectionActive){const t={},e={};n.append(new ci(this.W,this.boxSelectionBar,f,this.boxSelectionChannel,r));for(let i=0;i<f;i++){const o=this.boxSelectionBar+i,r=u[i%u.length]>>>0,h=this.W.song.channels[a].bars[o],l=[r,h].join(",");if(0==r&&0==h)continue;if(null!=t[l]){n.append(new Ut(this.W,t[l],o,a,1,1));continue}if(0==h){n.append(new ze(this.W,a,o));const t=c[String(r)],e=this.cl(t,a),i=this.W.song.getPattern(a,o);n.append(new Le(this.W,a,e,i))}else{const t=this.W.song.getPattern(a,o);if(null==t)throw new Error;if(e[String(h)]){n.append(new Ut(this.W,0,o,a,1,1)),n.append(new ze(this.W,a,o));const e=this.W.song.getPattern(a,o);if(null==e)throw new Error;for(const i of t.cloneNotes())n.append(new ei(this.W,e,i,e.notes.length,!1))}else e[String(h)]=!0}const f=this.W.song.getPattern(a,o);if(null==f)throw new Error;if(0==r)n.append(new si(this.W,f,this.patternSelectionStart,this.patternSelectionEnd));else{const t=c[String(r)];n.append(new Te(this.W,f,t.notes,this.patternSelectionStart,this.patternSelectionEnd,s))}t[l]=this.W.song.channels[a].bars[o]}}else{for(let t=0;t<f;t++){const e=this.boxSelectionBar+t,i=this.W.song.channels[a].bars[e];0!=i&&(n.append(new Ut(this.W,0,e,a,1,1)),this.ul(a,i)&&(this.W.song.channels[a].patterns[i-1].notes.length=0))}const t={};for(let i=0;i<f;i++){const o=this.boxSelectionBar+i,r=u[i%u.length]>>>0,h=String(r);if(0==r)continue;if(null!=t[h]){n.append(new Ut(this.W,t[h],o,a,1,1));continue}const l=c[String(r)],f=this.cl(l,a),p=this.W.song.channels[a].patterns[r-1];if(null!=p&&s==e.partsPerBeat*this.W.song.beatsPerBar&&Je(l.notes,p.notes)&&Lt(f,p.instruments))n.append(new Ut(this.W,r,o,a,1,1));else{null!=p&&this.ul(a,r)?n.append(new Ut(this.W,r,o,a,1,1)):n.append(new ze(this.W,a,o));const t=this.W.song.getPattern(a,o);if(null==t)throw new Error;n.append(new Te(this.W,t,l.notes,this.patternSelectionActive?this.patternSelectionStart:0,this.patternSelectionActive?this.patternSelectionEnd:e.partsPerBeat*this.W.song.beatsPerBar,s)),n.append(new Le(this.W,a,f,t))}t[h]=this.W.song.channels[a].bars[o]}}else{const t=u[0]>>>0,i=this.boxSelectionBar,o=this.W.song.channels[a].bars[i];if(0==t&&0==o)continue;const r=c[String(t)],h=this.cl(r,a);if(0==o){const e=this.W.song.channels[a].patterns[t-1];null!=e&&!this.patternSelectionActive&&(Je(r.notes,e.notes)&&Lt(h,e.instruments)||this.ul(a,t))?n.append(new Ut(this.W,t,i,a,1,1)):n.append(new ze(this.W,a,i))}const l=this.W.song.getPattern(a,i);if(null==l)throw new Error;n.append(new Te(this.W,l,r.notes,this.patternSelectionActive?this.patternSelectionStart:0,this.patternSelectionActive?this.patternSelectionEnd:e.partsPerBeat*this.W.song.beatsPerBar,s)),0==o&&n.append(new Le(this.W,a,h,l))}}this.W.record(n)}pasteNumbers(){const t=JSON.parse(String(window.localStorage.getItem("selectionCopy")));if(null==t)return;const e=t.channels||[],i=new Tt,s=this.boxSelectionWidth>1||this.boxSelectionHeight>1,n=s?this.boxSelectionHeight:Math.min(e.length,this.W.song.getChannelCount()-this.boxSelectionChannel);for(let t=0;t<n;t++){const n=e[t%e.length],o=this.boxSelectionChannel+t,r=n.bars||[];if(0==r.length)continue;const h=s?this.boxSelectionWidth:Math.min(r.length,this.W.song.barCount-this.boxSelectionBar);for(let t=0;t<h;t++){const e=r[t%r.length]>>>0,s=this.boxSelectionBar+t;e>this.W.song.patternsPerChannel&&i.append(new De(this.W,e)),i.append(new Ut(this.W,e,s,o,1,1))}}this.W.record(i)}selectAll(){new ai(this.W,0,0),0==this.boxSelectionBar&&0==this.boxSelectionChannel&&this.boxSelectionWidth==this.W.song.barCount&&this.boxSelectionHeight==this.W.song.getChannelCount()?this.setTrackSelection(this.W.bar,this.W.bar,this.W.channel,this.W.channel):this.setTrackSelection(0,this.W.song.barCount-1,0,this.W.song.getChannelCount()-1),this.selectionUpdated()}selectChannel(){new ai(this.W,0,0),0==this.boxSelectionBar&&this.boxSelectionWidth==this.W.song.barCount?this.setTrackSelection(this.W.bar,this.W.bar,this.boxSelectionY0,this.boxSelectionY1):this.setTrackSelection(0,this.W.song.barCount-1,this.boxSelectionY0,this.boxSelectionY1),this.selectionUpdated()}duplicatePatterns(){this.W.record(new ci(this.W,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight))}muteChannels(t){if(t){let t=!1;for(let e=0;e<this.W.song.channels.length;e++)if(this.W.song.channels[e].muted){t=!0;break}for(let e=0;e<this.W.song.channels.length;e++)this.W.song.channels[e].muted=!t}else{let t=!1;for(const e of this.hl())if(!this.W.song.channels[e].muted){t=!0;break}for(const e of this.hl())this.W.song.channels[e].muted=t}this.W.notifier.changed()}soloChannels(t){let e=!0;for(let i=0;i<this.W.song.channels.length;i++){const s=i<this.boxSelectionChannel||i>=this.boxSelectionChannel+this.boxSelectionHeight?!t:t;if(this.W.song.channels[i].muted!=s){e=!1;break}}if(e)for(let t=0;t<this.W.song.channels.length;t++)this.W.song.channels[t].muted=!1;else for(let e=0;e<this.W.song.channels.length;e++)this.W.song.channels[e].muted=e<this.boxSelectionChannel||e>=this.boxSelectionChannel+this.boxSelectionHeight?!t:t;this.W.notifier.changed()}forceRhythm(){const t=new Tt;(this.boxSelectionWidth>1||this.boxSelectionHeight>1)&&t.append(new ci(this.W,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const e of this.hl())for(const i of this.al(e))t.append(new Oe(this.W,i));this.W.record(t)}forceScale(){const t=new Tt;(this.boxSelectionWidth>1||this.boxSelectionHeight>1)&&t.append(new ci(this.W,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));const i=[!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];for(const t of this.hl())if(!this.W.song.getChannelIsNoise(t))for(const e of this.al(t))zt(e,i);const s=function(t,i){const s=e.scales[i].flags,n=[],o=[];for(let e=0;e<12;e++)t[e]&&n.push(e),s[e]&&o.push(e);const r=n.length>o.length,h=r?o:n,a=r?n:o,l=["root","second","second","third","third","fourth","tritone","fifth","sixth","sixth","seventh","seventh","root"];let c=Number.MAX_SAFE_INTEGER,u=[];const f=[[0]];for(;f.length>0;){const t=f.pop();if(t.length==h.length){let e=0;for(let i=0;i<t.length;i++)e+=Math.abs(h[i]-a[t[i]]),l[h[i]]!=l[a[t[i]]]&&(e+=.75);c>e&&(c=e,u=t)}else{const e=t[t.length-1]+1,i=a.length-h.length+t.length;for(let s=e;s<=i;s++)f.push(t.concat(s))}}const p=[];for(let t=0;t<u.length;t++){const e=h[t],i=a[u[t]];p[t]=r?[i,e]:[e,i]}p.push([12,12]),o.push(12);let d=0;const m=[];for(let t=0;t<12;t++){const e=p[d][0],i=p[d][1],s=p[d+1][0],n=p[d+1][1];t==s-1&&d++;const r=(t-e)*(n-i)/(s-e)+i;let h=0,a=Number.MAX_SAFE_INTEGER;for(const e of o){let i=Math.abs(e-r);l[e]!=l[t]&&(i+=.1),a>i&&(a=i,h=e)}m[t]=h}return m}(i,this.W.song.scale);for(const e of this.hl())if(!this.W.song.getChannelIsNoise(e))for(const i of this.al(e))t.append(new ui(this.W,i,s));this.W.record(t)}setTrackSelection(t,e,i,s){const n=this.W.lastChangeWas(this.ol);this.ol=new Tt,this.ol.append(new hi(this.W,t,e,i,s)),this.W.hasRedoHistory()||this.W.record(this.ol,n)}transpose(t,e){const i=this.W.lastChangeWas(this.sl);this.sl=new Tt,(this.boxSelectionWidth>1||this.boxSelectionHeight>1)&&this.sl.append(new ci(this.W,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const i of this.hl())for(const s of this.al(i))this.sl.append(new ri(this.W,i,s,t,this.W.notesOutsideScale,e));this.W.record(this.sl,i)}swapChannels(t){const e=[this.W.song.pitchChannelCount,this.W.song.pitchChannelCount+this.W.song.noiseChannelCount,this.W.song.getChannelCount()];let i=0,s=0;for(const n of e){if(this.boxSelectionChannel<n&&t<0||this.boxSelectionChannel+this.boxSelectionHeight<=n){s=n-1;break}i=n}const n=Math.max(this.boxSelectionChannel,i),o=Math.min(this.boxSelectionChannel+this.boxSelectionHeight-1,s);if(t=Math.max(t,i-n),0!=(t=Math.min(t,s-o))){const e=this.W.lastChangeWas(this.nl);this.nl=new Tt,this.boxSelectionY0=n+t,this.boxSelectionY1=o+t,this.nl.append(new Jt(this.W,n,o,t)),this.nl.append(new Zt(this.W,Math.max(this.boxSelectionY0,Math.min(this.boxSelectionY1,this.W.channel+t)),this.W.bar)),this.selectionUpdated(),this.W.record(this.nl,e)}}selectInstrument(t){if(this.W.viewedInstrument[this.W.channel]==t){if(this.W.song.layeredInstruments&&this.W.song.patternInstruments){const e=this.W.lastChangeWas(this.rl);this.rl=new Tt;const i=this.W.recentPatternInstruments[this.W.channel];if(-1==i.indexOf(t)){i.push(t);const e=this.W.song.getMaxInstrumentsPerPattern(this.W.channel);i.length>e&&i.splice(0,i.length-e)}else i.splice(i.indexOf(t),1),0==i.length&&(i[0]=0);(this.boxSelectionWidth>1||this.boxSelectionHeight>1)&&this.rl.append(new ci(this.W,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const t of this.hl())for(const e of this.al(t))this.rl.append(new Le(this.W,t,i,e));this.W.record(this.rl,e)}}else{const e=this.W.lastChangeWas(this.rl);if(this.rl=new Tt,this.rl.append(new xe(this.W,t)),!this.W.song.layeredInstruments&&this.W.song.patternInstruments){(this.boxSelectionWidth>1||this.boxSelectionHeight>1)&&this.rl.append(new ci(this.W,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));const i=[t];for(const t of this.hl())for(const e of this.al(t))this.rl.append(new Le(this.W,t,i,e));this.W.record(this.rl,e)}else this.W.hasRedoHistory()||this.W.record(this.rl,e)}}resetBoxSelection(){this.boxSelectionX0=this.boxSelectionX1=this.W.bar,this.boxSelectionY0=this.boxSelectionY1=this.W.channel}}class vn{constructor(){this.fl=[],this.pl=!1}watch(t){-1==this.fl.indexOf(t)&&this.fl.push(t)}unwatch(t){const e=this.fl.indexOf(t);-1!=e&&this.fl.splice(e,1)}changed(){this.pl=!0}notifyWatchers(){if(this.pl){this.pl=!1;for(const t of this.fl.concat())t()}}}class wn{constructor(){this.notifier=new vn,this.selection=new bn(this),this.channel=0,this.bar=0,this.volume=75,this.visibleOctaves=wn.defaultVisibleOctaves,this.recentPatternInstruments=[],this.viewedInstrument=[],this.trackVisibleBars=16,this.trackVisibleChannels=4,this.barScrollPos=0,this.channelScrollPos=0,this.prompt=null,this.addedEffect=!1,this.addedEnvelope=!1,this.dl=new Ys,this.ml=null,this.yl=0,this.gl=0,this.bl=!1,this.vl=!1,this.wl=!1,this.kl=()=>{if(null==window.history.state&&""!=window.location.hash){this.yl++,this.Ml();const t={canUndo:!0,sequenceNumber:this.yl,bar:this.bar,channel:this.channel,instrument:this.viewedInstrument[this.channel],recoveryUid:this.xl,prompt:null,selection:this.selection.toJSON()};return new Ve(this,window.location.hash),this.prompt=t.prompt,this.displayBrowserUrl?this.Sl(t,this.song.toBase64String()):this.Pl(t,this.song.toBase64String()),this.forgetLastChange(),void this.notifier.notifyWatchers()}const t=this.Fl();if(null==t)throw new Error("History state is null.");t.sequenceNumber!=this.yl&&(this.bar=t.bar,this.channel=t.channel,this.viewedInstrument[this.channel]=t.instrument,this.yl=t.sequenceNumber,this.prompt=t.prompt,new Ve(this,this.El()),this.xl=t.recoveryUid,this.selection.fromJSON(t.selection),this.forgetLastChange(),this.notifier.notifyWatchers())},this.Il=()=>{this.notifier.notifyWatchers()},this.ql=()=>{const t=this.song.getChannelCount();for(let e=this.recentPatternInstruments.length;e<t;e++)this.recentPatternInstruments[e]=[0];this.recentPatternInstruments.length=t;for(let e=0;e<t;e++){if(e==this.channel)if(this.song.patternInstruments){const t=this.song.getPattern(this.channel,this.bar);null!=t&&(this.recentPatternInstruments[e]=t.instruments.concat())}else{const t=this.song.channels[this.channel];for(let i=0;i<t.instruments.length;i++)this.recentPatternInstruments[e][i]=i;this.recentPatternInstruments[e].length=t.instruments.length}Dt(this.recentPatternInstruments[e],this.song,e)}for(let e=this.viewedInstrument.length;e<t;e++)this.viewedInstrument[e]=0;this.viewedInstrument.length=t;for(let e=0;e<t;e++){if(this.song.patternInstruments&&!this.song.layeredInstruments&&e==this.channel){const t=this.song.getPattern(this.channel,this.bar);null!=t&&(this.viewedInstrument[e]=t.instruments[0])}this.viewedInstrument[e]=Math.min(this.viewedInstrument[e],this.song.channels[e].instruments.length-1)}const e=this.getCurrentPattern();null!=e&&this.song.patternInstruments&&(this.recentPatternInstruments[this.channel]=e.instruments.concat()),(!this.synth.playing&&(this.bar<this.selection.boxSelectionBar||this.selection.boxSelectionBar+this.selection.boxSelectionWidth<=this.bar)||this.channel<this.selection.boxSelectionChannel||this.selection.boxSelectionChannel+this.selection.boxSelectionHeight<=this.channel||this.song.barCount<this.selection.boxSelectionBar+this.selection.boxSelectionWidth||t<this.selection.boxSelectionChannel+this.selection.boxSelectionHeight||1==this.selection.boxSelectionWidth&&1==this.selection.boxSelectionHeight)&&this.selection.resetBoxSelection()},this.Tl=()=>{let t;this.wl=!1;try{t=this.song.toBase64String()}catch(t){return void window.alert('Whoops, the song data appears to have been corrupted! Please try to recover the last working version of the song from the "Recover Recent Song..." option in BeepBox\'s "File" menu.')}this.bl&&this.yl++,this.vl?this.Ml():this.dl.saveVersion(this.xl,t);let e={canUndo:!0,sequenceNumber:this.yl,bar:this.bar,channel:this.channel,instrument:this.viewedInstrument[this.channel],recoveryUid:this.xl,prompt:this.prompt,selection:this.selection.toJSON()};this.bl?this.Pl(e,t):this.Sl(e,t),this.bl=!1,this.vl=!1},this.notifier.watch(this.ql),this.autoPlay="true"==window.localStorage.getItem("autoPlay"),this.autoFollow="true"==window.localStorage.getItem("autoFollow"),this.enableNotePreview="false"!=window.localStorage.getItem("enableNotePreview"),this.showFifth="true"==window.localStorage.getItem("showFifth"),this.notesOutsideScale="true"==window.localStorage.getItem("notesOutsideScale"),this.showLetters="true"==window.localStorage.getItem("showLetters"),this.showChannels="true"==window.localStorage.getItem("showChannels"),this.showScrollBar="true"==window.localStorage.getItem("showScrollBar"),this.alwaysShowSettings="true"==window.localStorage.getItem("alwaysShowSettings"),this.instrumentCopyPaste="true"==window.localStorage.getItem("instrumentCopyPaste"),this.enableChannelMuting="true"==window.localStorage.getItem("enableChannelMuting"),this.displayBrowserUrl="false"!=window.localStorage.getItem("displayBrowserUrl"),this.layout=window.localStorage.getItem("layout")||"small",this.colorTheme=window.localStorage.getItem("colorTheme")||"dark classic",this.visibleOctaves=window.localStorage.getItem("visibleOctaves")>>>0||wn.defaultVisibleOctaves;const t=e.scales.dictionary[window.localStorage.getItem("defaultScale")];this.defaultScale=null!=t?t.index:0,null!=window.localStorage.getItem("volume")&&(this.volume=Math.min(window.localStorage.getItem("volume")>>>0,75)),null!=window.localStorage.getItem("fullScreen")&&("true"==window.localStorage.getItem("fullScreen")&&(this.layout="long"),window.localStorage.removeItem("fullScreen")),$.setTheme(this.colorTheme),U.setLayout(this.layout),null==window.sessionStorage.getItem("currentUndoIndex")&&(window.sessionStorage.setItem("currentUndoIndex","0"),window.sessionStorage.setItem("oldestUndoIndex","0"),window.sessionStorage.setItem("newestUndoIndex","0"));let i=window.location.hash;""==i&&(i=this.El()),this.song=new yt(i),""!=i&&null!=i||(Ue(this.song),this.song.scale=this.defaultScale),i=this.song.toBase64String(),this.synth=new Mt(this.song),this.synth.volume=this.Cl();let s=this.Fl();null==s&&(s={canUndo:!1,sequenceNumber:0,bar:0,channel:0,instrument:0,recoveryUid:Ws(),prompt:null,selection:this.selection.toJSON()}),null==s.recoveryUid&&(s.recoveryUid=Ws()),this.Sl(s,i),window.addEventListener("hashchange",this.kl),window.addEventListener("popstate",this.kl),this.bar=0|s.bar,this.channel=0|s.channel;for(let t=0;t<=this.channel;t++)this.viewedInstrument[t]=0;this.viewedInstrument[this.channel]=0|s.instrument,this.xl=s.recoveryUid,this.prompt=s.prompt,this.selection.fromJSON(s.selection);for(const t of["input","change","click","keyup","keydown","mousedown","mousemove","mouseup","touchstart","touchmove","touchend","touchcancel"])window.addEventListener(t,this.Il);this.ql()}toggleDisplayBrowserUrl(){const t=this.Fl();this.displayBrowserUrl=!this.displayBrowserUrl,this.Sl(t,this.song.toBase64String())}Fl(){if(this.displayBrowserUrl)return window.history.state;{const t=JSON.parse(window.sessionStorage.getItem(window.sessionStorage.getItem("currentUndoIndex")));return null==t?null:t.state}}El(){if(this.displayBrowserUrl)return window.location.hash;{const t=JSON.parse(window.sessionStorage.getItem(window.sessionStorage.getItem("currentUndoIndex")));return null==t?"":t.hash}}Sl(t,e){this.displayBrowserUrl?window.history.replaceState(t,"","#"+e):(window.sessionStorage.setItem(window.sessionStorage.getItem("currentUndoIndex")||"0",JSON.stringify({state:t,hash:e})),window.history.replaceState(null,"",location.pathname))}Pl(t,e){if(this.displayBrowserUrl)window.history.pushState(t,"","#"+e);else{let i=Number(window.sessionStorage.getItem("currentUndoIndex")),s=Number(window.sessionStorage.getItem("oldestUndoIndex"));i=(i+1)%wn.Ll,window.sessionStorage.setItem("currentUndoIndex",String(i)),window.sessionStorage.setItem("newestUndoIndex",String(i)),i==s&&(s=(s+1)%wn.Ll,window.sessionStorage.setItem("oldestUndoIndex",String(s))),window.sessionStorage.setItem(String(i),JSON.stringify({state:t,hash:e})),window.history.replaceState(null,"",location.pathname)}this.gl=t.sequenceNumber}hasRedoHistory(){return this.gl>this.yl}Dl(){if(this.displayBrowserUrl)window.history.forward();else{let t=Number(window.sessionStorage.getItem("currentUndoIndex"));t!=Number(window.sessionStorage.getItem("newestUndoIndex"))&&(t=(t+1)%wn.Ll,window.sessionStorage.setItem("currentUndoIndex",String(t)),setTimeout(this.kl))}}zl(){if(this.displayBrowserUrl)window.history.back();else{let t=Number(window.sessionStorage.getItem("currentUndoIndex"));t!=Number(window.sessionStorage.getItem("oldestUndoIndex"))&&(t=(t+wn.Ll-1)%wn.Ll,window.sessionStorage.setItem("currentUndoIndex",String(t)),setTimeout(this.kl))}}record(t,e=!1,i=!1){t.isNoop()?(this.ml=null,e&&this.zl()):(t.commit(),this.ml=t,this.bl=this.bl||!e,this.vl=this.vl||i,this.wl||(window.requestAnimationFrame(this.Tl),this.wl=!0))}Ml(){this.xl=Ws()}openPrompt(t){this.prompt=t;const e=this.song.toBase64String();this.yl++;const i={canUndo:!0,sequenceNumber:this.yl,bar:this.bar,channel:this.channel,instrument:this.viewedInstrument[this.channel],recoveryUid:this.xl,prompt:this.prompt,selection:this.selection.toJSON()};this.Pl(i,e)}undo(){this.Fl().canUndo&&this.zl()}redo(){this.Dl()}setProspectiveChange(t){this.ml=t}forgetLastChange(){this.ml=null}lastChangeWas(t){return null!=t&&t==this.ml}goBackToStart(){this.channel=0,this.bar=0,this.barScrollPos=0,this.notifier.changed(),this.synth.snapToStart(),this.notifier.changed()}savePreferences(){window.localStorage.setItem("autoPlay",this.autoPlay?"true":"false"),window.localStorage.setItem("autoFollow",this.autoFollow?"true":"false"),window.localStorage.setItem("enableNotePreview",this.enableNotePreview?"true":"false"),window.localStorage.setItem("showFifth",this.showFifth?"true":"false"),window.localStorage.setItem("notesOutsideScale",this.notesOutsideScale?"true":"false"),window.localStorage.setItem("defaultScale",e.scales[this.defaultScale].name),window.localStorage.setItem("showLetters",this.showLetters?"true":"false"),window.localStorage.setItem("showChannels",this.showChannels?"true":"false"),window.localStorage.setItem("showScrollBar",this.showScrollBar?"true":"false"),window.localStorage.setItem("alwaysShowSettings",this.alwaysShowSettings?"true":"false"),window.localStorage.setItem("enableChannelMuting",this.enableChannelMuting?"true":"false"),window.localStorage.setItem("instrumentCopyPaste",this.instrumentCopyPaste?"true":"false"),window.localStorage.setItem("displayBrowserUrl",this.displayBrowserUrl?"true":"false"),window.localStorage.setItem("layout",this.layout),window.localStorage.setItem("colorTheme",this.colorTheme),window.localStorage.setItem("volume",String(this.volume)),window.localStorage.setItem("visibleOctaves",String(this.visibleOctaves))}setVolume(t){this.volume=t,this.savePreferences(),this.synth.volume=this.Cl()}Cl(){return Math.min(1,Math.pow(this.volume/50,.5))*Math.pow(2,(this.volume-75)/25)}getCurrentPattern(t=0){return this.song.getPattern(this.channel,this.bar+t)}getCurrentInstrument(t=0){return this.viewedInstrument[this.channel]}getMobileLayout(){return window.innerWidth<=710}getBarWidth(){return this.getMobileLayout()||!this.enableChannelMuting||this.getFullScreen()?32:30}getChannelHeight(){return 27}getFullScreen(){return!this.getMobileLayout()&&"small"!=this.layout}getVisibleOctaveCount(){return this.getFullScreen()?this.visibleOctaves:wn.defaultVisibleOctaves}getVisiblePitchCount(){return this.getVisibleOctaveCount()*e.pitchesPerOctave+1}getBaseVisibleOctave(t){const i=this.getVisibleOctaveCount();return Math.max(0,Math.min(e.pitchOctaves-i,Math.ceil(this.song.channels[t].octave-.5*i)))}}wn.defaultVisibleOctaves=3,wn.Ll=100;const kn=new wn,Mn=new gn(kn);if(document.getElementById("beepboxEditorContainer").appendChild(Mn.mainLayer),Mn.whenUpdated(),Mn.mainLayer.focus(),!k&&kn.autoPlay){function t(){document.hidden||(kn.synth.play(),Mn.updatePlayButton(),window.removeEventListener("visibilitychange",t))}document.hidden?window.addEventListener("visibilitychange",t):t()}return"scrollRestoration"in history&&(history.scrollRestoration="manual"),Mn.updatePlayButton(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/service_worker.js",{updateViaCache:"all",scope:"/"}).catch((()=>{})),t.ChangePreset=Ht,t.Channel=mt,t.ColorConfig=$,t.Config=e,t.EditorConfig=x,t.ExportPrompt=As,t.Instrument=dt,t.Note=rt,t.Pattern=ht,t.SongDocument=wn,t.SongEditor=gn,t.Synth=Mt,Object.defineProperty(t,"Al",{value:!0}),t}({});
//# sourceMappingURL=beepbox_editor.min.js.map
	</script>
</body></html>
